<!-- Compiled in Cursor | Last build update: 2/11/2026  5:31:00 PM | Version No. 7 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Strike Maps</title>

        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">
            <link rel="icon" href="https://strike-bot.pages.dev/strike.jpg">
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
                    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

                    <style>
                        :root {
                            --bg: #000000;
                            --glass-surface: rgba(10, 10, 10, 0.85);
                            --glass-border: rgba(255, 255, 255, 0.08);
                            --font-main: 'Manrope', sans-serif;
                            --ease-pro: cubic-bezier(0.2, 0, 0, 1);
                        }

                        body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: var(--font-main); height: 100vh; width: 100vw; overflow: hidden; }

                        #map { height: 100%; width: 100%; z-index: 1; background: #050505; transition: opacity 1s ease; }
                        .dark-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

                        .strike-glass { background: var(--glass-surface); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); box-shadow: 0 24px 60px rgba(0,0,0,0.9); border-radius: 16px; }
                        .strike-input { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); color: white; transition: all 0.3s var(--ease-pro); }

                        #info-sidebar { position: absolute; right: 24px; top: 24px; bottom: 24px; width: 380px; z-index: 2000; transform: translateX(calc(100% + 50px)); transition: transform 0.8s var(--ease-pro); display: flex; flex-direction: column; }
                        #info-sidebar.active { transform: translateX(0); }

                        .route-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; transition: all 0.2s; cursor: pointer; }
                        .route-card.active { border-color: #ffffff; background: rgba(255, 255, 255, 0.05); }

                        #active-nav-hud { display: none; }

                        #loader { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
                        .loading-bar { width: 120px; height: 2px; background: #111; margin-top: 15px; position: relative; overflow: hidden; }
                        .loading-fill { position: absolute; left: 0; top: 0; height: 100%; background: #fff; width: 0%; animation: load 2s forwards; }
                        @keyframes load { to { width: 100%; } }

                        .ui-animate { opacity: 0; transform: translateY(15px); transition: all 0.8s var(--ease-pro); }
                        .ui-ready .ui-animate { opacity: 1; transform: translateY(0); }

                        .gps-ring {
                            border: 2px solid #fff;
                            border-radius: 50%;
                            height: 18px;
                            width: 18px;
                            box-shadow: 0 0 15px rgba(255,255,255,0.6);
                            position: relative;
                            background: rgba(255, 255, 255, 0.1);
                            animation: pulse 2s infinite;
                        }
                        @keyframes pulse {
                            0% { transform: scale(1); opacity: 1; }
                            50% { transform: scale(1.1); opacity: 0.8; }
                            100% { transform: scale(1); opacity: 1; }
                        }

                        #results { max-height: 250px; overflow-y: auto; }
                        #results::-webkit-scrollbar { width: 4px; }
                        #results::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
                        #results::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

                        #sidebar-content::-webkit-scrollbar { width: 4px; }
                        #sidebar-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
                        #sidebar-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

                        #directions-list { max-height: 500px; overflow-y: auto; }
                        #directions-list::-webkit-scrollbar { width: 4px; }
                        #directions-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
                        #directions-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

                        .search-result { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; }
                        .search-result:hover { background: rgba(255,255,255,0.05); }
                        .search-result:last-child { border-bottom: none; }

                        .filter-btn { padding: 6px 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.7); transition: all 0.2s; }
                        .filter-btn.active { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); }

                        .nav-instruction-text { font-size: 13px; line-height: 1.4; }

                        #exit-nav-btn { background: rgba(239, 68, 68, 0.25); border: 1px solid rgba(239, 68, 68, 0.5); color: #ff6b6b; }
                        #exit-nav-btn:hover { background: #ef4444; color: white; border-color: #ef4444; }

                        .aviation-path { stroke-dasharray: 10, 10; }

                        .type-badge {
                            font-size: 8px;
                            font-weight: 700;
                            padding: 2px 5px;
                            border-radius: 4px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        .type-city { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
                        .type-street { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; }
                        .type-building { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
                        .type-landmark { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
                        .type-default { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.7); }

                        .direction-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: all 0.3s; }
                        .direction-item.active { background: rgba(59, 130, 246, 0.15); border-left: 3px solid #3b82f6; }
                        .direction-item.completed { opacity: 0.5; }

                        .traffic-indicator {
                            display: inline-block;
                            width: 6px;
                            height: 6px;
                            border-radius: 50%;
                            margin-right: 4px;
                        }
                        .traffic-high { background: #ef4444; }
                        .traffic-medium { background: #f59e0b; }
                        .traffic-low { background: #10b981; }

                        .recent-item { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
                        .recent-item:hover { background: rgba(255,255,255,0.05); }
                        .recent-time { font-size: 9px; color: #6b7280; }

                        .progress-bar { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 8px; }
                        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); transition: width 0.3s; }

                        .step-number {
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: rgba(255,255,255,0.1);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 11px;
                            font-weight: 700;
                        }
                        .step-number.active { background: #3b82f6; color: white; }
                        .step-number.completed { background: #10b981; color: white; }
                        .step-content { flex: 1; }
                        .step-instruction { font-size: 12px; font-weight: 600; color: white; }
                        .step-details { font-size: 10px; color: #9ca3af; margin-top: 2px; }

                        .nav-hud-pos { display: block; }
                        .nav-hud-eta { display: none; }
                        .nav-hud-acc { display: block; }
                        .nav-hud-distance { display: none; }

                        body.navigating .nav-hud-pos { display: none; }
                        body.navigating .nav-hud-eta { display: block; }
                        body.navigating .nav-hud-acc { display: none; }
                        body.navigating .nav-hud-distance { display: block; }

                        #directions-list::-webkit-scrollbar { width: 4px; }
                        #directions-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
                        #directions-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

                        .nav-hud-pos { display: block; }
                        .nav-hud-eta { display: none; }
                        .nav-hud-acc { display: block; }
                        .nav-hud-distance { display: none; }

                        body.navigating .nav-hud-pos { display: none; }
                        body.navigating .nav-hud-eta { display: block; }
                        body.navigating .nav-hud-acc { display: none; }
                        body.navigating .nav-hud-distance { display: block; }

                        .nav-hud-pos::before { content: "Pos:  "; }
                        .nav-hud-eta::before { content: "ETA:  "; }
                        .nav-hud-acc::before { content: "Acc:  "; }
                        .nav-hud-distance::before { content: "Left:  "; }

                        #custom-start-panel {
                            position: absolute;
                            top: 80px;
                            left: 24px;
                            z-index: 1001;
                            width: 340px;
                        }

                        #custom-start-toggle {
                            width: 100%;
                            padding: 8px 12px;
                            font-size: 11px;
                            background: rgba(255,255,255,0.03);
                            border: 1px solid rgba(255,255,255,0.1);
                            border-radius: 8px;
                            color: #9ca3af;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        }

                        #custom-start-toggle:hover {
                            background: rgba(255,255,255,0.05);
                            color: white;
                        }

                        #custom-start-expanded {
                            display: none;
                            margin-top: 8px;
                            padding: 16px;
                        }

                        .start-mode-btn {
                            width: 100%;
                            padding: 10px;
                            margin-bottom: 8px;
                            background: rgba(255,255,255,0.03);
                            border: 1px solid rgba(255,255,255,0.1);
                            border-radius: 8px;
                            color: white;
                            font-size: 11px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s;
                        }

                        .start-mode-btn:hover {
                            background: rgba(255,255,255,0.05);
                            border-color: rgba(255,255,255,0.2);
                        }

                        .start-mode-btn.active {
                            background: rgba(59, 130, 246, 0.2);
                            border-color: #3b82f6;
                            color: #93c5fd;
                        }

                        #custom-start-input-container {
                            display: none;
                            margin-top: 12px;
                        }

                        #custom-start-search-results {
                            max-height: 200px;
                            overflow-y: auto;
                            margin-top: 8px;
                            display: none;
                        }

                        .current-start-display {
                            font-size: 10px;
                            color: #9ca3af;
                            margin-top: 4px;
                            padding: 8px;
                            background: rgba(255,255,255,0.02);
                            border-radius: 6px;
                            border: 1px solid rgba(255,255,255,0.05);
                        }

                        #custom-start-panel {
                            position: absolute;
                            top: 180px;
                            left: 24px;
                            z-index: 1001;
                            width: 340px;
                        }

                        #custom-start-toggle {
                            width: 100%;
                            padding: 8px 12px;
                            font-size: 11px;
                            background: rgba(255,255,255,0.03);
                            border: 1px solid rgba(255,255,255,0.1);
                            border-radius: 8px;
                            color: #9ca3af;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        }

                        #custom-start-toggle:hover {
                            background: rgba(255,255,255,0.05);
                            color: white;
                        }

                        #custom-start-expanded {
                            display: none;
                            margin-top: 8px;
                            padding: 16px;
                        }

                        .start-mode-btn {
                            width: 100%;
                            padding: 10px;
                            margin-bottom: 8px;
                            background: rgba(255,255,255,0.03);
                            border: 1px solid rgba(255,255,255,0.1);
                            border-radius: 8px;
                            color: white;
                            font-size: 11px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s;
                        }

                        .start-mode-btn:hover {
                            background: rgba(255,255,255,0.05);
                            border-color: rgba(255,255,255,0.2);
                        }

                        .start-mode-btn.active {
                            background: rgba(59, 130, 246, 0.2);
                            border-color: #3b82f6;
                            color: #93c5fd;
                        }

                        #custom-start-input-container {
                            display: none;
                            margin-top: 12px;
                        }

                        #custom-start-search-results {
                            max-height: 200px;
                            overflow-y: auto;
                            margin-top: 8px;
                            display: none;
                        }

                        .current-start-display {
                            font-size: 10px;
                            color: #9ca3af;
                            margin-top: 4px;
                            padding: 8px;
                            background: rgba(255,255,255,0.02);
                            border-radius: 6px;
                            border: 1px solid rgba(255,255,255,0.05);
                        }

                        #custom-start-panel {
                            position: absolute;
                            top: 180px;
                            left: 24px;
                            z-index: 999;
                            width: 340px;
                            pointer-events: auto;
                        }

                        #custom-start-toggle {
                            width: 100%;
                            padding: 8px 12px;
                            font-size: 11px;
                            background: rgba(255,255,255,0.03);
                            border: 1px solid rgba(255,255,255,0.1);
                            border-radius: 8px;
                            color: #9ca3af;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        }

                        #custom-start-toggle:hover {
                            background: rgba(255,255,255,0.05);
                            color: white;
                        }

                        #custom-start-expanded {
                            display: none;
                            margin-top: 8px;
                            padding: 16px;
                            background: var(--glass-surface);
                            backdrop-filter: blur(30px);
                            border: 1px solid var(--glass-border);
                            border-radius: 12px;
                            box-shadow: 0 24px 60px rgba(0,0,0,0.9);
                            overflow-y: auto;
                        }

                        #custom-start-expanded.dynamic-height {
                            position: fixed;
                            max-height: none;
                        }

                        #custom-start-expanded::-webkit-scrollbar {
                            width: 6px !important;
                        }

                        #custom-start-expanded::-webkit-scrollbar-track {
                            background: rgba(255,255,255,0.05) !important;
                            border-radius: 3px !important;
                            margin: 4px 0 !important;
                        }

                        #custom-start-expanded::-webkit-scrollbar-thumb {
                            background: rgba(59, 130, 246, 0.5) !important;
                            border-radius: 3px !important;
                            border: 1px solid rgba(255,255,255,0.1) !important;
                        }

                        #custom-start-expanded::-webkit-scrollbar-thumb:hover {
                            background: rgba(59, 130, 246, 0.7) !important;
                        }

                        #custom-start-search-results {
                            max-height: 200px;
                            overflow-y: auto;
                            margin-top: 8px;
                            display: none;
                        }

                        #custom-start-search-results::-webkit-scrollbar {
                            width: 4px !important;
                        }

                        #custom-start-search-results::-webkit-scrollbar-track {
                            background: rgba(255,255,255,0.03) !important;
                        }

                        #custom-start-search-results::-webkit-scrollbar-thumb {
                            background: rgba(139, 92, 246, 0.5) !important;
                        }

                        #custom-start-panel {
                            position: absolute;
                            top: 180px;
                            left: 24px;
                            z-index: 1001;
                            width: 340px;
                            pointer-events: auto;
                        }

                        #custom-start-expanded {
                            display: none;
                            position: fixed;
                            margin-top: 8px;
                            padding: 16px;
                            background: var(--glass-surface);
                            backdrop-filter: blur(30px);
                            border: 1px solid var(--glass-border);
                            border-radius: 12px;
                            box-shadow: 0 24px 60px rgba(0,0,0,0.9);
                            overflow-y: auto;
                            max-height: calc(100vh - 200px);
                            width: 340px;
                            z-index: 1002;
                        }

                        .leaflet-popup-content {
                            font-family: 'Manrope', sans-serif !important;
                            margin: 12px !important;
                            min-width: fit-content !important;
                        }

                        .leaflet-popup-content-wrapper {
                            background: var(--glass-surface) !important;
                            backdrop-filter: blur(30px) !important;
                            border: 1px solid var(--glass-border) !important;
                            border-radius: 12px !important;
                            box-shadow: 0 8px 32px rgba(0,0,0,0.9) !important;
                        }

                        .leaflet-popup-tip {
                            background: var(--glass-surface) !important;
                            border: 1px solid var(--glass-border) !important;
                            box-shadow: 0 4px 16px rgba(0,0,0,0.9) !important;
                        }

                        .leaflet-popup-close-button {
                            color: #9ca3af !important;
                            font-size: 18px !important;
                            padding: 4px 8px !important;
                            transition: all 0.2s !important;
                        }

                        .leaflet-container a.leaflet-popup-close-button {
                            right: 5px !important;
                        }

                        .leaflet-popup-close-button:hover {
                            color: white !important;
                            background: transparent !important;
                        }

                        .leaflet-popup {
                            min-width: 180px;
                        }
                    </style>

                    <style>
                        .starting-panel-container {
                            position: relative;
                            width: 100%;
                        }

                        #custom-start-panel {
                            position: absolute;
                            top: 160px;
                            left: 24px;
                            z-index: 999;
                            width: 340px;
                            pointer-events: auto;
                            margin-top: 8px;
                        }

                        body.navigating #custom-start-panel {
                            display: none !important;
                        }

                        .destination-marker {
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: #ef4444;
                            border: 3px solid white;
                            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
                            position: relative;
                        }

                        .destination-marker::after {
                            content: '';
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            width: 8px;
                            height: 8px;
                            background: white;
                            border-radius: 50%;
                        }

                        #custom-start-expanded {
                            display: none;
                            position: absolute;
                            margin-top: 8px;
                            padding: 16px;
                            background: var(--glass-surface);
                            backdrop-filter: blur(30px);
                            border: 1px solid var(--glass-border);
                            border-radius: 12px;
                            box-shadow: 0 24px 60px rgba(0,0,0,0.9);
                            overflow-y: auto;
                            width: 100%;
                            box-sizing: border-box;
                            z-index: 1002;
                            max-height: 270px !important;
                        }

                        #custom-start-expanded {
                            max-height: 400px;
                        }

                        #custom-start-expanded::-webkit-scrollbar {
                            width: 6px !important;
                        }

                        #custom-start-expanded::-webkit-scrollbar-track {
                            background: rgba(255,255,255,0.05) !important;
                            border-radius: 3px !important;
                            margin: 4px 0 !important;
                        }

                        #custom-start-expanded::-webkit-scrollbar-thumb {
                            background: rgba(59, 130, 246, 0.5) !important;
                            border-radius: 3px !important;
                            border: 1px solid rgba(255,255,255,0.1) !important;
                        }

                        #custom-start-expanded::-webkit-scrollbar-thumb:hover {
                            background: rgba(59, 130, 246, 0.7) !important;
                        }

                        #custom-start-search-results {
                            max-height: 150px;
                            overflow-y: auto;
                            margin-top: 8px;
                            display: none;
                            border: 1px solid rgba(255,255,255,0.1);
                            border-radius: 8px;
                            background: rgba(0,0,0,0.3);
                        }

                        #custom-start-search-results::-webkit-scrollbar {
                            width: 4px !important;
                        }

                        #custom-start-search-results::-webkit-scrollbar-track {
                            background: rgba(255,255,255,0.03) !important;
                        }

                        #custom-start-search-results::-webkit-scrollbar-thumb {
                            background: rgba(139, 92, 246, 0.5) !important;
                        }

                        @media (max-width: 775px) {
                            #info-sidebar {
                                width: 92% !important;
                            }
                            body.navigating #info-sidebar {
                                display: none !important;
                            }
                        }

                        @keyframes pulse {
                            0% { transform: scale(1); opacity: 0.3; }
                            50% { transform: scale(1.2); opacity: 0.1; }
                            100% { transform: scale(1); opacity: 0.3; }
                        }

                        .real-time-marker {
                            z-index: 3000 !important;
                        }

                        .click-highlight {
                            animation: highlightPulse 1.5s ease-out;
                        }

                        @keyframes highlightPulse {
                            0% {
                                transform: scale(0.5);
                                opacity: 0.8;
                            }
                            50% {
                                transform: scale(1.2);
                                opacity: 0.4;
                            }
                            100% {
                                transform: scale(1.5);
                                opacity: 0;
                            }
                        }

                        .map-click-mode-active {
                            cursor: crosshair !important;
                        }

                        .map-click-mode-active .leaflet-interactive {
                            cursor: crosshair !important;
                        }

                        .nav-arrow {
                            opacity: 0.7;
                            transition: opacity 0.3s;
                        }

                        .nav-arrow:hover {
                            opacity: 1;
                        }

                        .nav-start-marker {
                            animation: pulseStart 2s infinite;
                        }

                        .nav-end-marker {
                            animation: pulseEnd 2s infinite;
                        }

                        @keyframes pulseStart {
                            0% { transform: scale(1); }
                            50% { transform: scale(1.1); }
                            100% { transform: scale(1); }
                        }

                        @keyframes pulseEnd {
                            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
                            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
                            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
                        }

                        .leaflet-fade-anim .leaflet-tile,
                        .leaflet-zoom-anim .leaflet-zoom-animated {
                            will-change: transform, opacity;
                        }

                        .start-mode-btn.map-active {
                            background: rgba(59, 130, 246, 0.3) !important;
                            border-color: #3b82f6 !important;
                            color: #93c5fd !important;
                            animation: pulseMapMode 2s infinite;
                        }

                        @keyframes pulseMapMode {
                            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
                            70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
                            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
                        }

                        .map-click-mode-active {
                            cursor: crosshair !important;
                        }

                        .map-click-mode-active .leaflet-interactive {
                            cursor: crosshair !important;
                        }

                        .click-highlight {
                            pointer-events: none;
                            z-index: 1000;
                        }

                        .nav-user-marker {
                            animation: navUserPulse 2s infinite;
                        }

                        @keyframes navUserPulse {
                            0% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                            100% { transform: scale(1); }
                        }

                        .nav-arrow-icon {
                            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
                            opacity: 0.9;
                            transition: opacity 0.3s;
                        }

                        .nav-arrow-icon:hover {
                            opacity: 1;
                            transform: scale(1.1);
                        }

                        .location-image-container {
                            position: relative;
                            width: 100%;
                            margin: 1rem 0;
                            border-radius: 12px;
                            overflow: hidden;
                            cursor: pointer;
                        }

                        .main-location-image-wrapper {
                            position: relative;
                            width: 100%;
                            height: 300px;
                            border-radius: 12px;
                            overflow: hidden;
                            transition: transform 0.3s ease;
                        }

                        .main-location-image-wrapper:hover {
                            transform: scale(1.02);
                        }

                        .main-location-image {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        .image-source-badge {
                            position: absolute;
                            bottom: 12px;
                            right: 12px;
                            background: rgba(0, 0, 0, 0.8);
                            color: white;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-size: 0.85rem;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            backdrop-filter: blur(4px);
                        }

                        .modal-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.9);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 999999;
                            padding: 20px;
                            animation: fadeIn 0.3s ease;
                        }

                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }

                        .modal-content {
                            border-radius: 16px;
                            max-width: 1200px;
                            width: 100%;
                            max-height: 90vh;
                            display: flex;
                            flex-direction: column;
                            overflow: hidden;
                            animation: slideUp 0.3s ease;
                        }

                        @keyframes slideUp {
                            from { transform: translateY(20px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }

                        .modal-header {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding: 20px;
                            border-bottom: 1px solid #e5e5e5;
                            background: #f8f9fa;
                        }

                        .modal-title {
                            margin: 0;
                            font-size: 1.5rem;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .gallery-icon {
                            font-size: 1.8rem;
                        }

                        .modal-close, .modal-back {
                            background: none;
                            border: none;
                            font-size: 1.2rem;
                            cursor: pointer;
                            padding: 8px;
                            color: #666;
                            transition: color 0.2s;
                        }

                        .modal-close:hover, .modal-back:hover {
                            color: #333;
                        }

                        .modal-back {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }

                        .image-gallery-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                            gap: 16px;
                            padding: 20px;
                            overflow-y: auto;
                            max-height: 60vh;
                        }

                        .gallery-image-item {
                            position: relative;
                            aspect-ratio: 1;
                            border-radius: 8px;
                            overflow: hidden;
                            cursor: pointer;
                            transition: transform 0.2s;
                        }

                        .gallery-image-item:hover {
                            z-index: 2;
                        }

                        .gallery-image-item img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        .image-source-overlay {
                            position: absolute;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            background: linear-gradient(transparent, rgba(0,0,0,0.8));
                            padding: 8px;
                            color: white;
                            font-size: 0.8rem;
                        }

                        .detail-modal {
                            max-width: 900px;
                        }

                        .detail-image-container {
                            position: relative;
                            min-height: 400px;
                            max-height: 60vh;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #f5f5f5;
                            overflow: hidden;
                        }

                        .detail-image {
                            max-width: 100%;
                            max-height: 100%;
                            object-fit: contain;
                            transition: opacity 0.3s;
                        }

                        .image-loading {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                        }

                        .loading-spinner {
                            width: 40px;
                            height: 40px;
                            border: 3px solid #e5e5e5;
                            border-top-color: #3498db;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                        }

                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }

                        .image-details-panel {
                            padding: 24px;
                            border-top: 1px solid #e5e5e5;
                            overflow-y: auto;
                            max-height: 30vh;
                        }

                        .detail-location-name {
                            margin: 0 0 16px 0;
                            font-size: 1.8rem;
                            color: #2c3e50;
                        }

                        .detail-description {
                            margin-bottom: 20px;
                            line-height: 1.6;
                            color: #555;
                        }

                        .detail-meta {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 20px;
                            margin-bottom: 20px;
                        }

                        .meta-item {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }

                        .meta-label {
                            font-weight: 600;
                            color: #666;
                        }

                        .meta-value {
                            color: #333;
                        }

                        .relevance-badge {
                            padding: 4px 12px;
                            border-radius: 12px;
                            font-size: 0.85rem;
                            font-weight: 600;
                        }

                        .relevance-badge.high {
                            background: #d4edda;
                            color: #155724;
                        }

                        .relevance-badge.medium {
                            background: #fff3cd;
                            color: #856404;
                        }

                        .relevance-badge.low {
                            background: #f8d7da;
                            color: #721c24;
                        }

                        .wikipedia-link {
                            color: #0366d6;
                            text-decoration: none;
                            display: inline-flex;
                            align-items: center;
                            gap: 6px;
                        }

                        .wikipedia-link:hover {
                            text-decoration: underline;
                        }

                        .modal-footer {
                            padding: 16px 20px;
                            border-top: 1px solid #e5e5e5;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: #f8f9fa;
                        }

                        .image-count {
                            margin: 0;
                            color: #666;
                            font-size: 0.95rem;
                        }

                        .btn-primary, .btn-secondary {
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            border: none;
                            font-size: 1rem;
                        }

                        .btn-primary {
                            background: #3498db;
                            color: white;
                        }

                        .btn-primary:hover {
                            background: #2980b9;
                        }

                        .btn-secondary {
                            background: #e5e5e5;
                            color: #333;
                        }

                        .btn-secondary:hover {
                            background: #d5d5d5;
                        }

                        .gallery-actions {
                            display: flex;
                            gap: 12px;
                        }

                        .detail-navigation {
                            padding: 20px;
                            display: flex;
                            justify-content: space-between;
                            gap: 12px;
                            border-top: 1px solid #e5e5e5;
                        }

                        @media (max-width: 768px) {
                            .modal-content {
                                border-radius: 12px 12px 0 0;
                                max-height: 85vh;
                                margin-top: auto;
                                animation: slideUpMobile 0.3s ease;
                            }

                            @keyframes slideUpMobile {
                                from { transform: translateY(100%); }
                                to { transform: translateY(0); }
                            }

                            .image-gallery-grid {
                                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                                gap: 12px;
                                padding: 16px;
                            }

                            .modal-header {
                                padding: 16px;
                            }

                            .modal-title {
                                font-size: 1.3rem;
                            }

                            .detail-image-container {
                                min-height: 300px;
                                max-height: 50vh;
                            }

                            .image-details-panel {
                                padding: 16px;
                                max-height: 40vh;
                            }

                            .detail-location-name {
                                font-size: 1.5rem;
                            }

                            .detail-meta {
                                flex-direction: column;
                                gap: 12px;
                            }

                            .detail-navigation {
                                flex-direction: column;
                                gap: 12px;
                            }

                            .btn-primary, .btn-secondary {
                                width: 100%;
                            }
                        }

                        @media (max-width: 480px) {
                            .main-location-image-wrapper {
                                height: 200px;
                            }

                            .image-gallery-grid {
                                grid-template-columns: repeat(2, 1fr);
                                gap: 8px;
                            }

                            .modal-header {
                                padding: 12px;
                            }

                            .modal-title {
                                font-size: 1.1rem;
                            }
                        }

                        .image-loading-skeleton {
                            width: 100%;
                            height: 300px;
                            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                            background-size: 200% 100%;
                            animation: loading 1.5s infinite;
                            border-radius: 12px;
                        }

                        @keyframes loading {
                            0% { background-position: 200% 0; }
                            100% { background-position: -200% 0; }
                        }

                        .iconify {
                            display: inline-block;
                            vertical-align: middle;
                        }

                        .image-source-badge .iconify {
                            margin-right: 6px;
                            font-size: 16px;
                        }

                        .wikipedia-link .iconify {
                            margin-right: 8px;
                            font-size: 18px;
                        }

                        @media (max-width: 768px) {
                            .iconify {
                                font-size: 90%;
                            }
                        }
                    </style>
                    <style>

                        .modal-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 999999;
                            animation: fadeIn 0.3s ease;
                            backdrop-filter: blur(10px);
                        }

                        .modal-overlay.fade-out {
                            animation: fadeOut 0.3s ease forwards;
                        }

                        @keyframes fadeOut {
                            from { opacity: 1; }
                            to { opacity: 0; }
                        }

                        .modal-content {
                            background: rgba(10, 10, 10, 0.2);
                            backdrop-filter: blur(30px);
                            border: 1px solid var(--glass-border);
                            border-radius: 12px;
                            box-shadow: 0 24px 60px rgba(0,0,0,0.06);
                            width: 90vw;
                            max-width: 1000px;
                            height: fit-content;
                            max-height: 570px;
                            display: flex;
                            flex-direction: column;
                            overflow: hidden;
                            animation: slideUp 0.3s ease;
                        }

                        .modal-content.slide-down {
                            animation: slideDown 0.3s ease forwards;
                        }

                        @keyframes slideDown {
                            from { transform: translateY(0); opacity: 1; }
                            to { transform: translateY(20px); opacity: 0; }
                        }

                        .modal-header {
                            padding: 16px 20px;
                            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                            background: rgba(10, 10, 10, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            flex-shrink: 0;
                        }

                        .modal-header h2 {
                            margin: 0;
                            font-size: 18px;
                            font-weight: 700;
                            color: #fff;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .modal-scrollable-content {
                            flex: 1;
                            overflow-y: auto;
                            display: flex;
                            flex-direction: column;
                            max-height: fit-content;
                        }

                        .modal-scrollable-content::-webkit-scrollbar { width: 4px; }
                        .modal-scrollable-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
                        .modal-scrollable-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

                        .image-section {
                            padding: 20px;
                            background: rgba(10, 10, 10, 0.2);
                            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                            flex-shrink: 0;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            min-height: 300px;
                            max-height: fit-content;
                            overflow: hidden;
                        }

                        .detail-image {
                            max-width: 100%;
                            max-height: fit-content;
                            width: auto;
                            height: auto;
                            object-fit: contain;
                            border-radius: 8px;
                            display: block;
                            opacity: 0;
                            transition: opacity 0.3s ease;
                        }

                        .detail-image.loaded {
                            opacity: 1;
                        }

                        .image-loading {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            z-index: 1;
                        }

                        .loading-spinner {
                            width: 30px;
                            height: 30px;
                            border: 2px solid rgba(255, 255, 255, 0.1);
                            border-top-color: #3b82f6;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                        }

                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }

                        .content-section {
                            padding: 20px;
                            flex: 1;
                        }

                        .detail-location-name {
                            margin: 0 0 16px 0;
                            font-size: 20px;
                            font-weight: 800;
                            color: white;
                        }

                        .detail-description-section {
                            margin-bottom: 24px;
                        }

                        .detail-description-label {
                            font-size: 10px;
                            font-weight: 700;
                            color: rgba(255, 255, 255, 0.5);
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 8px;
                        }

                        .detail-description {
                            line-height: 1.6;
                            color: rgba(255, 255, 255, 0.8);
                            font-size: 13px;
                            white-space: pre-line;
                            max-height: none;
                            overflow: visible;
                        }

                        .metadata-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 12px;
                            margin-bottom: 20px;
                        }

                        .metadata-item {
                            background: rgba(255, 255, 255, 0.03);
                            border: 1px solid rgba(255, 255, 255, 0.05);
                            border-radius: 8px;
                            padding: 12px;
                            transition: background-color 0.2s;
                        }

                        .metadata-label {
                            font-size: 9px;
                            font-weight: 700;
                            color: rgba(255, 255, 255, 0.5);
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        }

                        .metadata-value {
                            font-size: 12px;
                            font-weight: 600;
                            color: white;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }

                        .wikipedia-link {
                            color: #60a5fa;
                            text-decoration: none;
                            display: inline-flex;
                            align-items: center;
                            gap: 6px;
                            padding: 6px 10px;
                            background: rgba(96, 165, 250, 0.1);
                            border-radius: 6px;
                            border: 1px solid rgba(96, 165, 250, 0.2);
                            font-size: 11px;
                            font-weight: 600;
                            transition: background-color 0.2s;
                        }

                        .wikipedia-link:hover {
                            background: rgba(96, 165, 250, 0.2);
                            text-decoration: none;
                        }

                        .relevance-badge {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 9px;
                            font-weight: 700;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }

                        .relevance-badge.high {
                            background: rgba(34, 197, 94, 0.2);
                            color: #4ade80;
                            border: 1px solid rgba(34, 197, 94, 0.3);
                        }

                        .relevance-badge.medium {
                            background: rgba(234, 179, 8, 0.2);
                            color: #fbbf24;
                            border: 1px solid rgba(234, 179, 8, 0.3);
                        }

                        .relevance-badge.low {
                            background: rgba(239, 68, 68, 0.2);
                            color: #f87171;
                            border: 1px solid rgba(239, 68, 68, 0.3);
                        }

                        .modal-footer {
                            padding: 16px 20px;
                            border-top: 1px solid rgba(255, 255, 255, 0.08);
                            background: rgba(10, 10, 10, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            flex-shrink: 0;
                        }

                        .image-count {
                            font-size: 11px;
                            font-weight: 600;
                            color: rgba(255, 255, 255, 0.7);
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        }

                        .nav-button {
                            padding: 8px 16px;
                            border-radius: 8px;
                            font-size: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            background: rgba(255, 255, 255, 0.05);
                            color: rgba(255, 255, 255, 0.9);
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            transition: all 0.2s;
                            text-transform: none;
                        }

                        .nav-button:disabled {
                            opacity: 0.3;
                            cursor: not-allowed;
                        }

                        .nav-button .iconify {
                            font-size: 14px;
                        }

                        .image-gallery-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                            gap: 16px;
                            padding: 20px;
                        }

                        .gallery-image-item {
                            background: rgba(255, 255, 255, 0.03);
                            border: 1px solid rgba(255, 255, 255, 0.05);
                            border-radius: 16px;
                            overflow: hidden;
                            cursor: pointer;
                            transition: background-color 0.2s;
                            position: relative;
                            aspect-ratio: 1 / 1;
                            display: flex;
                            flex-direction: column;
                        }

                        .gallery-image-item:hover {
                            background: rgba(255, 255, 255, 0.05);
                            border-color: rgba(255, 255, 255, 0.1);
                        }

                        .gallery-image-item img {
                            width: 100%;
                            height: 180px;
                            object-fit: cover;
                            border-radius: 0;
                        }

                        .gallery-image-source {
                            padding: 8px;
                            font-size: 10px;
                            color: rgba(255, 255, 255, 0.7);
                            display: flex;
                            align-items: center;
                            gap: 4px;
                            border-top: 1px solid rgba(255, 255, 255, 0.05);
                        }

                        @media (max-width: 768px) {
                            .modal-content {
                                width: 95vw;
                                height: 95vh;
                            }

                            .image-section {
                                min-height: 200px;
                                max-height: fit-content;
                            }

                            .image-gallery-grid {
                                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                                gap: 12px;
                                padding: 16px;
                            }

                            .gallery-image-item img {
                                height: 150px;
                            }
                        }

                        .image-gallery-grid::-webkit-scrollbar { width: 4px; }
                        .image-gallery-grid::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
                        .image-gallery-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

                        #share-btn, #copy-dest-btn {
                            position: relative;
                            transition: all 0.2s var(--ease-pro);
                        }

                        #share-btn:hover, #copy-dest-btn:hover {
                            background: rgba(255,255,255,0.1);
                            transform: scale(1.05);
                        }

                        #share-btn:active, #copy-dest-btn:active {
                            transform: scale(0.95);
                        }
                    </style>
                </head>
                <body class="bg-black">

                    <div id="loader">
                        <svg viewBox="0 0 76 65" fill="white" class="w-12 h-12 mb-4 animate-pulse"><path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path></svg>
                        <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-[0.5em]">Strike Maps [V7] | Built by msentimental</div>
                        <div class="loading-bar"><div class="loading-fill"></div></div>
                    </div>

                    <div id="map"></div>

                    <div id="standard-ui" class="absolute top-6 left-6 z-[1000] w-[340px] flex flex-col gap-3">
                        <div class="strike-glass p-2 ui-animate">
                            <div class="relative group">
                                <iconify-icon icon="lucide:search" class="absolute left-3 top-2.5 text-neutral-500"></iconify-icon>
                                <input type="text" id="search-input" placeholder="Search destination..." class="w-full h-10 pl-10 pr-4 rounded-xl text-xs font-bold strike-input">
                                <div id="search-spinner" class="hidden absolute right-3 top-3"><iconify-icon icon="lucide:loader-2" class="animate-spin text-white"></iconify-icon></div>
                            </div>
                            <div id="filters" class="hidden mt-2 flex gap-1 flex-wrap">
                                <button class="filter-btn active" data-filter="all">All</button>
                                <button class="filter-btn" data-filter="nearby">Near Me</button>
                                <button class="filter-btn" data-filter="hotels">Hotels</button>
                                <button class="filter-btn" data-filter="parks">Parks</button>
                                <button class="filter-btn" data-filter="restaurants">Restaurants</button>
                                <button class="filter-btn" data-filter="gas">Gas Stations</button>
                            </div>
                            <div id="results" class="hidden mt-2 flex flex-col"></div>
                        </div>
                        <div class="strike-glass px-4 py-3 flex items-center justify-between ui-animate">
                            <div class="flex flex-col">
                                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-tight">Your Location</span>
                                <span id="status-text" class="text-[11px] font-bold text-white">Standby</span>
                            </div>
                            <button id="locate-btn" class="h-8 px-4 bg-white text-black rounded-lg text-[11px] font-extrabold flex items-center gap-2 hover:bg-neutral-100 transition-all">
                            <iconify-icon icon="lucide:crosshair"></iconify-icon> Re-Center
                            </button>
                        </div>

                    </div>

                    <div id="custom-start-panel" class="strike-glass ui-animate">
                        <div class="starting-panel-container">
                            <button id="custom-start-toggle" class="w-full">
                            <div class="flex justify-between items-center w-full">
                                <span>Starting Point: <span id="current-start-mode">Current Location</span></span>
                                <iconify-icon icon="lucide:chevron-down"></iconify-icon>
                            </div>
                            </button>
                            <div id="custom-start-expanded">
                                <div class="space-y-2">
                                    <button class="start-mode-btn active" data-mode="current">
                                    <iconify-icon icon="lucide:crosshair"></iconify-icon>
                                    Use Current Location
                                    </button>
                                    <button class="start-mode-btn" data-mode="map">
                                    <iconify-icon icon="lucide:map-pin"></iconify-icon>
                                    Click on Map
                                    </button>
                                    <button class="start-mode-btn" data-mode="search">
                                    <iconify-icon icon="lucide:search"></iconify-icon>
                                    Search for Location
                                    </button>
                                </div>

                                <div id="custom-start-input-container">
                                    <div class="relative mt-3">
                                        <iconify-icon icon="lucide:search" class="absolute left-3 top-2.5 text-neutral-500"></iconify-icon>
                                        <input type="text" id="custom-start-input" placeholder="Enter starting address or city..." class="w-full h-10 pl-10 pr-4 rounded-xl text-xs font-bold strike-input">
                                    </div>
                                    <div id="custom-start-search-results" class="flex flex-col"></div>
                                </div>

                                <div id="current-start-display" class="current-start-display mt-3">
                                    <div class="font-semibold text-white">Current start point:</div>
                                    <div class="text-[9px] mt-1" id="start-point-coords">Your current location</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="active-nav-hud" class="absolute top-6 left-6 z-[2000] w-[340px] flex flex-col gap-3">
                        <div class="strike-glass p-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center">
                                    <iconify-icon id="nav-step-icon" icon="lucide:navigation" class="text-2xl text-emerald-400"></iconify-icon>
                                </div>
                                <div class="flex-1">
                                    <span id="nav-dist-next" class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1">In 200m</span>
                                    <h3 id="nav-instruction" class="nav-instruction-text font-bold text-white leading-tight">Continue straight for 1.2 kilometers on Main Street</h3>
                                    <div class="progress-bar">
                                        <div id="step-progress" class="progress-fill" style="width: 30%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-white/5">
                                <div class="flex justify-between text-[11px]">
                                    <div>
                                        <div class="text-neutral-500 mb-1">Next Turn</div>
                                        <div id="nav-next-turn" class="text-white font-semibold">Right onto Broadway</div>
                                    </div>
                                    <div>
                                        <div class="text-neutral-500 mb-1">ETA</div>
                                        <div id="nav-eta" class="text-emerald-400 font-bold">14:30</div>
                                    </div>
                                    <div>
                                        <div class="text-neutral-500 mb-1">Remaining</div>
                                        <div id="nav-remaining" class="text-white font-bold">4.2 km</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button id="exit-nav-btn" class="w-full h-10 bg-red-500/25 border border-red-500/50 text-white rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-red-500 transition-all duration-200">
                        <iconify-icon icon="lucide:x-circle"></iconify-icon> Exit Navigation
                        </button>
                    </div>

                    <div id="info-sidebar" class="strike-glass">
                        <div class="p-6 border-b border-white/5 flex items-center justify-between">
                            <h2 id="side-title" class="text-xl font-bold text-white truncate pr-4">Location</h2>
                            <button onclick="closeSidebar()" class="text-neutral-500 hover:text-white"><iconify-icon icon="lucide:x" class="text-xl"></iconify-icon></button>
                        </div>
                        <div id="sidebar-content" class="p-6 flex-1 overflow-y-auto">
                        </div>
                        <div class="p-6 bg-white/[0.02] border-t border-white/5 flex gap-2">
                            <button id="start-nav-btn" class="hidden flex-1 h-12 bg-white text-black rounded-xl text-xs font-black flex items-center justify-center gap-3">
                            <iconify-icon icon="lucide:navigation-2" class="text-lg"></iconify-icon> START
                            </button>
                            <button id="sidebar-share-btn" class="hidden flex-1 h-12 bg-white/5 text-white rounded-xl text-xs font-black flex items-center justify-center gap-3 hover:bg-white/10 transition-all">
                                <iconify-icon icon="lucide:share-2" class="text-lg"></iconify-icon> SHARE
                            </button>
                        </div>
                    </div>

                    <div class="absolute bottom-6 right-6 z-[1000] flex flex-col gap-3 ui-animate">
                        <div class="strike-glass p-1 flex flex-col gap-1 mt-2">
                            <button id="copy-dest-btn" class="w-10 h-10 flex items-center justify-center rounded-xl text-neutral-400 hover:text-white transition-all" title="Copy last viewed destination link">
                            <iconify-icon icon="lucide:link-2" class="text-lg"></iconify-icon>
                            </button>
                        </div>
                        <div class="strike-glass p-1 flex flex-col gap-1">
                            <button id="sat-toggle" class="w-10 h-10 flex items-center justify-center rounded-xl text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:layers" class="text-lg"></iconify-icon></button>
                        </div>
                        <div class="strike-glass p-1 flex flex-col gap-1">
                            <button id="zoom-in" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:plus"></iconify-icon></button>
                            <button id="zoom-out" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:minus"></iconify-icon></button>
                        </div>
                    </div>

                    <div class="absolute bottom-6 left-6 z-[1000] pointer-events-none flex flex-col gap-4 ui-animate">
                        <div class="strike-glass px-4 py-3 flex gap-6 items-center pointer-events-auto"style="max-width: fit-content;">
                            <div class="flex flex-col">
                                <span id="hud-coords" class="nav-hud-pos text-[10px] font-mono text-white mt-1">0.0, 0.0</span>
                                <span id="hud-eta" class="nav-hud-eta text-[10px] font-mono text-emerald-400 mt-1">--:--</span>
                            </div>
                            <div class="flex flex-col">
                                <span id="hud-precision" class="nav-hud-acc text-[10px] font-mono text-white mt-1">-- m</span>
                                <span id="hud-remaining" class="nav-hud-distance text-[10px] font-mono text-white mt-1">-- km</span>
                            </div>
                        </div>
                        <div class="opacity-40 text-[10px] font-black uppercase tracking-widest text-white flex items-center gap-2">
                            <svg width="12" height="12" viewBox="0 0 76 65" fill="white">
                            <path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path>
                            </svg>

                            <span>Strike Maps [V7]</span>

                            <span class="opacity-60"></span>

                            <a
                            href="https://www.openstreetmap.org/copyright"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="hover:opacity-80"
                            style="z-index: 999999;"
                            >
                             OpenStreetMap contributors
                            </a>
                        </div>

                    </div>

                    <script>
                        let map = null;
                        let darkBase = null;
                        let satLayer = null;
                        let userIcon = null;
                        let userMarker = null;
                        let routeLayer = null;
                        let userPos = null;
                        let selectedTarget = null;
                        let currentRoute = null;
                        let currentNavRoute = null;
                        let currentStepIndex = 0;
                        let searchResults = [];
                        let activeFilter = 'all';
                        let isNavigating = false;
                        let recentSearches = [];

                        try {
                            const storedSearches = localStorage.getItem('strikeRecentSearches');
                            if (storedSearches) {
                                recentSearches = JSON.parse(storedSearches);
                                if (!Array.isArray(recentSearches)) {
                                    recentSearches = [];
                                    localStorage.removeItem('strikeRecentSearches');
                                }
                            }
                        } catch (error) {
                        recentSearches = [];
                        localStorage.removeItem('strikeRecentSearches');
                    }

                    let watchId = null;
                    let totalRouteDistance = 0;
                    let remainingDistance = 0;
                    let gpsWatchInterval = null;
                    let isLocationRequested = false;
                    let routeStartTime = null;

                    let customStartMode = 'current';
                    let customStartPos = null;
                    let customStartMarker = null;
                    let destinationMarker = null;
                    let previousRouteCoordinates = null;

                    let allRouteLayers = [];
                    let allNavigationLayers = [];
                    let allMarkers = [];

                    let isOnline = navigator.onLine;
                    let offlineModeEnabled = false;

                    function initializeLeafletObjects() {
                                        if (typeof L === 'undefined') {
                                                            console.warn('Leaflet not loaded - likely offline');
                                                            return false;
                                        }
                                        
                                        try {
                                                            userIcon = L.divIcon({
                                                                                className: 'user-location-marker',
                                                                                html: '<div class="gps-ring"></div>',
                                                                                iconSize: [24, 24],
                                                                                iconAnchor: [12, 12]
                                                            });
                                                            
                                                            userMarker = L.marker([0,0], {icon: userIcon});
                                                            routeLayer = L.layerGroup();
                                                            
                                                            customStartMarker = L.marker([0,0], {
                                                                                icon: L.divIcon({
                                                                                                    className: 'custom-start-marker',
                                                                                                    html: '<div style="background: #f59e0b; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(245,158,11,0.5);"></div>',
                                                                                                    iconSize: [22, 22],
                                                                                                    iconAnchor: [11, 11]
                                                                                })
                                                            });
                                                            
                                                            destinationMarker = L.marker([0,0], {
                                                                                icon: L.divIcon({
                                                                                                    className: 'destination-marker',
                                                                                                    html: '<div style="background: #ef4444; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(239,68,68,0.5); position: relative;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: white; border-radius: 50%;"></div></div>',
                                                                                                    iconSize: [22, 22],
                                                                                                    iconAnchor: [11, 11]
                                                                                }),
                                                                                zIndexOffset: 1000
                                                            });
                                                            
                                                            return true;
                                        } catch (error) {
                                                            console.error('Failed to initialize Leaflet objects:', error);
                                                            return false;
                                        }
                    }

                    function initConnectivityDetection() {
                                        window.addEventListener('online', () => {
                                                            isOnline = true;
                                                            hideOfflineOverlay();
                                                            document.getElementById('info-sidebar').classList.remove('active');
                                                            document.getElementById('sidebar-share-btn').classList.add('hidden');
                                                            showToast('Internet connection restored', 3000);
                                                            if (selectedTarget) {
                                                                                calculateRoutes(getCurrentStartPoint(), selectedTarget);
                                                            }
                                        });
                                        
                                        window.addEventListener('offline', () => {
                                                            isOnline = false;
                                                            showOfflineOverlay();
                                                            showToast('Failed to load - no internet connection', 4000);
                                                            console.warn('User does not have any internet connection.');
                                        });
                                        
                                        if (!navigator.onLine) {
                                                            setTimeout(() => {
                                                                                showOfflineOverlay();
                                                            }, 1000);
                                        }
                    }

                    function showOfflineOverlay() {
                        const loader = document.getElementById('loader');
                        if (!loader) return;

                        if (loader) {
                            loader.style.opacity = '0';
                            loader.style.display = 'none';
                        }
                        
                        const originalContent = loader.querySelectorAll('svg, div.text-\\[9px\\], div.loading-bar');
                        originalContent.forEach(el => el.style.display = 'none');
                        
                        const standardUI = document.getElementById('standard-ui');
                        const mapPage = document.getElementById('map');
                        const infoSidebarElement = document.getElementById('info-sidebar');
                        const custmSt = document.getElementById('custom-start-panel');
                        if (standardUI) {
                            standardUI.style.opacity = '0.5';
                            standardUI.style.pointerEvents = 'none';
                        }
                        if (custmSt) {
                            custmSt.style.opacity = '0.5';
                            custmSt.style.pointerEvents = 'none';
                        }
                        if (mapPage) {
                            mapPage.style.pointerEvents = 'none';
                        }
                        if (infoSidebarElement) {
                            infoSidebarElement.style.opacity = '0.5';
                            infoSidebarElement.style.pointerEvents = 'none';
                        }
                        document.querySelectorAll('.bottom-6.right-6 .strike-glass, .bottom-6.left-6 .strike-glass').forEach(el => {
                            el.style.opacity = '0.5';
                            el.style.pointerEvents = 'none';
                        });
                        document.querySelectorAll('.destination-marker').forEach(el => {
                            el.style.pointerEvents = 'none';
                            el.style.cursor = 'none';
                        });
                        document.querySelectorAll('.user-location-marker').forEach(el => {
                            el.style.pointerEvents = 'none';
                            el.style.cursor = 'none';
                        });
                        
                        disableOnlineFeatures();
                    }

                    function hideOfflineOverlay() {
                        const loader = document.getElementById('loader');
                        if (!loader) return;
                        
                        if (navigator.onLine) {
                            loader.classList.remove('offline-mode');
                            
                            const offlineUI = loader.querySelector('.offline-ui');
                            if (offlineUI) {
                                offlineUI.remove();
                            }
                            
                            const originalContent = loader.querySelectorAll('svg, div.text-\\[9px\\], div.loading-bar');
                            originalContent.forEach(el => el.style.display = '');
                            
                            loader.style.opacity = '0';
                            setTimeout(() => {
                                if (navigator.onLine) {
                                    loader.style.display = 'none';
                                    document.body.classList.add('ui-ready');
                                }
                            }, 500);

                            document.querySelectorAll('.bottom-6.right-6 .strike-glass, .bottom-6.left-6 .strike-glass').forEach(el => {
                                el.style.opacity = '1';
                                el.style.pointerEvents = 'auto';
                            });
                            document.querySelectorAll('.destination-marker').forEach(el => {
                                el.style.cursor = 'pointer';
                                el.style.pointerEvents = 'auto';
                            });
                            document.querySelectorAll('.user-location-marker').forEach(el => {
                                el.style.cursor = 'pointer';
                                el.style.pointerEvents = 'auto';
                            });
                            
                            document.getElementById('standard-ui').style.opacity = '1';
                            document.getElementById('standard-ui').style.pointerEvents = 'auto';
                            document.getElementById('custom-start-panel').style.opacity = '1';
                            document.getElementById('custom-start-panel').style.pointerEvents = 'auto';
                            document.getElementById('map').style.pointerEvents = 'auto';
                            document.getElementById('info-sidebar').style.opacity = '1';
                            document.getElementById('info-sidebar').style.pointerEvents = 'auto';
                            
                            enableOnlineFeatures();
                        }
                    }

                    window.retryConnection = function() {
                                        const loader = document.getElementById('loader');
                                        if (!loader) return;
                                        
                                        const button = loader.querySelector('button:first-child');
                                        if (button) {
                                                            const originalHTML = button.innerHTML;
                                                            button.innerHTML = '<iconify-icon icon="lucide:loader-2" class="text-lg animate-spin"></iconify-icon> Checking...';
                                                            button.disabled = true;
                                                            
                                                            fetch('https://www.google.com/favicon.ico', { 
                                                                                mode: 'no-cors',
                                                                                cache: 'no-store',
                                                                                timeout: 5000 
                                                            })
                                                            .then(() => {
                                                                                if (navigator.onLine) {
                                                                                                    hideOfflineOverlay();
                                                                                } else {
                                                                                                    throw new Error('Fetch failed - you are still offline');
                                                                                }
                                                            })
                                                            .catch(() => {
                                                                                button.innerHTML = originalHTML;
                                                                                button.disabled = false;
                                                                                showToast('Failed to load - you are still offline', 3000);
                                                                                
                                                                                const icon = loader.querySelector('iconify-icon[icon="lucide:wifi-off"]');
                                                                                if (icon) {
                                                                                                    icon.classList.add('text-red-300');
                                                                                                    setTimeout(() => icon.classList.remove('text-red-300'), 500);
                                                                                }
                                                            });
                                        }
                    };

                    window.enableOfflineMode = function() {
                                        offlineModeEnabled = true;
                                        hideOfflineOverlay();
                                        
                                        showToast('Offline mode enabled - Limited functionality', 5000);
                                        
                                        const offlineBadge = document.createElement('div');
                                        offlineBadge.id = 'offline-badge';
                                        offlineBadge.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999] bg-red-500/90 backdrop-blur px-4 py-2 rounded-full flex items-center gap-2 text-xs font-bold text-white border border-red-400/50';
                                        offlineBadge.innerHTML = `
                                                            <iconify-icon icon="lucide:wifi-off" class="text-sm"></iconify-icon>
                                                            OFFLINE MODE
                                                            <button onclick="disableOfflineMode()" class="ml-2 text-white/70 hover:text-white">
                                                                                <iconify-icon icon="lucide:x" class="text-sm"></iconify-icon>
                                                            </button>
                                        `;
                                        document.body.appendChild(offlineBadge);
                                        
                                        enableOfflineFeatures();
                    };

                    window.disableOfflineMode = function() {
                                        offlineModeEnabled = false;
                                        const badge = document.getElementById('offline-badge');
                                        if (badge) badge.remove();
                                        
                                        if (navigator.onLine) {
                                                            showToast('Online mode restored', 3000);
                                                            enableOnlineFeatures();
                                        } else {
                                                            showOfflineOverlay();
                                        }
                    };

                    function disableOnlineFeatures() {
                                        const searchInput = document.getElementById('search-input');
                                        if (searchInput) {
                                                            searchInput.disabled = true;
                                                            searchInput.placeholder = 'Search unavailable (offline)';
                                        }
                                        
                                        const customStartInput = document.getElementById('custom-start-input');
                                        if (customStartInput) {
                                                            customStartInput.disabled = true;
                                                            customStartInput.placeholder = 'Search unavailable (offline)';
                                        }
                                        
                                        window.calculateRoutes = function() {
                                                            showToast('Failed to calculate - route calculation requires internet', 3000);
                                                            return;
                                        };
                    }

                    function enableOnlineFeatures() {
                                        const searchInput = document.getElementById('search-input');
                                        if (searchInput) {
                                                            searchInput.disabled = false;
                                                            searchInput.placeholder = 'Search destination...';
                                        }
                                        
                                        const customStartInput = document.getElementById('custom-start-input');
                                        if (customStartInput) {
                                                            customStartInput.disabled = false;
                                                            customStartInput.placeholder = 'Enter starting address or city...';
                                        }
                    }

                    function enableOfflineFeatures() {
                                        console.log('Offline mode enabled - Limited functionality');
                    }

                    function checkConnectivityBeforeLoad() {
                                        if (!navigator.onLine) {
                                                            const loader = document.getElementById('loader');
                                                            if (loader) {
                                                                                showOfflineOverlay();
                                                            }
                                                            return false;
                                        }
                                        return true;
                    }

                    const offlineStyles = `
                                        @keyframes pulse-offline {
                                                            0%, 100% { opacity: 1; }
                                                            50% { opacity: 0.8; }
                                        }

                                        #offline-badge {
                                                            animation: pulse-offline 2s infinite;
                                                            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
                                        }

                                        #offline-badge:hover {
                                                            animation: none;
                                        }
                    `;

                    const offlineStyleSheet = document.createElement('style');
                    offlineStyleSheet.textContent = offlineStyles;
                    document.head.appendChild(offlineStyleSheet);

                    function createStraightPath(start, end) {
                        return {
                            type: "LineString",
                            coordinates: [
                            [start[1], start[0]],
                            [end[1], end[0]]
                            ]
                        };
                    }

                    async function getRealWeatherAtLocation(lat, lng) {
                        try {
                            const response = await fetch(
                            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,wind_speed_10m,precipitation,weather_code&timezone=auto`
                            );
                            const data = await response.json();

                            if (data.current) {
                                const weatherCode = data.current.weather_code;
                                let conditions = "Clear";
                                if (weatherCode > 0 && weatherCode < 50) conditions = "Cloudy";
                                if (weatherCode >= 50 && weatherCode < 70) conditions = "Rainy";
                                if (weatherCode >= 70) conditions = "Snowy";

                                return {
                                    temperature: data.current.temperature_2m,
                                    windSpeed: data.current.wind_speed_10m,
                                    precipitation: data.current.precipitation,
                                    conditions: conditions,
                                    weatherCode: weatherCode
                                };
                            }
                        } catch (error) {}
                        return null;
                    }

                    async function getRealTimeTraffic(start, end) {
                        try {
                            const response = await fetch(
                            `https://api.openrouteservice.org/v2/directions/driving-car?api_key=YOUR_API_KEY&start=${start[1]},${start[0]}&end=${end[1]},${end[0]}`
                            );
                            const data = await response.json();

                            if (data.features && data.features[0].properties.segments) {
                                const segments = data.features[0].properties.segments;
                                let totalCongestion = 0;

                                segments.forEach(segment => {
                                    if (segment.steps) {
                                        segment.steps.forEach(step => {
                                            if (step.way_points && step.way_points.length > 0) {
                                                totalCongestion += step.duration || 0;
                                            }
                                        });
                                    }
                                });

                                const avgSpeed = (route.distance / route.duration) * 3.6;
                                if (avgSpeed < 20) return 'high';
                                if (avgSpeed < 40) return 'medium';
                                return 'low';
                            }
                        } catch (error) {
                        console.log("Real-time traffic unavailable, using simulated");
                    }

                    const now = new Date();
                    const hour = now.getHours();
                    const isRushHour = (hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 18);
                    const isWeekend = now.getDay() === 0 || now.getDay() === 6;

                    if (isRushHour && !isWeekend) {
                        return Math.random() > 0.3 ? 'high' : 'medium';
                    }

                    const rand = Math.random();
                    if (rand > 0.8) return 'high';
                    if (rand > 0.5) return 'medium';
                    return 'low';
                }

                async function getRealTrafficEstimate(start, end) {
                    try {
                        const response = await fetch(
                        `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=false&alternatives=false&steps=true`
                        );
                        const data = await response.json();

                        if (data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const now = new Date();
                            const hour = now.getHours();
                            const day = now.getDay();

                            let trafficFactor = 1.0;

                            const isWeekday = day >= 1 && day <= 5;
                            const isWeekend = day === 0 || day === 6;

                            if (isWeekday) {
                                if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                                    trafficFactor = 1.4;
                                } else if ((hour >= 12 && hour <= 14)) {
                                trafficFactor = 1.2;
                            }
                        } else if (isWeekend) {
                        if ((hour >= 10 && hour <= 16)) {
                            trafficFactor = 1.2;
                        }
                    }

                    const weather = await getRealWeatherAtLocation(start[0], start[1]);
                    if (weather?.conditions === "Rainy") trafficFactor *= 1.3;
                    if (weather?.conditions === "Snowy") trafficFactor *= 1.6;
                    if (weather?.conditions === "Foggy") trafficFactor *= 1.2;

                    const steps = route.legs?.[0]?.steps || [];
                    let highwayPercent = 0;
                    let cityStreetPercent = 0;

                    steps.forEach(step => {
                        if (step.name?.toLowerCase().includes('highway') ||
                        step.name?.toLowerCase().includes('freeway') ||
                        step.name?.toLowerCase().includes('interstate')) {
                            highwayPercent += step.distance / route.distance;
                        } else {
                        cityStreetPercent += step.distance / route.distance;
                    }
                });

                if (cityStreetPercent > 0.7) {
                    trafficFactor *= 1.2;
                }

                const intersections = steps.filter(step =>
                step.maneuver?.type.includes('turn') ||
                step.maneuver?.type.includes('roundabout') ||
                step.maneuver?.type === 'new name'
                ).length;

                if (intersections > route.distance / 1000) {
                    trafficFactor *= 1.1;
                }

                return {
                    duration: route.duration * trafficFactor,
                    trafficLevel: trafficFactor > 1.35 ? 'high' : trafficFactor > 1.15 ? 'medium' : 'low',
                    intersections: intersections,
                    weatherImpact: weather?.conditions || "Clear",
                    highwayPercent: highwayPercent,
                    estimatedSpeed: (route.distance / (route.duration * trafficFactor)) * 3.6
                };
            }
        } catch (error) {
        console.error("Traffic estimate failed:", error);
    }

    const distance = map.distance(start, end);
    const baseTime = (distance / 50000) * 3600;

    const now = new Date();
    const hour = now.getHours();
    let trafficFactor = 1.0;

    if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
        trafficFactor = 1.4;
    } else if (hour >= 12 && hour <= 14) {
    trafficFactor = 1.2;
}

return {
    duration: baseTime * trafficFactor,
    trafficLevel: trafficFactor > 1.35 ? 'high' : trafficFactor > 1.15 ? 'medium' : 'low',
    intersections: 0,
    weatherImpact: "Unknown",
    estimatedSpeed: 50 / trafficFactor
};
}

async function getAllAirports() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat');
        const data = await response.text();

        const airports = [];
        const lines = data.split('\n');

        for (const line of lines) {
            if (!line.trim()) continue;

            const fields = line.split(',');
            if (fields.length >= 14) {
                const name = fields[1].replace(/"/g, '');
                const city = fields[2].replace(/"/g, '');
                const country = fields[3].replace(/"/g, '');
                const iata = fields[4].replace(/"/g, '');
                const icao = fields[5].replace(/"/g, '');
                const lat = parseFloat(fields[6]);
                const lng = parseFloat(fields[7]);

                if (iata && iata.length === 3 &&
                !isNaN(lat) && !isNaN(lng) &&
                !name.toLowerCase().includes('seaplane') &&
                !name.toLowerCase().includes('heliport') &&
                !name.toLowerCase().includes('airfield') &&
                !name.toLowerCase().includes('municipal') &&
                !name.toLowerCase().includes('regional') &&
                !name.toLowerCase().includes('executive') &&
                (name.toLowerCase().includes('international') ||
                icao.length === 4)) {

                    airports.push({
                        code: iata,
                        name: name,
                        city: city,
                        country: country,
                        coordinates: [lat, lng],
                        type: name.includes('International') ? 'large' : 'medium'
                    });
                }
            }
        }

        return airports;

    } catch (error) {
    return getCommercialAirports();
}
}

async function getFerryRoutes(start, end) {
    try {
        const [startLng, startLat] = [start[1], start[0]];
        const [endLng, endLat] = [end[1], end[0]];

        const bbox = [
        Math.min(startLat, endLat) - 0.5,
        Math.min(startLng, endLng) - 0.5,
        Math.max(startLat, endLat) + 0.5,
        Math.max(startLng, endLng) + 0.5
        ].join(',');

        const query = `
        [out:json][timeout:10];
        (
        way["route"="ferry"](${bbox});
        relation["route"="ferry"](${bbox});
        node["amenity"="ferry_terminal"](${bbox});
        );
        out body;
        `;

        const response = await fetch(
        `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`
        );
        const data = await response.json();

        if (data.elements && data.elements.length > 0) {
            const ferryTerminals = data.elements.filter(el =>
            el.type === 'node' && el.tags?.amenity === 'ferry_terminal'
            );

            const startTerminal = findNearestTerminal(start, ferryTerminals);
            const endTerminal = findNearestTerminal(end, ferryTerminals);

            if (startTerminal && endTerminal) {
                const distance = map.distance(start, end);
                const ferryTime = (distance / 11100) * 3600;

                return {
                    hasFerry: true,
                    duration: ferryTime + 1800,
                    distance: distance,
                    terminals: {
                        start: startTerminal.name,
                        end: endTerminal.name
                    },
                    details: `Ferry from ${startTerminal.name} to ${endTerminal.name}`
                };
            }
        }
    } catch (error) {}

    return { hasFerry: false };
}

function generateWikipediaSearchTitles(name, addressDetails) {
    const titles = [];
    const { city, country, street, housenumber, county, state } = addressDetails;

    titles.push(name);

    if (city && city !== name) {
        titles.push(`${name} ${city}`);
        titles.push(`${city} ${name}`);
    }

    if (city && isGenericLocationName(name, addressDetails)) {
        titles.push(city);
    }

    if (street && housenumber && !isGenericLocationName(name, addressDetails)) {
        titles.push(`${name} ${city} ${country}`);
    }

    if (name.includes('Airport') || name.includes('International') ||
    name.includes('Museum') || name.includes('University')) {
        if (city) titles.push(`${name} ${city}`);
        if (city && country) titles.push(`${name} ${city} ${country}`);
    }

    if (city && country) {
        titles.push(`${city}, ${country}`);
        titles.push(city);
    }

    if (street && city) {
        if (housenumber) {
            titles.push(`${housenumber} ${street}, ${city}`);
        }
        titles.push(`${street}, ${city}`);
    }

    if (state && country === 'USA') {
        titles.push(`${name}, ${state}`);
        if (city) titles.push(`${city}, ${state}`);
    }

    const uniqueTitles = [...new Set(titles.filter(title =>
    title && title.trim().length > 0 && title !== 'undefined'
    ))];

    console.log("Wikipedia search titles:", uniqueTitles);
    return uniqueTitles;
}

function openGalleryModal(images, locationName) {
    console.log("openGalleryModal called with:", images, locationName);

    if (!Array.isArray(images)) {
        console.error('Images is not an array:', images);
        images = window.allImages || [];
    }

    console.log("Images array:", images);
    console.log("Images length:", images.length);

    closeModal();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';

    if (images.length > 0) {
        images.forEach((img, i) => {
            console.log(`Image ${i}:`, img.image, img.source, img.description);
        });
    }

    const validImages = images.filter(img => img && img.image);
    console.log("Valid images:", validImages.length);

    if (validImages.length === 0) {
        modal.innerHTML = `
        <div class="modal-content strike-glass">
            <div class="p-6 border-b border-white/5 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <iconify-icon icon="lucide:image" class="text-2xl"></iconify-icon>
                Photos of ${locationName}
                </h2>
                <button onclick="closeModal()" class="text-neutral-500 hover:text-white">
                <iconify-icon icon="lucide:x" class="text-2xl"></iconify-icon>
                </button>
            </div>

            <div class="p-6 text-center">
                <iconify-icon icon="lucide:image-off" class="text-4xl text-neutral-500 mb-4"></iconify-icon>
                <p class="text-neutral-400">No photos available for this location.</p>
                <p class="text-xs text-neutral-500 mt-2">(Found ${images.length} images but none were valid)</p>
            </div>

            <div class="p-6 border-t border-white/5 flex justify-end">
                <button onclick="closeModal()"
                class="h-8 px-4 bg-white text-black rounded-lg text-[11px] font-extrabold flex items-center gap-2 hover:bg-neutral-100 transition-all">
                Close
                </button>
            </div>
        </div>
        `;
        document.body.appendChild(modal);
        return;
    }

    modal.innerHTML = `
    <div class="modal-content strike-glass">
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 10px; margin: 0; font-size: 18px; font-weight: 700; color: white;">
            <iconify-icon icon="lucide:image" class="text-lg"></iconify-icon>
            ${images.length} photo${images.length !== 1 ? 's' : ''} of ${locationName}
            </h2>
            <button onclick="closeModalWithAnimation()" class="text-neutral-500 hover:text-white" style="background: none; border: none; cursor: pointer;">
            <iconify-icon icon="lucide:x" class="text-xl"></iconify-icon>
            </button>
        </div>

        <div class="modal-scrollable-content">
            <div class="image-gallery-grid">
                ${images.map((img, i) => `
                <div class="gallery-image-item"
                onclick="openDetailModal(${i}, '${locationName.replace(/'/g, "\\'")}')">
                <img src="${img.image || img.url}" alt=""
                onerror="this.src='https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80';">
                ${img.source && img.source !== 'Default' ?
                `<div class="gallery-image-source">
                    <iconify-icon icon="lucide:camera" style="font-size: 10px;"></iconify-icon>
                    ${img.source}
                </div>` : ''}
            </div>
            `).join('')}
        </div>
    </div>

    <div class="modal-footer">
        <div style="flex: 1;"></div>
        <button onclick="closeModalWithAnimation()"
        class="nav-button">
        Close
        </button>
    </div>
</div>
`;

document.body.appendChild(modal);
}

function openDetailModal(imageIndex, locationName) {
    const images = window.currentLocationImages || window.allImages || [];

    if (!images || !Array.isArray(images) || images.length === 0) {
        console.error("No images available for detail modal");
        return;
    }

    if (imageIndex < 0 || imageIndex >= images.length) {
        console.error("Invalid image index:", imageIndex, "array length:", images.length);
        return;
    }

    const image = images[imageIndex];

    if (!image || !image.image) {
        console.error("Image object is invalid:", image);
        return;
    }

    let finalLocationName = locationName || window.currentLocationName || 'Location';

    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        document.body.removeChild(existingModal);
    }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';

    modal.innerHTML = `
    <div class="modal-content strike-glass detail-modal" id="detail-modal">
        <div class="modal-header">
            <button onclick="backToGallery()"
            class="flex items-center gap-2 text-neutral-400 hover:text-white text-sm font-semibold" style="background: none; border: none; cursor: pointer;">
            <iconify-icon icon="lucide:arrow-left" class="text-lg"></iconify-icon>
            Back
            </button>
            <button onclick="closeModalWithAnimation()" class="text-neutral-500 hover:text-white" style="background: none; border: none; cursor: pointer;">
            <iconify-icon icon="lucide:x" class="text-xl"></iconify-icon>
            </button>
        </div>

        <div class="modal-scrollable-content">
            <div class="image-section">
                <img src="${image.image}" alt=""
                class="detail-image" id="detail-image">
                <div id="image-loading" class="image-loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <div class="content-section">
                <h3 class="detail-location-name">${finalLocationName}</h3>

                ${image.description ? `
                <div class="detail-description-section">
                    <div class="detail-description-label">Description</div>
                    <p class="detail-description">${stripAllHTML(image.description)}</p>
                </div>
                ` : ''}

                <div class="metadata-grid">
                    ${image.source ? `
                    <div class="metadata-item">
                        <div class="metadata-label">Source</div>
                        <div class="metadata-value">
                            <iconify-icon icon="lucide:camera" class="text-sm"></iconify-icon>
                            ${image.source}
                        </div>
                    </div>
                    ` : ''}

                    ${image.relevance ? `
                    <div class="metadata-item">
                        <div class="metadata-label">Relevance</div>
                        <div class="metadata-value">
                            <iconify-icon icon="lucide:star" class="text-sm"></iconify-icon>
                            <span class="relevance-badge ${image.relevance}">${image.relevance}</span>
                        </div>
                    </div>
                    ` : ''}

                    ${image.wikipediaUrl ? `
                    <div class="metadata-item">
                        <div class="metadata-label">More Information</div>
                        <div class="metadata-value">
                            <a href="${image.wikipediaUrl}" target="_blank"
                            class="wikipedia-link">
                            <iconify-icon icon="lucide:external-link" class="text-sm"></iconify-icon>
                            View on wikipedia
                            </a>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button onclick="openDetailModal(${imageIndex > 0 ? imageIndex - 1 : 0}, '${finalLocationName.replace(/'/g, "\\'")}')"
            class="nav-button" ${imageIndex === 0 ? 'disabled' : ''}>
            <iconify-icon icon="lucide:chevron-left"></iconify-icon>
            Previous
            </button>

            <div class="image-count">
                <iconify-icon icon="lucide:image" class="text-sm"></iconify-icon>
                ${imageIndex + 1} of ${images.length}
            </div>

            <button onclick="openDetailModal(${imageIndex < images.length - 1 ? imageIndex + 1 : imageIndex}, '${finalLocationName.replace(/'/g, "\\'")}')"
            class="nav-button" ${imageIndex === images.length - 1 ? 'disabled' : ''}>
            Next
            <iconify-icon icon="lucide:chevron-right"></iconify-icon>
            </button>
        </div>
    </div>
    `;

    document.body.appendChild(modal);

    window.currentImageIndex = imageIndex;
    window.currentImages = images;
    window.currentLocationName = finalLocationName;

    const imgElement = document.getElementById('detail-image');
    const loadingElement = document.getElementById('image-loading');

    if (imgElement) {
        imgElement.alt = '';

        imgElement.onload = function() {
            if (loadingElement) loadingElement.style.display = 'none';

            imgElement.classList.add('loaded');

            imgElement.style.borderRadius = '8px';

            console.log("Image loaded successfully");
        };

        imgElement.onerror = function() {
            if (loadingElement) loadingElement.style.display = 'none';

            imgElement.src = 'https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80';
            imgElement.alt = '';
            imgElement.classList.add('loaded');
            imgElement.style.borderRadius = '8px';

            console.log("Image failed to load, using fallback");
        };

        if (imgElement.complete) {
            if (loadingElement) loadingElement.style.display = 'none';
            imgElement.classList.add('loaded');
            imgElement.style.borderRadius = '8px';
        }
    }
}

let allImages = [];

function createModal(type) {

    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        document.body.removeChild(existingModal);
    }

    const modal = document.createElement('div');
    modal.className = `modal-overlay ${type}-overlay`;
    modal.innerHTML = '<div class="modal-content"></div>';
    return modal;
}

function closeModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        document.body.removeChild(modal);
    }
}

function closeModalWithAnimation() {
    const modal = document.querySelector('.modal-overlay');
    if (!modal) return;

    modal.style.animation = 'fadeOut 0.3s ease forwards';

    setTimeout(() => {
        if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
        }
    }, 300);
}

function closeModal() {
    closeModalWithAnimation();
}

const fadeOutCSS = `
@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes slideDown {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(20px); opacity: 0; }
}

.modal-overlay.fade-out {
    animation: fadeOut 0.3s ease forwards;
}

.modal-content.slide-down {
    animation: slideDown 0.3s ease forwards;
}
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = fadeOutCSS;
document.head.appendChild(styleSheet);

function backToGallery() {
    const detailModal = document.querySelector('.modal-overlay');
    if (detailModal) {

        detailModal.style.animation = 'fadeOut 0.3s ease forwards';

        setTimeout(() => {
            if (detailModal.parentNode) {
                detailModal.parentNode.removeChild(detailModal);
            }

            const locationName = window.currentLocationName || 'Location';
            const images = window.currentImages || window.currentLocationImages || window.allImages || [];
            console.log("Back to gallery with:", images.length, "images, location:", locationName);

            if (images.length > 0) {
                openGalleryModal(images, locationName);
            } else {
            alert("Could not return to gallery. Images were not stored properly.");
        }
    }, 300);
}
}

async function initializeImageGallery(containerId, lat, lng, name, addressDetails) {

    initIconifyIcons();

    const imagesData = await getLocationImagesWithGallery(lat, lng, name, addressDetails);
    allImages = imagesData.images;

    const container = document.getElementById(containerId);
    if (container) {
        const galleryElement = createImageGalleryElement(imagesData.mainImage, allImages, name);
        container.innerHTML = '';
        container.appendChild(galleryElement);
    }
}

function createImageGalleryElement(mainImage, allImages, name) {
    const container = document.createElement('div');
    container.className = 'location-image-container';

    const mainWrapper = document.createElement('div');
    mainWrapper.className = 'main-location-image-wrapper';
    mainWrapper.innerHTML = `
    <img src="${mainImage.image}" alt="${mainImage.description || name}" class="main-location-image">
    ${mainImage.source !== 'Default' ?
    `<div class="image-source-badge">
        <span class="iconify" data-icon="mdi:camera"></span>
        <span>View Photos</span>
    </div>` : ''}
    `;

    mainWrapper.addEventListener('click', () => {
        openGalleryModal(allImages, name);
    });

    container.appendChild(mainWrapper);
    return container;
}

function createIcon(iconName, className = '') {
    const span = document.createElement('span');
    span.className = `iconify ${className}`;
    span.setAttribute('data-icon', iconName);
    return span;
}

function initIconifyIcons() {
    if (window.iconify) {
        iconify.scan();
    } else {
    const script = document.createElement('script');
    script.src = 'https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js';
    document.head.appendChild(script);
}
}

async function getCommonsImages(name, addressDetails, lat, lng) {
    const images = [];

    console.log("Full address:", addressDetails);

    const searchTerms = generateGlobalSearchTerms(name, addressDetails);


    for (const term of searchTerms) {
        try {
            const response = await fetch(
            `https://commons.wikimedia.org/w/api.php?action=query&format=json&generator=search&gsrsearch=${encodeURIComponent(term)}&gsrnamespace=6&gsrlimit=15&prop=imageinfo&iiprop=url|extmetadata&iiurlwidth=800&origin=*`
            );

            const data = await response.json();
            const pages = data.query?.pages;

            if (pages) {
                for (const pageId in pages) {
                    const page = pages[pageId];
                    const imageInfo = page.imageinfo?.[0];

                    if (imageInfo?.url) {
                        const isRelevant = isImageRelevantGlobally(page, imageInfo, name, addressDetails, lat, lng);

                        if (isRelevant) {

                            images.push({
                                image: imageInfo.thumburl || imageInfo.url,
                                description: getGlobalImageDescription(page, imageInfo, name, addressDetails),
                                source: 'Wikimedia Commons',
                                relevance: determineGlobalRelevance(page, imageInfo, name, addressDetails, lat, lng),
                                type: 'commons',
                                commonsUrl: `https://commons.wikimedia.org/wiki/File:${encodeURIComponent(page.title.replace('File:', ''))}`
                            });
                        }
                    }
                }
            }
        } catch (error) {
        console.error("Commons search error:", error);
        continue;
    }

    if (images.length > 10) break;
}

return images;
}

function generateGlobalSearchTerms(name, addressDetails) {
    const terms = [];
    const city = (addressDetails && addressDetails.city) || '';
    const region = (addressDetails && (addressDetails.state || addressDetails.region || addressDetails.county)) || '';
    const country = (addressDetails && addressDetails.country) || '';

    const cleanName = name
    .replace(/\b(city|town|village|borough|municipality|commune|||stadt)\b/gi, '')
    .trim();

    if (city && region && country) {
        terms.push(`${cleanName} ${city} ${region} ${country}`);
        terms.push(`${city} ${region} ${country} ${cleanName}`);
    }

    if (city && country) {
        terms.push(`${cleanName} ${city} ${country}`);
        terms.push(`${city} ${country} ${cleanName}`);
        terms.push(`${cleanName}, ${city}, ${country}`);
    }

    if (region && country) {
        terms.push(`${cleanName} ${region} ${country}`);
        terms.push(`${region} ${country} ${cleanName}`);
        terms.push(`${cleanName}, ${region}, ${country}`);
    }

    if (country) {
        terms.push(`${cleanName} ${country}`);
        terms.push(`${country} ${cleanName}`);
        terms.push(`${cleanName}, ${country}`);
    }

    if (city && city !== cleanName && country) {
        terms.push(`${city} ${country}`);
        terms.push(`${city}, ${country}`);
    }

    if (region && region !== cleanName && country) {
        terms.push(`${region} ${country}`);
        terms.push(`${region}, ${country}`);
    }

    if (country) {
        const countryVariations = getCountryNameVariations(country);
        for (const countryVar of countryVariations) {
            if (city) {
                terms.push(`${cleanName} ${city} ${countryVar}`);
                terms.push(`${city} ${countryVar} ${cleanName}`);
            }
            terms.push(`${cleanName} ${countryVar}`);
            terms.push(`${countryVar} ${cleanName}`);
        }
    }

    if (country) {
        terms.push(`downtown ${cleanName} ${country}`);
        terms.push(`${cleanName} ${country} aerial`);
        terms.push(`${cleanName} ${country} skyline`);
        terms.push(`${cleanName} ${country} urban`);
    }

    terms.push(cleanName);

    if (cleanName.toLowerCase() === 'paris' && country.toLowerCase() === 'france') {
        terms.push('Paris France');
        terms.push('Paris, France');
        terms.push('Paris ');
        terms.push('Paris Frankreich');
    }

    if (cleanName.toLowerCase() === 'london' && country.toLowerCase().includes('united kingdom')) {
        terms.push('London England');
        terms.push('London, England');
        terms.push('London UK');
    }

    return [...new Set(terms.filter(term => term && term.trim().length > 0))];
}

function isImageRelevantGlobally(page, imageInfo, expectedName, addressDetails, lat, lng) {
    const title = page.title.toLowerCase();
    const expectedNameLower = expectedName.toLowerCase();
    const city = (addressDetails && addressDetails.city) || '';
    const region = (addressDetails && (addressDetails.state || addressDetails.region || addressDetails.county)) || '';
    const country = (addressDetails && addressDetails.country) || '';

    if (title.includes('.svg') || title.includes('.pdf') || title.includes('.djvu')) {
        return false;
    }

    if (title.includes(' map') || title.includes('diagram') || title.includes('chart')) {
        return false;
    }

    const metadata = imageInfo.extmetadata || {};
    const description = (metadata.ImageDescription?.value || '').toLowerCase();
    const categories = (metadata.Categories?.value || '').toLowerCase();

    let score = 0;

    if (country) {
        const countryVariations = getCountryNameVariations(country);
        let countryFound = false;

        for (const countryVar of countryVariations) {
            if (title.includes(countryVar) || description.includes(countryVar)) {
                countryFound = true;
                score += 40;
                break;
            }
        }

        if (!countryFound) {
            const wrongCountries = getCommonCountryNames();
            for (const wrongCountry of wrongCountries) {
                if (wrongCountry !== country.toLowerCase() &&
                (title.includes(wrongCountry) || description.includes(wrongCountry))) {
                    score -= 50;
                }
            }
        }
    }

    if (region) {
        if (title.includes(region) || description.includes(region)) {
            score += 25;
        }
    }

    if (city && (title.includes(city) || description.includes(city))) {
        score += 20;
    }

    if (title.includes(expectedNameLower.replace(/\s+/g, '_'))) {
        score += 15;
    }

    if (description.includes(expectedNameLower)) {
        score += 10;
    }

    if (country) {
        const countryVariations = getCountryNameVariations(country);
        for (const countryVar of countryVariations) {
            if (categories.includes(countryVar)) {
                score += 20;
                break;
            }
        }
    }

    if (description.includes('photograph') || description.includes('photo') || description.includes('image of')) {
        score += 15;
    }

    if (description.includes('aerial') || description.includes('skyline') || description.includes('downtown')) {
        score += 10;
    }

    return score >= 25;
}

function getCountryNameVariations(country) {
    const countryLower = country.toLowerCase();
    const variations = [countryLower];

    const countryMap = {
        'united states': ['usa', 'united states of america', 'us', 'america', 'united states'],
        'united kingdom': ['uk', 'great britain', 'britain', 'england', 'scotland', 'wales', 'northern ireland'],
        'france': ['france', 'french republic', 'frankreich', 'francia'],
        'germany': ['germany', 'deutschland', 'federal republic of germany'],
        'spain': ['spain', 'espaa', 'espana', 'kingdom of spain'],
        'italy': ['italy', 'italia', 'italian republic'],
        'china': ['china', 'peoples republic of china', 'prc', 'zhongguo'],
        'japan': ['japan', 'nippon', 'japanese'],
        'russia': ['russia', 'russian federation', 'rossiya'],
        'canada': ['canada', 'canadian'],
        'australia': ['australia', 'oz'],
        'india': ['india', 'bharat', 'hindustan'],
        'brazil': ['brazil', 'brasil'],
        'mexico': ['mexico', 'mxico', 'mexican'],

    };

    for (const [key, values] of Object.entries(countryMap)) {
        if (countryLower.includes(key) || key.includes(countryLower)) {
            variations.push(...values);
        }
    }

    if (countryLower === 'france') variations.push('france', 'frankreich', 'francia');
    if (countryLower === 'germany') variations.push('germany', 'deutschland');
    if (countryLower === 'spain') variations.push('spain', 'espaa', 'espana');
    if (countryLower === 'italy') variations.push('italy', 'italia');

    return [...new Set(variations.map(v => v.toLowerCase()))];
}

function getCommonCountryNames() {
    return [
    'united states', 'usa', 'canada', 'mexico', 'brazil',
    'united kingdom', 'uk', 'france', 'germany', 'italy', 'spain',
    'china', 'japan', 'india', 'australia', 'russia'
    ];
}

function determineGlobalRelevance(page, imageInfo, name, addressDetails, lat, lng) {
    const score = calculateGlobalRelevanceScore(page, imageInfo, name, addressDetails);

    if (score >= 50) return 'high';
    if (score >= 25) return 'medium';
    return 'low';
}

function calculateGlobalRelevanceScore(page, imageInfo, name, addressDetails) {
    let score = 0;
    const title = page.title.toLowerCase();
    const metadata = imageInfo.extmetadata || {};
    const description = (metadata.ImageDescription?.value || '').toLowerCase();
    const city = (addressDetails && addressDetails.city) || '';
    const region = (addressDetails && (addressDetails.state || addressDetails.region || addressDetails.county)) || '';
    const country = (addressDetails && addressDetails.country) || '';

    if (country) {
        const countryVariations = getCountryNameVariations(country);
        for (const countryVar of countryVariations) {
            if (title.includes(countryVar) || description.includes(countryVar)) {
                score += 40;
                break;
            }
        }
    }

    if (region && (title.includes(region) || description.includes(region))) {
        score += 25;
    }

    if (city && (title.includes(city) || description.includes(city))) {
        score += 20;
    }

    const nameLower = name.toLowerCase();
    if (title.includes(nameLower.replace(/\s+/g, '_'))) {
        score += 15;
    }

    if (description.includes('photograph') || description.includes('photo')) {
        score += 10;
    }

    return score;
}

function getGlobalImageDescription(page, imageInfo, name, addressDetails) {
    const metadata = imageInfo.extmetadata || {};

    if (metadata.ImageDescription?.value) {

        const cleanDesc = metadata.ImageDescription.value
        .replace(/<[^>]*>/g, '')
        .replace(/\s+/g, ' ')
        .trim();

        return cleanDesc.substring(0, 200) +
        (cleanDesc.length > 200 ? '...' : '');
    }

    if (metadata.ObjectName?.value) {
        return metadata.ObjectName.value;
    }

    const city = addressDetails.city || '';
    const region = addressDetails.state || addressDetails.region || '';
    const country = addressDetails.country || '';

    if (city && region && country) {
        return `Photo of ${name} in ${city}, ${region}, ${country}`;
    } else if (city && country) {
    return `Photo of ${name} in ${city}, ${country}`;
} else if (region && country) {
return `Photo of ${name} in ${region}, ${country}`;
} else if (country) {
return `Photo of ${name} in ${country}`;
} else {
return `Photo of ${name}`;
}
}

function buildCommonsQuery(searchTerm, addressDetails) {
    const params = new URLSearchParams({
        action: 'query',
        generator: 'search',
        gsrsearch: encodeURIComponent(searchTerm),
        gsrnamespace: '6',
        gsrlimit: '20',
        prop: 'imageinfo',
        iiprop: 'url|extmetadata|dimensions|mime',
        iiurlwidth: '800',
        format: 'json',
        origin: '*'
    });

    const city = addressDetails.city || '';
    const state = addressDetails.state || '';
    const country = addressDetails.country || '';

    if (city) {
        params.set('gsrsearch', encodeURIComponent(`${searchTerm} "${city}"`));
    }

    return params.toString();
}

function copyCoordinates(lat, lng) {
    const text = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    copyToClipboard(text);
}

function generateCommonsSearchTerms(name, addressDetails) {
    const terms = [];
    const city = addressDetails.city || '';
    const state = addressDetails.state || '';
    const country = addressDetails.country || '';

    const cleanName = name
    .replace(/\b(city|town|village|borough|municipality|county)\b/gi, '')
    .trim();

    if (city && state) {
        terms.push(`${cleanName} ${city} ${state}`);
        terms.push(`${city} ${state} ${cleanName}`);
    }

    if (city && country) {
        terms.push(`${cleanName} ${city} ${country}`);
        terms.push(`${city} ${country} ${cleanName}`);
    }

    if (city) {
        terms.push(`${cleanName} ${city}`);
        terms.push(`${city} ${cleanName}`);

        if (name.toLowerCase().includes(city.toLowerCase())) {
            terms.push(city);
            terms.push(`${city} downtown`);
            terms.push(`${city} aerial view`);
            terms.push(`${city} skyline`);
        }
    }

    if (addressDetails.type) {
        switch(addressDetails.type.toLowerCase()) {
            case 'city':
            case 'town':
            terms.push(`${cleanName} city hall`);
            terms.push(`${cleanName} downtown`);
            terms.push(`${cleanName} aerial`);
            break;
            case 'street':
            case 'road':
            terms.push(`${cleanName} street view`);
            terms.push(`${cleanName} ${city} street`);
            break;
            case 'building':
            terms.push(`${cleanName} building`);
            terms.push(`${cleanName} architecture`);
            break;
        }
    }

    terms.push(cleanName);
    terms.push(`${cleanName} photograph`);
    terms.push(`${cleanName} photo`);

    if (city) {
        terms.push(`downtown ${city}`);
        terms.push(`${city} landscape`);
        terms.push(`${city} urban`);
    }

    return [...new Set(terms.filter(term => term && term.trim().length > 0))];
}

function isPhotoImage(page, imageInfo) {
    const title = page.title.toLowerCase();
    const url = imageInfo.url.toLowerCase();

    const isPhotoExtension = /\.(jpg|jpeg|png|gif|webp)$/i.test(url);

    if (!isPhotoExtension) return false;

    const isNonPhoto = (title.includes('map') && !title.includes('map pin')) ||
    title.includes('diagram') ||
    title.includes('logo') ||
    title.includes('icon') ||
    title.includes('svg') ||
    title.includes('pdf') ||
    title.includes('document') ||
    (title.includes('tif') && title.includes('city of'));

    const metadata = imageInfo.extmetadata || {};
    const isPhotograph = metadata.ImageDescription?.value?.toLowerCase().includes('photograph') ||
    metadata.ImageDescription?.value?.toLowerCase().includes('image') ||
    metadata.ImageDescription?.value?.toLowerCase().includes('photo') ||
    metadata.Artist?.value?.toLowerCase().includes('photograph');

    if (isNonPhoto && !isPhotograph) {
        return false;
    }

    return true;
}

function getCommonsImageDescription(page, imageInfo, locationName) {
    const metadata = imageInfo.extmetadata || {};

    if (metadata.ImageDescription?.value) {
        return metadata.ImageDescription.value.substring(0, 150) +
        (metadata.ImageDescription.value.length > 150 ? '...' : '');
    }

    if (metadata.ObjectName?.value) {
        return metadata.ObjectName.value;
    }

    const title = page.title.replace('File:', '').replace(/\.[^/.]+$/, '');
    return title || `Photo of ${locationName}`;
}

function determineCommonsRelevance(page, imageInfo, name, addressDetails) {
    let score = 0;
    const title = page.title.toLowerCase();
    const city = (addressDetails.city || '').toLowerCase();
    const state = (addressDetails.state || '').toLowerCase();
    const metadata = imageInfo.extmetadata || {};

    const nameWords = name.toLowerCase().split(' ');
    nameWords.forEach(word => {
        if (title.includes(word)) score += 10;
    });

    if (metadata.Location?.value) {
        const location = metadata.Location.value.toLowerCase();
        if (city && location.includes(city)) score += 20;
        if (state && location.includes(state)) score += 15;
    }

    if (metadata.ImageDescription?.value) {
        const desc = metadata.ImageDescription.value.toLowerCase();
        if (city && desc.includes(city)) score += 15;
        if (state && desc.includes(state)) score += 10;
        nameWords.forEach(word => {
            if (desc.includes(word)) score += 5;
        });
    }

    if (score >= 30) return 'high';
    if (score >= 15) return 'medium';
    return 'low';
}

async function getOSMImages(lat, lng) {
    const images = [];

    try {
        const overpassQuery = `
        [out:json][timeout:25];
        (
        node(around:200, ${lat}, ${lng})["wikimedia_commons"];
        way(around:200, ${lat}, ${lng})["wikimedia_commons"];
        relation(around:200, ${lat}, ${lng})["wikimedia_commons"];
        );
        out body;
        >;
        out skel qt;
        `;

        const response = await fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST',
            body: overpassQuery
        });

        const data = await response.json();

        if (data.elements && data.elements.length > 0) {
            for (const element of data.elements) {
                const commonsTag = element.tags?.wikimedia_commons;
                if (commonsTag) {
                    let imageUrl;
                    if (commonsTag.startsWith('http')) {
                        imageUrl = commonsTag;
                    } else if (commonsTag.startsWith('File:')) {
                    imageUrl = await getCommonsImageUrlFromFilename(commonsTag);
                } else {
                imageUrl = await getCommonsImageUrlFromFilename(`File:${commonsTag}`);
            }

            if (imageUrl) {
                images.push({
                    image: imageUrl,
                    description: element.tags?.name || `OSM feature at this location`,
                    source: 'OpenStreetMap + Wikimedia Commons',
                    relevance: 'medium',
                    type: 'osm'
                });
            }
        }
    }
}
} catch (error) {
console.error("OSM images error:", error);
}

return images;
}

async function getCommonsImageUrlFromFilename(filename) {
    try {
        const response = await fetch(
        `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(filename)}&prop=imageinfo&iiprop=url&iiurlwidth=800&format=json&origin=*`
        );

        const data = await response.json();
        const pages = data.query?.pages;

        if (pages) {
            const page = Object.values(pages)[0];
            return page.imageinfo?.[0]?.thumburl || page.imageinfo?.[0]?.url;
        }
    } catch (error) {
    return null;
}
}

async function getLocationImagesWithGallery(lat, lng, name, addressDetails) {
    const imagesData = await getLocationImages(lat, lng, name, addressDetails);
    return imagesData;
}

async function getLocationImages(lat, lng, name, addressDetails) {
    try {
        const images = [];

        const [wikiImages, commonsImages, osmImages] = await Promise.all([
        getWikipediaImages(name, addressDetails, lat, lng),
        getCommonsImages(name, addressDetails, lat, lng),
        getOSMImages(lat, lng)
        ]);

        if (wikiImages && wikiImages.length > 0) images.push(...wikiImages);
        if (commonsImages && commonsImages.length > 0) images.push(...commonsImages.slice(0, 5));
        if (osmImages && osmImages.length > 0) images.push(...osmImages);

        console.log("Raw img:", images.length, images);

        const processedImages = images.map((img, index) => ({
            image: img.image || img.url || getDefaultLocationImage(name, addressDetails),
            description: img.description || `${name} photo ${index + 1}`,
            source: img.source || 'Unknown',
            relevance: img.relevance || 'medium',
            wikipediaUrl: img.wikipediaUrl || null
        }));

        const validImages = processedImages.filter(img => {
            const hasValidImage = img.image && img.image.startsWith('http');
            if (!hasValidImage) {
                console.log("filter:", img);
            }
            return hasValidImage;
        });

        console.log("valid:", validImages.length);

        const uniqueImages = Array.from(new Map(validImages.map(img => [img.image, img])).values());

        window.currentLocationImages = uniqueImages;
        console.log("Storage:", window.currentLocationImages.length);

        return {
            mainImage: uniqueImages[0] || {
                image: getDefaultLocationImage(name, addressDetails),
                description: `Photo of ${name}`,
                source: 'Default'
            },
            images: uniqueImages,
            total: uniqueImages.length
        };

    } catch (error) {
    console.error("Image error:", error);
    const defaultImg = {
        image: getDefaultLocationImage(name, addressDetails),
        description: `Photo of ${name}`,
        source: 'Default'
    };
    window.currentLocationImages = [defaultImg];
    return {
        mainImage: defaultImg,
        images: [defaultImg],
        total: 1
    };
}
}

window.openImageGallery = function(locationName) {
    const images = window.allImages || [];
    console.log("Opening gallery with images:", images.length, images);
    openGalleryModal(images, locationName);
};

async function getWikipediaImages(name, addressDetails, lat, lng) {
    const images = [];

    const wikiTerms = generateGlobalWikipediaTerms(name, addressDetails);

    for (const term of wikiTerms) {
        try {

            const response = await fetch(
            `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages|extracts|coordinates&titles=${encodeURIComponent(term)}&pithumbsize=800&pilimit=5&origin=*`
            );

            const data = await response.json();
            const pages = data.query?.pages;

            if (pages) {
                const page = Object.values(pages)[0];

                if (page.pageid && !page.missing) {

                    const isRelevant = isWikipediaPageRelevantGlobally(page, name, addressDetails);

                    if (isRelevant && page.thumbnail?.source) {

                        images.push({
                            image: page.thumbnail.source,
                            description: cleanDescription(page.extract) || `Wikipedia: ${page.title}`,
                            source: 'Wikipedia',
                            wikipediaUrl: `https://en.wikipedia.org/wiki/${encodeURIComponent(page.title)}`,
                            relevance: 'high',
                            type: 'main'
                        });

                        const galleryImages = await getWikipediaGalleryImages(page.title);
                        images.push(...galleryImages);

                        break;
                    }
                }
            }
        } catch (error) {
        console.error("Wikipedia search error:", error);
        continue;
    }
}

if (images.length === 0) {
    try {
        const geoImages = await getWikipediaImagesByGeolocation(lat, lng, name, addressDetails);
        images.push(...geoImages);
    } catch (error) {
    console.error("Geolocation search error:", error);
}
}

return images;
}

function generateGlobalWikipediaTerms(name, addressDetails) {
    const terms = [];
    const city = (addressDetails && addressDetails.city) || '';
    const region = (addressDetails && (addressDetails.state || addressDetails.region || addressDetails.county)) || '';
    const country = (addressDetails && addressDetails.country) || '';

    const cleanName = name
    .replace(/\b(city|town|village|borough|commune|stadt||)\b/gi, '')
    .trim();

    if (country) {

        if (city && region) {
            terms.push(`${cleanName}, ${city}, ${region}, ${country}`);
        }

        if (city) {
            terms.push(`${cleanName}, ${city}, ${country}`);
            terms.push(`${city}, ${country}`);
        }

        if (region) {
            terms.push(`${cleanName}, ${region}, ${country}`);
            terms.push(`${region}, ${country}`);
        }

        terms.push(`${cleanName}, ${country}`);
    }

    if (city && region) {
        terms.push(`${cleanName}, ${city}, ${region}`);
    }

    if (city) {
        terms.push(`${cleanName}, ${city}`);
    }

    if (region) {
        terms.push(`${cleanName}, ${region}`);
    }

    terms.push(cleanName);

    if (cleanName.toLowerCase() === 'paris' && country.toLowerCase() === 'france') {
        terms.push('Paris');
        terms.push('Paris, France');
    }

    if (cleanName.toLowerCase() === 'london' && country.toLowerCase() === 'united kingdom') {
        terms.push('London');
        terms.push('London, England');
        terms.push('London, United Kingdom');
    }

    return [...new Set(terms.filter(term => term.trim()))];
}

function isWikipediaPageRelevantGlobally(page, expectedName, addressDetails) {
    const title = page.title.toLowerCase();
    const extract = (page.extract || '').toLowerCase();
    const expectedNameLower = expectedName.toLowerCase();
    const country = (addressDetails && addressDetails.country) || '';

    if (country) {
        const countryVariations = getCountryNameVariations(country);
        let countryFound = false;

        for (const countryVar of countryVariations) {
            if (title.includes(countryVar) || extract.includes(countryVar)) {
                countryFound = true;
                break;
            }
        }

        if (!countryFound) {
            return false;
        }
    }

    return title.includes(expectedNameLower) || extract.includes(expectedNameLower);
}

async function getWikipediaImagesByGeolocation(lat, lng, name, addressDetails) {
    const images = [];

    try {

        const response = await fetch(
        `https://en.wikipedia.org/w/api.php?action=query&format=json&list=geosearch&gscoord=${lat}|${lng}&gsradius=10000&gslimit=5&origin=*`
        );

        const data = await response.json();
        const pages = data.query?.geosearch || [];

        for (const page of pages) {
            try {

                const pageResponse = await fetch(
                `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages|extracts&pageids=${page.pageid}&pithumbsize=800&origin=*`
                );

                const pageData = await pageResponse.json();
                const pageInfo = pageData.query?.pages[page.pageid];

                if (pageInfo?.thumbnail?.source) {
                    images.push({
                        image: pageInfo.thumbnail.source,
                        description: cleanDescription(pageInfo.extract) || `Wikipedia: ${pageInfo.title}`,
                        source: 'Wikipedia',
                        wikipediaUrl: `https://en.wikipedia.org/wiki/${encodeURIComponent(pageInfo.title)}`,
                        relevance: 'medium',
                        type: 'geolocated'
                    });
                }
            } catch (error) {
            continue;
        }
    }
} catch (error) {
console.error("Wikipedia geolocation error:", error);
}

return images;
}

async function getWikipediaGalleryImages(pageTitle) {
    try {
        const response = await fetch(
        `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=images&titles=${encodeURIComponent(pageTitle)}&imlimit=20&origin=*`
        );
        const data = await response.json();

        const pages = data.query?.pages;
        if (pages) {
            const page = Object.values(pages)[0];
            const images = page.images || [];

            const photoImages = images.filter(img => {
                const title = img.title.toLowerCase();

                if (title.includes('emblem') ||
                title.includes('coat of arms') ||
                title.includes('flag') ||
                title.includes('seal') ||
                title.includes('logo.svg') ||
                title.includes('.svg')) {
                    return false;
                }

                const isImage = /\.(jpg|jpeg|png|gif|webp|tif|tiff)$/i.test(title);
                return isImage;
            }).slice(0, 10);

            const gallery = [];
            for (const img of photoImages) {
                const imageUrl = await getWikipediaImageUrl(img.title);
                if (imageUrl) {
                    gallery.push({
                        image: imageUrl,
                        description: img.title.replace('File:', '').replace(/\.[^/.]+$/, ''),
                        source: 'Wikipedia Gallery',
                        relevance: 'medium',
                        type: 'gallery'
                    });
                }
            }

            return gallery;
        }
    } catch (error) {
    console.error("Gallery fetch error:", error);
}

return [];
}

async function getWikipediaImageUrl(imageTitle) {
    try {
        const response = await fetch(
        `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=imageinfo&titles=${encodeURIComponent(imageTitle)}&iiprop=url&iiurlwidth=800&origin=*`
        );
        const data = await response.json();

        const pages = data.query?.pages;
        if (pages) {
            const page = Object.values(pages)[0];
            return page.imageinfo?.[0]?.thumburl || page.imageinfo?.[0]?.url;
        }
    } catch (error) {
    return null;
}
}

function getDefaultLocationImage(name, addressDetails) {
    return {
        image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQzdBEfMnnXcdTbA7Md3Q0hE7RpBCzWlsOsYQ&s",
        description: `No relevant image(s) were found.`,
        source: 'Default'
    };
}

function cleanDescription(text) {
    if (!text) return '';
    return text
    .replace(/\[.*?\]/g, '')
    .replace(/\s+/g, ' ')
    .substring(0, 150)
    .trim() + (text.length > 150 ? '...' : '');
}

function generateExactWikipediaTitles(name, addressDetails) {
    const titles = [];
    const city = addressDetails.city || '';
    const state = addressDetails.state || '';
    const cleanName = name.trim();

    const withoutDirection = cleanName.replace(/^(NE|NW|SE|SW|North|South|East|West|Northeast|Northwest|Southeast|Southwest)\s+/i, '');

    if (city && state) {
        titles.push(`${cleanName}, ${city}, ${state}`);
        titles.push(`${cleanName} (${city}, ${state})`);
    }

    if (city) {
        titles.push(`${cleanName}, ${city}`);
        titles.push(`${cleanName} (${city})`);
    }

    titles.push(cleanName);

    if (withoutDirection !== cleanName) {
        if (city && state) {
            titles.push(`${withoutDirection}, ${city}, ${state}`);
            titles.push(`${withoutDirection} (${city}, ${state})`);
        }
        titles.push(withoutDirection);
    }

    if (name.toLowerCase().includes('high school') || name.toLowerCase().includes('middle school')) {
        const baseName = cleanName.replace(/\b(High School|Middle School|Elementary School|School)\b/gi, '').trim();
        if (city && state) {
            titles.push(`${baseName} High School (${city}, ${state})`);
            titles.push(`${baseName} High School`);
        }
    }

    if (name.toLowerCase().includes('park')) {
        if (city) {
            titles.push(`${cleanName} (${city})`);

            titles.push(`${cleanName} Park`);
        }
    }

    return [...new Set(titles.filter(title => title && title.length > 0))];
}

function generateLocationBasedSearchTerms(name, addressDetails) {
    const terms = [];
    const city = addressDetails.city || '';
    const state = addressDetails.state || '';
    const cleanName = name.trim();

    const withoutGeneric = cleanName.replace(/\b(Park|Library|School|High School|Elementary|Center|Building|Plaza|Square|Mall)\b/gi, '').trim();

    if (city && state) {

        terms.push(`"${cleanName}" "${city}" "${state}"`);
        terms.push(`"${withoutGeneric}" "${city}" "${state}"`);

        if (state.toLowerCase().includes('washington')) {
            terms.push(`"${cleanName}" Washington`);
            terms.push(`"${withoutGeneric}" Washington`);
        }
    }

    if (city) {
        terms.push(`"${cleanName}" "${city}"`);
        terms.push(`"${withoutGeneric}" "${city}"`);
    }

    terms.push(`"${cleanName}"`);

    return terms.filter(term => term.length > 0);
}

async function getWikipediaFromOSMWithType(lat, lng, expectedName) {
    try {

        const overpassQuery = `
        [out:json][timeout:30];
        (
        node(around:200, ${lat}, ${lng})["wikipedia"]["name"];
        way(around:200, ${lat}, ${lng})["wikipedia"]["name"];
        relation(around:200, ${lat}, ${lng})["wikipedia"]["name"];
        );
        out body;
        >;
        out skel qt;
        `;

        const response = await fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST',
            body: overpassQuery
        });

        const data = await response.json();

        if (data.elements && data.elements.length > 0) {

            for (const element of data.elements) {
                if (element.tags?.wikipedia && element.tags?.name) {
                    const elementName = element.tags.name.toLowerCase();
                    const expectedNameLower = expectedName.toLowerCase();

                    if (elementName.includes(expectedNameLower) ||
                    expectedNameLower.includes(elementName) ||
                    areNamesSimilar(elementName, expectedNameLower)) {
                        return {
                            wikipedia: element.tags.wikipedia,
                            name: element.tags.name,
                            distance: calculateDistance(lat, lng, element.lat, element.lon)
                        };
                    }
                }
            }

            const element = data.elements[0];
            if (element.tags?.wikipedia) {
                return {
                    wikipedia: element.tags.wikipedia,
                    name: element.tags.name || '',
                    distance: calculateDistance(lat, lng, element.lat, element.lon)
                };
            }
        }
    } catch (error) {
    console.error("OSM Wikipedia lookup error:", error);
}

return null;
}

async function fetchWikipediaPageByTitle(wikiTitle) {
    try {

        let title = wikiTitle;
        if (title.includes(':')) {
            title = title.split(':').slice(1).join(':');
        }

        const response = await fetch(
        `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages|extracts|coordinates|info&titles=${encodeURIComponent(title)}&exintro=1&explaintext=1&pithumbsize=800&inprop=url&origin=*`
        );
        const data = await response.json();

        const pages = data.query?.pages;
        if (pages) {
            return Object.values(pages)[0];
        }
    } catch (error) {
    console.error("Wikipedia fetch error:", error);
}

return null;
}

async function getGeolocatedWikipediaPages(lat, lng) {
    try {
        const response = await fetch(
        `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages|extracts|coordinates|info&generator=geosearch&ggscoord=${lat}|${lng}&ggsradius=1000&ggslimit=10&exintro=1&explaintext=1&pithumbsize=400&inprop=url&origin=*`
        );
        const data = await response.json();

        const pages = data.query?.pages;
        if (pages) {
            return Object.values(pages).map(page => ({
                ...page,
                distance: page.coordinates ?
                calculateDistance(lat, lng, page.coordinates[0].lat, page.coordinates[0].lon) :
                9999
            }));
        }
    } catch (error) {
    console.error("Geolocated pages error:", error);
}

return [];
}

function findBestLocationMatch(pages, expectedName, addressDetails) {
    let bestMatch = null;
    let bestScore = -Infinity;

    const expectedNameLower = expectedName.toLowerCase();
    const cityLower = (addressDetails.city || '').toLowerCase();
    const stateLower = (addressDetails.state || '').toLowerCase();

    for (const page of pages) {
        let score = 0;
        const pageTitle = page.title.toLowerCase();
        const extract = page.extract?.toLowerCase() || '';

        if (pageTitle === expectedNameLower) score += 100;
        else if (pageTitle.includes(expectedNameLower)) score += 80;
        else if (expectedNameLower.includes(pageTitle)) score += 60;

        if (cityLower && pageTitle.includes(cityLower)) score += 40;
        if (stateLower && pageTitle.includes(stateLower)) score += 30;

        if (cityLower && extract.includes(cityLower)) score += 20;
        if (stateLower && extract.includes(stateLower)) score += 15;

        if (page.distance < 500) score += 50;
        else if (page.distance < 1000) score += 30;
        else if (page.distance < 2000) score += 10;

        if (page.thumbnail) score += 25;

        if (pageTitle.includes('disambiguation')) score -= 100;
        if (extract.includes('may refer to')) score -= 100;

        if (score > bestScore) {
            bestScore = score;
            bestMatch = page;
        }
    }

    return bestScore > 50 ? bestMatch : null;
}

function isSameLocation(page, lat, lng, expectedName) {

    if (page.coordinates && page.coordinates.length > 0) {
        const pageLat = page.coordinates[0].lat;
        const pageLng = page.coordinates[0].lon;

        const distance = calculateDistance(lat, lng, pageLat, pageLng);

        return distance < 2000;
    }

    const pageTitle = page.title.toLowerCase();
    const expectedNameLower = expectedName.toLowerCase();

    return pageTitle === expectedNameLower ||
    pageTitle.includes(expectedNameLower) ||
    expectedNameLower.includes(pageTitle);
}

function isInSameLocation(page, addressDetails) {
    const extract = page.extract?.toLowerCase() || '';
    const city = addressDetails.city?.toLowerCase() || '';
    const state = addressDetails.state?.toLowerCase() || '';

    if (city && extract.includes(city)) return true;
    if (state && extract.includes(state)) return true;

    if (page.coordinates && page.coordinates.length > 0) {

        const pageLat = page.coordinates[0].lat;
        const pageLng = page.coordinates[0].lon;

        if (pageLat > 45.5 && pageLat < 49 && pageLng > -124.8 && pageLng < -116.9) {
            return true;
        }
    }

    return false;
}

function cleanWikipediaDescription(extract) {
    if (!extract) return '';

    let clean = extract
    .replace(/\[.*?\]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

    const firstSentence = clean.split('.')[0];
    if (firstSentence && firstSentence.length > 30) {
        return firstSentence + '.';
    }

    return clean.substring(0, 200) + (clean.length > 200 ? '...' : '');
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c * 1000;
}

function areNamesSimilar(name1, name2) {

    const words1 = name1.split(/\s+/);
    const words2 = name2.split(/\s+/);

    const commonWords = words1.filter(word =>
    words2.some(w2 => w2.includes(word) || word.includes(w2))
    );

    return commonWords.length >= Math.min(words1.length, words2.length) / 2;
}

function isGenericLocationName(name, addressDetails) {
    const genericTerms = [
    'street', 'avenue', 'boulevard', 'blvd',
    'drive','court', 'ct', 'place', 'pl', 'way',
    'highway', 'hwy', 'freeway', 'fwy', 'expressway', 'expy', 'parkway', 'pkwy',
    'route', 'rt', 'circle', 'cir', 'terrace', 'ter', 'trail', 'trl'
    ];

    const nameLower = name.toLowerCase();

    for (const term of genericTerms) {
        if (nameLower.includes(` ${term}`) || nameLower.endsWith(` ${term}`)) {
        return true;
    }
}

if (/^\d+(st|nd|rd|th)\s/.test(nameLower) || /^\d+$/.test(name)) {
    return true;
}

if (/^(I-|US-|SR-|CR-|Route\s\d+)/i.test(name)) {
    return true;
}

return false;
}

function isFamousStreet(name, city) {
    const famousStreets = [
    'wall street', 'broadway', 'fifth avenue', 'rodeo drive', 'sunset boulevard',
    'lombard street', 'bourbon street', 'abbey road', 'champs-lyses',
    'las vegas strip', 'times square', 'piccadilly circus', 'trafalgar square'
    ];

    const nameLower = name.toLowerCase();
    if (famousStreets.includes(nameLower)) {
        return true;
    }

    const cityFamousStreets = {
        'new york': ['wall street', 'broadway', 'fifth avenue', 'madison avenue', 'park avenue'],
        'los angeles': ['rodeo drive', 'sunset boulevard', 'hollywood boulevard'],
        'san francisco': ['lombard street', 'market street'],
        'london': ['abbey road', 'oxford street', 'regent street', 'baker street'],
        'paris': ['champs-lyses', 'rue de rivoli'],
        'chicago': ['magnificent mile', 'state street'],
        'miami': ['ocean drive', 'lincoln road']
    };

    if (city && cityFamousStreets[city.toLowerCase()]) {
        return cityFamousStreets[city.toLowerCase()].includes(nameLower);
    }

    return false;
}

function isNotableWikipediaPage(page) {
    if (!page.extract || page.extract.length < 50) {
        return false;
    }

    if (page.redirect) {
        return false;
    }

    if (page.title && (page.title.includes('(disambiguation)') ||
    page.extract.includes('may refer to'))) {
        return false;
    }

    if (page.length && page.length < 500) {
        return false;
    }

    return true;
}

function generateLocationSearchTerms(name, addressDetails) {
    const terms = [];

    const city = addressDetails.city || '';
    const state = addressDetails.state || '';
    const country = addressDetails.country || '';
    const county = addressDetails.county || '';
    const type = addressDetails.type || '';
    const osm_key = addressDetails.osm_key || '';

    const fullLocation = [city, county, state, country].filter(Boolean).join(' ');

    if (fullLocation) {
        terms.push(`${name} ${fullLocation}`);
        terms.push(`${fullLocation} ${name}`);
    }

    if (city && state) {
        terms.push(`${name} ${city} ${state}`);
        terms.push(`${city} ${state} ${name}`);
    }

    if (city && country) {
        terms.push(`${name} ${city} ${country}`);
        terms.push(`${city} ${country} ${name}`);
    }

    if (state && country) {
        terms.push(`${name} ${state} ${country}`);
    }

    if (county && state) {
        terms.push(`${name} ${county} ${state}`);
        terms.push(`${county} ${state} ${name}`);
    }

    if (type === 'city' || type === 'town') {
        terms.push(`${name} ${state} ${country} city`);
        terms.push(`${name} tourism ${state}`);
        terms.push(`${name} downtown ${city}`);
    } else if (type === 'airport' || name.includes('Airport') || name.includes('International')) {
    terms.push(`${name} airport ${city} ${state}`);
    terms.push(`${city} ${state} airport terminal`);
    terms.push(`${name} aerial view ${city}`);
} else if (type === 'street' || type === 'road' || osm_key === 'highway') {
terms.push(`${name} ${city} ${state} road`);
terms.push(`${city} ${state} ${name} street`);
terms.push(`${name} scenic drive ${state}`);
terms.push(`${name} ${county} ${state} highway`);
} else if (type === 'building') {
terms.push(`${name} ${city} building architecture`);
terms.push(`${city} ${state} ${name} landmark`);
} else {
terms.push(`${name} ${city} ${state} landmark`);
terms.push(`${name} ${county} ${state} tourism`);
}

if (state) {
    terms.push(`${name} ${state}`);
}

if (country) {
    terms.push(`${name} ${country}`);
}

terms.push(`${name} landmark`);
terms.push(`${name} tourism`);
terms.push(`${name} ${type || 'location'}`);

return terms;
}

function findMostRelevantImage(pages, name, addressDetails) {
    const images = [];

    for (const pageId in pages) {
        const page = pages[pageId];
        if (page.imageinfo && page.imageinfo[0]) {
            const imageInfo = page.imageinfo[0];

            let score = 0;

            const filename = page.title.toLowerCase();
            const nameLower = name.toLowerCase();

            if (filename.includes(nameLower.replace(/\s+/g, '_'))) {
                score += 3;
            }

            if (filename.includes('panorama') || filename.includes('aerial')) {
                score += 2;
            }

            if (filename.includes('night') || filename.includes('dusk') || filename.includes('dawn')) {
                score += 1;
            }

            if (imageInfo.extmetadata) {
                const metadata = imageInfo.extmetadata;

                if (metadata.ImageDescription && metadata.ImageDescription.value) {
                    const desc = metadata.ImageDescription.value.toLowerCase();
                    if (desc.includes(nameLower)) score += 2;
                    if (desc.includes('landmark')) score += 3;
                    if (desc.includes('building')) score += 2;
                    if (desc.includes('architecture')) score += 2;
                }

                if (metadata.DateTimeOriginal) {
                    const year = new Date(metadata.DateTimeOriginal.value).getFullYear();
                    if (year > 2010) score += 1;
                }
            }

            images.push({
                url: imageInfo.thumburl,
                description: imageInfo.extmetadata?.ImageDescription?.value || '',
                score: score
            });
        }
    }

    images.sort((a, b) => b.score - a.score);
    return images[0];
}

async function getNotableFeatureFromOSM(lat, lng) {
    try {
        const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&namedetails=1`
        );
        const data = await response.json();

        if (data.namedetails) {
            const names = data.namedetails;

            if (data.extratags) {
                const extras = data.extratags;

                const wikipedia = extras.wikipedia || extras['wikipedia:en'] || extras['wikipedia'];
                const wikidata = extras.wikidata;
                const image = extras.image || extras['image:0'] || extras['image:1'];

                if (wikipedia) {
                    const pageTitle = wikipedia.split(':').slice(1).join(':');

                    const wikiImageResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(pageTitle)}&prop=pageimages&format=json&pithumbsize=400&origin=*`
                    );
                    const wikiImageData = await wikiImageResponse.json();

                    const pages = wikiImageData.query?.pages;
                    if (pages) {
                        const page = Object.values(pages)[0];
                        if (page.thumbnail?.source) {
                            return {
                                name: names.name || names['name:en'] || Object.values(names)[0],
                                description: `Notable feature: ${names.name || ''}`,
                                wikipedia_image: page.thumbnail.source,
                                wikipedia_url: `https://en.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}`
                            };
                        }
                    }
                }
            }

            const notableTypes = [
            'historic', 'tourism', 'amenity', 'building', 'leisure',
            'man_made', 'natural', 'place_of_worship', 'shop'
            ];

            if (data.category && notableTypes.includes(data.category)) {
                return {
                    name: names.name || names['name:en'] || Object.values(names)[0],
                    description: `${data.category}: ${names.name || ''}`,
                    type: data.category
                };
            }
        }
    } catch (error) {
    console.error("OSM notable feature error:", error);
}

return null;
}

function findNearestTerminal(point, terminals) {
    const [lat, lng] = point;
    let nearest = null;
    let minDistance = Infinity;

    for (const terminal of terminals) {
        if (terminal.lat && terminal.lon) {
            const distance = map.distance([lat, lng], [terminal.lat, terminal.lon]);
            if (distance < 50000 && distance < minDistance) {
                minDistance = distance;
                nearest = {
                    name: terminal.tags?.name || "Ferry Terminal",
                    lat: terminal.lat,
                    lng: terminal.lon,
                    distance: distance
                };
            }
        }
    }

    return nearest;
}

const TRANSPORT_MODELS = {
    walking: {
        baseSpeed: 5000,
        restMultiplier: 3.0,
        fatigueFactor: 0.00001,
        minSpeed: 3500,
        breakInterval: 5000,
        breakDuration: 300
    },
    cycling: {
        baseSpeed: 16000,
        restMultiplier: 4.0,
        fatigueFactor: 0.000005,
        minSpeed: 12000,
        breakInterval: 20000,
        breakDuration: 600
    },
    driving: {
        urbanSpeed: 30000,
        ruralSpeed: 70000,
        highwaySpeed: 105000,
        trafficFactor: 1.3,
        restMultiplier: 1.05,
        nighttimeFactor: 1.1
    }
};

async function calculateSmartTravelTime(distance, mode, start, end, routeGeometry = null) {
    const model = TRANSPORT_MODELS[mode];

    switch(mode) {
        case 'walking':
        case 'cycling':
        return await calculateHumanPoweredTime(distance, mode, start, end, model);

        case 'driving':
        return await calculateDrivingTime(distance, start, end, routeGeometry, model);

        default:
        return (distance / 50000) * 3600;
    }
}

async function calculateHumanPoweredTime(distance, mode, start, end, model) {
    let movingTime = (distance / model.baseSpeed) * 3600;

    if (distance > 100000) {
        const extraDistance = distance - 100000;
        const fatigue = 1 + (extraDistance * model.fatigueFactor);
        movingTime *= fatigue;

        const maxTime = (distance / model.minSpeed) * 3600;
        movingTime = Math.min(movingTime, maxTime);
    }

    const elevationTime = await getElevationAdjustedTime(start, end, mode);
    movingTime = Math.max(movingTime, elevationTime * 0.8);

    let totalTime = movingTime * model.restMultiplier;

    const numBreaks = Math.floor(distance / model.breakInterval);
    totalTime += numBreaks * model.breakDuration;

    return totalTime;
}

async function calculateDrivingTime(distance, start, end, routeGeometry, model) {
    let totalTime = 0;

    if (routeGeometry && routeGeometry.coordinates) {
        if (distance < 50000) {
            totalTime = (distance / model.urbanSpeed) * 3600;
        } else if (distance < 200000) {
        totalTime = (distance / model.ruralSpeed) * 3600;
    } else {
    totalTime = (distance / model.highwaySpeed) * 3600;
}
} else {
const urbanRatio = Math.min(1, 50000 / distance);
const ruralRatio = Math.min(1, (distance - 50000) / 150000);
const highwayRatio = 1 - urbanRatio - ruralRatio;

totalTime = (
(distance * urbanRatio / model.urbanSpeed) +
(distance * ruralRatio / model.ruralSpeed) +
(distance * highwayRatio / model.highwaySpeed)
) * 3600;
}

const trafficData = await getRealTrafficEstimate(start, end);
if (trafficData) {
    const trafficMultiplier = {
        'high': 1.6,
        'medium': 1.3,
        'low': 1.1
    }[trafficData.trafficLevel] || 1.3;

    totalTime *= trafficMultiplier;
} else {
totalTime *= model.trafficFactor;
}

if (distance > 100000) {
    const hoursDriving = totalTime / 3600;
    const restStops = Math.floor(hoursDriving / 2) * 900;
    totalTime += restStops;
}

const now = new Date();
const hour = now.getHours();
if (hour >= 22 || hour <= 6) {
    totalTime *= model.nighttimeFactor;
}

return totalTime;
}

async function getElevationAdjustedTime(start, end, mode) {
    try {
        const response = await fetch(
        `https://api.open-elevation.com/api/v1/lookup?locations=${start[0]},${start[1]}|${end[0]},${end[1]}`
        );
        const data = await response.json();

        if (data.results && data.results.length === 2) {
            const startElev = data.results[0].elevation;
            const endElev = data.results[1].elevation;
            const elevationChange = endElev - startElev;

            let speedMultiplier = 1.0;

            if (mode === 'walking') {
                if (elevationChange > 500) speedMultiplier = 0.5;
                else if (elevationChange > 200) speedMultiplier = 0.7;
                else if (elevationChange > 100) speedMultiplier = 0.85;
                else if (elevationChange < -500) speedMultiplier = 1.2;
                else if (elevationChange < -200) speedMultiplier = 1.1;
            } else if (mode === 'cycling') {
            if (elevationChange > 500) speedMultiplier = 0.6;
            else if (elevationChange > 200) speedMultiplier = 0.8;
            else if (elevationChange > 100) speedMultiplier = 0.9;
            else if (elevationChange < -500) speedMultiplier = 1.3;
            else if (elevationChange < -200) speedMultiplier = 1.15;
        }

        const distance = map.distance(start, end);
        const baseSpeed = mode === 'cycling' ? 16000 : 5000;
        return (distance / (baseSpeed * speedMultiplier)) * 3600;
    }
} catch (error) {}

const distance = map.distance(start, end);
const baseSpeed = mode === 'cycling' ? 16000 : 5000;
return (distance / baseSpeed) * 3600;
}

function getFallbackAirports() {
    return getCommercialAirports();
}

function cityPopulationLookup(city, country) {
    const majorCities = {
        "New York": 8419000,
        "Los Angeles": 3980000,
        "Chicago": 2716000,
        "Houston": 2328000,
        "Phoenix": 1689000,
        "Philadelphia": 1584000,
        "San Antonio": 1547000,
        "San Diego": 1426000,
        "Dallas": 1344000,
        "San Jose": 1035000,
        "London": 8900000,
        "Paris": 2148000,
        "Berlin": 3769000,
        "Madrid": 3223000,
        "Rome": 2873000,
        "Tokyo": 13960000,
        "Beijing": 21540000,
        "Shanghai": 26320000,
        "Delhi": 32941000,
        "Mumbai": 21357000
    };

    return majorCities[city] || 100000;
}

function isMajorCity(city, country) {
    const majorCities = [
    "New York", "Los Angeles", "Chicago", "Houston", "Phoenix",
    "Philadelphia", "San Antonio", "San Diego", "Dallas", "San Jose",
    "London", "Paris", "Berlin", "Madrid", "Rome", "Barcelona",
    "Tokyo", "Beijing", "Shanghai", "Delhi", "Mumbai", "Sydney",
    "Melbourne", "Toronto", "Vancouver", "Montreal", "Mexico City",
    "So Paulo", "Rio de Janeiro", "Buenos Aires", "Cairo", "Johannesburg"
    ];

    return majorCities.includes(city);
}

async function getFlightStatus(departureAirport, arrivalAirport) {
    const flightDistance = map.distance(departureAirport.coordinates, arrivalAirport.coordinates);
    const flightTime = (flightDistance / 750000) * 3600;

    return {
        available: true,
        duration: flightTime,
        airline: "Estimated",
        status: "Estimated"
    };
}

async function calculateSmartFlightRoute(start, end, distance) {
    try {
        const airports = await getAllAirports();

        const startAirports = airports
        .map(airport => ({
            ...airport,
            distance: map.distance(start, airport.coordinates),
            score: calculateAirportScore(airport, start)
        }))
        .filter(a => a.distance < 150000)
        .sort((a, b) => b.score - a.score);

        const endAirports = airports
        .map(a => ({
            ...a,
            distance: map.distance(end, a.coordinates)
        }))
        .filter(a => a.distance < 150000)
        .sort((a, b) => a.distance - b.distance);

        if (startAirports.length === 0 || endAirports.length === 0) return null;

        const startAirport = startAirports[0];
        const endAirport = endAirports[0];

        if (startAirport.code === endAirport.code) return null;

        const airportDistance = map.distance(startAirport.coordinates, endAirport.coordinates);
        if (airportDistance < 500000) return null;

        const flightData = await getFlightStatus(startAirport, endAirport);

        const groundSpeed = 50000;
        const toAirportTime = (startAirport.distance / groundSpeed) * 3600;
        const fromAirportTime = (endAirport.distance / groundSpeed) * 3600;

        const flightTime = flightData.duration || (airportDistance / 750000) * 3600;
        const airportTime = 7200;

        const totalTime = toAirportTime + flightTime + fromAirportTime + airportTime;

        const drivingEstimate = (distance / 80000) * 3600;
        if (totalTime > drivingEstimate * 0.8) return null;

        return {
            id: 'flight',
            icon: 'lucide:plane',
            label: 'Flight',
            duration: totalTime,
            distance: airportDistance,
            geometry: createFlightPath(startAirport.coordinates, endAirport.coordinates),
            steps: [
            {
                distance: startAirport.distance,
                duration: toAirportTime,
                maneuver: { instruction: `Travel to ${startAirport.name}`, type: 'ground' }
            },
            {
                distance: airportDistance,
                duration: flightTime,
                maneuver: { instruction: `Fly to ${endAirport.name}`, type: 'flight' }
            },
            {
                distance: endAirport.distance,
                duration: fromAirportTime,
                maneuver: { instruction: `Travel to destination`, type: 'ground' }
            }
            ],
            airports: { departure: startAirport, arrival: endAirport },
            flightData: flightData,
            realData: true,
            details: `${startAirport.code}  ${endAirport.code}`
        };

    } catch (error) {
    return null;
}
}

function calculateGoogleWalkingTime(km) {
    let effectiveSpeed;

    if (km <= 0.5) {
        effectiveSpeed = 5.0;
    } else if (km <= 1) {
    effectiveSpeed = 4.8;
} else if (km <= 2) {
effectiveSpeed = 4.7;
} else if (km <= 5) {
effectiveSpeed = 4.6;
} else if (km <= 10) {
effectiveSpeed = 4.61;
} else if (km <= 20) {
effectiveSpeed = 4.52;
} else if (km <= 50) {
effectiveSpeed = 4.47;
} else {
effectiveSpeed = 4.47 * (1 - Math.min(0.13, km * 0.00002));
}

let hours = km / effectiveSpeed;

const breakHours = Math.floor(km / 10) * 0.05;
hours += breakHours;

return hours * 3600;
}

function calculateGoogleCyclingTime(km) {
    let effectiveSpeed;

    if (km <= 1) {
        effectiveSpeed = 18.0;
    } else if (km <= 3) {
    effectiveSpeed = 19.0;
} else if (km <= 5) {
effectiveSpeed = 18.5;
} else if (km <= 10) {
effectiveSpeed = 18.2;
} else if (km <= 15) {
effectiveSpeed = 18.92;
} else if (km <= 20) {
effectiveSpeed = 18.5;
} else if (km <= 50) {
effectiveSpeed = 17.8;
} else if (km <= 100) {
effectiveSpeed = 17.5;
} else if (km <= 200) {
effectiveSpeed = 17.4;
} else {
effectiveSpeed = 17.4 * (1 - Math.min(0.08, km * 0.00001));
}

let hours = km / effectiveSpeed;

const breakHours = Math.floor(km / 20) * 0.03;
hours += breakHours;

return hours * 3600;
}

async function calculateGoogleDrivingTime(km, start, end, routeGeometry = null) {

    let baseSpeed;

    if (km <= 1) {
        baseSpeed = 25.0;
    } else if (km <= 2) {
    baseSpeed = 30.0;
} else if (km <= 5) {
baseSpeed = 40.0;
} else if (km <= 10) {
baseSpeed = 47.31;
} else if (km <= 20) {
baseSpeed = 55.0;
} else if (km <= 50) {
baseSpeed = 65.0;
} else if (km <= 100) {
baseSpeed = 75.0;
} else if (km <= 200) {
baseSpeed = 85.0;
} else if (km <= 500) {
baseSpeed = 90.0;
} else if (km <= 1000) {
baseSpeed = 95.0;
} else if (km <= 2000) {
baseSpeed = 98.0;
} else {
baseSpeed = 98.85;
}

let baseHours = km / baseSpeed;

const trafficMult = await getGoogleTrafficMultiplier(start, end);
baseHours *= trafficMult;

baseHours *= getGoogleTimeOfDayMultiplier();

if (routeGeometry) {
    baseHours *= await estimateGoogleRoadMultiplier(routeGeometry, km);
}

if (km > 100) {
    const restMultiplier = 1 + (0.05 * Math.min(1, (km - 100) / 900));
    baseHours *= restMultiplier;
}

return baseHours * 3600;
}

async function getGoogleTrafficMultiplier(start, end) {
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDay();
    const minute = now.getMinutes();

    let multiplier = 1.0;

    if (day >= 1 && day <= 5) {
        if (hour >= 7 && hour < 9) {
            multiplier = 1.35 + (0.1 * (hour - 7) / 2);
            if (hour === 8) multiplier = 1.45;
        }
        else if (hour >= 12 && hour < 13) {
            multiplier = 1.15;
        }
        else if (hour >= 16 && hour < 19) {
            multiplier = 1.4 + (0.1 * (hour - 16) / 3);
            if (hour === 17) multiplier = 1.5;
        }
        else if (hour >= 22 || hour < 6) {
            multiplier = 0.85;
        }
    } else {
    if (hour >= 11 && hour < 15) {
        multiplier = 1.1;
    } else if (hour >= 22 || hour < 6) {
    multiplier = 0.9;
}
}

multiplier *= (0.95 + Math.random() * 0.1);

return Math.max(0.8, Math.min(2.0, multiplier));
}

function getGoogleTimeOfDayMultiplier() {
    const hour = new Date().getHours();

    if (hour >= 22 || hour <= 5) {
        return 0.92;
    } else if (hour >= 13 && hour <= 15) {
    return 1.05;
}
return 1.0;
}

async function estimateGoogleRoadMultiplier(geometry, totalKm) {
    const likelyHighwayPercent = Math.min(0.85, 0.3 + (totalKm * 0.0002));

    const urbanSpeed = 40.0;
    const highwaySpeed = 105.0;

    const weightedSpeed = (urbanSpeed * (1 - likelyHighwayPercent)) +
    (highwaySpeed * likelyHighwayPercent);

    return 90.0 / weightedSpeed;
}

async function calculateGoogleAccurateTime(distance, mode, start, end, routeGeometry = null) {
    const km = distance / 1000;

    switch(mode) {
        case 'walking':
        return calculateGoogleWalkingTime(km);
        case 'cycling':
        return calculateGoogleCyclingTime(km);
        case 'driving':
        return await calculateGoogleDrivingTime(km, start, end, routeGeometry);
        default:
        return (distance / 50000) * 3600;
    }
}

async function calculateRoutes(start, end) {
    const container = document.getElementById('route-options');
    container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">Calculating routes...</div>';

    const routes = [];

    const [trafficData, weatherData] = await Promise.all([
    getRealTrafficEstimate(start, end),
    getRealWeatherAtLocation(start[0], start[1])
    ]);

    const directDistance = map.distance(start, end);

    if (shouldShowFlightRoute(start, end, directDistance)) {
        const flightRoute = await calculateFlightRoute(start, end, directDistance);
        if (flightRoute) {
            routes.push(flightRoute);
        }
    }

    try {
        const drivingResponse = await fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true`)
        .then(res => {
            if (!res.ok) {
                return null;
            }
            return res.json();
        });

        if (drivingResponse?.routes?.[0] && !drivingResponse.message && drivingResponse.code !== "NoRoute") {
            const route = drivingResponse.routes[0];
            const distance = route.distance;
            let duration = route.duration;

            if (trafficData.duration) {
                duration = trafficData.duration;
            } else {
            const trafficLevel = trafficData.trafficLevel;
            if (trafficLevel === 'high') duration = duration * 1.4;
            else if (trafficLevel === 'medium') duration = duration * 1.2;
        }

        const googleDrivingFactor = 0.66;
        const googleDuration = duration * googleDrivingFactor;

        const drivingTime = await calculateGoogleDrivingTime(route.distance / 1000, start, end, route.geometry);

        routes.push({
            id: 'driving',
            icon: 'lucide:car',
            label: 'Driving',
            duration: drivingTime,
            distance: distance,
            geometry: route.geometry,
            steps: processOSRMSteps(route.legs?.[0]?.steps || []),
            traffic: trafficData.trafficLevel,
            weather: weatherData?.conditions,
            realData: true
        });

        const routeDistance = distance;
        const routeGeometry = route.geometry;
        const drivingSteps = route.legs?.[0]?.steps || [];

        const walkingTime = calculateGoogleWalkingTime(routeDistance / 1000, start, end);
        const cyclingTime = calculateGoogleCyclingTime(routeDistance / 1000, start, end);

        const walkingSteps = generateWalkingSteps(drivingSteps, routeDistance, walkingTime);
        const cyclingSteps = generateCyclingSteps(drivingSteps, routeDistance, cyclingTime);

        routes.push({
            id: 'walking',
            icon: 'lucide:footprints',
            label: 'Walking',
            duration: walkingTime,
            distance: routeDistance,
            geometry: routeGeometry,
            steps: walkingSteps,
            realData: true
        });

        routes.push({
            id: 'cycling',
            icon: 'lucide:bike',
            label: 'Cycling',
            duration: cyclingTime,
            distance: routeDistance,
            geometry: routeGeometry,
            steps: cyclingSteps,
            realData: true
        });
    }
} catch(e) {
console.error('Driving route failed:', e);
}

const ferryData = await getFerryRoutes(start, end);
if (ferryData.hasFerry && directDistance > 10000 && directDistance < 500000) {
    const ferrySpeed = 40000;
    const ferryTime = (ferryData.distance / ferrySpeed) * 3600;

    routes.push({
        id: 'ferry',
        icon: 'lucide:ship',
        label: 'Ferry',
        duration: ferryTime,
        distance: ferryData.distance,
        geometry: createStraightPath(start, end),
        steps: [{
            distance: ferryData.distance,
            duration: ferryTime,
            maneuver: {
                instruction: `Take ferry from ${ferryData.terminals.start} to ${ferryData.terminals.end}`,
                type: 'ferry'
            }
        }],
        realData: true
    });
}

container.innerHTML = '';
if (routes.length === 0) {
    container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No routes available</div>';
    return;
}

routes.forEach(route => {
    addRouteCard(route);
});
}

function generateWalkingSteps(drivingSteps, totalDistance, totalTime) {
    if (!drivingSteps || drivingSteps.length === 0) {
        return [{
            distance: totalDistance,
            duration: totalTime,
            maneuver: {
                instruction: "Walk to destination",
                type: "arrive"
            }
        }];
    }

    const walkingSteps = [];
    let accumulatedDistance = 0;
    let accumulatedTime = 0;

    drivingSteps.forEach((step, index) => {
        const stepDistance = step.distance || 0;
        const stepProportion = stepDistance / totalDistance;
        const stepTime = totalTime * stepProportion;

        const walkingInstruction = convertToWalkingInstruction(step);

        walkingSteps.push({
            distance: stepDistance,
            duration: stepTime,
            geometry: step.geometry,
            maneuver: {
                instruction: walkingInstruction,
                type: step.maneuver?.type || "continue",
                modifier: step.maneuver?.modifier || ""
            },
            name: step.name,
            way_points: step.way_points
        });

        accumulatedDistance += stepDistance;
        accumulatedTime += stepTime;
    });

    if (Math.abs(accumulatedDistance - totalDistance) > 100) {
        const lastStep = walkingSteps[walkingSteps.length - 1];
        lastStep.distance = lastStep.distance + (totalDistance - accumulatedDistance);
        lastStep.duration = lastStep.duration + (totalTime - accumulatedTime);
    }

    walkingSteps.push({
        distance: 0,
        duration: 0,
        maneuver: {
            instruction: "Arrive at destination",
            type: "arrive"
        }
    });

    return walkingSteps;
}

function generateCyclingSteps(drivingSteps, totalDistance, totalTime) {
    if (!drivingSteps || drivingSteps.length === 0) {
        return [{
            distance: totalDistance,
            duration: totalTime,
            maneuver: {
                instruction: "Cycle to destination",
                type: "arrive"
            }
        }];
    }

    const cyclingSteps = [];
    let accumulatedDistance = 0;
    let accumulatedTime = 0;

    drivingSteps.forEach((step, index) => {
        const stepDistance = step.distance || 0;
        const stepProportion = stepDistance / totalDistance;
        const stepTime = totalTime * stepProportion;

        const cyclingInstruction = convertToCyclingInstruction(step);

        cyclingSteps.push({
            distance: stepDistance,
            duration: stepTime,
            geometry: step.geometry,
            maneuver: {
                instruction: cyclingInstruction,
                type: step.maneuver?.type || "continue",
                modifier: step.maneuver?.modifier || ""
            },
            name: step.name,
            way_points: step.way_points
        });

        accumulatedDistance += stepDistance;
        accumulatedTime += stepTime;
    });

    if (Math.abs(accumulatedDistance - totalDistance) > 100) {
        const lastStep = cyclingSteps[cyclingSteps.length - 1];
        lastStep.distance = lastStep.distance + (totalDistance - accumulatedDistance);
        lastStep.duration = lastStep.duration + (totalTime - accumulatedTime);
    }

    cyclingSteps.push({
        distance: 0,
        duration: 0,
        maneuver: {
            instruction: "Arrive at destination",
            type: "arrive"
        }
    });

    return cyclingSteps;
}

function convertToWalkingInstruction(step) {
    const maneuver = step.maneuver;
    if (!maneuver) return "Continue walking";

    const streetName = step.name || "";
    const baseInstruction = maneuver.instruction || "";

    switch(maneuver.type) {
        case 'depart':
        return streetName ? `Start walking toward ${streetName}` : "Start walking";
        case 'turn':
        if (maneuver.modifier === 'left') {
            return streetName ? `Turn left onto ${streetName}` : "Turn left";
        } else if (maneuver.modifier === 'right') {
        return streetName ? `Turn right onto ${streetName}` : "Turn right";
    } else if (maneuver.modifier === 'sharp left') {
    return streetName ? `Take sharp left onto ${streetName}` : "Take sharp left";
} else if (maneuver.modifier === 'sharp right') {
return streetName ? `Take sharp right onto ${streetName}` : "Take sharp right";
} else if (maneuver.modifier === 'slight left') {
return streetName ? `Bear left onto ${streetName}` : "Bear left";
} else if (maneuver.modifier === 'slight right') {
return streetName ? `Bear right onto ${streetName}` : "Bear right";
} else if (maneuver.modifier === 'uturn') {
return "Make a U-turn";
}
return streetName ? `Turn onto ${streetName}` : "Turn";
case 'continue':
return streetName ? `Continue on ${streetName}` : "Continue straight";
case 'roundabout':
const exitNumber = maneuver.exit || 1;
const ordinal = getOrdinal(exitNumber);
return streetName ? `Take ${ordinal} exit onto ${streetName}` : `Take ${ordinal} exit`;
case 'merge':
return streetName ? `Merge onto ${streetName}` : "Merge";
case 'fork':
if (maneuver.modifier === 'left') {
    return streetName ? `Keep left onto ${streetName}` : "Keep left at fork";
} else if (maneuver.modifier === 'right') {
return streetName ? `Keep right onto ${streetName}` : "Keep right at fork";
}
return streetName ? `At fork, continue onto ${streetName}` : "Continue at fork";
case 'off ramp':
return streetName ? `Take exit for ${streetName}` : "Take exit";
case 'on ramp':
return streetName ? `Take ramp onto ${streetName}` : "Take ramp";
case 'end of road':
if (maneuver.modifier === 'left') {
    return streetName ? `At end of road, turn left onto ${streetName}` : "Turn left at end of road";
} else if (maneuver.modifier === 'right') {
return streetName ? `At end of road, turn right onto ${streetName}` : "Turn right at end of road";
}
return streetName ? `At end of road, continue onto ${streetName}` : "Continue at end of road";
default:
return baseInstruction.replace(/Drive|Car/g, "Walk").replace(/driving/gi, "walking");
}
}

function convertToCyclingInstruction(step) {
    const maneuver = step.maneuver;
    if (!maneuver) return "Continue cycling";

    const streetName = step.name || "";
    const baseInstruction = maneuver.instruction || "";

    switch(maneuver.type) {
        case 'depart':
        return streetName ? `Start cycling toward ${streetName}` : "Start cycling";
        case 'turn':
        if (maneuver.modifier === 'left') {
            return streetName ? `Turn left onto ${streetName}` : "Turn left";
        } else if (maneuver.modifier === 'right') {
        return streetName ? `Turn right onto ${streetName}` : "Turn right";
    } else if (maneuver.modifier === 'sharp left') {
    return streetName ? `Take sharp left onto ${streetName}` : "Take sharp left";
} else if (maneuver.modifier === 'sharp right') {
return streetName ? `Take sharp right onto ${streetName}` : "Take sharp right";
} else if (maneuver.modifier === 'slight left') {
return streetName ? `Bear left onto ${streetName}` : "Bear left";
} else if (maneuver.modifier === 'slight right') {
return streetName ? `Bear right onto ${streetName}` : "Bear right";
} else if (maneuver.modifier === 'uturn') {
return "Make a U-turn";
}
return streetName ? `Turn onto ${streetName}` : "Turn";
case 'continue':
return streetName ? `Continue on ${streetName}` : "Continue straight";
case 'roundabout':
const exitNumber = maneuver.exit || 1;
const ordinal = getOrdinal(exitNumber);
return streetName ? `Take ${ordinal} exit onto ${streetName}` : `Take ${ordinal} exit`;
case 'merge':
return streetName ? `Merge onto ${streetName}` : "Merge";
case 'fork':
if (maneuver.modifier === 'left') {
    return streetName ? `Keep left onto ${streetName}` : "Keep left at fork";
} else if (maneuver.modifier === 'right') {
return streetName ? `Keep right onto ${streetName}` : "Keep right at fork";
}
return streetName ? `At fork, continue onto ${streetName}` : "Continue at fork";
case 'off ramp':
return streetName ? `Take exit for ${streetName}` : "Take exit";
case 'on ramp':
return streetName ? `Take ramp onto ${streetName}` : "Take ramp";
case 'end of road':
if (maneuver.modifier === 'left') {
    return streetName ? `At end of road, turn left onto ${streetName}` : "Turn left at end of road";
} else if (maneuver.modifier === 'right') {
return streetName ? `At end of road, turn right onto ${streetName}` : "Turn right at end of road";
}
return streetName ? `At end of road, continue onto ${streetName}` : "Continue at end of road";
case 'arrive':
return "Arrive at destination";
default:
return baseInstruction.replace(/Drive|Car/g, "Cycle").replace(/driving/gi, "cycling");
}
}

function initMap() {
    if (typeof L === 'undefined') {
        console.error('Cannot init map');
        return false;
    }
    
    try {
        map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            maxBounds: [[-85, -10000], [85, 10000]],
            maxBoundsViscosity: 1.0,
            worldCopyJump: true,
            minZoom: 3
        }).setView([40.7128, -74.0060], 2);

        darkBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            className: 'dark-layer',
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        });

        initializeLeafletObjects();

        if (routeLayer) routeLayer.addTo(map);
        if (userMarker) userMarker.addTo(map);
        
        return true;
    } catch (error) {
        console.error('Map initialization failed:', error);
        return false;
    }
}

function setupMapEvents() {
    if (!map) return;

    map.off('click');

    map.on('click', (e) => {
        if (isNavigating) return;

        if (isMapClickModeActive) {
            return;
        } else {
        triggerAnalysis(e.latlng.lat, e.latlng.lng);
        hideSearchResults();
    }
});

map.on('mousemove', (e) => {
    document.getElementById('hud-coords').innerText =
    `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
});

map.on('move', () => {
    hideSearchResults();
});
}

function toggleStartPanel(e) {
    e.stopPropagation();
    const expanded = document.getElementById('custom-start-expanded');
    const searchResults = document.getElementById('results');
    const customSearchResults = document.getElementById('custom-start-search-results');

    if (searchResults && !searchResults.classList.contains('hidden')) {
        hideSearchResults();
    }

    if (customSearchResults && customSearchResults.style.display === 'block') {
        customSearchResults.style.display = 'none';
    }

    if (expanded.style.display === 'block') {
        expanded.style.display = 'none';
    } else {
    expanded.style.display = 'block';

    expanded.style.maxHeight = '400px';

    const panelRect = expanded.getBoundingClientRect();
    const viewportHeight = window.innerHeight;

    if (panelRect.bottom > viewportHeight - 10) {
        const availableHeight = viewportHeight - panelRect.top - 20;
        expanded.style.maxHeight = Math.max(150, availableHeight) + 'px';
    }
}
}

function initURLParameters() {
    const urlParams = new URLSearchParams(window.location.search);

    if (!map) {
        const checkMapInterval = setInterval(() => {
            if (map) {
                clearInterval(checkMapInterval);
                initURLParameters();
            }
        }, 100);
        return;
    }
    
    if (urlParams.has('share') || urlParams.has('destination')) {
        setTimeout(() => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.body.classList.add('ui-ready');
            }, 500);
        }, 1000);
    }
    
    if (urlParams.has('share')) {
        const shareData = urlParams.get('share').split(';');
        if (shareData.length >= 2) {
            const startCoords = shareData[0].split(',').map(Number);
            const endCoords = shareData[1].split(',').map(Number);
            
            if (isNaN(startCoords[0]) || isNaN(startCoords[1]) || isNaN(endCoords[0]) || isNaN(endCoords[1])) {
                showToast(`Invalid share link`, 4000);
                return;
            }
            
            const mapType = urlParams.get('type') || 'osm';
            
            if (mapType === 'satellite' && !map.hasLayer(satLayer)) {
                satLayer.addTo(map);
            }
            
            setTimeout(() => {
                customStartPos = startCoords;
                customStartMode = 'map';
                
                if (customStartMarker) {
                    map.removeLayer(customStartMarker);
                }
                
                customStartMarker = L.marker(startCoords, {
                    icon: L.divIcon({
                        className: 'custom-start-marker',
                        html: '<div style="background: #f59e0b; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(245,158,11,0.5);"></div>',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    })
                }).addTo(map);
                
                document.getElementById('current-start-mode').textContent = 'Click on Map';
                document.getElementById('start-point-coords').textContent = 
                    `${startCoords[0].toFixed(4)}, ${startCoords[1].toFixed(4)}`;
                
                document.querySelector('.start-mode-btn[data-mode="map"]').classList.add('active');
                document.querySelector('.start-mode-btn[data-mode="current"]').classList.remove('active');
                
                triggerAnalysis(endCoords[0], endCoords[1]);
                
                showToast(`Shared route loaded`, 3000);
            }, 2000);
        } else {
            showToast(`Invalid share link format`, 4000);
        }
        return;
    }
    
    if (urlParams.has('destination')) {
        const destCoords = urlParams.get('destination').split(',').map(Number);
        
        if (isNaN(destCoords[0]) || isNaN(destCoords[1])) {
            showToast(`Invalid destination link`, 4000);
            return;
        }
        
        const mapType = urlParams.get('type') || 'osm';
        
        if (mapType === 'satellite' && !map.hasLayer(satLayer)) {
            satLayer.addTo(map);
        }
        
        setTimeout(() => {
            customStartMode = 'current';
            customStartPos = null;
            
            if (customStartMarker && map.hasLayer(customStartMarker)) {
                map.removeLayer(customStartMarker);
            }
            
            document.querySelector('.start-mode-btn[data-mode="current"]').classList.add('active');
            document.querySelector('.start-mode-btn[data-mode="map"]').classList.remove('active');
            document.getElementById('current-start-mode').textContent = 'Current Location';
            
            triggerAnalysis(destCoords[0], destCoords[1]);
            
            showToast(`Destination loaded`, 3000);
        }, 2000);
    }
}

function generateShareURL() {
    if (!selectedTarget) {
        showToast(`No destination selected`, 3000);
        return;
    }
    
    const start = getCurrentStartPoint();
    const end = selectedTarget;
    
    const shareString = `${start[0].toFixed(6)},${start[1].toFixed(6)};${end[0].toFixed(6)},${end[1].toFixed(6)}`;
    const mapType = map.hasLayer(satLayer) ? 'satellite' : 'osm';
    
    const url = new URL(window.location.href);
    url.searchParams.set('share', shareString);
    url.searchParams.set('type', mapType);
    
    navigator.clipboard.writeText(url.toString()).then(() => {
        showToast(`Share link copied to clipboard`, 3000);
        window.history.replaceState({}, '', url.toString());
    }).catch(() => {
        showToast(`Failed to copy link`, 3000);
    });
}

function generateDestinationURL() {
    if (!lastViewedDestination) {
        showToast(`No destination viewed yet`, 3000);
        return;
    }
    
    const dest = lastViewedDestination;
    const mapType = map.hasLayer(satLayer) ? 'satellite' : 'osm';
    const baseUrl = window.location.origin + window.location.pathname;
    const url = `${baseUrl}?destination=${dest[0].toFixed(6)},${dest[1].toFixed(6)}&type=${mapType}`;
    
    navigator.clipboard.writeText(url.toString()).then(() => {
        showToast(`Destination link copied to clipboard`, 3000);
        window.history.replaceState({}, '', url.toString());
    }).catch(() => {
        showToast(`Failed to copy link`, 3000);
    });
}

let activeToast = null;

function showToast(message, duration = 3000) {
    if (activeToast) {
        activeToast.style.animation = 'slideDown 0.3s ease forwards';
        setTimeout(() => {
            if (activeToast && activeToast.parentNode) {
                activeToast.parentNode.removeChild(activeToast);
            }
            activeToast = null;
            createNewToast(message, duration);
        }, 300);
    } else {
        createNewToast(message, duration);
    }
}

function createNewToast(message, duration) {
    const toast = document.createElement('div');
    toast.className = 'strike-glass fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[9999] px-5 py-3 flex items-center gap-3 animate-slideUp';
    toast.style.cssText = `
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 100px;
        color: white;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.3px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    `;
    
    let iconName = 'lucide:check-circle';
    let iconColor = 'text-emerald-400';
    
    if (message.includes('') || message.includes('No destination') || message.includes('unavailable')) {
        iconName = 'lucide:alert-triangle';
        iconColor = 'text-yellow-400';
    }
    if (message.includes('') || message.includes('Failed')) {
        iconName = 'lucide:x-circle';
        iconColor = 'text-red-400';
    }
    if (message.includes('') || message.includes('Destination')) {
        iconName = 'lucide:map-pin';
        iconColor = 'text-sky-400';
    }
    if (message.includes('') || message.includes('Share')) {
        iconName = 'lucide:share-2';
        iconColor = 'text-purple-400';
    }
    if (message.includes('')) {
        iconName = 'lucide:refresh-cw';
        iconColor = 'text-blue-400';
    }
    
    const icon = document.createElement('iconify-icon');
    icon.setAttribute('icon', iconName);
    icon.setAttribute('class', `${iconColor} text-lg`);
    
    toast.appendChild(icon);
    toast.appendChild(document.createTextNode(message));
    
    document.body.appendChild(toast);
    activeToast = toast;
    
    setTimeout(() => {
        if (activeToast === toast) {
            toast.style.animation = 'slideDown 0.3s ease forwards';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
                if (activeToast === toast) {
                    activeToast = null;
                }
            }, 300);
        }
    }, duration);
}

const slideAnimations = `
@keyframes slideUp {
    from { transform: translate(-50%, 20px); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}
@keyframes slideDown {
    from { transform: translate(-50%, 0); opacity: 1; }
    to { transform: translate(-50%, 20px); opacity: 0; }
}
.animate-slideUp { animation: slideUp 0.3s ease forwards; }
`;

const styleSheet2 = document.createElement('style');
styleSheet2.textContent = slideAnimations;
document.head.appendChild(styleSheet2);

window.addEventListener('resize', () => {
    const expanded = document.getElementById('custom-start-expanded');
    if (expanded.style.display === 'block') {
        const panelRect = expanded.getBoundingClientRect();
        const viewportHeight = window.innerHeight;

        if (panelRect.bottom > viewportHeight - 10) {
            const availableHeight = viewportHeight - panelRect.top - 20;
            expanded.style.maxHeight = Math.max(150, availableHeight) + 'px';
        } else {
        expanded.style.maxHeight = '400px';
    }
}
});

document.addEventListener('click', (e) => {
    const startPanel = document.getElementById('custom-start-panel');
    const startToggle = document.getElementById('custom-start-toggle');
    const startExpanded = document.getElementById('custom-start-expanded');
    const customStartInput = document.getElementById('custom-start-input');
    const customSearchResults = document.getElementById('custom-start-search-results');

    const isInSearchResults = customSearchResults && customSearchResults.contains(e.target);

    if (startExpanded.style.display === 'block' &&
    !startPanel.contains(e.target) &&
    e.target !== startToggle &&
    e.target !== customStartInput &&
    !isInSearchResults) {
        startExpanded.style.display = 'none';
    }
});

function calculateDynamicHeight() {
    const expanded = document.getElementById('custom-start-expanded');
    if (!expanded || expanded.style.display !== 'block') return;

    const viewportHeight = window.innerHeight;

    const panelRect = expanded.getBoundingClientRect();
    const toggleRect = document.getElementById('custom-start-toggle').getBoundingClientRect();

    const spaceFromTop = toggleRect.top + toggleRect.height + 8;
    const spaceToBottom = viewportHeight - spaceFromTop - 10;

    const maxHeight = Math.max(150, Math.min(400, spaceToBottom));

    expanded.style.maxHeight = `${maxHeight}px`;
    expanded.style.position = 'absolute';
    expanded.style.top = 'calc(100% + 8px)';
    expanded.style.left = '0';
    expanded.style.right = '0';
}

window.addEventListener('resize', calculateDynamicHeight);

document.querySelectorAll('.start-mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        setTimeout(() => calculateDynamicHeight(), 100);
    });
});

const customStartInput = document.getElementById('custom-start-input');
customStartInput.addEventListener('input', () => {
    setTimeout(() => calculateDynamicHeight(), 200);
});

let isMapClickModeActive = false;
let mapClickListener = null;

function setStartMode(mode) {
    const previousMode = customStartMode;
    customStartMode = mode;

    if (mapClickListener) {
        map.off('click', mapClickListener);
        mapClickListener = null;
    }

    isMapClickModeActive = (mode === 'map');

    document.querySelectorAll('.start-mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
            btn.classList.add('active');
        }
    });

    document.getElementById('current-start-mode').textContent =
    mode === 'current' ? 'Current Location' :
    mode === 'map' ? 'Click on Map' :
    'Search for Location';

    if (mode === 'map') {
        if (!customStartPos || previousMode !== 'map') {
            enableMapClickMode();
        } else {
        updateMapModeUI(true);
    }

    map.getContainer().style.cursor = isMapClickModeActive ? 'crosshair' : '';

} else {
disableMapClickMode();
}

const searchContainer = document.getElementById('custom-start-input-container');
const searchResults = document.getElementById('custom-start-search-results');

if (mode === 'search') {
    searchContainer.style.display = 'block';
    searchResults.style.display = 'none';
} else {
searchContainer.style.display = 'none';
searchResults.style.display = 'none';
document.getElementById('custom-start-input').value = '';
}

updateCustomStartMarker();

updateStartPointDisplay();

if (selectedTarget) {
    calculateRoutes(getCurrentStartPoint(), selectedTarget);
}
}

function enableMapClickMode() {
    isMapClickModeActive = true;

    map.getContainer().style.cursor = 'crosshair';
    map.getContainer().classList.add('map-click-mode-active');

    updateMapModeUI(true);

    mapClickListener = (e) => {
        setCustomStartFromMap(e.latlng);

        disableMapClickMode();
    };

    map.on('click', mapClickListener);
}

function disableMapClickMode() {
    isMapClickModeActive = false;
    map.getContainer().style.cursor = '';
    map.getContainer().classList.remove('map-click-mode-active');

    updateMapModeUI(false);

    if (mapClickListener) {
        map.off('click', mapClickListener);
        mapClickListener = null;
    }
}

function updateMapModeUI(isActive) {
    const mapModeBtn = document.querySelector('.start-mode-btn[data-mode="map"]');
    if (!mapModeBtn) return;

    if (isActive) {
        mapModeBtn.style.background = 'rgba(59, 130, 246, 0.3)';
        mapModeBtn.style.borderColor = '#3b82f6';
        mapModeBtn.style.color = '#93c5fd';
        mapModeBtn.innerHTML = `
        <iconify-icon icon="lucide:map-pin"></iconify-icon>
        Click on Map <span style="font-size: 9px; opacity: 0.8;">(click map)</span>
        `;
    } else {
    mapModeBtn.style.background = '';
    mapModeBtn.style.borderColor = '';
    mapModeBtn.style.color = '';
    mapModeBtn.innerHTML = `
    <iconify-icon icon="lucide:map-pin"></iconify-icon>
    Click on Map
    `;
}
}

function showClickHighlight(latlng) {
    removeClickHighlight();

    window.clickHighlight = L.circleMarker(latlng, {
        radius: 15,
        color: '#3b82f6',
        weight: 3,
        opacity: 0.8,
        fillColor: '#3b82f6',
        fillOpacity: 0.2,
        className: 'click-highlight'
    }).addTo(map);

    setTimeout(() => {
        removeClickHighlight();
    }, 1500);
}

function removeClickHighlight() {
    if (window.clickHighlight) {
        map.removeLayer(window.clickHighlight);
        window.clickHighlight = null;
    }
}

function setCustomStartFromMap(latlng) {
    customStartPos = [latlng.lat, latlng.lng];

    customStartMode = 'map';

    updateCustomStartMarker();

    showClickHighlight(latlng);

    fetch(`https://photon.komoot.io/reverse?lon=${latlng.lng}&lat=${latlng.lat}&limit=1`)
    .then(res => res.json())
    .then(data => {
        if (data.features && data.features.length > 0) {
            const p = data.features[0].properties || {};
            const address = [p.street, p.city, p.country].filter(Boolean).join(', ') ||
            `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
            document.getElementById('start-point-coords').textContent = address;
        } else {
        document.getElementById('start-point-coords').textContent =
        `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
    }
})
.catch(() => {
    document.getElementById('start-point-coords').textContent =
    `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
});

if (selectedTarget) {
    calculateRoutes(customStartPos, selectedTarget);
}

map.flyTo(latlng, 15, {
    animate: true,
    duration: 0.5
});
}

function searchCustomStartLocation(query) {
    if (!query || query.trim().length < 2) {
        const container = document.getElementById('custom-start-search-results');
        container.style.display = 'none';
        return;
    }

    fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=10`)
    .then(res => res.json())
    .then(data => {
        const results = data.features || [];
        const container = document.getElementById('custom-start-search-results');

        if (results.length === 0) {
            container.innerHTML = '<div class="text-xs text-neutral-500 p-2 text-center">No results found</div>';
            container.style.display = 'block';
            return;
        }

        let html = '';
        results.forEach(result => {
            const props = result.properties;
            const name = props.name || props.street || props.city || "Unnamed Location";
            const details = [props.housenumber, props.street, props.city, props.country]
            .filter(Boolean)
            .join(', ') || 'Coordinates';

            html += `
            <div class="search-result" data-lat="${result.geometry.coordinates[1]}" data-lng="${result.geometry.coordinates[0]}" data-name="${name}">
                <div class="text-[11px] font-bold text-white mb-1">${name}</div>
                <div class="text-[9px] text-neutral-400">${details}</div>
            </div>
            `;
        });

        container.innerHTML = html;
        container.style.display = 'block';

        const expanded = document.getElementById('custom-start-expanded');
        const expandedRect = expanded.getBoundingClientRect();
        const viewportHeight = window.innerHeight;

        const resultsHeight = Math.min(150, viewportHeight - expandedRect.top - 180);
        container.style.maxHeight = resultsHeight + 'px';

        document.querySelectorAll('#custom-start-search-results .search-result').forEach(item => {
            item.addEventListener('click', () => {
                const lat = parseFloat(item.dataset.lat);
                const lng = parseFloat(item.dataset.lng);
                const name = item.dataset.name;

                customStartPos = [lat, lng];
                customStartMode = 'search';
                updateCustomStartMarker();

                document.getElementById('start-point-coords').textContent = name;

                container.style.display = 'none';
                document.getElementById('custom-start-input').value = name;

                if (selectedTarget) {
                    calculateRoutes(customStartPos, selectedTarget);
                }

                map.flyTo([lat, lng], 14, { animate: true, duration: 1 });
            });
        });
    })
    .catch(error => {});
}

function updateCustomStartMarker() {
    if (map.hasLayer(customStartMarker)) {
        map.removeLayer(customStartMarker);
    }

    if (customStartMode !== 'current' && customStartPos) {
        customStartMarker.setLatLng(customStartPos);
        customStartMarker.addTo(map);
    }
}

function updateStartPointDisplay() {
    let displayText = '';

    if (customStartMode === 'current') {
        displayText = 'Your current location';
    } else if (customStartMode === 'map' && customStartPos) {
    displayText = `${customStartPos[0].toFixed(4)}, ${customStartPos[1].toFixed(4)}`;
} else if (customStartMode === 'search' && customStartPos) {
displayText = document.getElementById('start-point-coords').textContent;
} else {
displayText = 'Your current location';
}

document.getElementById('start-point-coords').textContent = displayText;
}

function getCurrentStartPoint() {
    if (customStartMode === 'current') {
        return userPos || [40.7128, -74.0060];
    } else if (customStartPos) {
    return customStartPos;
} else {
return userPos || [40.7128, -74.0060];
}
}

window.onload = () => {
    initConnectivityDetection();
    
    if (!checkConnectivityBeforeLoad()) {
        return;
    }
    initMap();

    document.getElementById('custom-start-toggle').addEventListener('click', toggleStartPanel);

    document.querySelectorAll('.start-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;

            if (mode === 'map') {
                if (customStartMode === 'map' && !isMapClickModeActive) {
                    enableMapClickMode();
                    return;
                }

                if (customStartMode === 'map' && isMapClickModeActive) {
                    setStartMode('current');
                    disableMapClickMode();
                    return;
                }

                setStartMode('map');

            } else {
            setStartMode(mode);
            disableMapClickMode();
        }
    });
});

const customStartInput = document.getElementById('custom-start-input');
let customSearchTimeout;
customStartInput.addEventListener('input', (e) => {
    clearTimeout(customSearchTimeout);
    customSearchTimeout = setTimeout(() => {
        searchCustomStartLocation(e.target.value);
    }, 500);
});

customStartInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchCustomStartLocation(e.target.value);
    }
});

setTimeout(() => {
    if (navigator.geolocation && !isLocationRequested) {
        isLocationRequested = true;
        document.getElementById('status-text').innerText = "Acquiring Signal";

        navigator.geolocation.getCurrentPosition(
        (pos) => {
            userPos = [pos.coords.latitude, pos.coords.longitude];
            userMarker.setLatLng(userPos);
            const urlParams = new URLSearchParams(window.location.search);
            const hasShareParam = urlParams.has('share');
            const hasDestinationParam = urlParams.has('destination');
            
            if (!hasShareParam && !hasDestinationParam) {
                map.setView(userPos, 14);
            }

            document.getElementById('hud-precision').innerText = `${pos.coords.accuracy.toFixed(0)}m`;
            document.getElementById('status-text').innerText = "Located";
            document.getElementById('hud-coords').innerText = `${userPos[0].toFixed(4)}, ${userPos[1].toFixed(4)}`;

            updateStartPointDisplay();

            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.body.classList.add('ui-ready');
                setupMapEvents();

                setTimeout(() => {
                    startContinuousGPS();
                }, 1000);
            }, 500);
        },
        (error) => {
            userPos = [40.7128, -74.0060];
            userMarker.setLatLng(userPos);
            map.setView(userPos, 2);
            document.getElementById('status-text').innerText = "GPS Unavailable";

            updateStartPointDisplay();
            if (navigator.onLine) {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.body.classList.add('ui-ready');
                    setupMapEvents();
                }, 500);
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 60000,
            maximumAge: 0
        }
        );
    } else {
    userPos = [40.7128, -74.0060];
    userMarker.setLatLng(userPos);
    map.setView(userPos, 2);

    updateStartPointDisplay();
    if (navigator.onLine) {
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            document.body.classList.add('ui-ready');
            setupMapEvents();
        }, 500);
    }
}
}, 2000);
};

function startContinuousGPS() {
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }

    watchId = navigator.geolocation.watchPosition(
    (pos) => {
        userPos = [pos.coords.latitude, pos.coords.longitude];

        userMarker.setLatLng(userPos);

        if (customStartMode === 'current') {
            updateStartPointDisplay();
        }

        if (!isNavigating) {
            document.getElementById('hud-precision').innerText = `${pos.coords.accuracy.toFixed(0)}m`;
            document.getElementById('hud-coords').innerText =
            `${userPos[0].toFixed(4)}, ${userPos[1].toFixed(4)}`;
        }

        if (isNavigating && currentNavRoute) {
            checkNavigationProgress(pos);
        }
    },
    (error) => {},
    {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 15000
    }
    );
}

function stripAllHTML(input = '') {
    if (typeof input !== 'string') return '';
    const div = document.createElement('div');
    div.innerHTML = input;
    return (div.textContent || '')
    .replace(/\u00A0/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

let lastViewedDestination = null;

async function triggerAnalysis(lat, lng) {
    if (destinationMarker && map.hasLayer(destinationMarker)) {
        map.removeLayer(destinationMarker);
    }

    selectedTarget = [lat, lng];
    lastViewedDestination = [lat, lng];
    const sidebar = document.getElementById('info-sidebar');
    sidebar.classList.add('active');
    routeLayer.clearLayers();
    document.getElementById('start-nav-btn').classList.add('hidden');
    updateDestinationMarker(lat, lng);

    document.getElementById('side-title').innerText = "Processing...";

    try {
        const res = await fetch(`https://photon.komoot.io/reverse?lon=${lng}&lat=${lat}&limit=1`);
        const data = await res.json();

        if (data.features && data.features.length > 0) {
            const p = data.features[0].properties || {};
            const locationName = p.name || p.street || "Selected Location";

            const addressDetails = {
                city: p.city || '',
                country: p.country || '',
                street: p.street || '',
                housenumber: p.housenumber || '',
                postcode: p.postcode || '',
                county: p.county || '',
                state: p.state || '',
                region: p.region || p.state || '',
                countrycode: p.countrycode || '',
                osm_key: p.osm_key || '',
                osm_value: p.osm_value || '',
                type: p.type || ''
            };

            let imageData = null;
            try {
                imageData = await getLocationImages(lat, lng, locationName, addressDetails);
                console.log("Image data received:", imageData);

                window.currentLocationImages = imageData.images || [];
                console.log("global store:", window.currentLocationImages.length);
            } catch (error) {
            console.error("Failed to fetch images:", error);
            imageData = { mainImage: null, images: [], total: 0 };
            window.currentLocationImages = [];
        }

        const mainImage = imageData?.mainImage;
        const mainImageDescription = mainImage?.description || '';
        const cleanDescription = stripAllHTML(mainImageDescription);
        const truncatedDescription = cleanDescription.substring(0, 200) + (cleanDescription.length > 200 ? '...' : '');
        const safeWikiUrl = mainImage?.wikipediaUrl ? encodeURI(mainImage.wikipediaUrl) : null;

        document.getElementById('side-title').innerText = locationName;

        const addressParts = [p.street, p.city, p.country, p.postcode].filter(Boolean);
        const addressString = addressParts.length > 0 ?
        addressParts.join(', ') :
        `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        let sidebarHTML = `
        <div class="space-y-6">
            ${mainImage && mainImage.image ? `
            <div class="relative h-48 rounded-xl overflow-hidden cursor-pointer"
            onclick="window.openCurrentImageGallery('${locationName.replace(/'/g, "\\'")}')">
            <img src="${mainImage.image}"
            class="w-full h-full object-cover"
            alt="${locationName}"
            onerror="this.style.display='none'; this.parentElement.style.display='none';">
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-4">
                ${mainImage.source ? `
                <div class="flex items-center gap-2 mb-2">
                    <iconify-icon icon="lucide:camera" class="text-white/70 text-sm"></iconify-icon>
                    <span class="text-xs text-white/70">${mainImage.source}</span>
                </div>
                ` : ''}
                <h3 class="text-lg font-bold text-white">${locationName}</h3>
                ${imageData.images && imageData.images.length > 1 ? `
                <div class="mt-1 text-xs text-sky-300 flex items-center gap-1">
                    <iconify-icon icon="lucide:image" class="text-[10px]"></iconify-icon>
                    View ${imageData.images.length} photos
                </div>
                ` : ''}
            </div>
        </div>
        ` : `
        <div class="h-32 rounded-xl bg-gradient-to-br from-gray-900 to-black border border-white/10 flex items-center justify-center">
            <div class="text-center">
                <iconify-icon icon="lucide:map-pin" class="text-3xl text-white/30 mb-2"></iconify-icon>
                <div class="text-sm text-white/50">${locationName}</div>
            </div>
        </div>
        `}

        ${mainImageDescription ? `
        <div class="space-y-2">
            <div class="flex items-center gap-2">
                <iconify-icon icon="lucide:info" class="text-neutral-500"></iconify-icon>
                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">About [May be irrelevant]</span>
            </div>
            <p class="text-xs text-neutral-300 leading-relaxed line-clamp-3">${truncatedDescription}</p>
            ${safeWikiUrl ? `
            <a href="${safeWikiUrl}" target="_blank" class="inline-flex items-center gap-1 text-xs text-sky-400 hover:text-sky-300 mt-1">
            <iconify-icon icon="lucide:external-link" class="text-[10px]"></iconify-icon>
            Read more on Wikipedia
            </a>
            ` : ''}
        </div>
        ` : ''}

        <div class="space-y-2">
            <div class="flex items-center gap-2">
                <iconify-icon icon="lucide:map-pin" class="text-neutral-500"></iconify-icon>
                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Address</span>
            </div>
            <p class="text-xs text-neutral-300 leading-relaxed">${addressString}</p>
            <button onclick="copyToClipboard('${addressString.replace(/'/g, "\\'")}', event)"
            class="inline-flex items-center gap-1 text-xs text-emerald-400 hover:text-emerald-300 mt-1">
            <iconify-icon icon="lucide:copy" class="text-[10px]"></iconify-icon>
            Copy Address
            </button>
        </div>

        <div id="logistics-module">
            <div class="flex items-center gap-2 mb-4">
                <iconify-icon icon="lucide:route" class="text-neutral-500"></iconify-icon>
                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Routes</span>
            </div>
            <div id="route-options" class="flex flex-col gap-2"></div>
        </div>
    </div>
    `;

    document.getElementById('sidebar-content').innerHTML = sidebarHTML;

    updateDestinationMarker(lat, lng, locationName);

    document.getElementById('sidebar-share-btn').classList.remove('hidden');
    document.getElementById('sidebar-share-btn').style.display = 'flex';

} else {
const imageData = await getLocationImages(lat, lng, "Location");

document.getElementById('side-title').innerText = "Location";
document.getElementById('sidebar-content').innerHTML = `
<div class="space-y-6">
    ${imageData.image ? `
    <div class="relative h-48 rounded-xl overflow-hidden">
        <img src="${imageData.image}"
        class="w-full h-full object-cover"
        alt="Location"
        onerror="this.style.display='none'; this.parentElement.style.display='none';">
        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-4">
            <h3 class="text-lg font-bold text-white">Selected Location</h3>
        </div>
    </div>
    ` : `
    <div class="h-32 rounded-xl bg-gradient-to-br from-gray-900 to-black border border-white/10 flex items-center justify-center">
        <div class="text-center">
            <iconify-icon icon="lucide:map-pin" class="text-3xl text-white/30 mb-2"></iconify-icon>
            <div class="text-sm text-white/50">Selected Location</div>
        </div>
    </div>
    `}

    <div class="space-y-2">
        <div class="flex items-center gap-2">
            <iconify-icon icon="lucide:map-pin" class="text-neutral-500"></iconify-icon>
            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Coordinates</span>
        </div>
        <p class="text-xs text-neutral-300 leading-relaxed">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
        <button onclick="copyToClipboard('${lat.toFixed(6)}, ${lng.toFixed(6)}')"
        class="inline-flex items-center gap-1 text-xs text-emerald-400 hover:text-emerald-300 mt-1">
        <iconify-icon icon="lucide:copy" class="text-[10px]"></iconify-icon>
        Copy Coordinates
        </button>
    </div>

    <div id="logistics-module">
        <div class="flex items-center gap-2 mb-4">
            <iconify-icon icon="lucide:route" class="text-neutral-500"></iconify-icon>
            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Routes</span>
        </div>
        <div id="route-options" class="flex flex-col gap-2"></div>
    </div>
</div>
`;

document.getElementById('sidebar-share-btn').classList.remove('hidden');
document.getElementById('sidebar-share-btn').style.display = 'flex';
}
} catch (error) {
console.error("Analysis failed:", error);
document.getElementById('side-title').innerText = "Target Location";
document.getElementById('sidebar-content').innerHTML = `
<div class="space-y-6">
    <div class="h-32 rounded-xl bg-gradient-to-br from-gray-900 to-black border border-white/10 flex items-center justify-center">
        <div class="text-center">
            <iconify-icon icon="lucide:map-pin" class="text-3xl text-white/30 mb-2"></iconify-icon>
            <div class="text-sm text-white/50">Selected Location</div>
        </div>
    </div>

    <div class="space-y-2">
        <div class="flex items-center gap-2">
            <iconify-icon icon="lucide:map-pin" class="text-neutral-500"></iconify-icon>
            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Coordinates</span>
        </div>
        <p class="text-xs text-neutral-300 leading-relaxed">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
    </div>

    <div id="logistics-module">
        <div class="flex items-center gap-2 mb-4">
            <iconify-icon icon="lucide:route" class="text-neutral-500"></iconify-icon>
            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Routes via Engine</span>
        </div>
        <div id="route-options" class="flex flex-col gap-2"></div>
    </div>
</div>
`;
}

    const url = new URL(window.location.href);
    url.searchParams.set('destination', `${lat.toFixed(6)},${lng.toFixed(6)}`);
    url.searchParams.set('type', map.hasLayer(satLayer) ? 'satellite' : 'osm');
    window.history.replaceState({}, '', url.toString());

calculateRoutes(getCurrentStartPoint(), [lat, lng]);
}

window.openCurrentImageGallery = function(locationName) {
    console.log("openCurrentImageGallery called");
    console.log("window.currentLocationImages:", window.currentLocationImages);
    console.log("window.allImages:", window.allImages);

    const images = window.currentLocationImages ||
    window.allImages ||
    (window.imageData ? window.imageData.images : []) ||
    [];

    console.log("Using images array:", images.length, images);

    if (images.length === 0) {

        const imageContainer = document.querySelector('.location-image-container');
        if (imageContainer) {
            console.log("Found image container, but no global images");
        }
    }

    openGalleryModal(images, locationName);
};

function copyToClipboard(text, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    let button;
    if (event && event.currentTarget) {
        button = event.currentTarget;
    } else if (event && event.target) {
    button = event.target.closest('button');
}

if (!button && event) {
    let element = event.target;
    while (element && element !== document.body) {
        if (element.tagName === 'BUTTON') {
            button = element;
            break;
        }
        element = element.parentElement;
    }
}

if (!button) {
    const buttons = document.querySelectorAll('button');
    for (let i = buttons.length - 1; i >= 0; i--) {
        if (buttons[i].textContent.includes('Copy')) {
            button = buttons[i];
            break;
        }
    }
}

let originalHTML = null;
let originalClasses = null;

if (button) {
    originalHTML = button.innerHTML;
    originalClasses = Array.from(button.classList);

    button.innerHTML = `
    <iconify-icon icon="lucide:check" class="text-[10px]"></iconify-icon>
    Copied!
    `;
    button.classList.remove('text-emerald-400', 'hover:text-emerald-300');
    button.classList.add('text-green-400');

    button.disabled = true;
}

navigator.clipboard.writeText(text).then(() => {
    console.log('Copied to clipboard:', text);

    if (button) {
        setTimeout(() => {
            if (originalHTML) {
                button.innerHTML = originalHTML;
            }
            if (originalClasses) {
                button.classList.remove('text-green-400');
                originalClasses.forEach(cls => button.classList.add(cls));
            }
            button.disabled = false;
        }, 2000);
    }
}).catch(err => {
console.error('Failed to copy:', err);

if (button) {
    if (originalHTML) {
        button.innerHTML = originalHTML;
    }
    if (originalClasses) {
        button.classList.remove('text-green-400');
        originalClasses.forEach(cls => button.classList.add(cls));
    }
    button.disabled = false;

    button.classList.add('text-red-400');
    setTimeout(() => {
        button.classList.remove('text-red-400');
    }, 1000);
}
});
}

async function fetchGraphHopperRoute(start, end, mode) {
    try {
        const vehicle = mode === 'driving' ? 'car' :
        mode === 'cycling' ? 'bike' : 'foot';

        const response = await fetch(
        `https://graphhopper.com/api/1/route?point=${start[0]},${start[1]}&point=${end[0]},${end[1]}&vehicle=${vehicle}&locale=en&instructions=true&points_encoded=false&key=demo`
        );

        const data = await response.json();

        if (data.paths && data.paths.length > 0) {
            return {
                distance: data.paths[0].distance,
                duration: data.paths[0].time / 1000,
                geometry: {
                    type: "LineString",
                    coordinates: data.paths[0].points.coordinates
                },
                legs: []
            };
        }

        throw new Error('GraphHopper no route');

    } catch (error) {
    throw error;
}
}

async function getICOAirports() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat');
        const data = await response.text();

        const airports = [];
        const lines = data.split('\n');

        for (const line of lines) {
            if (!line.trim()) continue;

            const fields = line.split(',');
            if (fields.length >= 14) {
                const name = fields[1].replace(/"/g, '');
                const city = fields[2].replace(/"/g, '');
                const country = fields[3].replace(/"/g, '');
                const iata = fields[4].replace(/"/g, '');
                const icao = fields[5].replace(/"/g, '');
                const lat = parseFloat(fields[6]);
                const lng = parseFloat(fields[7]);

                if (iata && iata.length === 3 &&
                !isNaN(lat) && !isNaN(lng) &&
                (icao || name.includes('International') || name.includes('Airport'))) {

                    airports.push({
                        code: iata,
                        icao: icao,
                        name: name,
                        city: city,
                        country: country,
                        coordinates: [lat, lng],
                        size: estimateAirportSize(name, city, country)
                    });
                }
            }
        }

        const filteredAirports = airports.filter(airport => {
            const name = airport.name.toLowerCase();
            const isMajor = (
            name.includes('international') ||
            (airport.size === 'large' || airport.size === 'medium') ||
            isMajorCity(airport.city, airport.country)
            );

            const isMilitary = (
            name.includes('air force') ||
            name.includes('space force') ||
            name.includes('naval') ||
            name.includes('army') ||
            name.includes('military') ||
            name.includes('afb') ||
            name.includes('airbase') ||
            airport.code.includes('X') ||
            name.includes('air station')
            );

            return isMajor && !isMilitary;
        });

        return filteredAirports;

    } catch (error) {
    return getVerifiedCommercialAirports();
}
}

function estimateAirportSize(name, city, country) {
    const nameLower = name.toLowerCase();

    if (nameLower.includes('international') ||
    ['JFK', 'LAX', 'LHR', 'CDG', 'DXB', 'SIN', 'HND', 'PEK', 'PVG'].some(code =>
    name.includes(code))) {
        return 'large';
    }

    if (nameLower.includes('regional') ||
    nameLower.includes('municipal') ||
    cityPopulationLookup(city, country) > 500000) {
        return 'medium';
    }

    return 'small';
}

async function isWaterCrossing(startCoords, endCoords) {
    try {
        const [startLat, startLng] = startCoords;
        const [endLat, endLng] = endCoords;
        
        const startCheck = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${startLat}&lon=${startLng}`);
        const startData = await startCheck.json();
        
        const endCheck = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${endLat}&lon=${endLng}`);
        const endData = await endCheck.json();
        
        const startIsWater = startData.error || 
                            (startData.address && (
                                startData.address.sea || 
                                startData.address.ocean || 
                                startData.address.water
                            ));
        
        const endIsWater = endData.error || 
                          (endData.address && (
                              endData.address.sea || 
                              endData.address.ocean || 
                              endData.address.water
                          ));

        const distance = map.distance(startCoords, endCoords) / 1000;
        const isLongDistanceOverWater = distance > 100 && (startIsWater || endIsWater);
        
        const isHawaii = (startLat > 18 && startLat < 23 && startLng > -161 && startLng < -154) ||
                        (endLat > 18 && endLat < 23 && endLng > -161 && endLng < -154);
        
        const isPhilippines = (startLat > 4 && startLat < 21 && startLng > 116 && startLng < 127) ||
                             (endLat > 4 && endLat < 21 && endLng > 116 && endLng < 127);
        
        return startIsWater || endIsWater || isLongDistanceOverWater || isHawaii || isPhilippines;
        
    } catch (error) {
        console.error("error checking if water:", error);
        const distance = map.distance(startCoords, endCoords) / 1000;
        return distance > 500;
    }
}

async function findBestAirportForRoute(startCoords, endCoords) {
    const airports = await getCommercialAirports();

    const startAirports = airports
    .map(airport => ({
        ...airport,
        distance: map.distance(startCoords, airport.coordinates),
        score: calculateAirportScore(airport, startCoords)
    }))
    .filter(a => a.distance < 1500000)
    .sort((a, b) => b.score - a.score);

    const waterCrossing = await isWaterCrossing(startCoords, endCoords);
    console.log(`crosses water: ${waterCrossing}`);

    const endAirports = airports
    .map(airport => ({
        ...airport,
        distance: map.distance(endCoords, airport.coordinates),
        score: calculateAirportScore(airport, endCoords)
    }))
    .filter(a => a.distance < 1500000)
    .sort((a, b) => b.score - a.score);

    if (waterCrossing) {
        if (startAirports.length === 0) {
            const closestStart = airports
                .map(a => ({...a, distance: map.distance(startCoords, a.coordinates)}))
                .sort((a, b) => a.distance - b.distance)[0];
            if (closestStart) startAirports.push(closestStart);
        }
        
        if (endAirports.length === 0) {
            const closestEnd = airports
                .map(a => ({...a, distance: map.distance(endCoords, a.coordinates)}))
                .sort((a, b) => a.distance - b.distance)[0];
            if (closestEnd) endAirports.push(closestEnd);
        }
    }

    if (startAirports.length === 0 || endAirports.length === 0) {
        return null;
    }

    const startAirport = startAirports[0];
    const endAirport = endAirports[0];

    const airportDistance = map.distance(startAirport.coordinates, endAirport.coordinates);
    if (!waterCrossing && airportDistance < 300000) {
        return null;
    }

    return { start: startAirport, end: endAirport };
}

function calculateAirportScore(airport, userCoords) {
    const distance = map.distance(userCoords, airport.coordinates);

    let score = 0;

    if (isMajorInternationalAirport(airport)) {
        score += 500;
    }

    if (airport.size === 'large') score += 200;
    else if (airport.size === 'medium') score += 100;
    else if (airport.size === 'small') score += 50;

    if (airport.name.toLowerCase().includes('international')) {
        score += 150;
    }

    const majorAirportCodes = ['SEA', 'JFK', 'LAX', 'ORD', 'DFW', 'LHR', 'CDG', 'FRA', 'AMS', 'HND', 'PEK', 'PVG'];
    if (majorAirportCodes.includes(airport.code)) {
        score += 300;
    }

    const distancePenalty = distance / 1000;
    score -= distancePenalty;

    return score;
}

function isMajorInternationalAirport(airport) {
    const majorInternationalAirports = [
    'ATL','LAX','ORD','DFW','DEN','JFK','SFO','SEA','LAS','MCO','MIA','CLT','EWR','PHX',
    'IAH','BOS','MSP','DTW','PHL','SAN','TPA','PDX','BWI','IAD','DCA','SJC','OAK',
    'AUS','SAT','DAL','HOU','CLE','CMH','CVG','IND','STL','MCI','SMF','SNA','ONT',
    'BUR','LGB','PSP','RNO','BOI','SLC','ABQ','ELP','TUS','OKC','TUL','OMA','DSM',
    'MSY','BTR','GPT','MOB','BHM','HSV','CHA','TYS','AVL','GSP','CAE','CHS','SAV',
    'JAX','RSW','PBI','FLL','EYW','ORF','RIC','ROA','LYH','GSO','RDU','ILM', 'YYZ','YVR','YUL','YYC','YEG','YOW','YWG','YHZ','YQB','YYT','YXE','YLW', 'MEX','CUN','GDL','MTY','TIJ','SJD','PVR','MZT','HMO','LAP','LHR','LGW','STN','LTN','MAN','EDI','GLA','BHX','BRS','DUB','SNN','ORK','CDG','ORY','NCE','LYS','MRS','TLS','BOD','AMS','BRU','CRL','MAD','BCN','PMI','AGP','ALC','SVQ','BIO','FCO','MXP','LIN','BGY','VCE','NAP','CTA','PMO','BLQ','FCO','MXP','LIN','BGY','VCE','NAP','CTA','PMO','BLQ','ZRH','GVA','BSL','VIE','SZG','INN','ARN','OSL','CPH','HEL','GOT','TRD','SVG','TMP','ATH','SKG','HER','CFU','BEG','ZAG','LJU','SJJ','TIA','SOF','IST','SAW','AYT','ADB','HND','NRT','KIX','ITM','NGO','FUK','CTS','OKA','PEK','PKX','PVG','SHA','CAN','SZX','CTU','XIY','HGH','NKG',
    'WUH','CSX','KMG','URC','TSN','CGO','ICN','GMP','PUS','CJU','SIN','HKG','BKK','DMK','HKT','CNX','DEL','BOM','BLR','MAA','HYD','CCU','COK','TRV','AMD','PNQ','KUL','PEN','CGK','DPS','SUB','MNL','CEB','DVO','TPE','KHH','SGN','HAN','DAD','DXB','DWC','AUH','SHJ','DOH','RUH','JED','DMM','KWI',
    'BAH','MCT','AMM','TLV','BEY','CAI','JNB','CPT','DUR','PLZ','LOS','ABV','ACC','ADD','NBO',
    'DAR','KGL','EBB','CMN','RAK','TUN','ALG','TIP','CAI','GRU','CGH','GIG','BSB','CNF','SSA','REC','FOR',
    'EZE','AEP','COR','MDZ','SCL','LIM','BOG','MDE',
    'UIO','GYE','CCS','PTY','MVD','ASU','LPB','VVI','SYD','MEL','BNE','PER','ADL','CBR','OOL','CNS',
    'AKL','WLG','CHC','ZQN','NAN','PPT'
    ];

    return majorInternationalAirports.includes(airport.code) ||
    airport.name.toLowerCase().includes('international') ||
    airport.size === 'large';
}

function getCommercialAirports() {
    return [
    { code: "ATL", name: "Hartsfield-Jackson Atlanta International", city: "Atlanta", country: "USA", coordinates: [33.6407, -84.4277], size: "large" },
    { code: "LAX", name: "Los Angeles International", city: "Los Angeles", country: "USA", coordinates: [33.9416, -118.4085], size: "large" },
    { code: "ORD", name: "O'Hare International", city: "Chicago", country: "USA", coordinates: [41.9742, -87.9073], size: "large" },
    { code: "DFW", name: "Dallas/Fort Worth International", city: "Dallas", country: "USA", coordinates: [32.8998, -97.0403], size: "large" },
    { code: "DEN", name: "Denver International", city: "Denver", country: "USA", coordinates: [39.8561, -104.6737], size: "large" },
    { code: "JFK", name: "John F. Kennedy International", city: "New York", country: "USA", coordinates: [40.6413, -73.7781], size: "large" },
    { code: "SFO", name: "San Francisco International", city: "San Francisco", country: "USA", coordinates: [37.6213, -122.3790], size: "large" },
    { code: "SEA", name: "Seattle-Tacoma International", city: "Seattle", country: "USA", coordinates: [47.4502, -122.3088], size: "large" },
    { code: "LAS", name: "Harry Reid International", city: "Las Vegas", country: "USA", coordinates: [36.0840, -115.1537], size: "large" },
    { code: "MCO", name: "Orlando International", city: "Orlando", country: "USA", coordinates: [28.4294, -81.3090], size: "large" },
    { code: "MIA", name: "Miami International", city: "Miami", country: "USA", coordinates: [25.7959, -80.2870], size: "large" },
    { code: "CLT", name: "Charlotte Douglas International", city: "Charlotte", country: "USA", coordinates: [35.2140, -80.9431], size: "large" },
    { code: "EWR", name: "Newark Liberty International", city: "Newark", country: "USA", coordinates: [40.6895, -74.1745], size: "large" },
    { code: "PHX", name: "Phoenix Sky Harbor International", city: "Phoenix", country: "USA", coordinates: [33.4343, -112.0081], size: "large" },
    { code: "IAH", name: "George Bush Intercontinental", city: "Houston", country: "USA", coordinates: [29.9844, -95.3414], size: "large" },
    { code: "BOS", name: "Logan International", city: "Boston", country: "USA", coordinates: [42.3643, -71.0052], size: "large" },
    { code: "MSP", name: "Minneapolis-Saint Paul International", city: "Minneapolis", country: "USA", coordinates: [44.8820, -93.2218], size: "large" },
    { code: "DTW", name: "Detroit Metropolitan", city: "Detroit", country: "USA", coordinates: [42.2124, -83.3534], size: "large" },
    { code: "PHL", name: "Philadelphia International", city: "Philadelphia", country: "USA", coordinates: [39.8719, -75.2411], size: "large" },
    { code: "SAN", name: "San Diego International", city: "San Diego", country: "USA", coordinates: [32.7338, -117.1933], size: "large" },
    { code: "TPA", name: "Tampa International", city: "Tampa", country: "USA", coordinates: [27.9759, -82.5338], size: "large" },
    { code: "PDX", name: "Portland International", city: "Portland", country: "USA", coordinates: [45.5887, -122.5975], size: "large" },
    { code: "BWI", name: "Baltimore/Washington International", city: "Baltimore", country: "USA", coordinates: [39.1754, -76.6683], size: "large" },
    { code: "IAD", name: "Washington Dulles International", city: "Washington", country: "USA", coordinates: [38.9445, -77.4558], size: "large" },
    { code: "DCA", name: "Ronald Reagan Washington National", city: "Washington", country: "USA", coordinates: [38.8521, -77.0377], size: "medium" },
    { code: "SJC", name: "San Jose International", city: "San Jose", country: "USA", coordinates: [37.3626, -121.9290], size: "medium" },
    { code: "OAK", name: "Oakland International", city: "Oakland", country: "USA", coordinates: [37.7213, -122.2207], size: "medium" },
    { code: "AUS", name: "Austin-Bergstrom International", city: "Austin", country: "USA", coordinates: [30.1975, -97.6664], size: "medium" },
    { code: "SAT", name: "San Antonio International", city: "San Antonio", country: "USA", coordinates: [29.5337, -98.4698], size: "medium" },
    { code: "DAL", name: "Dallas Love Field", city: "Dallas", country: "USA", coordinates: [32.8471, -96.8518], size: "medium" },
    { code: "HOU", name: "William P. Hobby", city: "Houston", country: "USA", coordinates: [29.6454, -95.2789], size: "medium" },
    { code: "CLE", name: "Cleveland Hopkins International", city: "Cleveland", country: "USA", coordinates: [41.4117, -81.8498], size: "medium" },
    { code: "CMH", name: "John Glenn Columbus International", city: "Columbus", country: "USA", coordinates: [39.9980, -82.8919], size: "medium" },
    { code: "CVG", name: "Cincinnati/Northern Kentucky International", city: "Cincinnati", country: "USA", coordinates: [39.0488, -84.6678], size: "medium" },
    { code: "IND", name: "Indianapolis International", city: "Indianapolis", country: "USA", coordinates: [39.7173, -86.2946], size: "medium" },
    { code: "STL", name: "St. Louis Lambert International", city: "St. Louis", country: "USA", coordinates: [38.7487, -90.3700], size: "medium" },
    { code: "MCI", name: "Kansas City International", city: "Kansas City", country: "USA", coordinates: [39.2976, -94.7139], size: "medium" },
    { code: "SMF", name: "Sacramento International", city: "Sacramento", country: "USA", coordinates: [38.6954, -121.5908], size: "medium" },
    { code: "SNA", name: "John Wayne Airport", city: "Santa Ana", country: "USA", coordinates: [33.6757, -117.8682], size: "medium" },
    { code: "ONT", name: "Ontario International", city: "Ontario", country: "USA", coordinates: [34.0560, -117.6012], size: "medium" },
    { code: "BUR", name: "Bob Hope Airport", city: "Burbank", country: "USA", coordinates: [34.2006, -118.3585], size: "small" },
    { code: "LGB", name: "Long Beach Airport", city: "Long Beach", country: "USA", coordinates: [33.8177, -118.1515], size: "small" },
    { code: "PSP", name: "Palm Springs International", city: "Palm Springs", country: "USA", coordinates: [33.8297, -116.5066], size: "small" },
    { code: "RNO", name: "Reno-Tahoe International", city: "Reno", country: "USA", coordinates: [39.4991, -119.7681], size: "medium" },
    { code: "BOI", name: "Boise Airport", city: "Boise", country: "USA", coordinates: [43.5644, -116.2229], size: "medium" },
    { code: "SLC", name: "Salt Lake City International", city: "Salt Lake City", country: "USA", coordinates: [40.7884, -111.9778], size: "large" },
    { code: "ABQ", name: "Albuquerque International Sunport", city: "Albuquerque", country: "USA", coordinates: [35.0402, -106.6091], size: "medium" },
    { code: "ELP", name: "El Paso International", city: "El Paso", country: "USA", coordinates: [31.8072, -106.3776], size: "medium" },
    { code: "TUS", name: "Tucson International", city: "Tucson", country: "USA", coordinates: [32.1161, -110.9410], size: "medium" },
    { code: "OKC", name: "Will Rogers World Airport", city: "Oklahoma City", country: "USA", coordinates: [35.3931, -97.6007], size: "medium" },
    { code: "TUL", name: "Tulsa International", city: "Tulsa", country: "USA", coordinates: [36.1984, -95.8881], size: "medium" },
    { code: "OMA", name: "Eppley Airfield", city: "Omaha", country: "USA", coordinates: [41.3025, -95.8942], size: "medium" },
    { code: "DSM", name: "Des Moines International", city: "Des Moines", country: "USA", coordinates: [41.5340, -93.6631], size: "medium" },
    { code: "MSY", name: "Louis Armstrong New Orleans International", city: "New Orleans", country: "USA", coordinates: [29.9934, -90.2580], size: "medium" },
    { code: "BTR", name: "Baton Rouge Metropolitan", city: "Baton Rouge", country: "USA", coordinates: [30.5332, -91.1496], size: "small" },
    { code: "GPT", name: "Gulfport-Biloxi International", city: "Gulfport", country: "USA", coordinates: [30.4073, -89.0701], size: "small" },
    { code: "MOB", name: "Mobile Regional Airport", city: "Mobile", country: "USA", coordinates: [30.6914, -88.2428], size: "small" },
    { code: "BHM", name: "Birmingham-Shuttlesworth International", city: "Birmingham", country: "USA", coordinates: [33.5629, -86.7535], size: "medium" },
    { code: "HSV", name: "Huntsville International", city: "Huntsville", country: "USA", coordinates: [34.6372, -86.7751], size: "medium" },
    { code: "CHA", name: "Chattanooga Metropolitan", city: "Chattanooga", country: "USA", coordinates: [35.0353, -85.2038], size: "small" },
    { code: "TYS", name: "McGhee Tyson Airport", city: "Knoxville", country: "USA", coordinates: [35.8110, -83.9940], size: "medium" },
    { code: "AVL", name: "Asheville Regional", city: "Asheville", country: "USA", coordinates: [35.4362, -82.5418], size: "medium" },
    { code: "GSP", name: "Greenville-Spartanburg International", city: "Greenville", country: "USA", coordinates: [34.8957, -82.2189], size: "medium" },
    { code: "CAE", name: "Columbia Metropolitan", city: "Columbia", country: "USA", coordinates: [33.9388, -81.1195], size: "medium" },
    { code: "CHS", name: "Charleston International", city: "Charleston", country: "USA", coordinates: [32.8986, -80.0405], size: "medium" },
    { code: "SAV", name: "Savannah/Hilton Head International", city: "Savannah", country: "USA", coordinates: [32.1276, -81.2021], size: "medium" },
    { code: "JAX", name: "Jacksonville International", city: "Jacksonville", country: "USA", coordinates: [30.4941, -81.6879], size: "medium" },
    { code: "RSW", name: "Southwest Florida International", city: "Fort Myers", country: "USA", coordinates: [26.5362, -81.7552], size: "medium" },
    { code: "PBI", name: "Palm Beach International", city: "West Palm Beach", country: "USA", coordinates: [26.6832, -80.0956], size: "medium" },
    { code: "FLL", name: "Fort Lauderdale-Hollywood International", city: "Fort Lauderdale", country: "USA", coordinates: [26.0742, -80.1506], size: "large" },
    { code: "EYW", name: "Key West International", city: "Key West", country: "USA", coordinates: [24.5561, -81.7596], size: "small" },
    { code: "ORF", name: "Norfolk International", city: "Norfolk", country: "USA", coordinates: [36.8946, -76.2012], size: "medium" },
    { code: "RIC", name: "Richmond International", city: "Richmond", country: "USA", coordinates: [37.5052, -77.3197], size: "medium" },
    { code: "ROA", name: "Roanoke-Blacksburg Regional", city: "Roanoke", country: "USA", coordinates: [37.3255, -79.9754], size: "small" },
    { code: "LYH", name: "Lynchburg Regional", city: "Lynchburg", country: "USA", coordinates: [37.3267, -79.2004], size: "small" },
    { code: "GSO", name: "Piedmont Triad International", city: "Greensboro", country: "USA", coordinates: [36.0978, -79.9373], size: "medium" },
    { code: "RDU", name: "Raleigh-Durham International", city: "Raleigh", country: "USA", coordinates: [35.8776, -78.7875], size: "large" },
    { code: "ILM", name: "Wilmington International", city: "Wilmington", country: "USA", coordinates: [34.2706, -77.9026], size: "small" },

    { code: "YYZ", name: "Toronto Pearson International", city: "Toronto", country: "Canada", coordinates: [43.6777, -79.6248], size: "large" },
    { code: "YVR", name: "Vancouver International", city: "Vancouver", country: "Canada", coordinates: [49.1947, -123.1792], size: "large" },
    { code: "YUL", name: "Montral-Trudeau International", city: "Montreal", country: "Canada", coordinates: [45.4706, -73.7408], size: "large" },
    { code: "YYC", name: "Calgary International", city: "Calgary", country: "Canada", coordinates: [51.1215, -114.0076], size: "large" },
    { code: "YEG", name: "Edmonton International", city: "Edmonton", country: "Canada", coordinates: [53.3097, -113.5794], size: "large" },
    { code: "YOW", name: "Ottawa Macdonald-Cartier International", city: "Ottawa", country: "Canada", coordinates: [45.3225, -75.6692], size: "medium" },
    { code: "YWG", name: "Winnipeg James Armstrong Richardson International", city: "Winnipeg", country: "Canada", coordinates: [49.9100, -97.2399], size: "medium" },
    { code: "YHZ", name: "Halifax Stanfield International", city: "Halifax", country: "Canada", coordinates: [44.8808, -63.5086], size: "medium" },
    { code: "YQB", name: "Qubec City Jean Lesage International", city: "Quebec City", country: "Canada", coordinates: [46.7911, -71.3933], size: "medium" },
    { code: "YYT", name: "St. John's International", city: "St. John's", country: "Canada", coordinates: [47.6186, -52.7519], size: "medium" },
    { code: "YXE", name: "Saskatoon John G. Diefenbaker International", city: "Saskatoon", country: "Canada", coordinates: [52.1708, -106.6997], size: "medium" },
    { code: "YLW", name: "Kelowna International", city: "Kelowna", country: "Canada", coordinates: [49.9561, -119.3778], size: "medium" },

    { code: "MEX", name: "Mexico City International", city: "Mexico City", country: "Mexico", coordinates: [19.4363, -99.0721], size: "large" },
    { code: "CUN", name: "Cancn International", city: "Cancn", country: "Mexico", coordinates: [21.0365, -86.8771], size: "large" },
    { code: "GDL", name: "Guadalajara International", city: "Guadalajara", country: "Mexico", coordinates: [20.5218, -103.3112], size: "large" },
    { code: "MTY", name: "Monterrey International", city: "Monterrey", country: "Mexico", coordinates: [25.7785, -100.1069], size: "large" },
    { code: "TIJ", name: "Tijuana International", city: "Tijuana", country: "Mexico", coordinates: [32.5411, -116.9702], size: "large" },
    { code: "SJD", name: "Los Cabos International", city: "San Jos del Cabo", country: "Mexico", coordinates: [23.1518, -109.7210], size: "large" },
    { code: "PVR", name: "Puerto Vallarta International", city: "Puerto Vallarta", country: "Mexico", coordinates: [20.6801, -105.2542], size: "medium" },
    { code: "MZT", name: "Mazatln International", city: "Mazatln", country: "Mexico", coordinates: [23.1614, -106.2661], size: "medium" },
    { code: "HMO", name: "Hermosillo International", city: "Hermosillo", country: "Mexico", coordinates: [29.0959, -111.0478], size: "medium" },
    { code: "LAP", name: "La Paz International", city: "La Paz", country: "Mexico", coordinates: [24.0727, -110.3625], size: "medium" },

    { code: "LHR", name: "London Heathrow", city: "London", country: "UK", coordinates: [51.4700, -0.4543], size: "large" },
    { code: "LGW", name: "London Gatwick", city: "London", country: "UK", coordinates: [51.1481, -0.1903], size: "large" },
    { code: "STN", name: "London Stansted", city: "London", country: "UK", coordinates: [51.8850, 0.2350], size: "large" },
    { code: "LTN", name: "London Luton", city: "London", country: "UK", coordinates: [51.8747, -0.3683], size: "medium" },
    { code: "MAN", name: "Manchester Airport", city: "Manchester", country: "UK", coordinates: [53.3497, -2.2803], size: "large" },
    { code: "EDI", name: "Edinburgh Airport", city: "Edinburgh", country: "UK", coordinates: [55.9500, -3.3725], size: "large" },
    { code: "GLA", name: "Glasgow International", city: "Glasgow", country: "UK", coordinates: [55.8722, -4.4331], size: "large" },
    { code: "BHX", name: "Birmingham Airport", city: "Birmingham", country: "UK", coordinates: [52.4539, -1.7480], size: "large" },
    { code: "BRS", name: "Bristol Airport", city: "Bristol", country: "UK", coordinates: [51.3827, -2.7191], size: "medium" },

    { code: "DUB", name: "Dublin Airport", city: "Dublin", country: "Ireland", coordinates: [53.4213, -6.2701], size: "large" },
    { code: "SNN", name: "Shannon Airport", city: "Shannon", country: "Ireland", coordinates: [52.7020, -8.9248], size: "medium" },
    { code: "ORK", name: "Cork Airport", city: "Cork", country: "Ireland", coordinates: [51.8413, -8.4911], size: "medium" },

    { code: "CDG", name: "Paris Charles de Gaulle", city: "Paris", country: "France", coordinates: [49.0097, 2.5479], size: "large" },
    { code: "ORY", name: "Paris Orly", city: "Paris", country: "France", coordinates: [48.7253, 2.3594], size: "large" },
    { code: "NCE", name: "Nice Cte d'Azur", city: "Nice", country: "France", coordinates: [43.6584, 7.2159], size: "large" },
    { code: "LYS", name: "Lyon-Saint Exupry", city: "Lyon", country: "France", coordinates: [45.7256, 5.0811], size: "large" },
    { code: "MRS", name: "Marseille Provence", city: "Marseille", country: "France", coordinates: [43.4367, 5.2150], size: "large" },
    { code: "TLS", name: "Toulouse-Blagnac", city: "Toulouse", country: "France", coordinates: [43.6291, 1.3638], size: "large" },
    { code: "BOD", name: "Bordeaux-Mrignac", city: "Bordeaux", country: "France", coordinates: [44.8283, -0.7156], size: "large" },

    { code: "AMS", name: "Amsterdam Schiphol", city: "Amsterdam", country: "Netherlands", coordinates: [52.3086, 4.7639], size: "large" },

    { code: "BRU", name: "Brussels Airport", city: "Brussels", country: "Belgium", coordinates: [50.9014, 4.4844], size: "large" },
    { code: "CRL", name: "Brussels South Charleroi", city: "Charleroi", country: "Belgium", coordinates: [50.4592, 4.4538], size: "medium" },

    { code: "MAD", name: "Adolfo Surez MadridBarajas", city: "Madrid", country: "Spain", coordinates: [40.4983, -3.5676], size: "large" },
    { code: "BCN", name: "Josep Tarradellas BarcelonaEl Prat", city: "Barcelona", country: "Spain", coordinates: [41.2974, 2.0833], size: "large" },
    { code: "PMI", name: "Palma de Mallorca", city: "Palma", country: "Spain", coordinates: [39.5517, 2.7388], size: "large" },
    { code: "AGP", name: "Mlaga-Costa del Sol", city: "Mlaga", country: "Spain", coordinates: [36.6749, -4.4991], size: "large" },
    { code: "ALC", name: "AlicanteElche", city: "Alicante", country: "Spain", coordinates: [38.2822, -0.5582], size: "large" },
    { code: "SVQ", name: "Seville", city: "Seville", country: "Spain", coordinates: [37.4180, -5.8931], size: "medium" },
    { code: "BIO", name: "Bilbao", city: "Bilbao", country: "Spain", coordinates: [43.3011, -2.9106], size: "medium" },

    { code: "FCO", name: "RomeFiumicino", city: "Rome", country: "Italy", coordinates: [41.8045, 12.2508], size: "large" },
    { code: "MXP", name: "MilanMalpensa", city: "Milan", country: "Italy", coordinates: [45.6306, 8.7281], size: "large" },
    { code: "LIN", name: "MilanLinate", city: "Milan", country: "Italy", coordinates: [45.4451, 9.2767], size: "medium" },
    { code: "BGY", name: "MilanBergamo", city: "Bergamo", country: "Italy", coordinates: [45.6739, 9.7042], size: "medium" },
    { code: "VCE", name: "Venice Marco Polo", city: "Venice", country: "Italy", coordinates: [45.5053, 12.3519], size: "large" },
    { code: "NAP", name: "Naples International", city: "Naples", country: "Italy", coordinates: [40.8860, 14.2908], size: "large" },
    { code: "CTA", name: "CataniaFontanarossa", city: "Catania", country: "Italy", coordinates: [37.4668, 15.0664], size: "large" },
    { code: "PMO", name: "Palermo Falcone Borsellino", city: "Palermo", country: "Italy", coordinates: [38.1810, 13.0993], size: "large" },
    { code: "BLQ", name: "Bologna Guglielmo Marconi", city: "Bologna", country: "Italy", coordinates: [44.5354, 11.2887], size: "medium" },

    { code: "ZRH", name: "Zurich Airport", city: "Zurich", country: "Switzerland", coordinates: [47.4647, 8.5492], size: "large" },
    { code: "GVA", name: "Geneva Airport", city: "Geneva", country: "Switzerland", coordinates: [46.2381, 6.1089], size: "large" },
    { code: "BSL", name: "EuroAirport Basel-Mulhouse-Freiburg", city: "Basel", country: "Switzerland", coordinates: [47.5896, 7.5299], size: "medium" },

    { code: "VIE", name: "Vienna International", city: "Vienna", country: "Austria", coordinates: [48.1103, 16.5697], size: "large" },
    { code: "SZG", name: "Salzburg Airport", city: "Salzburg", country: "Austria", coordinates: [47.7933, 13.0043], size: "medium" },
    { code: "INN", name: "Innsbruck Airport", city: "Innsbruck", country: "Austria", coordinates: [47.2602, 11.3440], size: "medium" },

    { code: "ARN", name: "Stockholm Arlanda", city: "Stockholm", country: "Sweden", coordinates: [59.6519, 17.9186], size: "large" },
    { code: "OSL", name: "Oslo Gardermoen", city: "Oslo", country: "Norway", coordinates: [60.1939, 11.1004], size: "large" },
    { code: "CPH", name: "Copenhagen Airport", city: "Copenhagen", country: "Denmark", coordinates: [55.6180, 12.6561], size: "large" },
    { code: "HEL", name: "Helsinki Airport", city: "Helsinki", country: "Finland", coordinates: [60.3172, 24.9633], size: "large" },
    { code: "GOT", name: "Gteborg Landvetter", city: "Gothenburg", country: "Sweden", coordinates: [57.6628, 12.2798], size: "medium" },
    { code: "TRD", name: "Trondheim Airport", city: "Trondheim", country: "Norway", coordinates: [63.4576, 10.9243], size: "medium" },
    { code: "SVG", name: "Stavanger Airport", city: "Stavanger", country: "Norway", coordinates: [58.8768, 5.6379], size: "medium" },
    { code: "TMP", name: "Tampere-Pirkkala", city: "Tampere", country: "Finland", coordinates: [61.4141, 23.6044], size: "medium" },

    { code: "ATH", name: "Athens International", city: "Athens", country: "Greece", coordinates: [37.9364, 23.9445], size: "large" },
    { code: "SKG", name: "Thessaloniki Airport", city: "Thessaloniki", country: "Greece", coordinates: [40.5197, 22.9709], size: "large" },
    { code: "HER", name: "Heraklion International", city: "Heraklion", country: "Greece", coordinates: [35.3397, 25.1803], size: "large" },
    { code: "CFU", name: "Corfu International", city: "Corfu", country: "Greece", coordinates: [39.6019, 19.9117], size: "medium" },

    { code: "BEG", name: "Belgrade Nikola Tesla", city: "Belgrade", country: "Serbia", coordinates: [44.8194, 20.3069], size: "large" },
    { code: "ZAG", name: "Zagreb Airport", city: "Zagreb", country: "Croatia", coordinates: [45.7429, 16.0688], size: "medium" },
    { code: "LJU", name: "Ljubljana Joe Punik", city: "Ljubljana", country: "Slovenia", coordinates: [46.2237, 14.4576], size: "medium" },
    { code: "SJJ", name: "Sarajevo International", city: "Sarajevo", country: "Bosnia", coordinates: [43.8246, 18.3315], size: "medium" },
    { code: "TIA", name: "Tirana International", city: "Tirana", country: "Albania", coordinates: [41.4147, 19.7206], size: "medium" },
    { code: "SOF", name: "Sofia Airport", city: "Sofia", country: "Bulgaria", coordinates: [42.6952, 23.4062], size: "large" },

    { code: "IST", name: "Istanbul Airport", city: "Istanbul", country: "Turkey", coordinates: [41.2622, 28.7425], size: "large" },
    { code: "SAW", name: "Istanbul Sabiha Gken", city: "Istanbul", country: "Turkey", coordinates: [40.8986, 29.3092], size: "large" },
    { code: "AYT", name: "Antalya Airport", city: "Antalya", country: "Turkey", coordinates: [36.8987, 30.8005], size: "large" },
    { code: "ADB", name: "zmir Adnan Menderes", city: "Izmir", country: "Turkey", coordinates: [38.2924, 27.1569], size: "large" },

    { code: "HND", name: "Tokyo Haneda", city: "Tokyo", country: "Japan", coordinates: [35.5494, 139.7798], size: "large" },
    { code: "NRT", name: "Tokyo Narita", city: "Tokyo", country: "Japan", coordinates: [35.7647, 140.3864], size: "large" },
    { code: "KIX", name: "Kansai International", city: "Osaka", country: "Japan", coordinates: [34.4273, 135.2441], size: "large" },
    { code: "ITM", name: "Osaka International", city: "Osaka", country: "Japan", coordinates: [34.7855, 135.4382], size: "large" },
    { code: "NGO", name: "Chubu Centrair International", city: "Nagoya", country: "Japan", coordinates: [34.8584, 136.8054], size: "large" },
    { code: "FUK", name: "Fukuoka Airport", city: "Fukuoka", country: "Japan", coordinates: [33.5859, 130.4507], size: "large" },
    { code: "CTS", name: "New Chitose Airport", city: "Sapporo", country: "Japan", coordinates: [42.7752, 141.6923], size: "large" },
    { code: "OKA", name: "Naha Airport", city: "Naha", country: "Japan", coordinates: [26.1958, 127.6459], size: "large" },

    { code: "PEK", name: "Beijing Capital International", city: "Beijing", country: "China", coordinates: [40.0799, 116.6031], size: "large" },
    { code: "PKX", name: "Beijing Daxing International", city: "Beijing", country: "China", coordinates: [39.5098, 116.4105], size: "large" },
    { code: "PVG", name: "Shanghai Pudong International", city: "Shanghai", country: "China", coordinates: [31.1434, 121.8052], size: "large" },
    { code: "SHA", name: "Shanghai Hongqiao International", city: "Shanghai", country: "China", coordinates: [31.1979, 121.3363], size: "large" },
    { code: "CAN", name: "Guangzhou Baiyun International", city: "Guangzhou", country: "China", coordinates: [23.3924, 113.2988], size: "large" },
    { code: "SZX", name: "Shenzhen Bao'an International", city: "Shenzhen", country: "China", coordinates: [22.6393, 113.8106], size: "large" },
    { code: "CTU", name: "Chengdu Shuangliu International", city: "Chengdu", country: "China", coordinates: [30.5785, 103.9471], size: "large" },
    { code: "XIY", name: "Xi'an Xianyang International", city: "Xi'an", country: "China", coordinates: [34.4471, 108.7516], size: "large" },
    { code: "HGH", name: "Hangzhou Xiaoshan International", city: "Hangzhou", country: "China", coordinates: [30.2295, 120.4345], size: "large" },
    { code: "NKG", name: "Nanjing Lukou International", city: "Nanjing", country: "China", coordinates: [31.7420, 118.8620], size: "large" },
    { code: "WUH", name: "Wuhan Tianhe International", city: "Wuhan", country: "China", coordinates: [30.7838, 114.2081], size: "large" },
    { code: "CSX", name: "Changsha Huanghua International", city: "Changsha", country: "China", coordinates: [28.1892, 113.2196], size: "large" },
    { code: "KMG", name: "Kunming Changshui International", city: "Kunming", country: "China", coordinates: [25.1019, 102.9292], size: "large" },
    { code: "URC", name: "rmqi Diwopu International", city: "rmqi", country: "China", coordinates: [43.9071, 87.4742], size: "large" },
    { code: "TSN", name: "Tianjin Binhai International", city: "Tianjin", country: "China", coordinates: [39.1244, 117.3464], size: "large" },
    { code: "CGO", name: "Zhengzhou Xinzheng International", city: "Zhengzhou", country: "China", coordinates: [34.5197, 113.8409], size: "large" },

    { code: "ICN", name: "Incheon International", city: "Seoul", country: "South Korea", coordinates: [37.4602, 126.4407], size: "large" },
    { code: "GMP", name: "Gimpo International", city: "Seoul", country: "South Korea", coordinates: [37.5583, 126.7906], size: "large" },
    { code: "PUS", name: "Gimhae International", city: "Busan", country: "South Korea", coordinates: [35.1795, 128.9382], size: "large" },
    { code: "CJU", name: "Jeju International", city: "Jeju", country: "South Korea", coordinates: [33.5113, 126.4930], size: "large" },

    { code: "SIN", name: "Singapore Changi", city: "Singapore", country: "Singapore", coordinates: [1.3644, 103.9915], size: "large" },

    { code: "HKG", name: "Hong Kong International", city: "Hong Kong", country: "China", coordinates: [22.3080, 113.9185], size: "large" },

    { code: "BKK", name: "Suvarnabhumi Airport", city: "Bangkok", country: "Thailand", coordinates: [13.6811, 100.7475], size: "large" },
    { code: "DMK", name: "Don Mueang International", city: "Bangkok", country: "Thailand", coordinates: [13.9126, 100.6068], size: "large" },
    { code: "HKT", name: "Phuket International", city: "Phuket", country: "Thailand", coordinates: [8.1132, 98.3169], size: "large" },
    { code: "CNX", name: "Chiang Mai International", city: "Chiang Mai", country: "Thailand", coordinates: [18.7668, 98.9626], size: "large" },

    { code: "DEL", name: "Indira Gandhi International", city: "Delhi", country: "India", coordinates: [28.5562, 77.1000], size: "large" },
    { code: "BOM", name: "Chhatrapati Shivaji Maharaj International", city: "Mumbai", country: "India", coordinates: [19.0887, 72.8679], size: "large" },
    { code: "BLR", name: "Kempegowda International", city: "Bangalore", country: "India", coordinates: [13.1986, 77.7066], size: "large" },
    { code: "MAA", name: "Chennai International", city: "Chennai", country: "India", coordinates: [12.9941, 80.1709], size: "large" },
    { code: "HYD", name: "Rajiv Gandhi International", city: "Hyderabad", country: "India", coordinates: [17.2403, 78.4294], size: "large" },
    { code: "CCU", name: "Netaji Subhas Chandra Bose International", city: "Kolkata", country: "India", coordinates: [22.6547, 88.4467], size: "large" },
    { code: "COK", name: "Cochin International", city: "Kochi", country: "India", coordinates: [10.1520, 76.4019], size: "large" },
    { code: "TRV", name: "Trivandrum International", city: "Thiruvananthapuram", country: "India", coordinates: [8.4821, 76.9201], size: "medium" },
    { code: "AMD", name: "Sardar Vallabhbhai Patel International", city: "Ahmedabad", country: "India", coordinates: [23.0772, 72.6346], size: "large" },
    { code: "PNQ", name: "Pune Airport", city: "Pune", country: "India", coordinates: [18.5821, 73.9197], size: "medium" },

    { code: "KUL", name: "Kuala Lumpur International", city: "Kuala Lumpur", country: "Malaysia", coordinates: [2.7456, 101.7099], size: "large" },
    { code: "PEN", name: "Penang International", city: "Penang", country: "Malaysia", coordinates: [5.2971, 100.2769], size: "large" },

    { code: "CGK", name: "SoekarnoHatta International", city: "Jakarta", country: "Indonesia", coordinates: [-6.1256, 106.6558], size: "large" },
    { code: "DPS", name: "Ngurah Rai International", city: "Denpasar", country: "Indonesia", coordinates: [-8.7482, 115.1672], size: "large" },
    { code: "SUB", name: "Juanda International", city: "Surabaya", country: "Indonesia", coordinates: [-7.3798, 112.7869], size: "large" },

    { code: "MNL", name: "Ninoy Aquino International", city: "Manila", country: "Philippines", coordinates: [14.5086, 121.0196], size: "large" },
    { code: "CEB", name: "MactanCebu International", city: "Cebu", country: "Philippines", coordinates: [10.3070, 123.9790], size: "large" },
    { code: "DVO", name: "Francisco Bangoy International", city: "Davao", country: "Philippines", coordinates: [7.1255, 125.6458], size: "large" },

    { code: "TPE", name: "Taiwan Taoyuan International", city: "Taipei", country: "Taiwan", coordinates: [25.0777, 121.2328], size: "large" },
    { code: "KHH", name: "Kaohsiung International", city: "Kaohsiung", country: "Taiwan", coordinates: [22.5771, 120.3500], size: "large" },

    { code: "SGN", name: "Tan Son Nhat International", city: "Ho Chi Minh City", country: "Vietnam", coordinates: [10.8188, 106.6520], size: "large" },
    { code: "HAN", name: "Noi Bai International", city: "Hanoi", country: "Vietnam", coordinates: [21.2212, 105.8072], size: "large" },
    { code: "DAD", name: "Da Nang International", city: "Da Nang", country: "Vietnam", coordinates: [16.0439, 108.1994], size: "large" },

    { code: "DXB", name: "Dubai International", city: "Dubai", country: "UAE", coordinates: [25.2532, 55.3657], size: "large" },
    { code: "DWC", name: "Al Maktoum International", city: "Dubai", country: "UAE", coordinates: [24.8861, 55.1722], size: "large" },
    { code: "AUH", name: "Abu Dhabi International", city: "Abu Dhabi", country: "UAE", coordinates: [24.4330, 54.6511], size: "large" },
    { code: "SHJ", name: "Sharjah International", city: "Sharjah", country: "UAE", coordinates: [25.3286, 55.5172], size: "medium" },
    { code: "DOH", name: "Hamad International", city: "Doha", country: "Qatar", coordinates: [25.2609, 51.6138], size: "large" },
    { code: "RUH", name: "King Khalid International", city: "Riyadh", country: "Saudi Arabia", coordinates: [24.9584, 46.6989], size: "large" },
    { code: "JED", name: "King Abdulaziz International", city: "Jeddah", country: "Saudi Arabia", coordinates: [21.6796, 39.1565], size: "large" },
    { code: "DMM", name: "King Fahd International", city: "Dammam", country: "Saudi Arabia", coordinates: [26.4712, 49.7979], size: "large" },
    { code: "KWI", name: "Kuwait International", city: "Kuwait City", country: "Kuwait", coordinates: [29.2266, 47.9689], size: "large" },
    { code: "BAH", name: "Bahrain International", city: "Manama", country: "Bahrain", coordinates: [26.2708, 50.6336], size: "large" },
    { code: "MCT", name: "Muscat International", city: "Muscat", country: "Oman", coordinates: [23.5933, 58.2844], size: "large" },
    { code: "AMM", name: "Queen Alia International", city: "Amman", country: "Jordan", coordinates: [31.7225, 35.9932], size: "large" },
    { code: "TLV", name: "Ben Gurion Airport", city: "Tel Aviv", country: "Israel", coordinates: [32.0114, 34.8867], size: "large" },
    { code: "BEY", name: "BeirutRafic Hariri International", city: "Beirut", country: "Lebanon", coordinates: [33.8209, 35.4884], size: "large" },
    { code: "CAI", name: "Cairo International", city: "Cairo", country: "Egypt", coordinates: [30.1219, 31.4056], size: "large" },

    { code: "JNB", name: "O.R. Tambo International", city: "Johannesburg", country: "South Africa", coordinates: [-26.1392, 28.2460], size: "large" },
    { code: "CPT", name: "Cape Town International", city: "Cape Town", country: "South Africa", coordinates: [-33.9648, 18.6017], size: "large" },
    { code: "DUR", name: "King Shaka International", city: "Durban", country: "South Africa", coordinates: [-29.6144, 31.1190], size: "large" },
    { code: "PLZ", name: "Port Elizabeth International", city: "Port Elizabeth", country: "South Africa", coordinates: [-33.9849, 25.6173], size: "medium" },
    { code: "LOS", name: "Murtala Muhammed International", city: "Lagos", country: "Nigeria", coordinates: [6.5774, 3.3212], size: "large" },
    { code: "ABV", name: "Nnamdi Azikiwe International", city: "Abuja", country: "Nigeria", coordinates: [9.0068, 7.2632], size: "large" },
    { code: "ACC", name: "Kotoka International", city: "Accra", country: "Ghana", coordinates: [5.6052, -0.1668], size: "large" },
    { code: "ADD", name: "Bole International", city: "Addis Ababa", country: "Ethiopia", coordinates: [8.9779, 38.7993], size: "large" },
    { code: "NBO", name: "Jomo Kenyatta International", city: "Nairobi", country: "Kenya", coordinates: [-1.3192, 36.9278], size: "large" },
    { code: "DAR", name: "Julius Nyerere International", city: "Dar es Salaam", country: "Tanzania", coordinates: [-6.8781, 39.2026], size: "large" },
    { code: "KGL", name: "Kigali International", city: "Kigali", country: "Rwanda", coordinates: [-1.9686, 30.1395], size: "medium" },
    { code: "EBB", name: "Entebbe International", city: "Entebbe", country: "Uganda", coordinates: [0.0424, 32.4435], size: "large" },
    { code: "CMN", name: "Mohammed V International", city: "Casablanca", country: "Morocco", coordinates: [33.3675, -7.5900], size: "large" },
    { code: "RAK", name: "Marrakesh Menara", city: "Marrakesh", country: "Morocco", coordinates: [31.6069, -8.0363], size: "large" },
    { code: "TUN", name: "TunisCarthage International", city: "Tunis", country: "Tunisia", coordinates: [36.8510, 10.2272], size: "large" },
    { code: "ALG", name: "Houari Boumediene Airport", city: "Algiers", country: "Algeria", coordinates: [36.6910, 3.2154], size: "large" },
    { code: "TIP", name: "Tripoli International", city: "Tripoli", country: "Libya", coordinates: [32.6635, 13.1590], size: "large" },

    { code: "GRU", name: "So PauloGuarulhos International", city: "So Paulo", country: "Brazil", coordinates: [-23.4356, -46.4731], size: "large" },
    { code: "CGH", name: "So PauloCongonhas", city: "So Paulo", country: "Brazil", coordinates: [-23.6261, -46.6564], size: "large" },
    { code: "GIG", name: "Rio de JaneiroGaleo International", city: "Rio de Janeiro", country: "Brazil", coordinates: [-22.8089, -43.2436], size: "large" },
    { code: "BSB", name: "Braslia International", city: "Braslia", country: "Brazil", coordinates: [-15.8711, -47.9186], size: "large" },
    { code: "CNF", name: "Belo HorizonteConfins", city: "Belo Horizonte", country: "Brazil", coordinates: [-19.6337, -43.9689], size: "large" },
    { code: "SSA", name: "SalvadorDeputado Lus Eduardo Magalhes International", city: "Salvador", country: "Brazil", coordinates: [-12.9107, -38.3310], size: "large" },
    { code: "REC", name: "Recife/GuararapesGilberto Freyre International", city: "Recife", country: "Brazil", coordinates: [-8.1268, -34.9240], size: "large" },
    { code: "FOR", name: "FortalezaPinto Martins International", city: "Fortaleza", country: "Brazil", coordinates: [-3.7763, -38.5326], size: "large" },
    { code: "EZE", name: "Ministro Pistarini International", city: "Buenos Aires", country: "Argentina", coordinates: [-34.8222, -58.5358], size: "large" },
    { code: "AEP", name: "Jorge Newbery Airfield", city: "Buenos Aires", country: "Argentina", coordinates: [-34.5592, -58.4156], size: "medium" },
    { code: "COR", name: "Ingeniero Aeronutico Ambrosio L.V. Taravella International", city: "Crdoba", country: "Argentina", coordinates: [-31.3236, -64.2080], size: "large" },
    { code: "MDZ", name: "Governor Francisco Gabrielli International", city: "Mendoza", country: "Argentina", coordinates: [-32.8317, -68.7928], size: "large" },
    { code: "SCL", name: "Arturo Merino Bentez International", city: "Santiago", country: "Chile", coordinates: [-33.3930, -70.7858], size: "large" },
    { code: "LIM", name: "Jorge Chvez International", city: "Lima", country: "Peru", coordinates: [-12.0219, -77.1143], size: "large" },
    { code: "BOG", name: "El Dorado International", city: "Bogot", country: "Colombia", coordinates: [4.7016, -74.1469], size: "large" },
    { code: "MDE", name: "Jos Mara Crdova International", city: "Medelln", country: "Colombia", coordinates: [6.1644, -75.4231], size: "large" },
    { code: "UIO", name: "Mariscal Sucre International", city: "Quito", country: "Ecuador", coordinates: [-0.1411, -78.4882], size: "large" },
    { code: "GYE", name: "Jos Joaqun de Olmedo International", city: "Guayaquil", country: "Ecuador", coordinates: [-2.1574, -79.8836], size: "large" },
    { code: "CCS", name: "Simn Bolvar International", city: "Caracas", country: "Venezuela", coordinates: [10.6031, -66.9906], size: "large" },
    { code: "PTY", name: "Tocumen International", city: "Panama City", country: "Panama", coordinates: [9.0714, -79.3835], size: "large" },
    { code: "MVD", name: "Carrasco International", city: "Montevideo", country: "Uruguay", coordinates: [-34.8384, -56.0308], size: "large" },
    { code: "ASU", name: "Silvio Pettirossi International", city: "Asuncin", country: "Paraguay", coordinates: [-25.2398, -57.5191], size: "large" },
    { code: "LPB", name: "El Alto International", city: "La Paz", country: "Bolivia", coordinates: [-16.5133, -68.1923], size: "large" },
    { code: "VVI", name: "Viru Viru International", city: "Santa Cruz de la Sierra", country: "Bolivia", coordinates: [-17.6448, -63.1354], size: "large" },

    { code: "SYD", name: "Sydney Kingsford Smith", city: "Sydney", country: "Australia", coordinates: [-33.9399, 151.1753], size: "large" },
    { code: "MEL", name: "Melbourne Airport", city: "Melbourne", country: "Australia", coordinates: [-37.6733, 144.8433], size: "large" },
    { code: "BNE", name: "Brisbane Airport", city: "Brisbane", country: "Australia", coordinates: [-27.3842, 153.1175], size: "large" },
    { code: "PER", name: "Perth Airport", city: "Perth", country: "Australia", coordinates: [-31.9404, 115.9670], size: "large" },
    { code: "ADL", name: "Adelaide Airport", city: "Adelaide", country: "Australia", coordinates: [-34.9450, 138.5306], size: "large" },
    { code: "CBR", name: "Canberra Airport", city: "Canberra", country: "Australia", coordinates: [-35.3069, 149.1950], size: "medium" },
    { code: "OOL", name: "Gold Coast Airport", city: "Gold Coast", country: "Australia", coordinates: [-28.1644, 153.5047], size: "medium" },
    { code: "CNS", name: "Cairns Airport", city: "Cairns", country: "Australia", coordinates: [-16.8858, 145.7555], size: "medium" },
    { code: "AKL", name: "Auckland Airport", city: "Auckland", country: "New Zealand", coordinates: [-37.0081, 174.7925], size: "large" },
    { code: "WLG", name: "Wellington International", city: "Wellington", country: "New Zealand", coordinates: [-41.3272, 174.8053], size: "large" },
    { code: "CHC", name: "Christchurch International", city: "Christchurch", country: "New Zealand", coordinates: [-43.4894, 172.5322], size: "large" },
    { code: "ZQN", name: "Queenstown Airport", city: "Queenstown", country: "New Zealand", coordinates: [-45.0211, 168.7392], size: "medium" },
    { code: "NAN", name: "Nadi International", city: "Nadi", country: "Fiji", coordinates: [-17.7554, 177.4434], size: "medium" },
    { code: "PPT", name: "Faa'a International", city: "Papeete", country: "French Polynesia", coordinates: [-17.5567, -149.6114], size: "medium" },

    { code: "ANC", name: "Ted Stevens Anchorage International", city: "Anchorage", country: "USA", coordinates: [61.1744, -149.9960], size: "large" },
    { code: "SVO", name: "Sheremetyevo International", city: "Moscow", country: "Russia", coordinates: [55.9726, 37.4146], size: "large" },
    { code: "DME", name: "Domodedovo International", city: "Moscow", country: "Russia", coordinates: [55.4146, 37.8996], size: "large" },
    { code: "VKO", name: "Vnukovo International", city: "Moscow", country: "Russia", coordinates: [55.6030, 37.2921], size: "large" },
    { code: "LED", name: "Pulkovo Airport", city: "Saint Petersburg", country: "Russia", coordinates: [59.8003, 30.2625], size: "large" },
    { code: "KRR", name: "Krasnodar International", city: "Krasnodar", country: "Russia", coordinates: [45.0347, 39.1705], size: "medium" },
    { code: "SVX", name: "Koltsovo International", city: "Yekaterinburg", country: "Russia", coordinates: [56.7431, 60.8027], size: "medium" },

    { code: "FRA", name: "Frankfurt Airport", city: "Frankfurt", country: "Germany", coordinates: [50.0333, 8.5706], size: "large" },
    { code: "MUC", name: "Munich Airport", city: "Munich", country: "Germany", coordinates: [48.3538, 11.7861], size: "large" },
    { code: "BER", name: "Berlin Brandenburg Airport", city: "Berlin", country: "Germany", coordinates: [52.3667, 13.5033], size: "large" },
    { code: "HAM", name: "Hamburg Airport", city: "Hamburg", country: "Germany", coordinates: [53.6304, 9.9882], size: "large" },
    { code: "WAW", name: "Warsaw Chopin Airport", city: "Warsaw", country: "Poland", coordinates: [52.1657, 20.9671], size: "large" },
    { code: "PRG", name: "Vclav Havel Airport", city: "Prague", country: "Czech Republic", coordinates: [50.1008, 14.2600], size: "large" },
    { code: "BUD", name: "Budapest Ferenc Liszt International", city: "Budapest", country: "Hungary", coordinates: [47.4298, 19.2611], size: "large" },

    { code: "TAO", name: "Qingdao Jiaodong International", city: "Qingdao", country: "China", coordinates: [36.2661, 120.3744], size: "large" },
    { code: "XMN", name: "Xiamen Gaoqi International", city: "Xiamen", country: "China", coordinates: [24.5440, 118.1277], size: "large" },
    { code: "DAC", name: "Hazrat Shahjalal International", city: "Dhaka", country: "Bangladesh", coordinates: [23.8433, 90.3978], size: "large" },
    { code: "KTM", name: "Tribhuvan International", city: "Kathmandu", country: "Nepal", coordinates: [27.6966, 85.3591], size: "medium" },
    { code: "ISB", name: "Islamabad International", city: "Islamabad", country: "Pakistan", coordinates: [33.5607, 72.8517], size: "large" },
    { code: "KHI", name: "Jinnah International", city: "Karachi", country: "Pakistan", coordinates: [24.9065, 67.1607], size: "large" },

    { code: "DKR", name: "Blaise Diagne International", city: "Dakar", country: "Senegal", coordinates: [14.7397, -17.4902], size: "medium" },
    { code: "LUN", name: "Kenneth Kaunda International", city: "Lusaka", country: "Zambia", coordinates: [-15.3308, 28.4527], size: "medium" },
    { code: "HRE", name: "Robert Gabriel Mugabe International", city: "Harare", country: "Zimbabwe", coordinates: [-17.9317, 31.0928], size: "medium" },

{ code: "STT", name: "Cyril E. King Airport", city: "Charlotte Amalie", country: "US Virgin Islands", coordinates: [18.3373, -64.9734], size: "medium" },
{ code: "STX", name: "Henry E. Rohlsen Airport", city: "Christiansted", country: "US Virgin Islands", coordinates: [17.7019, -64.7986], size: "medium" },
{ code: "SXM", name: "Princess Juliana International Airport", city: "Philipsburg", country: "Sint Maarten", coordinates: [18.0410, -63.1089], size: "large" },
{ code: "AXA", name: "Clayton J. Lloyd International Airport", city: "The Valley", country: "Anguilla", coordinates: [18.2048, -63.0551], size: "small" },
{ code: "TAB", name: "Arthur Napoleon Raymond Robinson International Airport", city: "Scarborough", country: "Trinidad and Tobago", coordinates: [11.1497, -60.8322], size: "medium" },
{ code: "BDA", name: "L.F. Wade International International Airport", city: "Hamilton", country: "Bermuda", coordinates: [32.3640, -64.6787], size: "medium" },
{ code: "ANU", name: "V.C. Bird International Airport", city: "St. John's", country: "Antigua and Barbuda", coordinates: [17.1367, -61.7927], size: "medium" },
{ code: "SKB", name: "Robert L. Bradshaw International Airport", city: "Basseterre", country: "Saint Kitts and Nevis", coordinates: [17.3112, -62.7187], size: "medium" },
{ code: "SLU", name: "George F. L. Charles Airport", city: "Castries", country: "Saint Lucia", coordinates: [14.0202, -60.9929], size: "medium" },
{ code: "UVF", name: "Hewanorra International Airport", city: "Vieux Fort", country: "Saint Lucia", coordinates: [13.7332, -60.9526], size: "medium" },
{ code: "GND", name: "Maurice Bishop International Airport", city: "St. George's", country: "Grenada", coordinates: [12.0042, -61.7862], size: "medium" },
{ code: "DOM", name: "DouglasCharles Airport", city: "Marigot", country: "Dominica", coordinates: [15.5470, -61.3000], size: "small" },
{ code: "SBH", name: "Gustaf III Airport", city: "Saint Barthlemy", country: "France", coordinates: [17.9044, -62.8436], size: "small" },
{ code: "EIS", name: "Terrance B. Lettsome International Airport", city: "Road Town", country: "British Virgin Islands", coordinates: [18.4448, -64.5429], size: "small" },
{ code: "VIJ", name: "Virgin Gorda Airport", city: "Spanish Town", country: "British Virgin Islands", coordinates: [18.4464, -64.4275], size: "small" },

{ code: "CAG", name: "Cagliari Elmas Airport", city: "Cagliari", country: "Italy", coordinates: [39.2515, 9.0543], size: "large" },
{ code: "OLB", name: "Olbia Costa Smeralda Airport", city: "Olbia", country: "Italy", coordinates: [40.8987, 9.5176], size: "large" },
{ code: "SUF", name: "Lamezia Terme International Airport", city: "Lamezia Terme", country: "Italy", coordinates: [38.9054, 16.2423], size: "medium" },
{ code: "PMO", name: "FalconeBorsellino Airport", city: "Palermo", country: "Italy", coordinates: [38.1760, 13.0910], size: "large" },
{ code: "CTA", name: "CataniaFontanarossa Airport", city: "Catania", country: "Italy", coordinates: [37.4668, 15.0664], size: "large" },
{ code: "LMP", name: "Lampedusa Airport", city: "Lampedusa", country: "Italy", coordinates: [35.4979, 12.6181], size: "small" },
{ code: "PNL", name: "Pantelleria Airport", city: "Pantelleria", country: "Italy", coordinates: [36.8165, 11.9689], size: "small" },
{ code: "JTR", name: "Santorini (Thira) National Airport", city: "Santorini", country: "Greece", coordinates: [36.3992, 25.4793], size: "medium" },
{ code: "JSI", name: "Skiathos Island National Airport", city: "Skiathos", country: "Greece", coordinates: [39.1771, 23.5037], size: "medium" },
{ code: "JMK", name: "Mykonos Island National Airport", city: "Mykonos", country: "Greece", coordinates: [37.4351, 25.3481], size: "medium" },
{ code: "RHO", name: "Rhodes International Airport", city: "Rhodes", country: "Greece", coordinates: [36.4054, 28.0862], size: "large" },
{ code: "CHQ", name: "Chania International Airport", city: "Chania", country: "Greece", coordinates: [35.5317, 24.1497], size: "large" },
{ code: "HER", name: "Heraklion International Airport", city: "Heraklion", country: "Greece", coordinates: [35.3397, 25.1803], size: "large" },
{ code: "CFU", name: "Corfu International Airport", city: "Corfu", country: "Greece", coordinates: [39.6019, 19.9117], size: "large" },
{ code: "ZTH", name: "Zakynthos International Airport", city: "Zakynthos", country: "Greece", coordinates: [37.7509, 20.8843], size: "medium" },
{ code: "KGS", name: "Kos International Airport", city: "Kos", country: "Greece", coordinates: [36.7933, 27.0917], size: "medium" },
{ code: "KVA", name: "Kavala International Airport", city: "Kavala", country: "Greece", coordinates: [40.9133, 24.6192], size: "medium" },
{ code: "SKG", name: "Thessaloniki Airport", city: "Thessaloniki", country: "Greece", coordinates: [40.5197, 22.9709], size: "large" },
{ code: "MLA", name: "Malta International Airport", city: "Valletta", country: "Malta", coordinates: [35.8575, 14.4775], size: "large" },
{ code: "LCA", name: "Larnaca International Airport", city: "Larnaca", country: "Cyprus", coordinates: [34.8751, 33.6249], size: "large" },
{ code: "PFO", name: "Paphos International Airport", city: "Paphos", country: "Cyprus", coordinates: [34.7180, 32.4857], size: "large" },
{ code: "ECN", name: "Ercan International Airport", city: "Nicosia", country: "Cyprus", coordinates: [35.1547, 33.4961], size: "medium" },
{ code: "DBV", name: "Dubrovnik Airport", city: "Dubrovnik", country: "Croatia", coordinates: [42.5614, 18.2682], size: "large" },
{ code: "SPU", name: "Split Airport", city: "Split", country: "Croatia", coordinates: [43.5389, 16.2980], size: "large" },
{ code: "PUY", name: "Pula Airport", city: "Pula", country: "Croatia", coordinates: [44.8935, 13.9222], size: "medium" },
{ code: "ZAD", name: "Zadar Airport", city: "Zadar", country: "Croatia", coordinates: [44.1083, 15.3467], size: "medium" },
{ code: "BWK", name: "Bra Airport", city: "Bra", country: "Croatia", coordinates: [43.2857, 16.6797], size: "small" },
{ code: "LSZ", name: "Loinj Airport", city: "Loinj", country: "Croatia", coordinates: [44.5658, 14.3931], size: "small" },
{ code: "TIV", name: "Tivat Airport", city: "Tivat", country: "Montenegro", coordinates: [42.4047, 18.7233], size: "medium" },
{ code: "TGD", name: "Podgorica Airport", city: "Podgorica", country: "Montenegro", coordinates: [42.3594, 19.2519], size: "medium" },

{ code: "LOP", name: "Lombok International Airport", city: "Praya", country: "Indonesia", coordinates: [-8.7573, 116.2767], size: "large" },
{ code: "BPN", name: "Sultan Aji Muhammad Sulaiman Airport", city: "Balikpapan", country: "Indonesia", coordinates: [-1.2683, 116.8944], size: "large" },
{ code: "UPG", name: "Sultan Hasanuddin International Airport", city: "Makassar", country: "Indonesia", coordinates: [-5.0616, 119.5540], size: "large" },
{ code: "MDC", name: "Sam Ratulangi International Airport", city: "Manado", country: "Indonesia", coordinates: [1.5492, 124.9263], size: "large" },
{ code: "DPS", name: "Ngurah Rai International Airport", city: "Denpasar", country: "Indonesia", coordinates: [-8.7482, 115.1672], size: "large" },
{ code: "KOE", name: "El Tari International Airport", city: "Kupang", country: "Indonesia", coordinates: [-10.1716, 123.6711], size: "medium" },
{ code: "BIK", name: "Frans Kaisiepo International Airport", city: "Biak", country: "Indonesia", coordinates: [-1.1900, 136.1080], size: "medium" },
{ code: "SOQ", name: "Domine Eduard Osok Airport", city: "Sorong", country: "Indonesia", coordinates: [-0.8940, 131.2870], size: "medium" },
{ code: "TIM", name: "Moses Kilangin Airport", city: "Timika", country: "Indonesia", coordinates: [-4.5283, 136.8875], size: "medium" },
{ code: "LBJ", name: "Komodo Airport", city: "Labuan Bajo", country: "Indonesia", coordinates: [-8.4867, 119.8894], size: "medium" },
{ code: "BTH", name: "Hang Nadim International Airport", city: "Batam", country: "Indonesia", coordinates: [1.1210, 104.1188], size: "large" },
{ code: "PKU", name: "Sultan Syarif Kasim II International Airport", city: "Pekanbaru", country: "Indonesia", coordinates: [0.4608, 101.4445], size: "large" },
{ code: "PLM", name: "Sultan Mahmud Badaruddin II International Airport", city: "Palembang", country: "Indonesia", coordinates: [-2.8983, 104.7019], size: "large" },
{ code: "JOG", name: "Adisutjipto International Airport", city: "Yogyakarta", country: "Indonesia", coordinates: [-7.7882, 110.4318], size: "large" },
{ code: "SRG", name: "Ahmad Yani International Airport", city: "Semarang", country: "Indonesia", coordinates: [-6.9714, 110.3741], size: "medium" },
{ code: "SOC", name: "Adisumarmo International Airport", city: "Surakarta", country: "Indonesia", coordinates: [-7.5161, 110.7569], size: "medium" },
{ code: "PDG", name: "Minangkabau International Airport", city: "Padang", country: "Indonesia", coordinates: [-0.7867, 100.2808], size: "large" },
{ code: "BTJ", name: "Sultan Iskandar Muda International Airport", city: "Banda Aceh", country: "Indonesia", coordinates: [5.5235, 95.4203], size: "large" },
{ code: "KNO", name: "Kualanamu International Airport", city: "Medan", country: "Indonesia", coordinates: [3.6424, 98.8854], size: "large" },

{ code: "MPH", name: "Godofredo P. Ramos Airport", city: "Malay", country: "Philippines", coordinates: [11.9245, 121.9541], size: "medium" },
{ code: "USU", name: "Francisco B. Reyes Airport", city: "Coron", country: "Philippines", coordinates: [12.1215, 120.1000], size: "small" },
{ code: "ENI", name: "El Nido Airport", city: "El Nido", country: "Philippines", coordinates: [11.2026, 119.4166], size: "small" },
{ code: "BXU", name: "Bancasi Airport", city: "Butuan", country: "Philippines", coordinates: [8.9515, 125.4777], size: "medium" },
{ code: "CGM", name: "Camiguin Airport", city: "Mambajao", country: "Philippines", coordinates: [9.2536, 124.7076], size: "small" },
{ code: "IAO", name: "Sayak Airport", city: "Del Carmen", country: "Philippines", coordinates: [9.8591, 126.0167], size: "small" },
{ code: "SUG", name: "Surigao Airport", city: "Surigao", country: "Philippines", coordinates: [9.7558, 125.4809], size: "small" },
{ code: "DGT", name: "Dumaguete-Sibulan Airport", city: "Dumaguete", country: "Philippines", coordinates: [9.3337, 123.3005], size: "medium" },
{ code: "TAC", name: "Daniel Z. Romualdez Airport", city: "Tacloban", country: "Philippines", coordinates: [11.2276, 125.0278], size: "medium" },
{ code: "BCD", name: "Bacolod-Silay Airport", city: "Bacolod", country: "Philippines", coordinates: [10.7764, 123.0146], size: "medium" },
{ code: "ILO", name: "Iloilo International Airport", city: "Iloilo", country: "Philippines", coordinates: [10.7130, 122.5453], size: "large" },
{ code: "PPS", name: "Puerto Princesa International Airport", city: "Puerto Princesa", country: "Philippines", coordinates: [9.7421, 118.7587], size: "large" },
{ code: "ZAM", name: "Zamboanga International Airport", city: "Zamboanga", country: "Philippines", coordinates: [6.9224, 122.0596], size: "medium" },
{ code: "CGY", name: "Laguindingan Airport", city: "Cagayan de Oro", country: "Philippines", coordinates: [8.6125, 124.4565], size: "medium" },
{ code: "GES", name: "General Santos International Airport", city: "General Santos", country: "Philippines", coordinates: [6.1064, 125.2353], size: "medium" },

{ code: "OKA", name: "Naha Airport", city: "Naha", country: "Japan", coordinates: [26.1958, 127.6459], size: "large" },
{ code: "ISG", name: "New Ishigaki Airport", city: "Ishigaki", country: "Japan", coordinates: [24.3964, 124.2450], size: "medium" },
{ code: "MMY", name: "Miyako Airport", city: "Miyakojima", country: "Japan", coordinates: [24.7828, 125.2950], size: "medium" },
{ code: "SHI", name: "Shimojishima Airport", city: "Shimojishima", country: "Japan", coordinates: [24.8267, 125.1447], size: "medium" },
{ code: "KTD", name: "Kitadaito Airport", city: "Kitadaito", country: "Japan", coordinates: [25.9447, 131.3267], size: "small" },
{ code: "MMD", name: "Minami-Daito Airport", city: "Minamidaito", country: "Japan", coordinates: [25.8465, 131.2635], size: "small" },
{ code: "TNE", name: "New Tanegashima Airport", city: "Tanegashima", country: "Japan", coordinates: [30.5500, 130.9500], size: "small" },
{ code: "KOJ", name: "Kagoshima Airport", city: "Kagoshima", country: "Japan", coordinates: [31.8034, 130.7194], size: "large" },
{ code: "KMJ", name: "Kumamoto Airport", city: "Kumamoto", country: "Japan", coordinates: [32.8373, 130.8551], size: "large" },
{ code: "OIT", name: "Oita Airport", city: "Oita", country: "Japan", coordinates: [33.4794, 131.7372], size: "medium" },
{ code: "MYJ", name: "Matsuyama Airport", city: "Matsuyama", country: "Japan", coordinates: [33.8272, 132.6998], size: "medium" },
{ code: "TAK", name: "Takamatsu Airport", city: "Takamatsu", country: "Japan", coordinates: [34.2142, 134.0156], size: "medium" },
{ code: "KCZ", name: "Kochi Ryoma Airport", city: "Kochi", country: "Japan", coordinates: [33.5461, 133.6694], size: "medium" },
{ code: "HSG", name: "Saga Airport", city: "Saga", country: "Japan", coordinates: [33.1497, 130.3022], size: "small" },
{ code: "FUK", name: "Fukuoka Airport", city: "Fukuoka", country: "Japan", coordinates: [33.5859, 130.4507], size: "large" },
{ code: "NGS", name: "Nagasaki Airport", city: "Nagasaki", country: "Japan", coordinates: [32.9169, 129.9136], size: "large" },
{ code: "KMQ", name: "Komatsu Airport", city: "Komatsu", country: "Japan", coordinates: [36.3946, 136.4065], size: "medium" },
{ code: "HIJ", name: "Hiroshima Airport", city: "Hiroshima", country: "Japan", coordinates: [34.4361, 132.9194], size: "large" },
{ code: "OKJ", name: "Okayama Airport", city: "Okayama", country: "Japan", coordinates: [34.7569, 133.8553], size: "medium" },
{ code: "IZO", name: "Izumo Airport", city: "Izumo", country: "Japan", coordinates: [35.4136, 132.8900], size: "small" },
{ code: "YGJ", name: "Miho-Yonago Airport", city: "Yonago", country: "Japan", coordinates: [35.4922, 133.2364], size: "small" },
{ code: "TTJ", name: "Tottori Airport", city: "Tottori", country: "Japan", coordinates: [35.5300, 134.1667], size: "small" },
{ code: "CTS", name: "New Chitose Airport", city: "Sapporo", country: "Japan", coordinates: [42.7752, 141.6923], size: "large" },
{ code: "AKJ", name: "Asahikawa Airport", city: "Asahikawa", country: "Japan", coordinates: [43.6708, 142.4475], size: "medium" },
{ code: "HKD", name: "Hakodate Airport", city: "Hakodate", country: "Japan", coordinates: [41.7700, 140.8219], size: "medium" },
{ code: "KUH", name: "Kushiro Airport", city: "Kushiro", country: "Japan", coordinates: [43.0410, 144.1930], size: "medium" },
{ code: "MMB", name: "Memanbetsu Airport", city: "Ozora", country: "Japan", coordinates: [43.8806, 144.1641], size: "medium" },
{ code: "SHB", name: "Nakashibetsu Airport", city: "Nakashibetsu", country: "Japan", coordinates: [43.5775, 144.9600], size: "small" },
{ code: "WKJ", name: "Wakkanai Airport", city: "Wakkanai", country: "Japan", coordinates: [45.4042, 141.8008], size: "small" },

{ code: "CJU", name: "Jeju International Airport", city: "Jeju", country: "South Korea", coordinates: [33.5113, 126.4930], size: "large" },
{ code: "PUS", name: "Gimhae International Airport", city: "Busan", country: "South Korea", coordinates: [35.1795, 128.9382], size: "large" },
{ code: "KUV", name: "Gunsan Airport", city: "Gunsan", country: "South Korea", coordinates: [35.9818, 126.7159], size: "small" },
{ code: "MWX", name: "Muan International Airport", city: "Muan", country: "South Korea", coordinates: [34.9914, 126.3828], size: "medium" },
{ code: "RSU", name: "Yeosu Airport", city: "Yeosu", country: "South Korea", coordinates: [34.8423, 127.6169], size: "small" },
{ code: "USN", name: "Ulsan Airport", city: "Ulsan", country: "South Korea", coordinates: [35.5935, 129.3517], size: "small" },
{ code: "YNY", name: "Yangyang International Airport", city: "Yangyang", country: "South Korea", coordinates: [38.0613, 128.6690], size: "small" },

{ code: "KHH", name: "Kaohsiung International Airport", city: "Kaohsiung", country: "Taiwan", coordinates: [22.5771, 120.3500], size: "large" },
{ code: "TNN", name: "Tainan Airport", city: "Tainan", country: "Taiwan", coordinates: [22.9504, 120.2058], size: "medium" },
{ code: "RMQ", name: "Taichung International Airport", city: "Taichung", country: "Taiwan", coordinates: [24.2647, 120.6206], size: "medium" },
{ code: "HUN", name: "Hualien Airport", city: "Hualien", country: "Taiwan", coordinates: [24.0231, 121.6169], size: "small" },
{ code: "TTT", name: "Taitung Airport", city: "Taitung", country: "Taiwan", coordinates: [22.7549, 121.1017], size: "small" },
{ code: "MZG", name: "Makung Airport", city: "Makung", country: "Taiwan", coordinates: [23.5687, 119.6283], size: "medium" },
{ code: "KNH", name: "Kinmen Airport", city: "Kinmen", country: "Taiwan", coordinates: [24.4279, 118.3591], size: "medium" },
{ code: "LZN", name: "Matsu Nangan Airport", city: "Nangan", country: "Taiwan", coordinates: [26.1598, 119.9583], size: "small" },

{ code: "GOH", name: "Nuuk Airport", city: "Nuuk", country: "Greenland", coordinates: [64.1909, -51.6781], size: "medium" },
{ code: "SFJ", name: "Kangerlussuaq Airport", city: "Kangerlussuaq", country: "Greenland", coordinates: [67.0169, -50.6893], size: "medium" },
{ code: "JAV", name: "Ilulissat Airport", city: "Ilulissat", country: "Greenland", coordinates: [69.2432, -51.0571], size: "small" },
{ code: "KEF", name: "Keflavk International Airport", city: "Reykjavk", country: "Iceland", coordinates: [63.9850, -22.6056], size: "large" },
{ code: "AEY", name: "Akureyri Airport", city: "Akureyri", country: "Iceland", coordinates: [65.6600, -18.0727], size: "medium" },
{ code: "EGS", name: "Egilsstair Airport", city: "Egilsstair", country: "Iceland", coordinates: [65.2833, -14.4014], size: "small" },
{ code: "IFJ", name: "safjrur Airport", city: "safjrur", country: "Iceland", coordinates: [66.0581, -23.1353], size: "small" },
{ code: "LYR", name: "Svalbard Airport", city: "Longyearbyen", country: "Norway", coordinates: [78.2461, 15.4656], size: "medium" },
{ code: "TOS", name: "Troms Airport", city: "Troms", country: "Norway", coordinates: [69.6833, 18.9189], size: "large" },
{ code: "BOO", name: "Bod Airport", city: "Bod", country: "Norway", coordinates: [67.2692, 14.3653], size: "medium" },
{ code: "EVE", name: "Harstad/Narvik Airport, Evenes", city: "Evenes", country: "Norway", coordinates: [68.4913, 16.6781], size: "medium" },
{ code: "KKN", name: "Kirkenes Airport", city: "Kirkenes", country: "Norway", coordinates: [69.7258, 29.8913], size: "medium" },
{ code: "ALF", name: "Alta Airport", city: "Alta", country: "Norway", coordinates: [69.9761, 23.3717], size: "medium" },
{ code: "HFT", name: "Hammerfest Airport", city: "Hammerfest", country: "Norway", coordinates: [70.6797, 23.6686], size: "small" },

{ code: "RUN", name: "Roland Garros Airport", city: "Saint-Denis", country: "Runion", coordinates: [-20.8871, 55.5103], size: "large" },
{ code: "TNR", name: "Ivato International Airport", city: "Antananarivo", country: "Madagascar", coordinates: [-18.7969, 47.4788], size: "large" },
{ code: "NOS", name: "Fascene Airport", city: "Nosy Be", country: "Madagascar", coordinates: [-13.3121, 48.3148], size: "medium" },
{ code: "DZA", name: "Dzaoudzi Pamandzi International Airport", city: "Dzaoudzi", country: "Mayotte", coordinates: [-12.8047, 45.2811], size: "medium" },
{ code: "SEZ", name: "Seychelles International Airport", city: "Victoria", country: "Seychelles", coordinates: [-4.6743, 55.5218], size: "medium" },
{ code: "PRI", name: "Praslin Island Airport", city: "Praslin", country: "Seychelles", coordinates: [-4.3193, 55.6914], size: "small" },
{ code: "MRU", name: "Sir Seewoosagur Ramgoolam International Airport", city: "Port Louis", country: "Mauritius", coordinates: [-20.4302, 57.6836], size: "large" },
{ code: "RRG", name: "Sir Gatan Duval Airport", city: "Rodrigues", country: "Mauritius", coordinates: [-19.7577, 63.3610], size: "small" },
{ code: "CPT", name: "Cape Town International Airport", city: "Cape Town", country: "South Africa", coordinates: [-33.9648, 18.6017], size: "large" },
{ code: "GRJ", name: "George Airport", city: "George", country: "South Africa", coordinates: [-34.0056, 22.3789], size: "medium" },
{ code: "PLZ", name: "Port Elizabeth International Airport", city: "Gqeberha", country: "South Africa", coordinates: [-33.9849, 25.6173], size: "medium" },
{ code: "DUR", name: "King Shaka International Airport", city: "Durban", country: "South Africa", coordinates: [-29.6144, 31.1190], size: "large" },
{ code: "HLE", name: "Saint Helena Airport", city: "Jamestown", country: "Saint Helena", coordinates: [-15.9590, -5.6459], size: "small" },
{ code: "ASU", name: "Silvio Pettirossi International Airport", city: "Asuncin", country: "Paraguay", coordinates: [-25.2398, -57.5191], size: "large" },
{ code: "CAB", name: "Cabinda Airport", city: "Cabinda", country: "Angola", coordinates: [-5.5970, 12.1884], size: "medium" },
{ code: "SSA", name: "Salvador International Airport", city: "Salvador", country: "Brazil", coordinates: [-12.9107, -38.3310], size: "large" },
{ code: "NAT", name: "So Gonalo do Amarante - Governador Aluzio Alves International Airport", city: "Natal", country: "Brazil", coordinates: [-5.7683, -35.3761], size: "large" },
{ code: "FOR", name: "Fortaleza International Airport", city: "Fortaleza", country: "Brazil", coordinates: [-3.7763, -38.5326], size: "large" },
{ code: "REC", name: "Recife International Airport", city: "Recife", country: "Brazil", coordinates: [-8.1268, -34.9240], size: "large" },
{ code: "MCZ", name: "Zumbi dos Palmares International Airport", city: "Macei", country: "Brazil", coordinates: [-9.5108, -35.7917], size: "medium" },
{ code: "JPA", name: "Presidente Castro Pinto International Airport", city: "Joo Pessoa", country: "Brazil", coordinates: [-7.1450, -34.9486], size: "medium" },
{ code: "AJU", name: "Santa Maria Airport", city: "Aracaju", country: "Brazil", coordinates: [-10.9840, -37.0703], size: "medium" },
{ code: "CGB", name: "Marechal Rondon International Airport", city: "Cuiab", country: "Brazil", coordinates: [-15.6529, -56.1167], size: "medium" },
{ code: "GYN", name: "Santa Genoveva Airport", city: "Goinia", country: "Brazil", coordinates: [-16.6320, -49.2207], size: "medium" },

{ code: "SCL", name: "Arturo Merino Bentez International Airport", city: "Santiago", country: "Chile", coordinates: [-33.3930, -70.7858], size: "large" },
{ code: "PUQ", name: "Presidente Carlos Ibez del Campo International Airport", city: "Punta Arenas", country: "Chile", coordinates: [-53.0026, -70.8546], size: "medium" },
{ code: "PMC", name: "El Tepual International Airport", city: "Puerto Montt", country: "Chile", coordinates: [-41.4389, -73.0940], size: "medium" },
{ code: "ZCO", name: "Maquehue Airport", city: "Temuco", country: "Chile", coordinates: [-38.7668, -72.6371], size: "small" },
{ code: "CCP", name: "Carriel Sur International Airport", city: "Concepcin", country: "Chile", coordinates: [-36.7726, -73.0631], size: "medium" },
{ code: "IQQ", name: "Diego Aracena International Airport", city: "Iquique", country: "Chile", coordinates: [-20.5352, -70.1813], size: "medium" },
{ code: "ANF", name: "Cerro Moreno International Airport", city: "Antofagasta", country: "Chile", coordinates: [-23.4445, -70.4451], size: "medium" },
{ code: "IPC", name: "Mataveri International Airport", city: "Hanga Roa", country: "Chile", coordinates: [-27.1648, -109.4218], size: "medium" },
{ code: "WPR", name: "Captain Fuentes Martnez Airport", city: "Porvenir", country: "Chile", coordinates: [-53.2537, -70.3192], size: "small" },

{ code: "MPN", name: "RAF Mount Pleasant", city: "Mount Pleasant", country: "Falkland Islands", coordinates: [-51.8228, -58.4472], size: "medium" },
{ code: "PSY", name: "Port Stanley Airport", city: "Stanley", country: "Falkland Islands", coordinates: [-51.6857, -57.7776], size: "small" },

{ code: "ASU", name: "Silvio Pettirossi International Airport", city: "Asuncin", country: "Paraguay", coordinates: [-25.2398, -57.5191], size: "large" },
{ code: "VVI", name: "Viru Viru International Airport", city: "Santa Cruz", country: "Bolivia", coordinates: [-17.6448, -63.1354], size: "large" },
{ code: "LPB", name: "El Alto International Airport", city: "La Paz", country: "Bolivia", coordinates: [-16.5133, -68.1923], size: "large" },

{ code: "BAH", name: "Bahrain International Airport", city: "Manama", country: "Bahrain", coordinates: [26.2708, 50.6336], size: "large" },
{ code: "DOH", name: "Hamad International Airport", city: "Doha", country: "Qatar", coordinates: [25.2609, 51.6138], size: "large" },
{ code: "AUH", name: "Abu Dhabi International Airport", city: "Abu Dhabi", country: "UAE", coordinates: [24.4330, 54.6511], size: "large" },
{ code: "DXB", name: "Dubai International Airport", city: "Dubai", country: "UAE", coordinates: [25.2532, 55.3657], size: "large" },
{ code: "DWC", name: "Al Maktoum International Airport", city: "Dubai", country: "UAE", coordinates: [24.8861, 55.1722], size: "large" },
{ code: "SHJ", name: "Sharjah International Airport", city: "Sharjah", country: "UAE", coordinates: [25.3286, 55.5172], size: "medium" },
{ code: "MCT", name: "Muscat International Airport", city: "Muscat", country: "Oman", coordinates: [23.5933, 58.2844], size: "large" },
{ code: "SLL", name: "Salalah Airport", city: "Salalah", country: "Oman", coordinates: [17.0387, 54.0913], size: "medium" },
{ code: "KWI", name: "Kuwait International Airport", city: "Kuwait City", country: "Kuwait", coordinates: [29.2266, 47.9689], size: "large" },

        { code: "HNL", name: "Daniel K. Inouye International", city: "Honolulu", country: "USA", coordinates: [21.3243, -157.9252], size: "large" },
        { code: "OGG", name: "Kahului Airport", city: "Kahului", country: "USA", coordinates: [20.8986, -156.4305], size: "large" },
        { code: "KOA", name: "Kona International Airport", city: "Kailua-Kona", country: "USA", coordinates: [19.7388, -156.0456], size: "large" },
        { code: "LIH", name: "Lihue Airport", city: "Lihue", country: "USA", coordinates: [21.9762, -159.3389], size: "large" },
        { code: "ITO", name: "Hilo International Airport", city: "Hilo", country: "USA", coordinates: [19.7203, -155.0485], size: "medium" },
        { code: "JHM", name: "Kapalua Airport", city: "Lahaina", country: "USA", coordinates: [20.9629, -156.6730], size: "small" },
        { code: "MKK", name: "Molokai Airport", city: "Hoolehua", country: "USA", coordinates: [21.1529, -157.0961], size: "small" },
        { code: "LNY", name: "Lanai Airport", city: "Lanai City", country: "USA", coordinates: [20.7856, -156.9514], size: "small" },
        
        { code: "KEF", name: "Keflavk International Airport", city: "Reykjavk", country: "Iceland", coordinates: [63.9850, -22.6056], size: "large" },
        { code: "RKV", name: "Reykjavk Airport", city: "Reykjavk", country: "Iceland", coordinates: [64.1300, -21.9406], size: "medium" },
        { code: "AEY", name: "Akureyri Airport", city: "Akureyri", country: "Iceland", coordinates: [65.6600, -18.0727], size: "medium" },
        { code: "EGS", name: "Egilsstair Airport", city: "Egilsstair", country: "Iceland", coordinates: [65.2833, -14.4014], size: "small" },
        { code: "IFJ", name: "safjrur Airport", city: "safjrur", country: "Iceland", coordinates: [66.0581, -23.1353], size: "small" },
        { code: "HZK", name: "Hsavk Airport", city: "Hsavk", country: "Iceland", coordinates: [65.9523, -17.4260], size: "small" },
        { code: "VPN", name: "Vopnafjrur Airport", city: "Vopnafjrur", country: "Iceland", coordinates: [65.7206, -14.8506], size: "small" },
        { code: "THO", name: "rshfn Airport", city: "rshfn", country: "Iceland", coordinates: [66.2185, -15.3356], size: "small" },
        { code: "GRY", name: "Grmsey Airport", city: "Grmsey", country: "Iceland", coordinates: [66.5547, -18.0175], size: "small" },
        
        { code: "CRK", name: "Clark International Airport", city: "Angeles", country: "Philippines", coordinates: [15.1858, 120.5603], size: "large" },
        { code: "ILO", name: "Iloilo International Airport", city: "Iloilo", country: "Philippines", coordinates: [10.7130, 122.5453], size: "medium" },
        { code: "PPS", name: "Puerto Princesa International Airport", city: "Puerto Princesa", country: "Philippines", coordinates: [9.7421, 118.7587], size: "medium" },
        { code: "KLO", name: "Kalibo International Airport", city: "Kalibo", country: "Philippines", coordinates: [11.6794, 122.3763], size: "medium" },
        { code: "MPH", name: "Godofredo P. Ramos Airport", city: "Malay", country: "Philippines", coordinates: [11.9245, 121.9541], size: "medium" },
        { code: "TAG", name: "Bohol-Panglao International Airport", city: "Panglao", country: "Philippines", coordinates: [9.5701, 123.7726], size: "medium" },
        { code: "ZAM", name: "Zamboanga International Airport", city: "Zamboanga", country: "Philippines", coordinates: [6.9224, 122.0596], size: "medium" },
        { code: "CGY", name: "Laguindingan Airport", city: "Cagayan de Oro", country: "Philippines", coordinates: [8.6125, 124.4565], size: "medium" },
        { code: "BCD", name: "Bacolod-Silay Airport", city: "Bacolod", country: "Philippines", coordinates: [10.7764, 123.0146], size: "medium" },
        { code: "RXS", name: "Roxas Airport", city: "Roxas", country: "Philippines", coordinates: [11.5977, 122.7517], size: "small" },
        
        { code: "SJU", name: "Luis Muoz Marn International Airport", city: "San Juan", country: "Puerto Rico", coordinates: [18.4394, -66.0018], size: "large" },
        { code: "PUJ", name: "Punta Cana International Airport", city: "Punta Cana", country: "Dominican Republic", coordinates: [18.5674, -68.3634], size: "large" },
        { code: "SDQ", name: "Las Amricas International Airport", city: "Santo Domingo", country: "Dominican Republic", coordinates: [18.4297, -69.6689], size: "large" },
        { code: "MBJ", name: "Sangster International Airport", city: "Montego Bay", country: "Jamaica", coordinates: [18.5037, -77.9134], size: "large" },
        { code: "KIN", name: "Norman Manley International Airport", city: "Kingston", country: "Jamaica", coordinates: [17.9357, -76.7875], size: "large" },
        { code: "NAS", name: "Lynden Pindling International Airport", city: "Nassau", country: "Bahamas", coordinates: [25.0390, -77.4662], size: "large" },
        { code: "FPO", name: "Grand Bahama International Airport", city: "Freeport", country: "Bahamas", coordinates: [26.5587, -78.6956], size: "medium" },
        { code: "GCM", name: "Owen Roberts International Airport", city: "George Town", country: "Cayman Islands", coordinates: [19.2928, -81.3577], size: "medium" },
        { code: "CUR", name: "Curaao International Airport", city: "Willemstad", country: "Curaao", coordinates: [12.1889, -68.9598], size: "medium" },
        { code: "AUA", name: "Queen Beatrix International Airport", city: "Oranjestad", country: "Aruba", coordinates: [12.5014, -70.0152], size: "medium" },
        { code: "BGI", name: "Grantley Adams International Airport", city: "Bridgetown", country: "Barbados", coordinates: [13.0746, -59.4925], size: "medium" },
        { code: "POS", name: "Piarco International Airport", city: "Port of Spain", country: "Trinidad and Tobago", coordinates: [10.5954, -61.3372], size: "medium" },
        
        { code: "GUM", name: "Antonio B. Won Pat International Airport", city: "Hagta", country: "Guam", coordinates: [13.4839, 144.7960], size: "large" },
        { code: "SPN", name: "Saipan International Airport", city: "Saipan", country: "Northern Mariana Islands", coordinates: [15.1190, 145.7290], size: "medium" },
        { code: "ROR", name: "Roman Tmetuchl International Airport", city: "Koror", country: "Palau", coordinates: [7.3673, 134.5443], size: "medium" },
        { code: "MAJ", name: "Marshall Islands International Airport", city: "Majuro", country: "Marshall Islands", coordinates: [7.0649, 171.2720], size: "medium" },
        { code: "KSA", name: "Kosrae International Airport", city: "Kosrae", country: "Micronesia", coordinates: [5.3570, 162.9580], size: "small" },
        { code: "PNI", name: "Pohnpei International Airport", city: "Pohnpei", country: "Micronesia", coordinates: [6.9851, 158.2090], size: "small" },
        { code: "TKK", name: "Chuuk International Airport", city: "Chuuk", country: "Micronesia", coordinates: [7.4619, 151.8430], size: "small" },
        { code: "YAP", name: "Yap International Airport", city: "Yap", country: "Micronesia", coordinates: [9.4989, 138.0820], size: "small" },
        { code: "APW", name: "Faleolo International Airport", city: "Apia", country: "Samoa", coordinates: [-13.8300, -172.0083], size: "medium" },
        { code: "TBU", name: "Fuaamotu International Airport", city: "Nukualofa", country: "Tonga", coordinates: [-21.2412, -175.1494], size: "medium" },
        { code: "VLI", name: "Bauerfield International Airport", city: "Port Vila", country: "Vanuatu", coordinates: [-17.6993, 168.3198], size: "medium" },
        { code: "NOU", name: "La Tontouta International Airport", city: "Nouma", country: "New Caledonia", coordinates: [-22.0146, 166.2130], size: "medium" },
        { code: "PPT", name: "Faa'a International Airport", city: "Papeete", country: "French Polynesia", coordinates: [-17.5567, -149.6114], size: "medium" },
        { code: "RAR", name: "Rarotonga International Airport", city: "Avarua", country: "Cook Islands", coordinates: [-21.2027, -159.8056], size: "small" },
        
        { code: "PMI", name: "Palma de Mallorca Airport", city: "Palma", country: "Spain", coordinates: [39.5517, 2.7388], size: "large" },
        { code: "IBZ", name: "Ibiza Airport", city: "Ibiza", country: "Spain", coordinates: [38.8729, 1.3731], size: "large" },
        { code: "MAH", name: "Menorca Airport", city: "Mahn", country: "Spain", coordinates: [39.8626, 4.2186], size: "medium" },
        { code: "ACE", name: "Lanzarote Airport", city: "Arrecife", country: "Spain", coordinates: [28.9455, -13.6052], size: "large" },
        { code: "LPA", name: "Gran Canaria Airport", city: "Las Palmas", country: "Spain", coordinates: [27.9319, -15.3866], size: "large" },
        { code: "TFS", name: "Tenerife South Airport", city: "Tenerife", country: "Spain", coordinates: [28.0445, -16.5725], size: "large" },
        { code: "TFN", name: "Tenerife North Airport", city: "Tenerife", country: "Spain", coordinates: [28.4827, -16.3415], size: "large" },
        { code: "FUE", name: "Fuerteventura Airport", city: "Puerto del Rosario", country: "Spain", coordinates: [28.4527, -13.8638], size: "large" },
        { code: "SPC", name: "La Palma Airport", city: "Santa Cruz de La Palma", country: "Spain", coordinates: [28.6265, -17.7556], size: "medium" },
        { code: "VDE", name: "El Hierro Airport", city: "Valverde", country: "Spain", coordinates: [27.8148, -17.8871], size: "small" },
        { code: "GMZ", name: "La Gomera Airport", city: "San Sebastin de La Gomera", country: "Spain", coordinates: [28.0296, -17.2146], size: "small" },
        { code: "FNC", name: "Madeira Airport", city: "Funchal", country: "Portugal", coordinates: [32.6941, -16.7745], size: "large" },
        { code: "PXO", name: "Porto Santo Airport", city: "Porto Santo", country: "Portugal", coordinates: [33.0734, -16.3500], size: "medium" },
        { code: "PDL", name: "Joo Paulo II Airport", city: "Ponta Delgada", country: "Portugal", coordinates: [37.7412, -25.6979], size: "large" },
        { code: "TER", name: "Lajes Airport", city: "Terceira", country: "Portugal", coordinates: [38.7618, -27.0908], size: "medium" },
        { code: "HOR", name: "Horta Airport", city: "Horta", country: "Portugal", coordinates: [38.5199, -28.7159], size: "small" },
        { code: "FLW", name: "Flores Airport", city: "Santa Cruz das Flores", country: "Portugal", coordinates: [39.4553, -31.1314], size: "small" },
        { code: "GRW", name: "Graciosa Airport", city: "Santa Cruz da Graciosa", country: "Portugal", coordinates: [39.0922, -28.0298], size: "small" },
        { code: "SMA", name: "Santa Maria Airport", city: "Vila do Porto", country: "Portugal", coordinates: [36.9714, -25.1706], size: "small" },
        { code: "BJV", name: "Milas-Bodrum Airport", city: "Bodrum", country: "Turkey", coordinates: [37.2506, 27.6643], size: "large" },
        { code: "DLM", name: "Dalaman Airport", city: "Dalaman", country: "Turkey", coordinates: [36.7131, 28.7926], size: "large" },
        { code: "AYT", name: "Antalya Airport", city: "Antalya", country: "Turkey", coordinates: [36.8987, 30.8005], size: "large" },
        
        { code: "MRU", name: "Sir Seewoosagur Ramgoolam International Airport", city: "Port Louis", country: "Mauritius", coordinates: [-20.4302, 57.6836], size: "large" },
        { code: "RUN", name: "Roland Garros Airport", city: "Saint-Denis", country: "Runion", coordinates: [-20.8871, 55.5103], size: "large" },
        { code: "TNR", name: "Ivato International Airport", city: "Antananarivo", country: "Madagascar", coordinates: [-18.7969, 47.4788], size: "large" },
        { code: "DZA", name: "Dzaoudzi Pamandzi International Airport", city: "Dzaoudzi", country: "Mayotte", coordinates: [-12.8047, 45.2811], size: "medium" },
        { code: "SEZ", name: "Seychelles International Airport", city: "Victoria", country: "Seychelles", coordinates: [-4.6743, 55.5218], size: "medium" },
        { code: "MLE", name: "Velana International Airport", city: "Mal", country: "Maldives", coordinates: [4.1918, 73.5291], size: "large" },

{ code: "ULN", name: "Chinggis Khaan International Airport", city: "Ulaanbaatar", country: "Mongolia", coordinates: [47.8431, 106.7664], size: "large" },
{ code: "UBN", name: "New Ulaanbaatar International Airport", city: "Ulaanbaatar", country: "Mongolia", coordinates: [47.6469, 106.8197], size: "large" },
{ code: "COQ", name: "Choibalsan Airport", city: "Choibalsan", country: "Mongolia", coordinates: [48.1353, 114.6464], size: "small" },
{ code: "MXV", name: "Mrn Airport", city: "Mrn", country: "Mongolia", coordinates: [49.6633, 100.0994], size: "small" },
{ code: "ULZ", name: "Uliastai Airport", city: "Uliastai", country: "Mongolia", coordinates: [47.7125, 96.5258], size: "small" },
{ code: "HVD", name: "Khovd Airport", city: "Khovd", country: "Mongolia", coordinates: [47.9541, 91.6282], size: "small" },
{ code: "LTI", name: "Altai Airport", city: "Altai", country: "Mongolia", coordinates: [46.3764, 96.2211], size: "small" },
{ code: "DLZ", name: "Dalanzadgad Airport", city: "Dalanzadgad", country: "Mongolia", coordinates: [43.5917, 104.4300], size: "small" },

{ code: "ALA", name: "Almaty International Airport", city: "Almaty", country: "Kazakhstan", coordinates: [43.3551, 77.0405], size: "large" },
{ code: "NQZ", name: "Nursultan Nazarbayev International Airport", city: "Astana", country: "Kazakhstan", coordinates: [51.0222, 71.4669], size: "large" },
{ code: "CIT", name: "Shymkent International Airport", city: "Shymkent", country: "Kazakhstan", coordinates: [42.3642, 69.4789], size: "medium" },
{ code: "AKX", name: "Aktobe International Airport", city: "Aktobe", country: "Kazakhstan", coordinates: [50.2458, 57.2067], size: "medium" },
{ code: "GUW", name: "Atyrau International Airport", city: "Atyrau", country: "Kazakhstan", coordinates: [47.1219, 51.8214], size: "medium" },
{ code: "KGF", name: "Sary-Arka Airport", city: "Karaganda", country: "Kazakhstan", coordinates: [49.6708, 73.3344], size: "medium" },
{ code: "URA", name: "Oral Ak Zhol Airport", city: "Oral", country: "Kazakhstan", coordinates: [51.1508, 51.5431], size: "medium" },
{ code: "PWQ", name: "Pavlodar Airport", city: "Pavlodar", country: "Kazakhstan", coordinates: [52.1950, 77.0739], size: "medium" },
{ code: "PLX", name: "Semey Airport", city: "Semey", country: "Kazakhstan", coordinates: [50.3513, 80.2344], size: "medium" },
{ code: "DMB", name: "Taraz Airport", city: "Taraz", country: "Kazakhstan", coordinates: [42.8536, 71.3036], size: "small" },
{ code: "UKK", name: "skemen Airport", city: "Oskemen", country: "Kazakhstan", coordinates: [50.0366, 82.4942], size: "medium" },
{ code: "KOV", name: "Kokshetau Airport", city: "Kokshetau", country: "Kazakhstan", coordinates: [53.3291, 69.5946], size: "small" },
{ code: "PPK", name: "Petropavl Airport", city: "Petropavl", country: "Kazakhstan", coordinates: [54.7747, 69.1839], size: "small" },
{ code: "ZIX", name: "Zhylyoi Airport", city: "Kulsary", country: "Kazakhstan", coordinates: [46.8833, 54.0167], size: "small" },

{ code: "FRU", name: "Manas International Airport", city: "Bishkek", country: "Kyrgyzstan", coordinates: [43.0613, 74.4776], size: "large" },
{ code: "OSS", name: "Osh Airport", city: "Osh", country: "Kyrgyzstan", coordinates: [40.6090, 72.7933], size: "medium" },
{ code: "IKU", name: "Issyk-Kul International Airport", city: "Tamchy", country: "Kyrgyzstan", coordinates: [42.5878, 76.7131], size: "small" },
{ code: "KDJ", name: "Kyrgyzstan Airport", city: "Jalal-Abad", country: "Kyrgyzstan", coordinates: [40.9444, 72.9778], size: "small" },

{ code: "DYU", name: "Dushanbe International Airport", city: "Dushanbe", country: "Tajikistan", coordinates: [38.5433, 68.8250], size: "large" },
{ code: "LBD", name: "Khujand Airport", city: "Khujand", country: "Tajikistan", coordinates: [40.2154, 69.6947], size: "medium" },
{ code: "KQT", name: "Qurghonteppa International Airport", city: "Bokhtar", country: "Tajikistan", coordinates: [37.8664, 68.8647], size: "small" },
{ code: "TJU", name: "Kulob Airport", city: "Kulob", country: "Tajikistan", coordinates: [37.9881, 69.8050], size: "small" },

{ code: "ASB", name: "Ashgabat International Airport", city: "Ashgabat", country: "Turkmenistan", coordinates: [37.9868, 58.3610], size: "large" },
{ code: "KRW", name: "Turkmenbashi International Airport", city: "Turkmenbashi", country: "Turkmenistan", coordinates: [40.0633, 53.0072], size: "medium" },
{ code: "MYP", name: "Mary International Airport", city: "Mary", country: "Turkmenistan", coordinates: [37.6194, 61.8967], size: "medium" },
{ code: "TAZ", name: "Daoguz Airport", city: "Daoguz", country: "Turkmenistan", coordinates: [41.7644, 59.8331], size: "small" },
{ code: "CRZ", name: "Turkmenabat International Airport", city: "Turkmenabat", country: "Turkmenistan", coordinates: [39.0833, 63.6133], size: "medium" },

{ code: "TAS", name: "Islam Karimov Tashkent International Airport", city: "Tashkent", country: "Uzbekistan", coordinates: [41.2579, 69.2812], size: "large" },
{ code: "SKD", name: "Samarkand International Airport", city: "Samarkand", country: "Uzbekistan", coordinates: [39.7005, 66.9838], size: "medium" },
{ code: "BHK", name: "Bukhara International Airport", city: "Bukhara", country: "Uzbekistan", coordinates: [39.7750, 64.4833], size: "medium" },
{ code: "FEG", name: "Fergana International Airport", city: "Fergana", country: "Uzbekistan", coordinates: [40.3588, 71.7450], size: "medium" },
{ code: "NMA", name: "Namangan Airport", city: "Namangan", country: "Uzbekistan", coordinates: [40.9846, 71.5567], size: "medium" },
{ code: "UGC", name: "Urgench International Airport", city: "Urgench", country: "Uzbekistan", coordinates: [41.5843, 60.6417], size: "medium" },
{ code: "KSQ", name: "Karshi Airport", city: "Karshi", country: "Uzbekistan", coordinates: [38.8336, 65.9215], size: "medium" },
{ code: "TMJ", name: "Termez Airport", city: "Termez", country: "Uzbekistan", coordinates: [37.2867, 67.3100], size: "medium" },
{ code: "NCU", name: "Nukus Airport", city: "Nukus", country: "Uzbekistan", coordinates: [42.4884, 59.6233], size: "medium" },

{ code: "GYD", name: "Heydar Aliyev International Airport", city: "Baku", country: "Azerbaijan", coordinates: [40.4675, 50.0467], size: "large" },
{ code: "KVD", name: "Ganja International Airport", city: "Ganja", country: "Azerbaijan", coordinates: [40.7377, 46.3176], size: "medium" },
{ code: "NAJ", name: "Nakhchivan International Airport", city: "Nakhchivan", country: "Azerbaijan", coordinates: [39.1888, 45.4584], size: "medium" },
{ code: "GBB", name: "Qabala International Airport", city: "Qabala", country: "Azerbaijan", coordinates: [40.8267, 47.7125], size: "small" },
{ code: "LLK", name: "Lankaran International Airport", city: "Lankaran", country: "Azerbaijan", coordinates: [38.7464, 48.8180], size: "small" },
{ code: "ZTU", name: "Zaqatala International Airport", city: "Zaqatala", country: "Azerbaijan", coordinates: [41.5622, 46.6672], size: "small" },

{ code: "EVN", name: "Zvartnots International Airport", city: "Yerevan", country: "Armenia", coordinates: [40.1473, 44.3959], size: "large" },
{ code: "LWN", name: "Shirak International Airport", city: "Gyumri", country: "Armenia", coordinates: [40.7504, 43.8593], size: "medium" },

{ code: "TBS", name: "Tbilisi International Airport", city: "Tbilisi", country: "Georgia", coordinates: [41.6692, 44.9547], size: "large" },
{ code: "BUS", name: "Batumi International Airport", city: "Batumi", country: "Georgia", coordinates: [41.6103, 41.5997], size: "medium" },
{ code: "KUT", name: "David the Builder Kutaisi International Airport", city: "Kutaisi", country: "Georgia", coordinates: [42.1769, 42.4828], size: "medium" },
{ code: "SUI", name: "Sukhumi Babushara Airport", city: "Sukhumi", country: "Georgia", coordinates: [42.8582, 41.1281], size: "small" },

{ code: "TLL", name: "Lennart Meri Tallinn Airport", city: "Tallinn", country: "Estonia", coordinates: [59.4133, 24.8328], size: "large" },
{ code: "TAY", name: "Tartu Airport", city: "Tartu", country: "Estonia", coordinates: [58.3075, 26.6904], size: "small" },
{ code: "URE", name: "Kuressaare Airport", city: "Kuressaare", country: "Estonia", coordinates: [58.2299, 22.5095], size: "small" },
{ code: "EPU", name: "Prnu Airport", city: "Prnu", country: "Estonia", coordinates: [58.4190, 24.4728], size: "small" },

{ code: "RIX", name: "Riga International Airport", city: "Riga", country: "Latvia", coordinates: [56.9236, 23.9711], size: "large" },
{ code: "VNT", name: "Ventspils International Airport", city: "Ventspils", country: "Latvia", coordinates: [57.3578, 21.5442], size: "small" },
{ code: "LPX", name: "Liepja International Airport", city: "Liepja", country: "Latvia", coordinates: [56.5175, 21.0969], size: "small" },

{ code: "VNO", name: "Vilnius International Airport", city: "Vilnius", country: "Lithuania", coordinates: [54.6341, 25.2858], size: "large" },
{ code: "KUN", name: "Kaunas International Airport", city: "Kaunas", country: "Lithuania", coordinates: [54.9639, 24.0848], size: "medium" },
{ code: "PLQ", name: "Palanga International Airport", city: "Palanga", country: "Lithuania", coordinates: [55.9732, 21.0939], size: "medium" },
{ code: "SQQ", name: "iauliai International Airport", city: "iauliai", country: "Lithuania", coordinates: [55.8939, 23.3950], size: "small" },

{ code: "PRN", name: "Pristina International Airport", city: "Pristina", country: "Kosovo", coordinates: [42.5728, 21.0358], size: "medium" },
{ code: "TGD", name: "Podgorica Airport", city: "Podgorica", country: "Montenegro", coordinates: [42.3594, 19.2519], size: "medium" },
{ code: "TIV", name: "Tivat Airport", city: "Tivat", country: "Montenegro", coordinates: [42.4047, 18.7233], size: "medium" },
{ code: "OHD", name: "Ohrid St. Paul the Apostle Airport", city: "Ohrid", country: "North Macedonia", coordinates: [41.1800, 20.7423], size: "small" },
{ code: "SKP", name: "Skopje International Airport", city: "Skopje", country: "North Macedonia", coordinates: [41.9616, 21.6214], size: "medium" },
{ code: "SJJ", name: "Sarajevo International Airport", city: "Sarajevo", country: "Bosnia and Herzegovina", coordinates: [43.8246, 18.3315], size: "medium" },
{ code: "BNX", name: "Banja Luka International Airport", city: "Banja Luka", country: "Bosnia and Herzegovina", coordinates: [44.9414, 17.2975], size: "small" },
{ code: "OMO", name: "Mostar International Airport", city: "Mostar", country: "Bosnia and Herzegovina", coordinates: [43.2829, 17.8459], size: "small" },
{ code: "TZL", name: "Tuzla International Airport", city: "Tuzla", country: "Bosnia and Herzegovina", coordinates: [44.4587, 18.7248], size: "small" },

{ code: "GYE", name: "Jos Joaqun de Olmedo International Airport", city: "Guayaquil", country: "Ecuador", coordinates: [-2.1574, -79.8836], size: "large" },
{ code: "UIO", name: "Mariscal Sucre International Airport", city: "Quito", country: "Ecuador", coordinates: [-0.1411, -78.4882], size: "large" },
{ code: "CUE", name: "Mariscal Lamar International Airport", city: "Cuenca", country: "Ecuador", coordinates: [-2.8895, -78.9844], size: "medium" },
{ code: "GPS", name: "Seymour Airport", city: "Galpagos Islands", country: "Ecuador", coordinates: [-0.4538, -90.2659], size: "medium" },
{ code: "SCY", name: "San Cristbal Airport", city: "Galpagos Islands", country: "Ecuador", coordinates: [-0.9102, -89.6174], size: "small" },

{ code: "VVI", name: "Viru Viru International Airport", city: "Santa Cruz", country: "Bolivia", coordinates: [-17.6448, -63.1354], size: "large" },
{ code: "LPB", name: "El Alto International Airport", city: "La Paz", country: "Bolivia", coordinates: [-16.5133, -68.1923], size: "large" },
{ code: "CBB", name: "Jorge Wilstermann International Airport", city: "Cochabamba", country: "Bolivia", coordinates: [-17.4211, -66.1771], size: "medium" },
{ code: "TJA", name: "Capitn Oriel Lea Plaza Airport", city: "Tarija", country: "Bolivia", coordinates: [-21.5557, -64.7013], size: "small" },
{ code: "SRE", name: "Juana Azurduy de Padilla International Airport", city: "Sucre", country: "Bolivia", coordinates: [-19.0071, -65.2887], size: "small" },
{ code: "POI", name: "Captain Nicolas Rojas Airport", city: "Potos", country: "Bolivia", coordinates: [-19.5431, -65.7237], size: "small" },

{ code: "ASU", name: "Silvio Pettirossi International Airport", city: "Asuncin", country: "Paraguay", coordinates: [-25.2398, -57.5191], size: "large" },
{ code: "AGT", name: "Guaran International Airport", city: "Ciudad del Este", country: "Paraguay", coordinates: [-25.4545, -54.8432], size: "medium" },

{ code: "MVD", name: "Carrasco International Airport", city: "Montevideo", country: "Uruguay", coordinates: [-34.8384, -56.0308], size: "large" },
{ code: "PDP", name: "Capitn de Corbeta Carlos A. Curbelo International Airport", city: "Punta del Este", country: "Uruguay", coordinates: [-34.8551, -55.0943], size: "medium" },
{ code: "STY", name: "Nueva Hesprides International Airport", city: "Salto", country: "Uruguay", coordinates: [-31.4385, -57.9853], size: "small" },

{ code: "CCS", name: "Simn Bolvar International Airport", city: "Caracas", country: "Venezuela", coordinates: [10.6031, -66.9906], size: "large" },
{ code: "MAR", name: "La Chinita International Airport", city: "Maracaibo", country: "Venezuela", coordinates: [10.5582, -71.7279], size: "large" },
{ code: "VLN", name: "Arturo Michelena International Airport", city: "Valencia", country: "Venezuela", coordinates: [10.1497, -67.9284], size: "medium" },
{ code: "BLA", name: "General Jos Antonio Anzotegui International Airport", city: "Barcelona", country: "Venezuela", coordinates: [10.1071, -64.6892], size: "medium" },
{ code: "PZO", name: "Manuel Carlos Piar Guayana Airport", city: "Ciudad Guayana", country: "Venezuela", coordinates: [8.2885, -62.7604], size: "medium" },
{ code: "SVZ", name: "San Antonio del Tchira Airport", city: "San Antonio", country: "Venezuela", coordinates: [7.8408, -72.4397], size: "small" },

{ code: "PTY", name: "Tocumen International Airport", city: "Panama City", country: "Panama", coordinates: [9.0714, -79.3835], size: "large" },
{ code: "PAC", name: "Marcos A. Gelabert International Airport", city: "Panama City", country: "Panama", coordinates: [8.9733, -79.5556], size: "medium" },
{ code: "DAV", name: "Enrique Malek International Airport", city: "David", country: "Panama", coordinates: [8.3910, -82.4348], size: "medium" },

{ code: "SJO", name: "Juan Santamara International Airport", city: "San Jos", country: "Costa Rica", coordinates: [9.9939, -84.2089], size: "large" },
{ code: "LIR", name: "Daniel Oduber Quirs International Airport", city: "Liberia", country: "Costa Rica", coordinates: [10.5933, -85.5444], size: "large" },
{ code: "SYQ", name: "Tobas Bolaos International Airport", city: "San Jos", country: "Costa Rica", coordinates: [9.9571, -84.1398], size: "small" },
{ code: "PMS", name: "Puerto Jimnez Airport", city: "Puerto Jimnez", country: "Costa Rica", coordinates: [8.5333, -83.3000], size: "small" },
{ code: "DRK", name: "Drake Bay Airport", city: "Drake Bay", country: "Costa Rica", coordinates: [8.7189, -83.6417], size: "small" },

{ code: "MGA", name: "Augusto C. Sandino International Airport", city: "Managua", country: "Nicaragua", coordinates: [12.1415, -86.1682], size: "large" },

{ code: "SAP", name: "Ramn Villeda Morales International Airport", city: "San Pedro Sula", country: "Honduras", coordinates: [15.4526, -87.9236], size: "large" },
{ code: "TGU", name: "Toncontn International Airport", city: "Tegucigalpa", country: "Honduras", coordinates: [14.0609, -87.2172], size: "medium" },
{ code: "RTB", name: "Juan Manuel Glvez International Airport", city: "Roatn", country: "Honduras", coordinates: [16.3168, -86.5230], size: "medium" },
{ code: "LCE", name: "Golosn International Airport", city: "La Ceiba", country: "Honduras", coordinates: [15.7425, -86.8530], size: "medium" },

{ code: "BZE", name: "Philip S. W. Goldson International Airport", city: "Belize City", country: "Belize", coordinates: [17.5392, -88.3082], size: "large" },
{ code: "SPR", name: "San Pedro Airport", city: "San Pedro", country: "Belize", coordinates: [17.9139, -87.9711], size: "small" },
{ code: "CYD", name: "Caye Caulker Airport", city: "Caye Caulker", country: "Belize", coordinates: [17.7347, -88.0325], size: "small" },

{ code: "GUA", name: "La Aurora International Airport", city: "Guatemala City", country: "Guatemala", coordinates: [14.5833, -90.5275], size: "large" },
{ code: "FRS", name: "Mundo Maya International Airport", city: "Flores", country: "Guatemala", coordinates: [16.9138, -89.8664], size: "medium" },
{ code: "AAZ", name: "Quetzaltenango Airport", city: "Quetzaltenango", country: "Guatemala", coordinates: [14.8656, -91.5019], size: "small" },

{ code: "SAL", name: "Monseor scar Arnulfo Romero International Airport", city: "San Salvador", country: "El Salvador", coordinates: [13.4409, -89.0557], size: "large" },

{ code: "BRG", name: "Terrance B. Lettsome International Airport", city: "Road Town", country: "British Virgin Islands", coordinates: [18.4448, -64.5429], size: "small" },
{ code: "NEV", name: "Vance W. Amory International Airport", city: "Nevis", country: "Saint Kitts and Nevis", coordinates: [17.2058, -62.5899], size: "small" },
{ code: "MNI", name: "John A. Osborne Airport", city: "Gerald's Park", country: "Montserrat", coordinates: [16.7914, -62.1933], size: "small" },
{ code: "BBR", name: "Baillif Airport", city: "Basse-Terre", country: "Guadeloupe", coordinates: [16.0133, -61.7422], size: "small" },
{ code: "SFG", name: "L'Esprance Airport", city: "Grand Case", country: "Saint Martin", coordinates: [18.0999, -63.0472], size: "small" },
{ code: "GBJ", name: "Les Bases Airport", city: "Grand-Bourg", country: "Guadeloupe", coordinates: [15.8687, -61.2700], size: "small" },
{ code: "FDF", name: "Martinique Aim Csaire International Airport", city: "Fort-de-France", country: "Martinique", coordinates: [14.5910, -61.0032], size: "medium" },
{ code: "PTP", name: "Pointe--Pitre International Airport", city: "Pointe--Pitre", country: "Guadeloupe", coordinates: [16.2653, -61.5318], size: "medium" },
{ code: "CAY", name: "Cayenne  Flix bou Airport", city: "Cayenne", country: "French Guiana", coordinates: [4.8198, -52.3604], size: "medium" },

{ code: "DLA", name: "Douala International Airport", city: "Douala", country: "Cameroon", coordinates: [4.0061, 9.7195], size: "large" },
{ code: "NSI", name: "Yaound Nsimalen International Airport", city: "Yaound", country: "Cameroon", coordinates: [3.7226, 11.5533], size: "large" },
{ code: "BGF", name: "Bangui M'Poko International Airport", city: "Bangui", country: "Central African Republic", coordinates: [4.3985, 18.5188], size: "medium" },
{ code: "NDJ", name: "N'Djamena International Airport", city: "N'Djamena", country: "Chad", coordinates: [12.1337, 15.0340], size: "medium" },
{ code: "COO", name: "Cadjehoun Airport", city: "Cotonou", country: "Benin", coordinates: [6.3572, 2.3844], size: "medium" },
{ code: "LFW", name: "LomTokoin International Airport", city: "Lom", country: "Togo", coordinates: [6.1656, 1.2544], size: "medium" },
{ code: "OUA", name: "Ouagadougou International Airport", city: "Ouagadougou", country: "Burkina Faso", coordinates: [12.3532, -1.5124], size: "medium" },
{ code: "BKO", name: "BamakoSnou International Airport", city: "Bamako", country: "Mali", coordinates: [12.5335, -7.9499], size: "medium" },
{ code: "NKC", name: "NouakchottOumtounsy International Airport", city: "Nouakchott", country: "Mauritania", coordinates: [18.3100, -15.9697], size: "medium" },
{ code: "DSS", name: "Blaise Diagne International Airport", city: "Dakar", country: "Senegal", coordinates: [14.7397, -17.4902], size: "large" },
{ code: "BJL", name: "Banjul International Airport", city: "Banjul", country: "Gambia", coordinates: [13.3380, -16.6522], size: "medium" },
{ code: "FNA", name: "Lungi International Airport", city: "Freetown", country: "Sierra Leone", coordinates: [8.6164, -13.1955], size: "medium" },
{ code: "ROB", name: "Roberts International Airport", city: "Monrovia", country: "Liberia", coordinates: [6.2338, -10.3623], size: "medium" },
{ code: "ABJ", name: "Flix-Houphout-Boigny International Airport", city: "Abidjan", country: "Ivory Coast", coordinates: [5.2614, -3.9263], size: "large" },
{ code: "ACC", name: "Kotoka International Airport", city: "Accra", country: "Ghana", coordinates: [5.6052, -0.1668], size: "large" },

{ code: "NIM", name: "Diori Hamani International Airport", city: "Niamey", country: "Niger", coordinates: [13.4815, 2.1836], size: "medium" },
{ code: "KAN", name: "Mallam Aminu Kano International Airport", city: "Kano", country: "Nigeria", coordinates: [12.0476, 8.5246], size: "large" },
{ code: "ABV", name: "Nnamdi Azikiwe International Airport", city: "Abuja", country: "Nigeria", coordinates: [9.0068, 7.2632], size: "large" },
{ code: "LOS", name: "Murtala Muhammed International Airport", city: "Lagos", country: "Nigeria", coordinates: [6.5774, 3.3212], size: "large" },
{ code: "PHC", name: "Port Harcourt International Airport", city: "Port Harcourt", country: "Nigeria", coordinates: [5.0151, 6.9496], size: "large" },
{ code: "ENU", name: "Akanu Ibiam International Airport", city: "Enugu", country: "Nigeria", coordinates: [6.4743, 7.5619], size: "medium" },
{ code: "KAD", name: "Kaduna International Airport", city: "Kaduna", country: "Nigeria", coordinates: [10.6960, 7.3201], size: "medium" },

{ code: "SSG", name: "Malabo International Airport", city: "Malabo", country: "Equatorial Guinea", coordinates: [3.7550, 8.7087], size: "medium" },
{ code: "BSG", name: "Bata Airport", city: "Bata", country: "Equatorial Guinea", coordinates: [1.9055, 9.8056], size: "small" },
{ code: "LBV", name: "Libreville International Airport", city: "Libreville", country: "Gabon", coordinates: [0.4586, 9.4123], size: "large" },
{ code: "POG", name: "Port Gentil International Airport", city: "Port-Gentil", country: "Gabon", coordinates: [-0.7117, 8.7544], size: "medium" },
{ code: "BZV", name: "Maya-Maya Airport", city: "Brazzaville", country: "Republic of the Congo", coordinates: [-4.2517, 15.2530], size: "medium" },
{ code: "FIH", name: "N'djili International Airport", city: "Kinshasa", country: "DR Congo", coordinates: [-4.3858, 15.4446], size: "large" },
{ code: "FBM", name: "Lubumbashi International Airport", city: "Lubumbashi", country: "DR Congo", coordinates: [-11.5913, 27.5309], size: "medium" },
{ code: "KGL", name: "Kigali International Airport", city: "Kigali", country: "Rwanda", coordinates: [-1.9686, 30.1395], size: "large" },
{ code: "BJM", name: "Bujumbura International Airport", city: "Bujumbura", country: "Burundi", coordinates: [-3.3240, 29.3185], size: "medium" },
{ code: "EBB", name: "Entebbe International Airport", city: "Entebbe", country: "Uganda", coordinates: [0.0424, 32.4435], size: "large" },
{ code: "JUB", name: "Juba International Airport", city: "Juba", country: "South Sudan", coordinates: [4.8720, 31.6011], size: "medium" },

{ code: "MPM", name: "Maputo International Airport", city: "Maputo", country: "Mozambique", coordinates: [-25.9208, 32.5726], size: "large" },
{ code: "BEW", name: "Beira Airport", city: "Beira", country: "Mozambique", coordinates: [-19.7964, 34.9076], size: "medium" },
{ code: "VNX", name: "Vilankulo Airport", city: "Vilankulo", country: "Mozambique", coordinates: [-22.0184, 35.3133], size: "small" },
{ code: "INH", name: "Inhambane Airport", city: "Inhambane", country: "Mozambique", coordinates: [-23.8764, 35.4085], size: "small" },
{ code: "WDH", name: "Hosea Kutako International Airport", city: "Windhoek", country: "Namibia", coordinates: [-22.4867, 17.4625], size: "large" },
{ code: "WVB", name: "Walvis Bay Airport", city: "Walvis Bay", country: "Namibia", coordinates: [-22.9799, 14.6453], size: "medium" },
{ code: "GBE", name: "Sir Seretse Khama International Airport", city: "Gaborone", country: "Botswana", coordinates: [-24.5552, 25.9182], size: "large" },
{ code: "BBK", name: "Kasane Airport", city: "Kasane", country: "Botswana", coordinates: [-17.8329, 25.1624], size: "small" },
{ code: "MUB", name: "Maun Airport", city: "Maun", country: "Botswana", coordinates: [-19.9726, 23.4311], size: "medium" },
{ code: "HRE", name: "Robert Gabriel Mugabe International Airport", city: "Harare", country: "Zimbabwe", coordinates: [-17.9318, 31.0928], size: "large" },
{ code: "BUQ", name: "Joshua Mqabuko Nkomo International Airport", city: "Bulawayo", country: "Zimbabwe", coordinates: [-20.0174, 28.6179], size: "medium" },
{ code: "VFA", name: "Victoria Falls International Airport", city: "Victoria Falls", country: "Zimbabwe", coordinates: [-18.0959, 25.8390], size: "medium" },
{ code: "LUN", name: "Kenneth Kaunda International Airport", city: "Lusaka", country: "Zambia", coordinates: [-15.3308, 28.4527], size: "large" },
{ code: "LVI", name: "Harry Mwanga Nkumbula International Airport", city: "Livingstone", country: "Zambia", coordinates: [-17.8218, 25.8227], size: "medium" },
{ code: "BLZ", name: "Chileka International Airport", city: "Blantyre", country: "Malawi", coordinates: [-15.6791, 34.9740], size: "medium" },
{ code: "LLW", name: "Lilongwe International Airport", city: "Lilongwe", country: "Malawi", coordinates: [-13.7894, 33.7810], size: "medium" },
{ code: "TNR", name: "Ivato International Airport", city: "Antananarivo", country: "Madagascar", coordinates: [-18.7969, 47.4788], size: "large" },
{ code: "NOS", name: "Fascene Airport", city: "Nosy Be", country: "Madagascar", coordinates: [-13.3121, 48.3148], size: "medium" },
{ code: "DZA", name: "Dzaoudzi Pamandzi International Airport", city: "Dzaoudzi", country: "Mayotte", coordinates: [-12.8047, 45.2811], size: "medium" },
{ code: "RUN", name: "Roland Garros Airport", city: "Saint-Denis", country: "Runion", coordinates: [-20.8871, 55.5103], size: "large" },
{ code: "MRU", name: "Sir Seewoosagur Ramgoolam International Airport", city: "Port Louis", country: "Mauritius", coordinates: [-20.4302, 57.6836], size: "large" },
{ code: "SEZ", name: "Seychelles International Airport", city: "Victoria", country: "Seychelles", coordinates: [-4.6743, 55.5218], size: "medium" },
{ code: "PRI", name: "Praslin Island Airport", city: "Praslin", country: "Seychelles", coordinates: [-4.3193, 55.6914], size: "small" },
{ code: "COM", name: "Mutiara Airport", city: "Maumere", country: "Indonesia", coordinates: [-8.6406, 122.2369], size: "small" },

{ code: "TBS", name: "Tbilisi International Airport", city: "Tbilisi", country: "Georgia", coordinates: [41.6692, 44.9547], size: "large" },
{ code: "KUT", name: "David the Builder Kutaisi International Airport", city: "Kutaisi", country: "Georgia", coordinates: [42.1769, 42.4828], size: "medium" },
{ code: "BUS", name: "Batumi International Airport", city: "Batumi", country: "Georgia", coordinates: [41.6103, 41.5997], size: "medium" },
{ code: "EVN", name: "Zvartnots International Airport", city: "Yerevan", country: "Armenia", coordinates: [40.1473, 44.3959], size: "large" },
{ code: "LWN", name: "Shirak International Airport", city: "Gyumri", country: "Armenia", coordinates: [40.7504, 43.8593], size: "medium" },
{ code: "GYD", name: "Heydar Aliyev International Airport", city: "Baku", country: "Azerbaijan", coordinates: [40.4675, 50.0467], size: "large" },
{ code: "KVD", name: "Ganja International Airport", city: "Ganja", country: "Azerbaijan", coordinates: [40.7377, 46.3176], size: "medium" },
{ code: "NAJ", name: "Nakhchivan International Airport", city: "Nakhchivan", country: "Azerbaijan", coordinates: [39.1888, 45.4584], size: "medium" },

{ code: "TKK", name: "Chuuk International Airport", city: "Chuuk", country: "Micronesia", coordinates: [7.4619, 151.8430], size: "small" },
{ code: "PNI", name: "Pohnpei International Airport", city: "Pohnpei", country: "Micronesia", coordinates: [6.9851, 158.2090], size: "small" },
{ code: "KSA", name: "Kosrae International Airport", city: "Kosrae", country: "Micronesia", coordinates: [5.3570, 162.9580], size: "small" },
{ code: "YAP", name: "Yap International Airport", city: "Yap", country: "Micronesia", coordinates: [9.4989, 138.0820], size: "small" },

{ code: "POM", name: "Jacksons International Airport", city: "Port Moresby", country: "Papua New Guinea", coordinates: [-9.4438, 147.2203], size: "large" },
{ code: "LAE", name: "Lae Nadzab Airport", city: "Lae", country: "Papua New Guinea", coordinates: [-6.5698, 146.7262], size: "medium" },
{ code: "HGU", name: "Mount Hagen Airport", city: "Mount Hagen", country: "Papua New Guinea", coordinates: [-5.8268, 144.2959], size: "medium" },
{ code: "RAB", name: "Rabaul Airport", city: "Rabaul", country: "Papua New Guinea", coordinates: [-4.3405, 152.3796], size: "small" },
{ code: "MAG", name: "Madang Airport", city: "Madang", country: "Papua New Guinea", coordinates: [-5.2071, 145.7887], size: "small" },
{ code: "VLI", name: "Bauerfield International Airport", city: "Port Vila", country: "Vanuatu", coordinates: [-17.6993, 168.3198], size: "medium" },
{ code: "SON", name: "Santo-Pekoa International Airport", city: "Luganville", country: "Vanuatu", coordinates: [-15.5050, 167.2197], size: "small" },
{ code: "NOU", name: "La Tontouta International Airport", city: "Nouma", country: "New Caledonia", coordinates: [-22.0146, 166.2130], size: "medium" },
{ code: "SUV", name: "Nausori International Airport", city: "Suva", country: "Fiji", coordinates: [-18.0433, 178.5592], size: "medium" },
{ code: "NAN", name: "Nadi International Airport", city: "Nadi", country: "Fiji", coordinates: [-17.7554, 177.4434], size: "large" },
{ code: "TBU", name: "Fuaamotu International Airport", city: "Nukualofa", country: "Tonga", coordinates: [-21.2412, -175.1494], size: "medium" },
{ code: "APW", name: "Faleolo International Airport", city: "Apia", country: "Samoa", coordinates: [-13.8300, -172.0083], size: "medium" },
{ code: "PPT", name: "Faa'a International Airport", city: "Papeete", country: "French Polynesia", coordinates: [-17.5567, -149.6114], size: "large" },
{ code: "BOB", name: "Bora Bora Airport", city: "Bora Bora", country: "French Polynesia", coordinates: [-16.4444, -151.7514], size: "medium" },
{ code: "RAR", name: "Rarotonga International Airport", city: "Avarua", country: "Cook Islands", coordinates: [-21.2027, -159.8056], size: "small" },
{ code: "FUN", name: "Funafuti International Airport", city: "Funafuti", country: "Tuvalu", coordinates: [-8.5250, 179.1964], size: "small" },
{ code: "TRW", name: "Bonriki International Airport", city: "Tarawa", country: "Kiribati", coordinates: [1.3816, 173.1469], size: "small" },
{ code: "INU", name: "Nauru International Airport", city: "Yaren", country: "Nauru", coordinates: [-0.5477, 166.9194], size: "small" }
    ];
}

function getMajorAirportsList() {
    return [
    { code: "JFK", name: "John F. Kennedy International", coords: [40.6413, -73.7781], city: "New York" },
    { code: "LAX", name: "Los Angeles International", coords: [33.9416, -118.4085], city: "Los Angeles" },
    { code: "ORD", name: "O'Hare International", coords: [41.9742, -87.9073], city: "Chicago" },
    { code: "DFW", name: "Dallas/Fort Worth International", coords: [32.8998, -97.0403], city: "Dallas" },
    { code: "DEN", name: "Denver International", coords: [39.8561, -104.6737], city: "Denver" },
    { code: "SFO", name: "San Francisco International", coords: [37.6213, -122.3790], city: "San Francisco" },
    { code: "SEA", name: "Seattle-Tacoma International", coords: [47.4502, -122.3088], city: "Seattle" },
    { code: "MIA", name: "Miami International", coords: [25.7959, -80.2870], city: "Miami" },
    { code: "ATL", name: "Hartsfield-Jackson Atlanta", coords: [33.6407, -84.4277], city: "Atlanta" },
    { code: "YYZ", name: "Toronto Pearson", coords: [43.6777, -79.6248], city: "Toronto" },
    { code: "YVR", name: "Vancouver International", coords: [49.1947, -123.1792], city: "Vancouver" },
    { code: "MEX", name: "Mexico City International", coords: [19.4363, -99.0721], city: "Mexico City" },

    { code: "LHR", name: "London Heathrow", coords: [51.4700, -0.4543], city: "London" },
    { code: "CDG", name: "Paris Charles de Gaulle", coords: [49.0097, 2.5479], city: "Paris" },
    { code: "FRA", name: "Frankfurt Airport", coords: [50.0333, 8.5706], city: "Frankfurt" },
    { code: "AMS", name: "Amsterdam Schiphol", coords: [52.3086, 4.7639], city: "Amsterdam" },
    { code: "MAD", name: "Madrid Barajas", coords: [40.4983, -3.5676], city: "Madrid" },
    { code: "FCO", name: "Rome Fiumicino", coords: [41.8045, 12.2508], city: "Rome" },
    { code: "BCN", name: "Barcelona El Prat", coords: [41.2974, 2.0833], city: "Barcelona" },
    { code: "ZRH", name: "Zurich Airport", coords: [47.4647, 8.5492], city: "Zurich" },
    { code: "IST", name: "Istanbul Airport", coords: [41.2622, 28.7425], city: "Istanbul" },
    { code: "DUB", name: "Dublin Airport", coords: [53.4213, -6.2701], city: "Dublin" },

    { code: "HND", name: "Tokyo Haneda", coords: [35.5494, 139.7798], city: "Tokyo" },
    { code: "NRT", name: "Tokyo Narita", coords: [35.7647, 140.3864], city: "Tokyo" },
    { code: "PEK", name: "Beijing Capital", coords: [40.0799, 116.6031], city: "Beijing" },
    { code: "PVG", name: "Shanghai Pudong", coords: [31.1434, 121.8052], city: "Shanghai" },
    { code: "HKG", name: "Hong Kong International", coords: [22.3080, 113.9185], city: "Hong Kong" },
    { code: "SIN", name: "Singapore Changi", coords: [1.3644, 103.9915], city: "Singapore" },
    { code: "BKK", name: "Bangkok Suvarnabhumi", coords: [13.6811, 100.7475], city: "Bangkok" },
    { code: "DEL", name: "Delhi Indira Gandhi", coords: [28.5562, 77.1000], city: "Delhi" },
    { code: "ICN", name: "Seoul Incheon", coords: [37.4602, 126.4407], city: "Seoul" },
    { code: "DOH", name: "Doha Hamad International", coords: [25.2609, 51.6138], city: "Doha" },

    { code: "SYD", name: "Sydney Kingsford Smith", coords: [-33.9399, 151.1753], city: "Sydney" },
    { code: "MEL", name: "Melbourne Airport", coords: [-37.6733, 144.8433], city: "Melbourne" },
    { code: "AKL", name: "Auckland Airport", coords: [-37.0081, 174.7925], city: "Auckland" },

    { code: "GRU", name: "So Paulo Guarulhos", coords: [-23.4356, -46.4731], city: "So Paulo" },
    { code: "EZE", name: "Buenos Aires Ezeiza", coords: [-34.8222, -58.5358], city: "Buenos Aires" },
    { code: "SCL", name: "Santiago Arturo Merino Bentez", coords: [-33.3930, -70.7858], city: "Santiago" },
    { code: "LIM", name: "Lima Jorge Chvez", coords: [-12.0219, -77.1143], city: "Lima" },

    { code: "JNB", name: "Johannesburg O.R. Tambo", coords: [-26.1392, 28.2460], city: "Johannesburg" },
    { code: "CAI", name: "Cairo International", coords: [30.1219, 31.4056], city: "Cairo" },
    { code: "ADD", name: "Addis Ababa Bole", coords: [8.9779, 38.7993], city: "Addis Ababa" },
    { code: "MBA", name: "Mombasa Moi International", coords: [-4.0348, 39.5942], city: "Mombasa" },

    { code: "DXB", name: "Dubai International", coords: [25.2532, 55.3657], city: "Dubai" },
    { code: "AUH", name: "Abu Dhabi International", coords: [24.4330, 54.6511], city: "Abu Dhabi" },
    { code: "RUH", name: "Riyadh King Khalid", coords: [24.9584, 46.6989], city: "Riyadh" },
    { code: "TLV", name: "Tel Aviv Ben Gurion", coords: [32.0114, 34.8867], city: "Tel Aviv" }
    ];
}

async function findNearestMajorAirport(coords) {
    const majorAirports = getMajorAirportsList();

    const airportsWithDistance = majorAirports.map(airport => {
        const distance = map.distance(coords, airport.coords);
        return { ...airport, distance };
    });

    airportsWithDistance.sort((a, b) => a.distance - b.distance);

    const nearbyAirports = airportsWithDistance.filter(a => a.distance <= 500000);

    if (nearbyAirports.length === 0) {
        return null;
    }

    return {
        name: nearbyAirports[0].name,
        code: nearbyAirports[0].code,
        city: nearbyAirports[0].city,
        coordinates: nearbyAirports[0].coords,
        distance: nearbyAirports[0].distance
    };
}

let airportCache = null;
const CACHE_DURATION = 24 * 60 * 60 * 1000;

async function getAirportDatabase() {
    if (airportCache && (Date.now() - airportCache.timestamp) < CACHE_DURATION) {
        return airportCache.data;
    }

    try {
        const airports = await getAllAirports();

        airportCache = {
            timestamp: Date.now(),
            data: airports
        };

        try {
            localStorage.setItem('airportData', JSON.stringify({
                timestamp: Date.now(),
                data: airports.slice(0, 5000)
            }));
        } catch (e) {}

        return airports;

    } catch (error) {
    try {
        const cached = JSON.parse(localStorage.getItem('airportData'));
        if (cached && cached.data) {
            return cached.data;
        }
    } catch (e) {}

    return getEssentialAirports();
}
}

async function findNearestAirport(coords, maxDistance = 200000) {
    const airports = await getAirportDatabase();
    const [lat, lng] = coords;

    let nearest = null;
    let minDistance = Infinity;

    for (const airport of airports) {
        const distance = map.distance([lat, lng], airport.coordinates);

        if (distance < minDistance && distance < maxDistance) {
            minDistance = distance;
            nearest = {
                ...airport,
                distance: distance
            };
        }
    }

    return nearest;
}

function getEssentialAirports() {
    return [
    { code: "ATL", name: "Hartsfield-Jackson Atlanta International", city: "Atlanta", country: "USA", coordinates: [33.6407, -84.4277] },
    { code: "LAX", name: "Los Angeles International", city: "Los Angeles", country: "USA", coordinates: [33.9416, -118.4085] },
    { code: "ORD", name: "O'Hare International", city: "Chicago", country: "USA", coordinates: [41.9742, -87.9073] },
    { code: "DFW", name: "Dallas/Fort Worth International", city: "Dallas", country: "USA", coordinates: [32.8998, -97.0403] },
    { code: "DEN", name: "Denver International", city: "Denver", country: "USA", coordinates: [39.8561, -104.6737] },
    { code: "JFK", name: "John F. Kennedy International", city: "New York", country: "USA", coordinates: [40.6413, -73.7781] },
    { code: "SFO", name: "San Francisco International", city: "San Francisco", country: "USA", coordinates: [37.6213, -122.3790] },
    { code: "SEA", name: "Seattle-Tacoma International", city: "Seattle", country: "USA", coordinates: [47.4502, -122.3088] },
    { code: "YYZ", name: "Toronto Pearson International", city: "Toronto", country: "Canada", coordinates: [43.6777, -79.6248] },
    { code: "MEX", name: "Mexico City International", city: "Mexico City", country: "Mexico", coordinates: [19.4363, -99.0721] },

    { code: "LHR", name: "London Heathrow", city: "London", country: "UK", coordinates: [51.4700, -0.4543] },
    { code: "CDG", name: "Paris Charles de Gaulle", city: "Paris", country: "France", coordinates: [49.0097, 2.5479] },
    { code: "AMS", name: "Amsterdam Schiphol", city: "Amsterdam", country: "Netherlands", coordinates: [52.3086, 4.7639] },
    { code: "FRA", name: "Frankfurt Airport", city: "Frankfurt", country: "Germany", coordinates: [50.0333, 8.5706] },
    { code: "IST", name: "Istanbul Airport", city: "Istanbul", country: "Turkey", coordinates: [41.2622, 28.7425] },
    { code: "MAD", name: "Madrid Barajas", city: "Madrid", country: "Spain", coordinates: [40.4983, -3.5676] },
    { code: "FCO", name: "Rome Fiumicino", city: "Rome", country: "Italy", coordinates: [41.8045, 12.2508] },

    { code: "PEK", name: "Beijing Capital International", city: "Beijing", country: "China", coordinates: [40.0799, 116.6031] },
    { code: "HND", name: "Tokyo Haneda", city: "Tokyo", country: "Japan", coordinates: [35.5494, 139.7798] },
    { code: "PVG", name: "Shanghai Pudong International", city: "Shanghai", country: "China", coordinates: [31.1434, 121.8052] },
    { code: "DXB", name: "Dubai International", city: "Dubai", country: "UAE", coordinates: [25.2532, 55.3657] },
    { code: "SIN", name: "Singapore Changi", city: "Singapore", country: "Singapore", coordinates: [1.3644, 103.9915] },
    { code: "BKK", name: "Bangkok Suvarnabhumi", city: "Bangkok", country: "Thailand", coordinates: [13.6811, 100.7475] },
    { code: "ICN", name: "Seoul Incheon International", city: "Seoul", country: "South Korea", coordinates: [37.4602, 126.4407] },
    { code: "DEL", name: "Delhi Indira Gandhi International", city: "Delhi", country: "India", coordinates: [28.5562, 77.1000] },

    { code: "SYD", name: "Sydney Kingsford Smith", city: "Sydney", country: "Australia", coordinates: [-33.9399, 151.1753] },
    { code: "MEL", name: "Melbourne Airport", city: "Melbourne", country: "Australia", coordinates: [-37.6733, 144.8433] },
    { code: "AKL", name: "Auckland Airport", city: "Auckland", country: "New Zealand", coordinates: [-37.0081, 174.7925] },

    { code: "GRU", name: "So Paulo Guarulhos", city: "So Paulo", country: "Brazil", coordinates: [-23.4356, -46.4731] },
    { code: "EZE", name: "Buenos Aires Ezeiza", city: "Buenos Aires", country: "Argentina", coordinates: [-34.8222, -58.5358] },

    { code: "JNB", name: "Johannesburg O.R. Tambo", city: "Johannesburg", country: "South Africa", coordinates: [-26.1392, 28.2460] },
    { code: "CAI", name: "Cairo International", city: "Cairo", country: "Egypt", coordinates: [30.1219, 31.4056] }
    ];
}

async function shouldShowFlightRoute(start, end, distance) {
    const distanceKm = distance / 1000;
    
    if (distanceKm > 800) return true;
    
    const waterCrossing = await isWaterCrossing(start, end);
    
    if (waterCrossing && distanceKm > 100) return true;

    if (distanceKm > 300) return true;
    
    return false;
}

async function calculateFlightRoute(start, end, distance) {
    if (distance < 300000) return null;

    const airports = await findBestAirportForRoute(start, end);
    if (!airports) return null;

    const { start: startAirport, end: endAirport } = airports;
    console.log(`located - ${startAirport} to ${endAirport}`);

    const toAirportDistance = startAirport.distance;
    const airportToAirportDistance = map.distance(startAirport.coordinates, endAirport.coordinates);
    const fromAirportDistance = endAirport.distance;

    const groundSpeed = 30000;
    const flightSpeed = 800000;
    const airportTime = 7200;

    const toAirportTime = (toAirportDistance / groundSpeed) * 3600;
    const flightTime = (airportToAirportDistance / flightSpeed) * 3600;
    const fromAirportTime = (fromAirportDistance / groundSpeed) * 3600;

    const totalTime = toAirportTime + flightTime + fromAirportTime + airportTime;

    const directDistance = map.distance(start, end);
    const drivingTime = (directDistance / 80000) * 3600;

    return {
        id: 'flight',
        icon: 'lucide:plane',
        label: 'Flight',
        duration: totalTime,
        distance: airportToAirportDistance,
        geometry: createFlightPath(startAirport.coordinates, endAirport.coordinates),
        steps: [
        {
            distance: toAirportDistance,
            duration: toAirportTime,
            maneuver: {
                instruction: `Travel to ${startAirport.code} Airport`,
                type: 'ground'
            }
        },
        {
            distance: airportToAirportDistance,
            duration: flightTime,
            maneuver: {
                instruction: `Fly from ${startAirport.code} to ${endAirport.code}`,
                type: 'flight'
            }
        },
        {
            distance: fromAirportDistance,
            duration: fromAirportTime,
            maneuver: {
                instruction: `Travel from ${endAirport.code} Airport to destination`,
                type: 'ground'
            }
        }
        ],
        airports: {
            departure: startAirport,
            arrival: endAirport
        },
        groundTransport: {
            toAirport: formatTime(toAirportTime),
            fromAirport: formatTime(fromAirportTime)
        },
        details: `${startAirport.name}  ${endAirport.name}`
    };
}

function processOSRMSteps(osrmSteps) {
    return osrmSteps.map((step, index) => {
        const exitInfo = getExitInfo(step);
        const instruction = generateRealNavigationInstruction(step, index, osrmSteps);

        return {
            distance: step.distance,
            duration: step.duration,
            geometry: step.geometry,
            maneuver: {
                instruction: instruction,
                type: step.maneuver?.type || 'continue',
                modifier: step.maneuver?.modifier || '',
                location: step.maneuver?.location,
                exit: step.maneuver?.exit,
                notification_type: step.maneuver?.notification_type
            },
            name: step.name || getStreetName(step),
            ref: step.ref || '',
            destinations: step.destinations || '',
            intersections: step.intersections || [],
            exit: exitInfo,
            way_points: step.way_points
        };
    });
}

function generateFlightBookingLinks(departure, arrival) {
    const links = [];

    if (departure.code && arrival.code) {
        links.push({
            name: "Kayak",
            url: `https://www.kayak.com/flights/${departure.code}-${arrival.code}`,
            icon: "lucide:search"
        });

        links.push({
            name: "Expedia",
            url: `https://www.expedia.com/Flights-Search?flight-type=on&mode=search&trip=oneway&leg1=from:${departure.code},to:${arrival.code}`,
            icon: "lucide:plane"
        });

        links.push({
            name: "Google Flights",
            url: `https://www.google.com/travel/flights?q=Flights%20to%20${arrival.code}%20from%20${departure.code}`,
            icon: "lucide:globe"
        });
    } else {
    const startName = departure.city || departure.name || "origin";
    const endName = arrival.city || arrival.name || "destination";

    links.push({
        name: "Search Flights",
        url: `https://www.google.com/search?q=flights+from+${encodeURIComponent(startName)}+to+${encodeURIComponent(endName)}`,
        icon: "lucide:search"
    });
}

links.push({
    name: "Car Rental",
    url: `https://www.rentalcars.com/`,
    icon: "lucide:car"
});

links.push({
    name: "Hotels",
    url: `https://www.booking.com/`,
    icon: "lucide:building"
});

return links;
}

function createFlightPath(start, end) {
    const midLat = (start[0] + end[0]) / 2;
    const midLng = (start[1] + end[1]) / 2;

    const curveFactor = 0.5;
    const curveLat = midLat + curveFactor;
    const curveLng = midLng + curveFactor;

    return {
        type: "LineString",
        coordinates: [
        [start[1], start[0]],
        [curveLng, curveLat],
        [end[1], end[0]]
        ]
    };
}

function formatDistanceForInstructions(distance) {
    if (distance < 50) return "Soon";
    if (distance < 100) return "In 100 m";
    if (distance < 200) return "In 200 m";
    if (distance < 500) return "In 500 m";
    if (distance < 1000) return "In " + Math.round(distance/100)*100 + " m";
    return "in " + (distance/1000).toFixed(1) + " km";
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function getStreetName(step) {
    if (!step) return '';

    const name = step.name ||
    step.road_name ||
    step.way_name ||
    step.ref ||
    step.destination ||
    '';

    if (name) {
        return name
        .replace(/^US-/, 'US Route ')
        .replace(/^I-/, 'I-')
        .replace(/^SR-/, 'State Route ')
        .replace(/^CR-/, 'County Route ')
        .replace(/_/g, ' ')
        .trim();
    }

    return '';
}

function getExitInfo(step) {
    if (!step.intersections || !step.intersections[0]) return null;

    const intersection = step.intersections[0];
    if (intersection.classes && intersection.classes.includes('motorway_junction')) {
        return {
            number: intersection.ref || '',
            name: intersection.name || '',
            destinations: intersection.destinations || ''
        };
    }
    return null;
}

function getOrdinal(n) {
    if (n === undefined || n === null || isNaN(n)) return '';
    n = parseInt(n);

    if (n % 100 >= 11 && n % 100 <= 13) {
        return n + "th";
    }

    switch (n % 10) {
        case 1: return n + "st";
        case 2: return n + "nd";
        case 3: return n + "rd";
        default: return n + "th";
    }
}

function calculateTrafficLevel(start, end) {
    const now = new Date();
    const hour = now.getHours();
    const distance = map.distance(start, end);

    if (distance < 50000 && ((hour >= 8 && hour <= 10) || (hour >= 16 && hour <= 19))) {
        return Math.random() > 0.5 ? 'high' : 'medium';
    }

    const rand = Math.random();
    if (rand > 0.7) return 'high';
    if (rand > 0.4) return 'medium';
    return 'low';
}

function addRouteCard(route) {
    const container = document.getElementById('route-options');
    const div = document.createElement('div');
    div.className = "route-card";
    div.dataset.routeId = route.id;

    const timeStr = formatTime(route.duration);
    const arrival = getArrival(route.duration);
    const distanceStr = (route.distance / 1000).toFixed(1) + ' km';

    let trafficIndicator = '';
    if (route.id === 'driving' && route.traffic) {
        const trafficClass = `traffic-${route.traffic}`;
        trafficIndicator = `<span class="traffic-indicator ${trafficClass}"></span>`;
    }

    if (route.id === 'flight') {
        const bookingLinks = generateFlightBookingLinks(
        route.airports?.departure || {code: "???", city: "origin"},
        route.airports?.arrival || {code: "???", city: "destination"}
        );

        const bookingLinksHTML = bookingLinks.map(link =>
        `<a href="${link.url}" target="_blank" class="inline-flex items-center gap-1 text-[8px] text-sky-400 hover:text-sky-300 mr-3 border border-sky-400/30 rounded px-2 py-1 hover:bg-sky-400/10 transition-colors">
        <iconify-icon icon="${link.icon}" class="text-[10px]"></iconify-icon>
        ${link.name}
        </a>`
        ).join('');

        const totalTime = formatTime(route.duration);
        const flightTime = formatTime(route.flightTime || (route.duration * 0.6));

        div.innerHTML = `
        <div class="flex items-center gap-4">
            <iconify-icon icon="${route.icon}" class="text-2xl text-sky-500"></iconify-icon>
            <div class="flex-1">
                <div class="flex justify-between items-center">
                    <div class="text-[10px] font-bold text-white">Flight Route</div>
                    <div class="text-[9px] font-bold text-sky-400">${(route.distance/1000).toFixed(0)} km</div>
                </div>
                <div class="text-[9px] text-sky-300 mb-1">${route.details || "Direct flight"}</div>
                <div class="text-[9px] text-neutral-400 uppercase">${flightTime} flight  ${totalTime} total</div>
                <div class="mt-2 pt-2 border-t border-white/10">
                    <div class="text-[8px] text-neutral-500 uppercase mb-1">Book Travel:</div>
                    <div class="flex flex-wrap gap-1">
                        ${bookingLinksHTML}
                    </div>
                </div>
            </div>
        </div>`;
    } else {
    div.innerHTML = `
    <div class="flex items-center gap-4">
        <iconify-icon icon="${route.icon}" class="text-xl text-neutral-500"></iconify-icon>
        <div class="flex-1">
            <div class="flex justify-between items-center">
                <div class="text-[10px] font-bold text-white">${trafficIndicator}${route.label}</div>
                <div class="text-[9px] font-bold text-emerald-400">${distanceStr}</div>
            </div>
            <div class="text-[9px] text-neutral-400 uppercase">${timeStr}  Arr: ${arrival}</div>
        </div>
    </div>`;
}

div.onclick = (e) => {
    e.stopPropagation();

    document.querySelectorAll('.route-card').forEach(c => c.classList.remove('active'));
    div.classList.add('active');

    currentRoute = route;

    renderPath(route);
};

container.appendChild(div);
}


function cleanupRouteRendering() {
    if (routeLayer) {
        routeLayer.clearLayers();
    }

    window.currentRouteLayer = null;
}

function renderPath(route) {
    routeLayer.clearLayers();

    if (!route || !route.geometry) return;

    const coords = route.geometry.coordinates || [];
    if (coords.length < 2) return;

    const routeColor = getRouteColor(route);
    let weight = 5;
    let dashArray = null;

    if (route.id === 'driving') {
        weight = 5;
    } else if (route.id === 'cycling') {
    weight = 4;
} else if (route.id === 'walking') {
weight = 3;
dashArray = '5, 10';
} else if (route.id === 'flight') {
weight = 3;
dashArray = '10, 5';
}

const geoJsonLayer = L.geoJSON(route.geometry, {
    style: {
        color: routeColor,
        weight: weight,
        opacity: 0.8,
        dashArray: dashArray
    }
});

geoJsonLayer.addTo(routeLayer);

window.currentRouteGeoJson = geoJsonLayer;

currentRoute = route;

const startBtn = document.getElementById('start-nav-btn');
startBtn.classList.remove('hidden');
startBtn.style.display = '';
startBtn.onclick = () => startActiveNav(route);
}

function getRouteColor(route) {
    if (route.id === 'cycling') return '#38bdf8';
    if (route.id === 'walking') return '#38bdf8';
    if (route.id === 'flight') return '#38bdf8';

    if (route.id === 'driving') {
        if (route.traffic === 'high') return '#ef4444';
        if (route.traffic === 'medium') return '#f59e0b';
        return '#3b82f6';
    }

    return '#3b82f6';
}

function drawNavigationRoute(latLngs, route) {
    if (window.navigationGeoJson && map.hasLayer(window.navigationGeoJson)) {
        map.removeLayer(window.navigationGeoJson);
    }

    const routeColor = getRouteColor(route);
    const weight = 5;

    const coordinates = latLngs.map(point => {
        return [point[1], point[0]];
    });

    const geoJsonGeometry = {
        type: "LineString",
        coordinates: coordinates
    };

    window.navigationGeoJson = L.geoJSON(geoJsonGeometry, {
        style: {
            color: routeColor,
            weight: weight,
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round'
        }
    }).addTo(map);
}

function startActiveNav(route) {
    isNavigating = true;
    currentNavRoute = route;
    currentStepIndex = 0;
    totalRouteDistance = route.distance;
    routeStartTime = new Date();

    document.body.classList.add('navigating');
    const startBtn1 = document.getElementById('start-nav-btn');
    startBtn1.classList.add('hidden');
    startBtn1.style.display = 'none';
    document.getElementById('standard-ui').style.display = 'none';
    document.getElementById('active-nav-hud').style.display = 'flex';

    transformSidebarToDirections(route);
    updateNavigationDisplay();
    updateNavigationHUD();

    routeLayer.clearLayers();

    const coords = route.geometry.coordinates || [];
    if (coords.length >= 2) {
        const latLngs = coords.map(coord => [coord[1], coord[0]]);

        if (latLngs.length >= 2) {
            drawNavigationRoute(latLngs, route);

            const bounds = L.latLngBounds(latLngs);
            map.fitBounds(bounds, {
                padding: [50, 50],
                animate: true,
                duration: 1
            });
        }
    }

    startNavigationUpdates();
}

function startNavigationUpdates() {
    if (window.navUpdateInterval) {
        clearInterval(window.navUpdateInterval);
    }

    let isUserMovingMap = false;
    let mapMoveTimeout;

    map.on('movestart', () => {
        isUserMovingMap = true;
        clearTimeout(mapMoveTimeout);
    });

    map.on('moveend', () => {
        mapMoveTimeout = setTimeout(() => {
            isUserMovingMap = false;
        }, 3000);
    });

    window.navUpdateInterval = setInterval(() => {
        if (!isNavigating || !window.navigationCamera || isUserMovingMap) {
            return;
        }

        const camera = window.navigationCamera;
        const userPos = getCurrentUserPosition();

        if (!userPos) return;

        const userLatLng = L.latLng(userPos[0], userPos[1]);

        let closestIndex = 0;
        let minDistance = Infinity;

        const searchStart = Math.max(0, camera.currentIndex - 20);
        const searchEnd = Math.min(camera.currentIndex + 50, camera.routePoints.length);

        for (let i = searchStart; i < searchEnd; i++) {
            const distance = userLatLng.distanceTo(camera.routePoints[i]);
            if (distance < minDistance) {
                minDistance = distance;
                closestIndex = i;
            }
        }

        if (minDistance > 100 && Math.abs(closestIndex - camera.currentIndex) > 5) {
            camera.currentIndex = closestIndex;

            updateTraveledPath(closestIndex);

            const lookAhead = Math.min(closestIndex + 10, camera.routePoints.length - 1);

            if (lookAhead > closestIndex) {
                const targetPoint = camera.routePoints[closestIndex];
                const currentCenter = map.getCenter();
                const distanceToCenter = targetPoint.distanceTo(currentCenter);

                if (distanceToCenter > 300) {
                    map.panTo(targetPoint, {
                        animate: true,
                        duration: 0.5,
                        easeLinearity: 0.25
                    });
                }

                camera.bearing = calculateBearing(
                camera.routePoints[closestIndex],
                camera.routePoints[lookAhead]
                );

                updateRealTimeMarkerRotation(camera.bearing);
            }
        }

        updateRouteProgress(camera.currentIndex, camera.routePoints.length);

    }, 3000);
}

function transformSidebarToDirections(route) {
    const sidebar = document.getElementById('info-sidebar');
    sidebar.classList.add('active');

    const title = document.getElementById('side-title');
    title.innerText = "Directions";

    const content = document.getElementById('sidebar-content');
    content.innerHTML = `
    <div class="space-y-1">
        <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-4">STEP-BY-STEP DIRECTIONS</div>
        <div id="directions-list" class="space-y-4"></div>
    </div>
    `;

    generateGoogleStyleDirectionsList(route);
}

function generateGoogleStyleDirectionsList(route) {
    const container = document.getElementById('directions-list');
    container.innerHTML = '';

    if (!route.steps || route.steps.length === 0) {
        container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No directions available</div>';
        return;
    }

    const groupedSteps = groupStepsLikeGoogle(route.steps);

    groupedSteps.forEach((group, groupIndex) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'direction-group';

        const primaryInstruction = group.primaryStep.maneuver.instruction ||
        generateRealNavigationInstruction(group.primaryStep, 0, route.steps);

        const distanceText = group.totalDistance < 1000 ?
        `${Math.round(group.totalDistance)} m` :
        `${(group.totalDistance/1000).toFixed(1)} km`;
        const timeText = formatTime(group.totalTime);

        groupDiv.innerHTML = `
        <div class="flex items-start gap-3 mb-2">
            <div class="step-number">${groupIndex + 1}</div>
            <div class="flex-1">
                <div class="text-[11px] font-bold text-white leading-tight mb-1">${primaryInstruction}</div>
                <div class="text-[9px] text-emerald-400">${timeText}  ${distanceText}</div>
            </div>
        </div>
        `;

        if (group.substeps.length > 1) {
            const substepsDiv = document.createElement('div');
            substepsDiv.className = 'ml-9 pl-3 border-l border-white/10 space-y-2';

            group.substeps.forEach((substep, substepIndex) => {
                if (substepIndex === 0) return;

                const instruction = substep.maneuver.instruction ||
                generateRealNavigationInstruction(substep, 0, route.steps);
                const substepDiv = document.createElement('div');
                substepDiv.className = 'text-[10px] text-neutral-400';
                substepDiv.innerHTML = `
                <iconify-icon icon="lucide:chevron-right" class="text-[8px] mr-1 opacity-50"></iconify-icon>
                ${instruction}
                `;
                substepsDiv.appendChild(substepDiv);
            });

            groupDiv.appendChild(substepsDiv);
        }

        container.appendChild(groupDiv);
    });
}

function generateDirectionsListUI(route) {
    const container = document.getElementById('directions-list');
    container.innerHTML = '';

    if (!route.steps || route.steps.length === 0) {
        container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No directions available</div>';
        return;
    }

    let cumulativeDistance = 0;

    route.steps.forEach((step, index) => {
        const instruction = step.maneuver.instruction;
        const distance = step.distance;
        const duration = step.duration || 0;
        const isActive = index === currentStepIndex;
        const isCompleted = index < currentStepIndex;

        cumulativeDistance += distance;

        const stepDiv = document.createElement('div');
        stepDiv.className = `direction-item flex items-start gap-3 ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
        stepDiv.dataset.stepIndex = index;

        stepDiv.innerHTML = `
        <div class="step-number ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
            ${index + 1}
        </div>
        <div class="step-content">
            <div class="step-instruction">${instruction}</div>
            <div class="step-details">${distance < 1000 ? Math.round(distance) + ' m' : (distance/1000).toFixed(1) + ' km'}  ${formatTime(duration)}</div>
        </div>
        `;

        container.appendChild(stepDiv);
    });
}

async function checkFerryRouteFree(start, end) {
    const distance = map.distance(start, end);

    if (distance < 10000 || distance > 500000) return { hasFerry: false };

    try {
        const [startWater, endWater] = await Promise.all([
        isPointOverWater(start),
        isPointOverWater(end)
        ]);

        if (startWater && endWater) {
            const ferryTime = (distance / 40000) * 3600;

            return {
                hasFerry: true,
                duration: ferryTime + 1800,
                distance: distance,
                description: "Possible ferry route",
                details: "Check local ferry schedules"
            };
        }

    } catch (error) {}

    return { hasFerry: false };
}

async function isPointOverWater(coords) {
    try {
        const [lat, lng] = coords;
        const query = `
        [out:json][timeout:5];
        (
        way["natural"="water"](around:1000, ${lat}, ${lng});
        relation["natural"="water"](around:1000, ${lat}, ${lng});
        );
        out body;
        `;

        const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
        const data = await response.json();

        return data.elements && data.elements.length > 0;

    } catch (error) {
    return false;
}
}

function checkNavigationProgress(position) {
    if (!isNavigating || !currentNavRoute || !currentNavRoute.steps) return;

    const currentPos = [position.coords.latitude, position.coords.longitude];
    if (!currentPos) return;

    const currentStep = currentNavRoute.steps[currentStepIndex];
    if (!currentStep) return;

    const timeSinceStart = (new Date() - routeStartTime) / 1000;
    const progressPercent = Math.min(95, (timeSinceStart / (currentStep.duration || 30)) * 100);

    document.getElementById('step-progress').style.width = `${progressPercent}%`;

    updateNavigationHUD();
}

function advanceToNextStep() {
    if (!currentNavRoute || !currentNavRoute.steps) return;

    if (currentStepIndex < currentNavRoute.steps.length - 1) {
        currentStepIndex++;
        updateNavigationDisplay();
        updateDirectionsListUI();
        updateNavigationHUD();
    } else {
    completeNavigation();
}
}

function updateNavigationDisplay() {
    if (!currentNavRoute) return;

    const steps = currentNavRoute.steps || [];

    if (steps.length > 0 && currentStepIndex < steps.length) {
        const currentStep = steps[currentStepIndex];
        const nextStep = steps[currentStepIndex + 1];

        document.getElementById('nav-instruction').innerHTML = currentStep.maneuver.instruction;
        document.getElementById('nav-dist-next').innerText =
        currentStep.distance < 1000 ? `In ${Math.round(currentStep.distance)}m` : `In ${(currentStep.distance/1000).toFixed(1)}km`;

        document.getElementById('step-progress').style.width = '0%';

        if (nextStep) {
            document.getElementById('nav-next-turn').innerText =
            nextStep.maneuver.instruction.split('.').slice(0, 2).join('.') + '.';
        } else {
        document.getElementById('nav-next-turn').innerText = "Final destination ahead";
    }

    let remainingTime = 0;
    for (let i = currentStepIndex; i < steps.length; i++) {
        remainingTime += steps[i].duration || 0;
    }

    const eta = getArrival(remainingTime);
    document.getElementById('nav-eta').innerText = eta;

    let remainingDistance = 0;
    for (let i = currentStepIndex; i < steps.length; i++) {
        remainingDistance += steps[i].distance || 0;
    }

    document.getElementById('nav-remaining').innerText =
    remainingDistance < 1000 ? `${Math.round(remainingDistance)}m` : `${(remainingDistance/1000).toFixed(1)} km`;

    updateNavIcon(currentStep);
}
}

function updateNavigationHUD() {
    if (!currentNavRoute || !isNavigating) return;

    const steps = currentNavRoute.steps || [];

    let remainingTime = 0;
    let remainingDistance = 0;

    for (let i = currentStepIndex; i < steps.length; i++) {
        remainingTime += steps[i].duration || 0;
        remainingDistance += steps[i].distance || 0;
    }

    const eta = getArrival(remainingTime);
    document.getElementById('hud-eta').innerText = eta;
    document.getElementById('hud-remaining').innerText =
    remainingDistance < 1000 ? `${Math.round(remainingDistance)}m` : `${(remainingDistance/1000).toFixed(1)} km`;
}

function updateDirectionsListUI() {
    const directionItems = document.querySelectorAll('.direction-item');
    const stepNumbers = document.querySelectorAll('.step-number');

    directionItems.forEach((item, index) => {
        item.classList.remove('active', 'completed');
        stepNumbers[index].classList.remove('active', 'completed');

        if (index === currentStepIndex) {
            item.classList.add('active');
            stepNumbers[index].classList.add('active');
        } else if (index < currentStepIndex) {
        item.classList.add('completed');
        stepNumbers[index].classList.add('completed');
    }
});
}

function completeNavigation() {
    document.getElementById('nav-instruction').innerText = "You have arrived at your destination";
    document.getElementById('nav-dist-next').innerText = "Arrived";
    document.getElementById('nav-next-turn').innerText = "Destination reached";
    document.getElementById('step-progress').style.width = '100%';
    document.getElementById('nav-eta').innerText = "Now";
    document.getElementById('nav-remaining').innerText = "0 m";

    document.getElementById('hud-eta').innerText = "Arrived";
    document.getElementById('hud-remaining').innerText = "0 m";

    if (gpsWatchInterval) {
        clearInterval(gpsWatchInterval);
        gpsWatchInterval = null;
    }
}

function updateNavIcon(step) {
    const icon = document.getElementById('nav-step-icon');
    const maneuver = step.maneuver.type || '';

    if (maneuver.includes('arrive')) {
        icon.setAttribute('icon', 'lucide:flag');
    } else if (maneuver.includes('depart')) {
    icon.setAttribute('icon', 'lucide:map-pin');
} else if (maneuver.includes('left')) {
icon.setAttribute('icon', 'lucide:corner-up-left');
} else if (maneuver.includes('right')) {
icon.setAttribute('icon', 'lucide:corner-up-right');
} else if (maneuver.includes('roundabout')) {
icon.setAttribute('icon', 'lucide:repeat');
} else if (maneuver.includes('fork')) {
icon.setAttribute('icon', 'lucide:git-fork');
} else {
icon.setAttribute('icon', 'lucide:navigation');
}
}

function getRouteBounds(geometry) {
    const coords = geometry.coordinates;
    const bounds = [];

    for (const coord of coords) {
        bounds.push([coord[1], coord[0]]);
    }

    return bounds;
}

async function performSearch(query) {
    if (!query || query.trim().length < 2) {
        showRecentSearches();
        return;
    }

    saveToRecentSearches(query);

    document.getElementById('search-spinner').classList.remove('hidden');
    document.getElementById('filters').classList.remove('hidden');

    try {
        const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=25`);
        const data = await response.json();

        searchResults = data.features || [];
        applyFilter(activeFilter);
    } catch (error) {
    searchResults = [];
    displaySearchResults([]);
} finally {
document.getElementById('search-spinner').classList.add('hidden');
}
}

function saveToRecentSearches(query) {
    const recent = {
        query: query,
        timestamp: new Date().toISOString(),
        timeText: 'Just now'
    };

    recentSearches = recentSearches.filter(item => item.query !== query);
    recentSearches.unshift(recent);
    recentSearches = recentSearches.slice(0, 10);
    updateRecentTimes();
    localStorage.setItem('strikeRecentSearches', JSON.stringify(recentSearches));
}

function updateRecentTimes() {
    const now = new Date();
    recentSearches.forEach(item => {
        const itemTime = new Date(item.timestamp);
        const diffMinutes = Math.floor((now - itemTime) / (1000 * 60));

        if (diffMinutes < 1) item.timeText = 'Just now';
        else if (diffMinutes < 60) item.timeText = `${diffMinutes}m ago`;
        else if (diffMinutes < 1440) item.timeText = `${Math.floor(diffMinutes/60)}h ago`;
        else item.timeText = `${Math.floor(diffMinutes/1440)}d ago`;
    });
}

function showRecentSearches() {
    updateRecentTimes();
    const container = document.getElementById('results');
    const filters = document.getElementById('filters');

    if (recentSearches.length === 0) {
        filters.classList.add('show');
        filters.classList.remove('hidden');

        container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No recent searches</div>';
        container.classList.add('show');
        container.classList.remove('hidden');
        return;
    }

    filters.classList.remove('hidden');

    let html = `
    <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-2">Recent Searches</div>
    `;

    recentSearches.forEach((recent) => {
        html += `
        <div class="recent-item" data-query="${recent.query}">
            <div class="flex justify-between items-center">
                <div class="text-[11px] font-semibold text-white">${recent.query}</div>
                <div class="recent-time">${recent.timeText}</div>
            </div>
        </div>
        `;
    });

    container.innerHTML = html;
    container.classList.remove('hidden');

    document.querySelectorAll('.recent-item').forEach(item => {
        item.addEventListener('click', () => {
            const query = item.dataset.query;
            document.getElementById('search-input').value = query;
            performSearch(query);
        });
    });
}

function applyFilter(filter) {
    activeFilter = filter;

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
            btn.classList.add('active');
        }
    });

    let filteredResults = searchResults;

    if (filter !== 'all' && filter !== 'nearby') {
        filteredResults = searchResults.filter(result => {
            const props = result.properties;
            const name = props.name?.toLowerCase() || '';

            switch(filter) {
                case 'hotels':
                return name.includes('hotel') || name.includes('inn') || name.includes('motel');
                case 'parks':
                return name.includes('park') || name.includes('garden');
                case 'restaurants':
                return name.includes('restaurant') || name.includes('cafe') || name.includes('diner');
                case 'gas':
                return name.includes('gas') || name.includes('fuel') || name.includes('station');
                default:
                return true;
            }
        });
    }

    displaySearchResults(filteredResults);
}

function capitalizeFirstLetterIfLetter(text) {
    if (!text) return text;
    const firstChar = text.charAt(0);
    if (firstChar >= 'a' && firstChar <= 'z' || firstChar >= 'A' && firstChar <= 'Z') {
        return firstChar.toUpperCase() + text.slice(1);
    }
    return text;
}

function lowercaseFirstLetter(text) {
    if (!text) return text;
    const firstChar = text.charAt(0);
    if (firstChar >= 'a' && firstChar <= 'z' || firstChar >= 'A' && firstChar <= 'Z') {
        return firstChar.toLowerCase() + text.slice(1);
    }
    return text;
}

function generateRealNavigationInstruction(step, index, allSteps) {
    if (!step.maneuver) return "Continue";

    const distance = step.distance;
    const streetName = step.name || getStreetName(step) || '';
    const nextStreetName = allSteps[index + 1]?.name || getStreetName(allSteps[index + 1]) || '';
    const maneuverType = step.maneuver.type;
    const modifier = step.maneuver.modifier || '';
    const exitNumber = step.maneuver.exit || step.exits;
    const laneCount = step.intersections?.[0]?.lanes?.length || 0;
    const destinations = step.destinations || '';
    const ref = step.ref || '';

    let distanceText = formatDistanceGoogleStyle(distance);
    let actionText = '';
    let laneText = '';
    let exitText = '';

    const formattedStreet = formatStreetNameForDisplay(streetName, ref);
    const formattedNextStreet = formatStreetNameForDisplay(nextStreetName, allSteps[index + 1]?.ref);

    if (exitNumber) {
        exitText = `exit ${exitNumber}`;
    }

    if (laneCount >= 3) {
        const validLanes = step.intersections[0].lanes.filter(lane => lane.valid).length;
        if (modifier === 'left' && validLanes > 1) {
            laneText = `Use the left ${Math.min(2, validLanes)} lanes to `;
        } else if (modifier === 'right' && validLanes > 1) {
        laneText = `Use the right ${Math.min(2, validLanes)} lanes to `;
    }
}

switch(maneuverType) {
    case 'depart':
    if (formattedStreet) {
        actionText = `Head toward ${formattedStreet}`;
    } else if (formattedNextStreet) {
    actionText = `Head toward ${formattedNextStreet}`;
} else {
actionText = `Head toward destination`;
}
break;

case 'turn':
let turnType = '';
switch(modifier) {
    case 'left': turnType = 'turn left'; break;
    case 'right': turnType = 'turn right'; break;
    case 'sharp left': turnType = 'turn sharp left'; break;
    case 'sharp right': turnType = 'turn sharp right'; break;
    case 'slight left': turnType = 'turn slight left'; break;
    case 'slight right': turnType = 'turn slight right'; break;
    case 'uturn': turnType = 'make a U-turn'; break;
    default: turnType = 'turn';
}

if (formattedStreet) {
    actionText = `${turnType} onto ${formattedStreet}`;
} else {
actionText = turnType;
}
break;

case 'continue':
if (formattedStreet && formattedNextStreet && formattedStreet !== formattedNextStreet) {
    actionText = `continue onto ${formattedNextStreet}`;
} else if (formattedStreet) {
actionText = `continue on ${formattedStreet}`;
} else {
actionText = 'continue straight';
}
break;

case 'arrive':
if (index === allSteps.length - 1) {
    return "You have arrived at your destination";
}
actionText = "Arrive at waypoint";
break;

case 'roundabout':
const ordinalExit = getOrdinal(exitNumber || 1);
if (formattedStreet) {
    actionText = `Take the ${ordinalExit} exit onto ${formattedStreet}`;
} else {
actionText = `Take the ${ordinalExit} exit`;
}
break;

case 'merge':
if (ref) {
    actionText = `merge onto ${ref}`;
} else if (formattedStreet) {
actionText = `merge onto ${formattedStreet}`;
} else {
actionText = 'Merge';
}
break;

case 'fork':
let forkType = '';
switch(modifier) {
    case 'left': forkType = 'Keep left at the fork'; break;
    case 'right': forkType = 'Keep right at the fork'; break;
    case 'slight left': forkType = 'Keep slight left at the fork'; break;
    case 'slight right': forkType = 'Keep slight right at the fork'; break;
    case 'straight': forkType = 'At the fork, continue straight'; break;
    default: forkType = 'At the fork, continue';
}

if (destinations) {
    actionText = `${forkType}${formattedStreet ? ' onto ' + formattedStreet : ''} toward ${destinations}`;
} else if (formattedStreet) {
actionText = `${forkType}${formattedStreet ? ' onto ' + formattedStreet : ''}`;
} else {
actionText = forkType;
}
break;

case 'off ramp':
const exitInfo = exitNumber ? `exit ${exitNumber}` : '';
const destinationInfo = destinations ? (exitInfo ? `${exitInfo} for ${destinations}` : `exit for ${destinations}`) : '';

if (destinationInfo) {
    actionText = `take ${destinationInfo}`;
} else if (exitInfo) {
actionText = `take ${exitInfo}`;
} else if (formattedStreet) {
actionText = `take the exit onto ${formattedStreet}`;
} else {
actionText = 'take the exit';
}
break;

case 'on ramp':
if (destinations) {
    actionText = `take the ramp toward ${destinations}`;
} else if (formattedStreet) {
actionText = `take the ramp onto ${formattedStreet}`;
} else {
actionText = 'take the ramp';
}
break;

case 'end of road':
let endAction = '';
switch(modifier) {
    case 'left': endAction = 'turn left'; break;
    case 'right': endAction = 'turn right'; break;
    case 'sharp left': endAction = 'turn sharp left'; break;
    case 'sharp right': endAction = 'turn sharp right'; break;
    case 'slight left': endAction = 'turn slight left'; break;
    case 'slight right': endAction = 'turn slight right'; break;
    case 'straight': endAction = 'continue straight'; break;
    default: endAction = 'continue';
}

if (formattedStreet) {
    actionText = `at the end of the road, ${endAction} onto ${formattedStreet}`;
} else {
actionText = `at the end of the road, ${endAction}`;
}
break;

case 'new name':
if (formattedNextStreet && formattedStreet !== formattedNextStreet) {
    actionText = `continue onto ${formattedNextStreet}`;
} else {
actionText = 'continue';
}
break;

case 'exit roundabout':
actionText = `exit the roundabout${formattedStreet ? ' onto ' + formattedStreet : ''}`;
break;

case 'rotary':
actionText = `enter the rotary${formattedStreet ? ' onto ' + formattedStreet : ''}`;
break;

default:
if (formattedStreet) {
    actionText = `Follow ${formattedStreet}`;
} else {
actionText = 'Continue';
}
}

if (laneText) {
    actionText = laneText + actionText.toLowerCase();
}

if (distanceText && distanceText.trim()) {
    distanceText = capitalizeFirstLetterIfLetter(distanceText);
    actionText = lowercaseFirstLetter(actionText);
    return `${distanceText}, ${actionText}`;
} else {
actionText = capitalizeFirstLetterIfLetter(actionText);
return actionText;
}
}

function formatStreetNameForDisplay(name, ref) {
    if (!name && !ref) return '';

    if (ref && (!name || name.includes(ref))) {
        return ref;
    }

    if (ref && name) {
        const isHighway = /^(I|US|SR|WA|SH|Route)\s*\d+/i.test(ref);
        if (isHighway) {
            return `${ref} (${name})`;
        }
    }

    return name || ref || '';
}

function formatDistanceGoogleStyle(distance) {
    const feet = Math.round(distance * 3.28084);
    const miles = distance / 1609.34;

    if (feet < 10) return "";
    if (feet < 20) return "Soon";
    if (feet < 50) return "Shortly";

    if (feet < 1000) {
        if (feet < 100) return `in ${Math.round(feet / 10) * 10} ft`;
        if (feet < 200) return "in 100 ft";
        if (feet < 300) return "in 200 ft";
        if (feet < 500) return "in 300 ft";
        if (feet < 750) return "in 500 ft";
        if (feet < 1000) return "in 750 ft";
    }

    if (miles < 0.1) return "in 500 ft";
    if (miles < 0.2) return "in 0.1 mi";
    if (miles < 0.3) return "in 0.2 mi";
    if (miles < 0.4) return "in 0.3 mi";
    if (miles < 0.5) return "in 0.4 mi";
    if (miles < 0.6) return "in 0.5 mi";
    if (miles < 0.7) return "in 0.6 mi";
    if (miles < 0.8) return "in 0.7 mi";
    if (miles < 0.9) return "in 0.8 mi";
    if (miles < 1.0) return "in 0.9 mi";

    if (miles < 2) {
        const quarter = Math.round(miles * 4) / 4;
        if (quarter === 1) return "in 1 mi";
        if (quarter === 1.25) return "in 1 mi";
        if (quarter === 1.5) return "in 1 mi";
        if (quarter === 1.75) return "in 1 mi";
    }

    if (miles < 10) {
        const rounded = Math.round(miles * 2) / 2;
        if (rounded === Math.floor(rounded)) {
            return `in ${rounded} mi`;
        } else {
        return `in ${rounded.toFixed(1)} mi`;
    }
}

return `in ${Math.round(miles)} mi`;
}

function getOrdinal(n) {
    if (n === undefined || n === null) return '';
    const s = ["th", "st", "nd", "rd"];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function capitalizeStreetName(streetName) {
    if (!streetName) return '';

    const directions = {
        'n': 'North', 'n.': 'North',
        's': 'South', 's.': 'South',
        'e': 'East', 'e.': 'East',
        'w': 'West', 'w.': 'West',
        'ne': 'Northeast', 'ne.': 'Northeast',
        'nw': 'Northwest', 'nw.': 'Northwest',
        'se': 'Southeast', 'se.': 'Southeast',
        'sw': 'Southwest', 'sw.': 'Southwest'
    };

    const streetTypes = {
        'st': 'Street', 'st.': 'Street',
        'ave': 'Avenue', 'ave.': 'Avenue',
        'av': 'Avenue', 'av.': 'Avenue',
        'blvd': 'Boulevard', 'blvd.': 'Boulevard',
        'rd': 'Road', 'rd.': 'Road',
        'dr': 'Drive', 'dr.': 'Drive',
        'ln': 'Lane', 'ln.': 'Lane',
        'ct': 'Court', 'ct.': 'Court',
        'pl': 'Place', 'pl.': 'Place',
        'ter': 'Terrace', 'ter.': 'Terrace',
        'cir': 'Circle', 'cir.': 'Circle',
        'pkwy': 'Parkway', 'pkwy.': 'Parkway',
        'hwy': 'Highway', 'hwy.': 'Highway',
        'fwy': 'Freeway', 'fwy.': 'Freeway',
        'expy': 'Expressway', 'expy.': 'Expressway'
    };

    const parts = streetName.split(' ');

    return parts.map((part, index) => {
        const lowerPart = part.toLowerCase().replace(/\.$/, '');

        if (index === 0) {
            if (directions[lowerPart]) {
                return directions[lowerPart];
            }
            if (/^[Ii]-\d+$/.test(part)) {
                return part.toUpperCase();
            }
            if (/^US-\d+$/.test(part)) {
                return part.replace('US-', 'US Route ');
            }
            if (/^SR-\d+$/.test(part) || /^State Route \d+$/.test(part)) {
                return part.replace('SR-', 'State Route ');
            }
            return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
        }

        if (index === parts.length - 1) {
            if (streetTypes[lowerPart]) {
                return streetTypes[lowerPart];
            }
        }

        if (directions[lowerPart]) {
            return directions[lowerPart];
        }

        if (/^\d+(st|nd|rd|th)$/i.test(part)) {
            return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
        }

        if (/^\d+$/.test(part)) {
            return part + (streetTypes[parts[parts.length - 1]?.toLowerCase()] ? 'th' : '');
        }

        return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
    }).join(' ');
}

function groupStepsLikeGoogle(steps) {
    const grouped = [];
    let currentGroup = null;

    for (let i = 0; i < steps.length; i++) {
        const step = steps[i];

        const isMajorManeuver = step.maneuver.type === 'turn' ||
        step.maneuver.type === 'merge' ||
        step.maneuver.type === 'fork' ||
        step.maneuver.type === 'off ramp' ||
        step.maneuver.type === 'on ramp' ||
        step.maneuver.type === 'roundabout' ||
        i === 0;

        if (isMajorManeuver || !currentGroup) {
            if (currentGroup) {
                grouped.push(currentGroup);
            }

            currentGroup = {
                primaryStep: step,
                substeps: [step],
                totalDistance: step.distance,
                totalTime: step.duration || 0
            };
        } else {
        currentGroup.substeps.push(step);
        currentGroup.totalDistance += step.distance;
        currentGroup.totalTime += (step.duration || 0);
    }
}

if (currentGroup) {
    grouped.push(currentGroup);
}

return grouped;
}

function displaySearchResults(results) {
    const container = document.getElementById('results');
    container.innerHTML = '';

    if (results.length === 0) {
        container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No results found</div>';
        container.classList.remove('hidden');
        return;
    }

    results.forEach((result) => {
        const div = document.createElement('div');
        div.className = 'search-result';

        const props = result.properties;
        const name = props.name || props.street || props.city || "Location";

        const addressParts = [];

        if (props.housenumber && props.street) {
            addressParts.push(`${props.housenumber} ${props.street}`);
        } else if (props.street) {
        addressParts.push(props.street);
    }

    if (props.city) addressParts.push(props.city);
    if (props.county) addressParts.push(props.county);
    if (props.state) addressParts.push(props.state);
    if (props.country) addressParts.push(props.country);
    if (props.postcode) addressParts.push(props.postcode);

    const address = addressParts.length > 0 ? addressParts.join(', ') : 'Coordinates';

    let typeBadge = '';
    if (props.type) {
        const typeClass = {
            'city': 'type-city',
            'street': 'type-street',
            'building': 'type-building',
            'landmark': 'type-landmark'
        }[props.type] || 'type-default';

        const typeLabel = {
            'city': 'City',
            'street': 'Street',
            'building': 'Building',
            'landmark': 'Landmark',
            'county': 'County',
            'state': 'State',
            'country': 'Country'
        }[props.type] || props.type || 'Location';

        typeBadge = `<span class="type-badge ${typeClass}">${typeLabel}</span>`;
    }

    const osmType = props.osm_type;
    if (osmType && !props.type) {
        const osmTypeClass = {
            'N': 'type-landmark',
            'W': 'type-street',
            'R': 'type-city'
        }[osmType] || 'type-default';

        const osmTypeLabel = {
            'N': 'Node',
            'W': 'Way',
            'R': 'Relation'
        }[osmType] || 'OSM';

        typeBadge = `<span class="type-badge ${osmTypeClass}">${osmTypeLabel}</span>`;
    }

    div.innerHTML = `
    <div class="flex items-start gap-2 mb-1">
        ${typeBadge}
        <div class="text-[11px] font-bold text-white truncate flex-1">${name}</div>
    </div>
    <div class="text-[9px] text-neutral-400 leading-tight">${address}</div>
    `;

    div.onclick = () => {
        const [lng, lat] = result.geometry.coordinates;
        map.flyTo([lat, lng], 15, { animate: true, duration: 1 });
        triggerAnalysis(lat, lng);
        hideSearchResults();
        document.getElementById('search-input').value = name;
    };

    container.appendChild(div);
});

container.classList.remove('hidden');
}

function hideSearchResults() {
    document.getElementById('results').classList.add('hidden');
    document.getElementById('filters').classList.add('hidden');
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else if (minutes > 0) {
    return `${minutes}m`;
} else {
return '<1m';
}
}

function getArrival(seconds) {
    const now = new Date();
    const arrival = new Date(now.getTime() + seconds * 1000);
    return arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

document.getElementById('sidebar-share-btn').addEventListener('click', () => {
    if (selectedTarget) {
        if (customStartMode === 'current' && !userPos) {
            showToast(`Acton failed, location unavailable`, 3000);
            return;
        }
        generateShareURL();
    } else {
        showToast(`No destination selected`, 3000);
    }
});

function closeSidebar() {
    document.getElementById('info-sidebar').classList.remove('active');
    document.getElementById('sidebar-share-btn').classList.add('hidden');
    routeLayer.clearLayers();
    currentRoute = null;
    currentNavRoute = null;

    if (isNavigating) {
        exitNavigation();
        isNavigating = false;

        if (gpsWatchInterval) {
            clearInterval(gpsWatchInterval);
            gpsWatchInterval = null;
        }
    }

    if (gpsWatchInterval) {
        clearInterval(gpsWatchInterval);
        gpsWatchInterval = null;
    }

    if (destinationMarker && map.hasLayer(destinationMarker)) {
        map.removeLayer(destinationMarker);
    }

    selectedTarget = null;
    
    const url = new URL(window.location.href);
    url.search = '';
    window.history.replaceState({}, '', url.toString());

    document.getElementById('sidebar-content').innerHTML = `
    <div class="space-y-6">
        <div id="logistics-module">
            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block mb-4">Routes via Engine</span>
            <div id="route-options" class="flex flex-col gap-2"></div>
        </div>
        <div class="space-y-2">
            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block">Address</span>
            <p id="side-address" class="text-xs text-neutral-400 leading-relaxed">Select a location to view details</p>
        </div>
    </div>
    `;
}

function recenterMap() {
    if (userPos) {
        map.flyTo(userPos, 14, { animate: true, duration: 1 });
        userMarker.setLatLng(userPos);
    }
}

function updateDestinationMarker(lat, lng, name = "Destination") {
    if (destinationMarker && map.hasLayer(destinationMarker)) {
        map.removeLayer(destinationMarker);
    }

    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div style="background: #ef4444; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(239,68,68,0.5); position: relative;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: white; border-radius: 50%;"></div></div>',
            iconSize: [22, 22],
            iconAnchor: [11, 11]
        }),
        zIndexOffset: 1000,
        title: name
    });

    destinationMarker.addTo(map);

    if (name && name !== "Destination") {
        destinationMarker.bindPopup(`
        <div class="text-xs font-bold text-white" style="margin-right: 15px;">${name}</div>
        <div class="text-[10px] text-neutral-600">Destination</div>
        `);
    }
}

async function checkRealFerryRoute(start, end) {
    try {
        const [startLng, startLat] = [start[1], start[0]];
        const [endLng, endLat] = [end[1], end[0]];

        const bbox = [
        Math.min(startLat, endLat) - 1,
        Math.min(startLng, endLng) - 1,
        Math.max(startLat, endLat) + 1,
        Math.max(startLng, endLng) + 1
        ].join(',');

        const overpassQuery = `
        [out:json][timeout:25];
        (
        relation["route"="ferry"](${bbox});
        way["route"="ferry"](${bbox});
        node["amenity"="ferry_terminal"](${bbox});
        );
        out body;
        >;
        out skel qt;
        `;

        const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`);
        const data = await response.json();

        if (data.elements && data.elements.length > 0) {
            const ferryRoutes = data.elements.filter(el =>
            el.type === 'relation' && el.tags && el.tags.route === 'ferry'
            );

            const ferryTerminals = data.elements.filter(el =>
            el.type === 'node' && el.tags && el.tags.amenity === 'ferry_terminal'
            );

            if (ferryRoutes.length > 0 || ferryTerminals.length > 0) {
                const startNearTerminal = isNearFerryTerminal(start, ferryTerminals);
                const endNearTerminal = isNearFerryTerminal(end, ferryTerminals);

                if (startNearTerminal && endNearTerminal) {
                    const distance = map.distance(start, end);
                    const ferryTime = (distance / 55000) * 3600;

                    return {
                        hasFerry: true,
                        duration: ferryTime + 1800,
                        distance: distance,
                        description: "Ferry route available",
                        terminals: {
                            start: startNearTerminal.name || "Ferry terminal",
                            end: endNearTerminal.name || "Ferry terminal"
                        }
                    };
                }
            }
        }

        return { hasFerry: false };
    } catch (error) {
    return { hasFerry: false };
}
}

function isNearFerryTerminal(point, terminals) {
    const [lat, lng] = point;

    for (const terminal of terminals) {
        const terminalLat = terminal.lat;
        const terminalLng = terminal.lon;
        const distance = map.distance([lat, lng], [terminalLat, terminalLng]);

        if (distance < 5000) {
            return {
                name: terminal.tags.name || "Ferry Terminal",
                lat: terminalLat,
                lng: terminalLng
            };
        }
    }
    return null;
}

function exitNavigation() {
    isNavigating = false;
    document.body.classList.remove('navigating');

    if (window.navigationGeoJson && map.hasLayer(window.navigationGeoJson)) {
        map.removeLayer(window.navigationGeoJson);
        window.navigationGeoJson = null;
    }

    if (window.currentRouteGeoJson && routeLayer.hasLayer(window.currentRouteGeoJson)) {
        routeLayer.removeLayer(window.currentRouteGeoJson);
        window.currentRouteGeoJson = null;
    }

    routeLayer.clearLayers();

    closeSidebar();

    document.getElementById('standard-ui').style.display = 'flex';
    document.getElementById('active-nav-hud').style.display = 'none';
    document.getElementById('start-nav-btn').classList.add('hidden');

    currentNavRoute = null;
    currentStepIndex = 0;
}

function updateRealTimeMarkerRotation(bearing) {
    if (!window.realTimeMarker || !bearing) return;

    const markerElement = window.realTimeMarker.getElement();
    if (!markerElement) return;

    const arrowDiv = markerElement.querySelector('div > div:nth-child(1)');
    if (arrowDiv) {
        arrowDiv.style.transform = `rotate(${bearing}deg)`;
    }
}

function updateRouteProgress(currentIndex, totalPoints) {
    if (!navigationLine || !window.navigationCamera) return;

    const progress = currentIndex / totalPoints;
}

document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    let searchTimeout;

    searchInput.addEventListener('focus', () => {
        showRecentSearches();
    });

    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        if (!e.target.value.trim()) {
            showRecentSearches();
            return;
        }
        searchTimeout = setTimeout(() => {
            performSearch(e.target.value);
        }, 300);
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filter = e.target.dataset.filter;
            applyFilter(filter);
            if (searchInput.value.trim()) {
                performSearch(searchInput.value);
            }
        });
    });

    document.getElementById('copy-dest-btn').addEventListener('click', generateDestinationURL);

    document.getElementById('locate-btn').addEventListener('click', recenterMap);

    document.getElementById('sat-toggle').addEventListener('click', () => {
        if (map.hasLayer(satLayer)) {
            map.removeLayer(satLayer);
        } else {
        satLayer.addTo(map);
    }
});

document.getElementById('zoom-in').addEventListener('click', () => {
    map.zoomIn();
});

document.getElementById('zoom-out').addEventListener('click', () => {
    map.zoomOut();
});

if (checkConnectivityBeforeLoad()) {
    initURLParameters();
}

document.getElementById('exit-nav-btn').addEventListener('click', exitNavigation);

document.addEventListener('click', (e) => {
    const searchContainer = document.querySelector('.strike-glass.p-2');
    const results = document.getElementById('results');

    if (searchContainer && results && !searchContainer.contains(e.target) &&
    e.target !== searchInput) {
        hideSearchResults();
    }
});
});

setTimeout(() => {
    if (!navigator.onLine) {
        showOfflineOverlay();
    }
}, 1000);

window.addEventListener('beforeunload', () => {
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
    }
    if (gpsWatchInterval) {
        clearInterval(gpsWatchInterval);
    }
});

if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/public/sw.js");
  });
}
</script>

</body>
</html>
