<!-- Compiled in Cursor | Last build update: 2/7/2026  5:38:56 PM | Version No. 5 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strike Maps</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="https://strike-bot.pages.dev/strike.jpg">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg: #000000;
            --glass-surface: rgba(10, 10, 10, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --font-main: 'Manrope', sans-serif;
            --ease-pro: cubic-bezier(0.2, 0, 0, 1);
        }

        body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: var(--font-main); height: 100vh; width: 100vw; overflow: hidden; }

        #map { height: 100%; width: 100%; z-index: 1; background: #050505; transition: opacity 1s ease; }
        .dark-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        
        .strike-glass { background: var(--glass-surface); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); box-shadow: 0 24px 60px rgba(0,0,0,0.9); border-radius: 16px; }
        .strike-input { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); color: white; transition: all 0.3s var(--ease-pro); }

        #info-sidebar { position: absolute; right: 24px; top: 24px; bottom: 24px; width: 380px; z-index: 2000; transform: translateX(calc(100% + 50px)); transition: transform 0.8s var(--ease-pro); display: flex; flex-direction: column; }
        #info-sidebar.active { transform: translateX(0); }

        .route-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; transition: all 0.2s; cursor: pointer; }
        .route-card.active { border-color: #ffffff; background: rgba(255, 255, 255, 0.05); }

        /* ACTIVE NAV HUD */
        #active-nav-hud { display: none; }
        
        #loader { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loading-bar { width: 120px; height: 2px; background: #111; margin-top: 15px; position: relative; overflow: hidden; }
        .loading-fill { position: absolute; left: 0; top: 0; height: 100%; background: #fff; width: 0%; animation: load 2s forwards; }
        @keyframes load { to { width: 100%; } }

        .ui-animate { opacity: 0; transform: translateY(15px); transition: all 0.8s var(--ease-pro); }
        .ui-ready .ui-animate { opacity: 1; transform: translateY(0); }
        
        .gps-ring { 
            border: 2px solid #fff; 
            border-radius: 50%; 
            height: 18px; 
            width: 18px; 
            box-shadow: 0 0 15px rgba(255,255,255,0.6); 
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Search results and filters */
        #results { max-height: 250px; overflow-y: auto; }
        #results::-webkit-scrollbar { width: 4px; }
        #results::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
        #results::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        /* Directions list scrollbar */
        #sidebar-content::-webkit-scrollbar { width: 4px; }
        #sidebar-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
        #sidebar-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        /* Directions list specific */
        #directions-list { max-height: 500px; overflow-y: auto; }
        #directions-list::-webkit-scrollbar { width: 4px; }
        #directions-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
        #directions-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .search-result { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; }
        .search-result:hover { background: rgba(255,255,255,0.05); }
        .search-result:last-child { border-bottom: none; }
        
        .filter-btn { padding: 6px 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.7); transition: all 0.2s; }
        .filter-btn.active { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); }
        
        /* Navigation instructions */
        .nav-instruction-text { font-size: 13px; line-height: 1.4; }
        
        /* Exit navigation button */
        #exit-nav-btn { background: rgba(239, 68, 68, 0.25); border: 1px solid rgba(239, 68, 68, 0.5); color: #ff6b6b; }
        #exit-nav-btn:hover { background: #ef4444; color: white; border-color: #ef4444; }
        
        /* Path styling */
        .aviation-path { stroke-dasharray: 10, 10; }
        
        /* Type badges */
        .type-badge { 
            font-size: 8px; 
            font-weight: 700; 
            padding: 2px 5px; 
            border-radius: 4px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .type-city { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .type-street { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; }
        .type-building { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .type-landmark { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .type-default { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.7); }
        
        /* Directions list */
        .direction-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: all 0.3s; }
        .direction-item.active { background: rgba(59, 130, 246, 0.15); border-left: 3px solid #3b82f6; }
        .direction-item.completed { opacity: 0.5; }
        
        /* Traffic indicators */
        .traffic-indicator { 
            display: inline-block; 
            width: 6px; 
            height: 6px; 
            border-radius: 50%; 
            margin-right: 4px;
        }
        .traffic-high { background: #ef4444; }
        .traffic-medium { background: #f59e0b; }
        .traffic-low { background: #10b981; }
        
        /* Recents list */
        .recent-item { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .recent-item:hover { background: rgba(255,255,255,0.05); }
        .recent-time { font-size: 9px; color: #6b7280; }
        
        /* Progress bar */
        .progress-bar { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); transition: width 0.3s; }
        
        /* Step numbers */
        .step-number { 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
            font-weight: 700;
        }
        .step-number.active { background: #3b82f6; color: white; }
        .step-number.completed { background: #10b981; color: white; }
        .step-content { flex: 1; }
        .step-instruction { font-size: 12px; font-weight: 600; color: white; }
        .step-details { font-size: 10px; color: #9ca3af; margin-top: 2px; }
        
        /* HUD elements */
        .nav-hud-pos { display: block; }
        .nav-hud-eta { display: none; }
        .nav-hud-acc { display: block; }
        .nav-hud-distance { display: none; }
        
        /* When navigating */
        body.navigating .nav-hud-pos { display: none; }
        body.navigating .nav-hud-eta { display: block; }
        body.navigating .nav-hud-acc { display: none; }
        body.navigating .nav-hud-distance { display: block; }

#directions-list::-webkit-scrollbar { width: 4px; }
#directions-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
#directions-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

.nav-hud-pos { display: block; }
.nav-hud-eta { display: none; }
.nav-hud-acc { display: block; }
.nav-hud-distance { display: none; }

body.navigating .nav-hud-pos { display: none; }
body.navigating .nav-hud-eta { display: block; }
body.navigating .nav-hud-acc { display: none; }
body.navigating .nav-hud-distance { display: block; }

.nav-hud-pos::before { content: "Pos  "; }
.nav-hud-eta::before { content: "ETA  "; } 
.nav-hud-acc::before { content: "Acc  "; }
.nav-hud-distance::before { content: "Left  "; } 

/* Custom start point UI */
#custom-start-panel {
    position: absolute;
    top: 80px;
    left: 24px;
    z-index: 1001;
    width: 340px;
}

#custom-start-toggle {
    width: 100%;
    padding: 8px 12px;
    font-size: 11px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

#custom-start-toggle:hover {
    background: rgba(255,255,255,0.05);
    color: white;
}

#custom-start-expanded {
    display: none;
    margin-top: 8px;
    padding: 16px;
}

.start-mode-btn {
    width: 100%;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: white;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.start-mode-btn:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.2);
}

.start-mode-btn.active {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
    color: #93c5fd;
}

#custom-start-input-container {
    display: none;
    margin-top: 12px;
}

#custom-start-search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
}

.current-start-display {
    font-size: 10px;
    color: #9ca3af;
    margin-top: 4px;
    padding: 8px;
    background: rgba(255,255,255,0.02);
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.05);
}

/* Custom start point UI */
#custom-start-panel {
    position: absolute;
    top: 180px; /* Moved down below the Signal State panel */
    left: 24px;
    z-index: 1001;
    width: 340px;
}

#custom-start-toggle {
    width: 100%;
    padding: 8px 12px;
    font-size: 11px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

#custom-start-toggle:hover {
    background: rgba(255,255,255,0.05);
    color: white;
}

#custom-start-expanded {
    display: none;
    margin-top: 8px;
    padding: 16px;
}

.start-mode-btn {
    width: 100%;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: white;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.start-mode-btn:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.2);
}

.start-mode-btn.active {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
    color: #93c5fd;
}

#custom-start-input-container {
    display: none;
    margin-top: 12px;
}

#custom-start-search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
}

.current-start-display {
    font-size: 10px;
    color: #9ca3af;
    margin-top: 4px;
    padding: 8px;
    background: rgba(255,255,255,0.02);
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.05);
}

/* Custom start point UI - FIXED HEIGHT AND SCROLLING */
#custom-start-panel {
    position: absolute;
    top: 180px; /* Moved down below the Signal State panel */
    left: 24px;
    z-index: 999; /* LOWER than search panel (1000) */
    width: 340px;
    pointer-events: auto; /* Ensure it's clickable */
}

#custom-start-toggle {
    width: 100%;
    padding: 8px 12px;
    font-size: 11px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

#custom-start-toggle:hover {
    background: rgba(255,255,255,0.05);
    color: white;
}

#custom-start-expanded {
    display: none;
    margin-top: 8px;
    padding: 16px;
    background: var(--glass-surface);
    backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.9);
    overflow-y: auto; /* Always scrollable */
}

/* DYNAMIC HEIGHT CALCULATION - Will be set by JavaScript */
#custom-start-expanded.dynamic-height {
    position: fixed; /* Fixed positioning for viewport calculation */
    max-height: none; /* Remove fixed max-height */
}

/* CUSTOM SCROLLBAR for starting panel */
#custom-start-expanded::-webkit-scrollbar {
    width: 6px !important; /* Different width than other scrollbars */
}

#custom-start-expanded::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05) !important;
    border-radius: 3px !important; /* Different radius */
    margin: 4px 0 !important;
}

#custom-start-expanded::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.5) !important; /* Blue color */
    border-radius: 3px !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
}

#custom-start-expanded::-webkit-scrollbar-thumb:hover {
    background: rgba(59, 130, 246, 0.7) !important;
}

/* Fix search results overflow */
#custom-start-search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
}

/* Different scrollbar for search results inside starting panel */
#custom-start-search-results::-webkit-scrollbar {
    width: 4px !important;
}

#custom-start-search-results::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.03) !important;
}

#custom-start-search-results::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.5) !important; /* Purple color */
}

/* Remove the duplicate styles and keep only this: */
#custom-start-panel {
    position: absolute;
    top: 180px; /* Below the Signal State panel (80px + height of panels + gap) */
    left: 24px;
    z-index: 1001; /* Higher than standard-ui (1000) */
    width: 340px;
    pointer-events: auto;
}

/* Make the expanded panel FIXED to viewport */
#custom-start-expanded {
    display: none;
    position: fixed; /* Changed from absolute to fixed */
    margin-top: 8px;
    padding: 16px;
    background: var(--glass-surface);
    backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.9);
    overflow-y: auto;
    max-height: calc(100vh - 200px); /* Dynamic based on viewport */
    width: 340px; /* Same width as parent */
    z-index: 1002; /* Even higher */
}

/* Remove the .dynamic-height class styles - we don't need them */
    </style>

<style>
    /* Add this new style to control the starting point panel positioning */
    .starting-panel-container {
        position: relative;
        width: 100%;
    }

    /* FIXED: Custom start point UI - properly positioned below Signal State */
    #custom-start-panel {
        position: absolute;
        top: 160px; /* Fixed position below signal state */
        left: 24px;
        z-index: 999; /* Lower than search panel (1000) */
        width: 340px;
        pointer-events: auto;
        margin-top: 8px; /* Small gap from signal state */
    }

    /* Ensure expanded panel is positioned correctly */
    #custom-start-expanded {
        display: none;
        position: absolute; /* Changed from fixed to absolute */
        margin-top: 8px;
        padding: 16px;
        background: var(--glass-surface);
        backdrop-filter: blur(30px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        box-shadow: 0 24px 60px rgba(0,0,0,0.9);
        overflow-y: auto;
        width: 100%; /* Full width of parent */
        box-sizing: border-box;
        z-index: 1002;
max-height: 270px !important;
    }

    /* Set a reasonable maximum height that won't exceed viewport */
    #custom-start-expanded {
        max-height: 400px; /* Fixed max height */
    }

    /* Custom scrollbar for starting panel */
    #custom-start-expanded::-webkit-scrollbar {
        width: 6px !important;
    }

    #custom-start-expanded::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05) !important;
        border-radius: 3px !important;
        margin: 4px 0 !important;
    }

    #custom-start-expanded::-webkit-scrollbar-thumb {
        background: rgba(59, 130, 246, 0.5) !important;
        border-radius: 3px !important;
        border: 1px solid rgba(255,255,255,0.1) !important;
    }

    #custom-start-expanded::-webkit-scrollbar-thumb:hover {
        background: rgba(59, 130, 246, 0.7) !important;
    }

    /* Fix search results inside starting panel to have their own scroll */
    #custom-start-search-results {
        max-height: 150px; /* Smaller fixed height */
        overflow-y: auto;
        margin-top: 8px;
        display: none;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        background: rgba(0,0,0,0.3);
    }

    /* Different scrollbar for search results inside starting panel */
    #custom-start-search-results::-webkit-scrollbar {
        width: 4px !important;
    }

    #custom-start-search-results::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.03) !important;
    }

    #custom-start-search-results::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.5) !important;
    }

@media (max-width: 775px) {
#info-sidebar {
width: 92% !important;
}
        body.navigating #info-sidebar {
            display: none !important;
        }
}
</style>
</head>
<body class="bg-black">

    <div id="loader">
        <svg viewBox="0 0 76 65" fill="white" class="w-12 h-12 mb-4 animate-pulse"><path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path></svg>
        <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-[0.5em]">Requesting Locaton...</div>
        <div class="loading-bar"><div class="loading-fill"></div></div>
    </div>

    <div id="map"></div>

    <div id="standard-ui" class="absolute top-6 left-6 z-[1000] w-[340px] flex flex-col gap-3">
        <div class="strike-glass p-2 ui-animate">
            <div class="relative group">
                <iconify-icon icon="lucide:search" class="absolute left-3 top-2.5 text-neutral-500"></iconify-icon>
                <input type="text" id="search-input" placeholder="Search destination..." class="w-full h-10 pl-10 pr-4 rounded-xl text-xs font-bold strike-input">
                <div id="search-spinner" class="hidden absolute right-3 top-3"><iconify-icon icon="lucide:loader-2" class="animate-spin text-white"></iconify-icon></div>
            </div>
            <div id="filters" class="hidden mt-2 flex gap-1 flex-wrap">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="nearby">Near Me</button>
                <button class="filter-btn" data-filter="hotels">Hotels</button>
                <button class="filter-btn" data-filter="parks">Parks</button>
                <button class="filter-btn" data-filter="restaurants">Restaurants</button>
                <button class="filter-btn" data-filter="gas">Gas Stations</button>
            </div>
            <div id="results" class="hidden mt-2 flex flex-col"></div>
        </div>
        <div class="strike-glass px-4 py-3 flex items-center justify-between ui-animate">
            <div class="flex flex-col">
                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-tight">Signal State</span>
                <span id="status-text" class="text-[11px] font-bold text-white">Standby</span>
            </div>
            <button id="locate-btn" class="h-8 px-4 bg-white text-black rounded-lg text-[11px] font-extrabold flex items-center gap-2 hover:bg-neutral-100 transition-all">
                <iconify-icon icon="lucide:crosshair"></iconify-icon> Re-Center
            </button>
        </div>

    </div>

<div id="custom-start-panel" class="strike-glass ui-animate">
    <div class="starting-panel-container">
        <button id="custom-start-toggle" class="w-full">
            <div class="flex justify-between items-center w-full">
                <span>Starting Point: <span id="current-start-mode">Current Location</span></span>
                <iconify-icon icon="lucide:chevron-down"></iconify-icon>
            </div>
        </button>
        <div id="custom-start-expanded">
            <div class="space-y-2">
                <button class="start-mode-btn active" data-mode="current">
                    <iconify-icon icon="lucide:crosshair"></iconify-icon>
                    Use Current Location
                </button>
                <button class="start-mode-btn" data-mode="map">
                    <iconify-icon icon="lucide:map-pin"></iconify-icon>
                    Click on Map
                </button>
                <button class="start-mode-btn" data-mode="search">
                    <iconify-icon icon="lucide:search"></iconify-icon>
                    Search for Location
                </button>
            </div>
            
            <div id="custom-start-input-container">
                <div class="relative mt-3">
                    <iconify-icon icon="lucide:search" class="absolute left-3 top-2.5 text-neutral-500"></iconify-icon>
                    <input type="text" id="custom-start-input" placeholder="Enter starting address or city..." class="w-full h-10 pl-10 pr-4 rounded-xl text-xs font-bold strike-input">
                </div>
                <div id="custom-start-search-results" class="flex flex-col"></div>
            </div>
            
            <div id="current-start-display" class="current-start-display mt-3">
                <div class="font-semibold text-white">Current start point:</div>
                <div class="text-[9px] mt-1" id="start-point-coords">Your current location</div>
            </div>
        </div>
    </div>
</div>

    <div id="active-nav-hud" class="absolute top-6 left-6 z-[2000] w-[340px] flex flex-col gap-3">
        <div class="strike-glass p-4 border-l-4 border-emerald-500">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center">
                    <iconify-icon id="nav-step-icon" icon="lucide:navigation" class="text-2xl text-emerald-400"></iconify-icon>
                </div>
                <div class="flex-1">
                    <span id="nav-dist-next" class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1">In 200m</span>
                    <h3 id="nav-instruction" class="nav-instruction-text font-bold text-white leading-tight">Continue straight for 1.2 kilometers on Main Street</h3>
                    <div class="progress-bar">
                        <div id="step-progress" class="progress-fill" style="width: 30%"></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white/5">
                <div class="flex justify-between text-[11px]">
                    <div>
                        <div class="text-neutral-500 mb-1">Next Turn</div>
                        <div id="nav-next-turn" class="text-white font-semibold">Right onto Broadway</div>
                    </div>
                    <div>
                        <div class="text-neutral-500 mb-1">ETA</div>
                        <div id="nav-eta" class="text-emerald-400 font-bold">14:30</div>
                    </div>
                    <div>
                        <div class="text-neutral-500 mb-1">Remaining</div>
                        <div id="nav-remaining" class="text-white font-bold">4.2 km</div>
                    </div>
                </div>
            </div>
        </div>
        <button id="exit-nav-btn" class="w-full h-10 bg-red-500/25 border border-red-500/50 text-white rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-red-500 transition-all duration-200">
            <iconify-icon icon="lucide:x-circle"></iconify-icon> Exit Navigation
        </button>
    </div>

    <div id="info-sidebar" class="strike-glass">
        <div class="p-6 border-b border-white/5 flex items-center justify-between">
            <h2 id="side-title" class="text-xl font-bold text-white truncate pr-4">Location</h2>
            <button onclick="closeSidebar()" class="text-neutral-500 hover:text-white"><iconify-icon icon="lucide:x" class="text-xl"></iconify-icon></button>
        </div>
        <div id="sidebar-content" class="p-6 flex-1 overflow-y-auto">
            <!-- Content will be dynamically populated -->
        </div>
        <div class="p-6 bg-white/[0.02] border-t border-white/5 flex gap-2">
            <button id="start-nav-btn" class="hidden flex-1 h-12 bg-white text-black rounded-xl text-xs font-black flex items-center justify-center gap-3">
                <iconify-icon icon="lucide:navigation-2" class="text-lg"></iconify-icon> START NAVIGATION
            </button>
        </div>
    </div>

    <div class="absolute bottom-6 right-6 z-[1000] flex flex-col gap-3 ui-animate">
        <div class="strike-glass p-1 flex flex-col gap-1">
            <button id="sat-toggle" class="w-10 h-10 flex items-center justify-center rounded-xl text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:layers" class="text-lg"></iconify-icon></button>
        </div>
        <div class="strike-glass p-1 flex flex-col gap-1">
            <button id="zoom-in" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:plus"></iconify-icon></button>
            <button id="zoom-out" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:minus"></iconify-icon></button>
        </div>
    </div>

    <div class="absolute bottom-6 left-6 z-[1000] pointer-events-none flex flex-col gap-4 ui-animate">
<div class="strike-glass px-4 py-3 flex gap-6 items-center pointer-events-auto">
    <div class="flex flex-col">
        <span id="hud-coords" class="nav-hud-pos text-[10px] font-mono text-white mt-1">0.0, 0.0</span>
        <span id="hud-eta" class="nav-hud-eta text-[10px] font-mono text-emerald-400 mt-1">--:--</span>
    </div>
    <div class="flex flex-col">
        <span id="hud-precision" class="nav-hud-acc text-[10px] font-mono text-white mt-1">-- m</span>
        <span id="hud-remaining" class="nav-hud-distance text-[10px] font-mono text-white mt-1">-- km</span>
    </div>
</div>
        <div class="opacity-40 text-[10px] font-black uppercase tracking-widest text-white flex items-center gap-2">
            <svg width="12" height="12" viewBox="0 0 76 65" fill="white"><path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path></svg>
            Strike Maps [V5]
        </div>
    </div>

    <script>
        // Initialize variables
        let map = null;
        let darkBase = null;
        let satLayer = null;
        const userIcon = L.divIcon({ 
            className: 'user-location-marker', 
            html: '<div class="gps-ring"></div>', 
            iconSize: [24, 24], 
            iconAnchor: [12, 12] 
        });
        let userMarker = L.marker([0,0], {icon: userIcon});
        let routeLayer = L.layerGroup();
        let userPos = null;
        let selectedTarget = null;
        let currentRoute = null;
        let currentNavRoute = null;
        let currentStepIndex = 0;
        let searchResults = [];
        let activeFilter = 'all';
        let isNavigating = false;
        let recentSearches = JSON.parse(localStorage.getItem('strikeRecentSearches')) || [];
        let watchId = null;
        let totalRouteDistance = 0;
        let remainingDistance = 0;
        let gpsWatchInterval = null;
        let isLocationRequested = false;
        let routeStartTime = null;
        
        // NEW VARIABLES FOR CUSTOM START POINT
        let customStartMode = 'current'; // 'current', 'map', 'search'
        let customStartPos = null;
        let customStartMarker = null;
        
        // Map initialization function
        function initMap() {
            map = L.map('map', { 
                zoomControl: false, 
                attributionControl: false, 
                maxBounds: [[-85, -10000], [85, 10000]], 
                maxBoundsViscosity: 1.0, 
                worldCopyJump: true, 
                minZoom: 3 
            }).setView([40.7128, -74.0060], 2); // Default to NYC
            
            darkBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 19, 
                className: 'dark-layer' 
            }).addTo(map);
            
            satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
                maxZoom: 19 
            });
            
            routeLayer.addTo(map);
            
            // Add user marker
            userMarker.addTo(map);
            
            // Initialize custom start marker
            customStartMarker = L.marker([0,0], {
                icon: L.divIcon({
                    className: 'custom-start-marker',
                    html: '<div style="background: #f59e0b; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(245,158,11,0.5);"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                })
            });
        }
        
        // Setup map event listeners
        function setupMapEvents() {
            if (!map) return;
            
            map.on('click', (e) => {
                if (isNavigating) return;
                
                if (customStartMode === 'map') {
                    // Set custom start point from map click
                    setCustomStartFromMap(e.latlng);
                } else {
                    // Normal behavior - trigger analysis on clicked point
                    triggerAnalysis(e.latlng.lat, e.latlng.lng);
                    hideSearchResults();
                }
            });
            
            map.on('mousemove', (e) => {
                document.getElementById('hud-coords').innerText = 
                    `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            });
            
            map.on('move', () => {
                hideSearchResults();
            });
        }
        
        // --- CUSTOM START POINT FUNCTIONS ---
        function toggleStartPanel() {
            const expanded = document.getElementById('custom-start-expanded');
            if (expanded.style.display === 'block') {
                expanded.style.display = 'none';
            } else {
                expanded.style.display = 'block';
            }
        }

function toggleStartPanel(e) {
    e.stopPropagation();
    const expanded = document.getElementById('custom-start-expanded');
    const searchResults = document.getElementById('results');
    const customSearchResults = document.getElementById('custom-start-search-results');
    
    // Close search results if open
    if (searchResults && !searchResults.classList.contains('hidden')) {
        hideSearchResults();
    }
    
    // Close custom search results
    if (customSearchResults && customSearchResults.style.display === 'block') {
        customSearchResults.style.display = 'none';
    }
    
    // Toggle starting panel
    if (expanded.style.display === 'block') {
        expanded.style.display = 'none';
    } else {
        expanded.style.display = 'block';
        
        // Reset to default height (show full content)
        expanded.style.maxHeight = '400px';
        
        // Ensure the panel is visible in viewport
        const panelRect = expanded.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        // If panel would go below viewport, adjust max-height
        if (panelRect.bottom > viewportHeight - 10) {
            const availableHeight = viewportHeight - panelRect.top - 20;
            expanded.style.maxHeight = Math.max(150, availableHeight) + 'px';
        }
    }
}

window.addEventListener('resize', () => {
    const expanded = document.getElementById('custom-start-expanded');
    if (expanded.style.display === 'block') {
        const panelRect = expanded.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        // If panel goes below viewport, adjust max-height
        if (panelRect.bottom > viewportHeight - 10) {
            const availableHeight = viewportHeight - panelRect.top - 20;
            expanded.style.maxHeight = Math.max(150, availableHeight) + 'px';
        } else {
            expanded.style.maxHeight = '400px';
        }
    }
});

// Update click outside detection
document.addEventListener('click', (e) => {
    const startPanel = document.getElementById('custom-start-panel');
    const startToggle = document.getElementById('custom-start-toggle');
    const startExpanded = document.getElementById('custom-start-expanded');
    const customStartInput = document.getElementById('custom-start-input');
    const customSearchResults = document.getElementById('custom-start-search-results');
    
    // Check if click is inside search results
    const isInSearchResults = customSearchResults && customSearchResults.contains(e.target);
    
    // Close starting point panel if clicking outside
    if (startExpanded.style.display === 'block' && 
        !startPanel.contains(e.target) && 
        e.target !== startToggle &&
        e.target !== customStartInput &&
        !isInSearchResults) {
        startExpanded.style.display = 'none';
    }
});

function calculateDynamicHeight() {
    const expanded = document.getElementById('custom-start-expanded');
    if (!expanded || expanded.style.display !== 'block') return;
    
    // Get viewport height
    const viewportHeight = window.innerHeight;
    
    // Get panel position and dimensions
    const panelRect = expanded.getBoundingClientRect();
    const toggleRect = document.getElementById('custom-start-toggle').getBoundingClientRect();
    
    // Calculate available space from panel top to 10px above bottom
    const spaceFromTop = toggleRect.top + toggleRect.height + 8; // Panel top position
    const spaceToBottom = viewportHeight - spaceFromTop - 10; // 10px margin from bottom
    
    // Set max height (but not less than 150px)
    const maxHeight = Math.max(150, Math.min(400, spaceToBottom));
    
    expanded.style.maxHeight = `${maxHeight}px`;
    expanded.style.position = 'absolute';
    expanded.style.top = 'calc(100% + 8px)';
    expanded.style.left = '0';
    expanded.style.right = '0';
}

// Recalculate height on window resize
window.addEventListener('resize', calculateDynamicHeight);

// Also recalculate when switching modes
document.querySelectorAll('.start-mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        setTimeout(() => calculateDynamicHeight(), 100);
    });
});

// Recalculate when search results appear
const customStartInput = document.getElementById('custom-start-input');
customStartInput.addEventListener('input', () => {
    setTimeout(() => calculateDynamicHeight(), 200);
});
        
        function setStartMode(mode) {
            customStartMode = mode;
            
            // Update UI
            document.querySelectorAll('.start-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById('current-start-mode').textContent = 
                mode === 'current' ? 'Current Location' :
                mode === 'map' ? 'Click on Map' :
                'Search for Location';
            
            // Show/hide search input
            const searchContainer = document.getElementById('custom-start-input-container');
            const searchResults = document.getElementById('custom-start-search-results');
            
            if (mode === 'search') {
                searchContainer.style.display = 'block';
                searchResults.style.display = 'none';
            } else {
                searchContainer.style.display = 'none';
                searchResults.style.display = 'none';
                document.getElementById('custom-start-input').value = '';
            }
            
            // Update marker
            updateCustomStartMarker();
            
            // Update display
            updateStartPointDisplay();
            
            // If we have a target selected, recalculate routes
            if (selectedTarget) {
                calculateRoutes(getCurrentStartPoint(), selectedTarget);
            }
        }
        
        function setCustomStartFromMap(latlng) {
            customStartPos = [latlng.lat, latlng.lng];
            updateCustomStartMarker();
            
            // Reverse geocode to get address
            fetch(`https://photon.komoot.io/reverse?lon=${latlng.lng}&lat=${latlng.lat}&limit=1`)
                .then(res => res.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        const p = data.features[0].properties || {};
                        const address = [p.street, p.city, p.country].filter(Boolean).join(', ') || 
                                       `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                        document.getElementById('start-point-coords').textContent = address;
                    } else {
                        document.getElementById('start-point-coords').textContent = 
                            `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                    }
                })
                .catch(() => {
                    document.getElementById('start-point-coords').textContent = 
                        `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                });
            
            // If we have a target selected, recalculate routes
            if (selectedTarget) {
                calculateRoutes(customStartPos, selectedTarget);
            }
        }
        
function searchCustomStartLocation(query) {
    if (!query || query.trim().length < 2) {
        const container = document.getElementById('custom-start-search-results');
        container.style.display = 'none';
        return;
    }
    
    fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=10`)
        .then(res => res.json())
        .then(data => {
            const results = data.features || [];
            const container = document.getElementById('custom-start-search-results');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="text-xs text-neutral-500 p-2 text-center">No results found</div>';
                container.style.display = 'block';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                const props = result.properties;
                const name = props.name || props.street || props.city || "Unnamed Location";
                const details = [props.housenumber, props.street, props.city, props.country]
                    .filter(Boolean)
                    .join(', ') || 'Coordinates';
                
                html += `
                    <div class="search-result" data-lat="${result.geometry.coordinates[1]}" data-lng="${result.geometry.coordinates[0]}" data-name="${name}">
                        <div class="text-[11px] font-bold text-white mb-1">${name}</div>
                        <div class="text-[9px] text-neutral-400">${details}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            // Ensure container doesn't exceed available space
            const expanded = document.getElementById('custom-start-expanded');
            const expandedRect = expanded.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            // Calculate available space for search results
            const resultsHeight = Math.min(150, viewportHeight - expandedRect.top - 180);
            container.style.maxHeight = resultsHeight + 'px';
            
            // Add click handlers
            document.querySelectorAll('#custom-start-search-results .search-result').forEach(item => {
                item.addEventListener('click', () => {
                    const lat = parseFloat(item.dataset.lat);
                    const lng = parseFloat(item.dataset.lng);
                    const name = item.dataset.name;
                    
                    customStartPos = [lat, lng];
                    customStartMode = 'search';
                    updateCustomStartMarker();
                    
                    // Update display
                    document.getElementById('start-point-coords').textContent = name;
                    
                    // Hide results and clear input
                    container.style.display = 'none';
                    document.getElementById('custom-start-input').value = name;
                    
                    // If we have a target selected, recalculate routes
                    if (selectedTarget) {
                        calculateRoutes(customStartPos, selectedTarget);
                    }
                    
                    // Center map on selected location
                    map.flyTo([lat, lng], 14, { animate: true, duration: 1 });
                });
            });
        })
        .catch(error => {
            console.error("Custom start search failed:", error);
        });
}
        
        function updateCustomStartMarker() {
            // Remove existing marker
            if (map.hasLayer(customStartMarker)) {
                map.removeLayer(customStartMarker);
            }
            
            // Add marker if we have a custom position and mode is not 'current'
            if (customStartMode !== 'current' && customStartPos) {
                customStartMarker.setLatLng(customStartPos);
                customStartMarker.addTo(map);
            }
        }
        
        function updateStartPointDisplay() {
            let displayText = '';
            
            if (customStartMode === 'current') {
                displayText = 'Your current location';
            } else if (customStartMode === 'map' && customStartPos) {
                displayText = `${customStartPos[0].toFixed(4)}, ${customStartPos[1].toFixed(4)}`;
            } else if (customStartMode === 'search' && customStartPos) {
                displayText = document.getElementById('start-point-coords').textContent;
            } else {
                displayText = 'Your current location';
            }
            
            document.getElementById('start-point-coords').textContent = displayText;
        }
        
        function getCurrentStartPoint() {
            if (customStartMode === 'current') {
                return userPos || [40.7128, -74.0060]; // Fallback to NYC
            } else if (customStartPos) {
                return customStartPos;
            } else {
                return userPos || [40.7128, -74.0060];
            }
        }
        
        // --- LOAD & GPS ---
        window.onload = () => {
            initMap();
            
            // Setup custom start point UI
            document.getElementById('custom-start-toggle').addEventListener('click', toggleStartPanel);
            
            document.querySelectorAll('.start-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => setStartMode(btn.dataset.mode));
            });
            
            // Custom start search input
            const customStartInput = document.getElementById('custom-start-input');
            let customSearchTimeout;
            customStartInput.addEventListener('input', (e) => {
                clearTimeout(customSearchTimeout);
                customSearchTimeout = setTimeout(() => {
                    searchCustomStartLocation(e.target.value);
                }, 500);
            });
            
            customStartInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchCustomStartLocation(e.target.value);
                }
            });
            
            // After the setTimeout in window.onload:
            setTimeout(() => {
                if (navigator.geolocation && !isLocationRequested) {
                    isLocationRequested = true;
                    document.getElementById('status-text').innerText = "Acquiring Signal";
                    
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            userPos = [pos.coords.latitude, pos.coords.longitude];
                            userMarker.setLatLng(userPos);
                            map.setView(userPos, 14);
                            
                            document.getElementById('hud-precision').innerText = `${pos.coords.accuracy.toFixed(0)}m`;
                            document.getElementById('status-text').innerText = "Signal Locked";
                            document.getElementById('hud-coords').innerText = `${userPos[0].toFixed(4)}, ${userPos[1].toFixed(4)}`;
                            
                            // Update start point display
                            updateStartPointDisplay();
                            
                            // HIDE LOADER HERE
                            document.getElementById('loader').style.opacity = '0';
                            setTimeout(() => { 
                                document.getElementById('loader').style.display = 'none'; 
                                document.body.classList.add('ui-ready'); 
                                setupMapEvents();
                                
                                // Start continuous GPS AFTER permission is granted
                                setTimeout(() => {
                                    startContinuousGPS();
                                }, 1000);
                            }, 500);
                        },
                        (error) => { 
                            userPos = [40.7128, -74.0060];
                            userMarker.setLatLng(userPos);
                            map.setView(userPos, 2);
                            document.getElementById('status-text').innerText = "GPS Unavailable";
                            
                            // Update start point display
                            updateStartPointDisplay();
                            
                            // HIDE LOADER HERE TOO
                            document.getElementById('loader').style.opacity = '0';
                            setTimeout(() => { 
                                document.getElementById('loader').style.display = 'none'; 
                                document.body.classList.add('ui-ready'); 
                                setupMapEvents();
                            }, 500);
                        },
                        { 
                            enableHighAccuracy: true,
                            timeout: 60000,
                            maximumAge: 0
                        }
                    );
                } else {
                    userPos = [40.7128, -74.0060];
                    userMarker.setLatLng(userPos);
                    map.setView(userPos, 2);
                    
                    // Update start point display
                    updateStartPointDisplay();
                    
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => { 
                        document.getElementById('loader').style.display = 'none'; 
                        document.body.classList.add('ui-ready'); 
                        setupMapEvents();
                    }, 500);
                }
            }, 2000);
        };
        
        function startContinuousGPS() {
    // Don't start if we don't have permission or if already watching
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    
    // Start watching position silently (no permission prompt)
    watchId = navigator.geolocation.watchPosition(
        (pos) => {
            userPos = [pos.coords.latitude, pos.coords.longitude];
            
            // Update marker position
            userMarker.setLatLng(userPos);
            
            // Update start point display if using current location
            if (customStartMode === 'current') {
                updateStartPointDisplay();
            }
            
            // Update HUD - only if not navigating
            if (!isNavigating) {
                document.getElementById('hud-precision').innerText = `${pos.coords.accuracy.toFixed(0)}m`;
                document.getElementById('hud-coords').innerText = 
                    `${userPos[0].toFixed(4)}, ${userPos[1].toFixed(4)}`;
            }
            
            // Check navigation progress
            if (isNavigating && currentNavRoute) {
                checkNavigationProgress(pos);
            }
        },
        (error) => {
            console.log("GPS watch error:", error);
            // Don't retry continuously if permission is denied
        },
        { 
            enableHighAccuracy: true,
            maximumAge: 5000, // 5 seconds
            timeout: 15000 // 15 second timeout
        }
    );
}
        
        async function triggerAnalysis(lat, lng) {
            selectedTarget = [lat, lng];
            const sidebar = document.getElementById('info-sidebar');
            sidebar.classList.add('active');
            routeLayer.clearLayers();
            document.getElementById('start-nav-btn').classList.add('hidden');
            
            document.getElementById('side-title').innerText = "Processing...";
            
            try {
                const res = await fetch(`https://photon.komoot.io/reverse?lon=${lng}&lat=${lat}&limit=1`);
                const data = await res.json();
                
                if (data.features && data.features.length > 0) {
                    const p = data.features[0].properties || {};
                    document.getElementById('side-title').innerText = 
                        p.name || p.street || "Selected Location";
                    document.getElementById('sidebar-content').innerHTML = `
                        <div class="space-y-6">
                            <div id="logistics-module">
                                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block mb-4">Routes via Engine</span>
                                <div id="route-options" class="flex flex-col gap-2"></div>
                            </div>
                            <div class="space-y-2">
                                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block">Address</span>
                                <p class="text-xs text-neutral-400 leading-relaxed">${[p.street, p.city, p.country, p.postcode].filter(Boolean).join(', ') || `${lat.toFixed(6)}, ${lng.toFixed(6)}`}</p>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('side-title').innerText = "Location";
                    document.getElementById('sidebar-content').innerHTML = `
                        <div class="space-y-6">
                            <div id="logistics-module">
                                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block mb-4">Routes via Engine</span>
                                <div id="route-options" class="flex flex-col gap-2"></div>
                            </div>
                            <div class="space-y-2">
                                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block">Address</span>
                                <p class="text-xs text-neutral-400 leading-relaxed">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Reverse geocoding failed:", error);
                document.getElementById('side-title').innerText = "Target Location";
                document.getElementById('sidebar-content').innerHTML = `
                    <div class="space-y-6">
                        <div id="logistics-module">
                            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block mb-4">Routes via Engine</span>
                            <div id="route-options" class="flex flex-col gap-2"></div>
                        </div>
                        <div class="space-y-2">
                            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block">Address</span>
                            <p class="text-xs text-neutral-400 leading-relaxed">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        </div>
                    </div>
                `;
            }
            
            // Use current start point (which could be custom or current location)
            calculateRoutes(getCurrentStartPoint(), [lat, lng]);
        }
        
        async function calculateRoutes(start, end) {
            const container = document.getElementById('route-options');
            container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">Calculating routes...</div>';
            
            const distance = map.distance(start, end);
            const routes = [];
            
            const trafficLevel = calculateTrafficLevel(start, end);

            // Check if flight route should be shown
            if (shouldShowFlightRoute(start, end, distance)) {
                const flightRoute = await calculateFlightRoute(start, end, distance);
                if (flightRoute) {
                    routes.push(flightRoute);
                }
            }

            const modes = [
                { id: 'driving', icon: 'lucide:car', label: 'Driving' },
                { id: 'cycling', icon: 'lucide:bike', label: 'Cycling' },
                { id: 'walking', icon: 'lucide:footprints', label: 'Walking' }
            ];
            
            for (const m of modes) {
                try {
                    const r = await fetch(`https://router.project-osrm.org/route/v1/${m.id}/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true&annotations=true`)
                        .then(res => res.json());
                    
                    if (r.routes?.[0]) {
                        const route = {
                            id: m.id,
                            icon: m.icon,
                            label: m.label,
                            duration: r.routes[0].duration,
                            distance: r.routes[0].distance,
                            geometry: r.routes[0].geometry,
                            legs: r.routes[0].legs,
                            steps: processOSRMSteps(r.routes[0].legs?.[0]?.steps || []),
                            fullRouteData: r.routes[0]
                        };
                        
                        if (m.id === 'driving') {
                            route.traffic = trafficLevel;
                            route.originalDuration = r.routes[0].duration;
                            if (trafficLevel === 'high') {
                                route.duration = route.duration * 1.4;
                            } else if (trafficLevel === 'medium') {
                                route.duration = route.duration * 1.2;
                            }
                        }
                        
                        routes.push(route);
                    }
                } catch(e) {
                    console.error(`Route calculation failed for ${m.id}:`, e);
                }
            }
            
            container.innerHTML = '';
            if (routes.length === 0) {
                container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No routes available</div>';
                return;
            }
            
            routes.forEach(route => {
                addRouteCard(route);
            });
        }
        
        function processOSRMSteps(osrmSteps) {
            return osrmSteps.map((step, index) => {
                const instruction = generateRealNavigationInstruction(step, index, osrmSteps);
                
                return {
                    distance: step.distance,
                    duration: step.duration,
                    geometry: step.geometry,
                    maneuver: {
                        instruction: instruction,
                        type: step.maneuver?.type || 'continue',
                        modifier: step.maneuver?.modifier || '',
                        location: step.maneuver?.location
                    },
                    name: step.name || getStreetName(step),
                    way_points: step.way_points
                };
            });
        }

        function shouldShowFlightRoute(start, end, distance) {
            // Show flight for distances over 300km
            if (distance > 300000) return true;
            
            // Also show flight if both points are near major airports
            const majorAirports = getMajorAirportsList();
            
            const isNearAirportStart = majorAirports.some(airport => 
                map.distance(start, airport.coords) < 50000
            );
            
            const isNearAirportEnd = majorAirports.some(airport => 
                map.distance(end, airport.coords) < 50000
            );
            
            return isNearAirportStart && isNearAirportEnd;
        }
        
        function getMajorAirportsList() {
            return [
                { code: "JFK", name: "John F. Kennedy International", coords: [40.6413, -73.7781], city: "New York" },
                { code: "LAX", name: "Los Angeles International", coords: [33.9416, -118.4085], city: "Los Angeles" },
                { code: "ORD", name: "O'Hare International", coords: [41.9742, -87.9073], city: "Chicago" },
                { code: "DFW", name: "Dallas/Fort Worth International", coords: [32.8998, -97.0403], city: "Dallas" },
                { code: "DEN", name: "Denver International", coords: [39.8561, -104.6737], city: "Denver" },
                { code: "SFO", name: "San Francisco International", coords: [37.6213, -122.3790], city: "San Francisco" },
                { code: "SEA", name: "Seattle-Tacoma International", coords: [47.4502, -122.3088], city: "Seattle" },
                { code: "MIA", name: "Miami International", coords: [25.7959, -80.2870], city: "Miami" },
                { code: "ATL", name: "Hartsfield-Jackson Atlanta", coords: [33.6407, -84.4277], city: "Atlanta" },
                { code: "LHR", name: "London Heathrow", coords: [51.4700, -0.4543], city: "London" },
                { code: "CDG", name: "Charles de Gaulle", coords: [49.0097, 2.5479], city: "Paris" },
                { code: "FRA", name: "Frankfurt Airport", coords: [50.0333, 8.5706], city: "Frankfurt" },
                { code: "AMS", name: "Amsterdam Schiphol", coords: [52.3086, 4.7639], city: "Amsterdam" },
                { code: "DXB", name: "Dubai International", coords: [25.2532, 55.3657], city: "Dubai" },
                { code: "HND", name: "Tokyo Haneda", coords: [35.5494, 139.7798], city: "Tokyo" },
                { code: "PEK", name: "Beijing Capital", coords: [40.0799, 116.6031], city: "Beijing" },
                { code: "SYD", name: "Sydney Kingsford Smith", coords: [-33.9399, 151.1753], city: "Sydney" },
                { code: "YYZ", name: "Toronto Pearson", coords: [43.6777, -79.6248], city: "Toronto" },
                { code: "MAD", name: "Madrid Barajas", coords: [40.4983, -3.5676], city: "Madrid" },
                { code: "FCO", name: "Rome Fiumicino", coords: [41.8045, 12.2508], city: "Rome" }
            ];
        }
        
        async function calculateFlightRoute(start, end, distance) {
            try {
                // Get REAL major airports (not random airstrips)
                const startAirport = await findNearestMajorAirport(start);
                const endAirport = await findNearestMajorAirport(end);
                
                // Calculate flight time (average 800 km/h)
                const flightHours = distance / 800000;
                const flightMinutes = Math.round(flightHours * 60);
                const totalFlightTime = flightHours * 3600; // in seconds
                
                // Add airport transfer time (2 hours for check-in, security, etc.)
                const totalDuration = totalFlightTime + 7200;
                
                // Generate airport description
                const startDesc = startAirport.code ? 
                    `${startAirport.code} (${startAirport.name})` : 
                    "nearest airport";
                
                const endDesc = endAirport.code ? 
                    `${endAirport.code} (${endAirport.name})` : 
                    "destination airport";
                
                // Generate booking links with REAL airport codes
                const bookingLinks = generateFlightBookingLinks(startAirport, endAirport);
                
                return {
                    id: 'flight',
                    icon: 'lucide:plane',
                    label: 'Flight',
                    duration: totalDuration,
                    distance: distance,
                    geometry: createFlightPath(startAirport.coordinates || start, endAirport.coordinates || end),
                    steps: [
                        {
                            distance: distance,
                            duration: totalDuration,
                            maneuver: {
                                instruction: `Fly from ${startDesc} to ${endDesc}`,
                                type: 'depart'
                            }
                        }
                    ],
                    bookingLinks: bookingLinks,
                    flightTime: flightMinutes,
                    airports: {
                        departure: startAirport,
                        arrival: endAirport
                    },
                    description: `${startDesc}  ${endDesc}`,
                    details: `Flight from ${startAirport.city || 'origin'} to ${endAirport.city || 'destination'}`
                };
            } catch (error) {
                console.error("Flight route calculation failed:", error);
                return null;
            }
        }
        
        async function findNearestMajorAirport(coords) {
            const majorAirports = getMajorAirportsList();
            
            // Find the closest major airport
            let closestAirport = majorAirports[0];
            let minDistance = map.distance(coords, closestAirport.coords);
            
            for (const airport of majorAirports) {
                const distance = map.distance(coords, airport.coords);
                if (distance < minDistance && distance < 200000) { // Within 200km
                    minDistance = distance;
                    closestAirport = airport;
                }
            }
            
            // If no airport within 200km, return the closest one anyway
            if (minDistance > 200000) {
                // Recalculate absolute closest
                closestAirport = majorAirports[0];
                minDistance = map.distance(coords, closestAirport.coords);
                for (const airport of majorAirports) {
                    const distance = map.distance(coords, airport.coords);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestAirport = airport;
                    }
                }
            }
            
            return {
                name: closestAirport.name,
                code: closestAirport.code,
                city: closestAirport.city,
                coordinates: closestAirport.coords,
                distance: minDistance
            };
        }
        
        function generateFlightBookingLinks(departure, arrival) {
            const links = [];
            
            // Only show booking links if we have airport codes
            if (departure.code && arrival.code) {
                links.push({
                    name: "Kayak",
                    url: `https://www.kayak.com/flights/${departure.code}-${arrival.code}`,
                    icon: "lucide:search"
                });
                
                links.push({
                    name: "Expedia",
                    url: `https://www.expedia.com/Flights-Search?flight-type=on&mode=search&trip=oneway&leg1=from:${departure.code},to:${arrival.code}`,
                    icon: "lucide:plane"
                });
                
                links.push({
                    name: "Google Flights",
                    url: `https://www.google.com/travel/flights?q=Flights%20to%20${arrival.code}%20from%20${departure.code}`,
                    icon: "lucide:globe"
                });
            } else {
                // Generic search if no airport codes
                const startName = departure.city || departure.name || "origin";
                const endName = arrival.city || arrival.name || "destination";
                
                links.push({
                    name: "Search Flights",
                    url: `https://www.google.com/search?q=flights+from+${encodeURIComponent(startName)}+to+${encodeURIComponent(endName)}`,
                    icon: "lucide:search"
                });
            }
            
            // Add car rental link
            links.push({
                name: "Car Rental",
                url: `https://www.rentalcars.com/`,
                icon: "lucide:car"
            });
            
            // Add hotel booking link
            links.push({
                name: "Hotels",
                url: `https://www.booking.com/`,
                icon: "lucide:building"
            });
            
            return links;
        }
        
        function createFlightPath(start, end) {
            // Create a curved flight path (great circle approximation)
            const midLat = (start[0] + end[0]) / 2;
            const midLng = (start[1] + end[1]) / 2;
            
            // Add a slight curve to the path (great circle arc)
            const curveFactor = 0.5;
            const curveLat = midLat + curveFactor;
            const curveLng = midLng + curveFactor;
            
            return {
                type: "LineString",
                coordinates: [
                    [start[1], start[0]],
                    [curveLng, curveLat],
                    [end[1], end[0]]
                ]
            };
        }
        
        function formatDistanceForInstructions(distance) {
            if (distance < 50) return "soon";
            if (distance < 100) return "in 100 m";
            if (distance < 200) return "in 200 m";
            if (distance < 500) return "in 500 m";
            if (distance < 1000) return "in " + Math.round(distance/100)*100 + " m";
            return "in " + (distance/1000).toFixed(1) + " km";
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function getStreetName(step) {
            return step.name || "";
        }
        
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }
        
        function calculateTrafficLevel(start, end) {
            const now = new Date();
            const hour = now.getHours();
            const distance = map.distance(start, end);
            
            // High traffic during rush hours
            if (distance < 50000 && ((hour >= 8 && hour <= 10) || (hour >= 16 && hour <= 19))) {
                return Math.random() > 0.5 ? 'high' : 'medium';
            }
            
            const rand = Math.random();
            if (rand > 0.7) return 'high';
            if (rand > 0.4) return 'medium';
            return 'low';
        }
        
        function addRouteCard(route) {
            const container = document.getElementById('route-options');
            const div = document.createElement('div');
            div.className = "route-card";
            div.dataset.routeId = route.id;
            
            const timeStr = formatTime(route.duration);
            const arrival = getArrival(route.duration);
            const distanceStr = (route.distance / 1000).toFixed(1) + ' km';
            
            let trafficIndicator = '';
            if (route.id === 'driving' && route.traffic) {
                const trafficClass = `traffic-${route.traffic}`;
                trafficIndicator = `<span class="traffic-indicator ${trafficClass}"></span>`;
            }

            if (route.id === 'flight') {
                const flightTime = route.flightTime || Math.round(route.duration / 60);
                const bookingLinksHTML = route.bookingLinks ? route.bookingLinks.map(link => 
                    `<a href="${link.url}" target="_blank" class="inline-flex items-center gap-1 text-[8px] text-sky-400 hover:text-sky-300 mr-3">
                        <iconify-icon icon="${link.icon}" class="text-[10px]"></iconify-icon>
                        ${link.name}
                    </a>`
                ).join('') : '';
                
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <iconify-icon icon="${route.icon}" class="text-2xl text-sky-500"></iconify-icon>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div class="text-[10px] font-bold text-white">Flight Route</div>
                                <div class="text-[9px] font-bold text-sky-400">${(route.distance/1000).toFixed(0)} km</div>
                            </div>
                            <div class="text-[9px] text-sky-300 mb-1">${route.description || "Flight available"}</div>
                            <div class="text-[9px] text-neutral-400 uppercase">${flightTime} min flight  ${formatTime(route.duration)} total</div>
                            <div class="mt-2 pt-2 border-t border-white/10 flex flex-wrap gap-2">
                                ${bookingLinksHTML}
                            </div>
                        </div>
                    </div>`;
            } else {
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <iconify-icon icon="${route.icon}" class="text-xl text-neutral-500"></iconify-icon>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div class="text-[10px] font-bold text-white">${trafficIndicator}${route.label}</div>
                                <div class="text-[9px] font-bold text-emerald-400">${distanceStr}</div>
                            </div>
                            <div class="text-[9px] text-neutral-400 uppercase">${timeStr}  Arr: ${arrival}</div>
                        </div>
                    </div>`;
            }
            
            div.onclick = () => {
                document.querySelectorAll('.route-card').forEach(c => c.classList.remove('active'));
                div.classList.add('active');
                currentRoute = route;
                renderPath(route);
            };
            container.appendChild(div);
        }
        
        function renderPath(route) {
            routeLayer.clearLayers();
            
            if (!route || !route.geometry) {
                console.error("No route geometry available");
                return;
            }
            
            // Set path color based on mode and traffic
            let color = '#10b981';
            let weight = 5;
            let dashArray = null;
            
            if (route.id === 'driving') {
                if (route.traffic === 'high') color = '#ef4444';
                else if (route.traffic === 'medium') color = '#f59e0b';
                else color = '#10b981';
            } else if (route.id === 'cycling') {
                color = '#3b82f6';
            } else if (route.id === 'walking') {
                color = '#8b5cf6';
                weight = 3;
            } else if (route.id === 'flight') {
                color = '#38bdf8'; // Sky blue
                weight = 3;
                dashArray = '10, 5'; // Dashed line for flight path
            }
            
            // Create GeoJSON feature
            const feature = {
                type: "Feature",
                geometry: route.geometry,
                properties: {}
            };
            
            L.geoJSON(feature, {
                style: { 
                    color: color, 
                    weight: weight, 
                    opacity: 0.8,
                    dashArray: dashArray
                }
            }).addTo(routeLayer);
            
            // Show start navigation button
            const startBtn = document.getElementById('start-nav-btn');
            startBtn.classList.remove('hidden');
            startBtn.onclick = () => startActiveNav(route);
        }
        
        // --- REAL NAVIGATION ---
        function startActiveNav(route) {
            isNavigating = true;
            currentNavRoute = route;
            currentStepIndex = 0;
            totalRouteDistance = route.distance;
            routeStartTime = new Date();
            
            // Add navigating class to body for HUD styling
            document.body.classList.add('navigating');
            
            // Hide start button immediately
            document.getElementById('start-nav-btn').classList.add('hidden');
            
            document.getElementById('standard-ui').style.display = 'none';
            document.getElementById('active-nav-hud').style.display = 'flex';
            
            // Transform sidebar to directions list
            transformSidebarToDirections(route);
            
            // Update navigation display
            updateNavigationDisplay();
            
            // Update bottom HUD with ETA and distance
            updateNavigationHUD();
            
            // Center map on route
            map.fitBounds(getRouteBounds(route.geometry), { padding: [50, 50] });
        }
        
        function transformSidebarToDirections(route) {
            const sidebar = document.getElementById('info-sidebar');
            sidebar.classList.add('active');
            
            const title = document.getElementById('side-title');
            title.innerText = "Turn-by-Turn Directions";
            
            const content = document.getElementById('sidebar-content');
            content.innerHTML = `
                <div class="space-y-1">
                    <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-4">STEP-BY-STEP DIRECTIONS</div>
                    <div id="directions-list" class="space-y-2"></div>
                </div>
            `;
            
            generateDirectionsListUI(route);
        }
        
        function generateDirectionsListUI(route) {
            const container = document.getElementById('directions-list');
            container.innerHTML = '';
            
            if (!route.steps || route.steps.length === 0) {
                container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No directions available</div>';
                return;
            }
            
            let cumulativeDistance = 0;
            
            route.steps.forEach((step, index) => {
                const instruction = step.maneuver.instruction;
                const distance = step.distance;
                const duration = step.duration || 0;
                const isActive = index === currentStepIndex;
                const isCompleted = index < currentStepIndex;
                
                cumulativeDistance += distance;
                
                const stepDiv = document.createElement('div');
                stepDiv.className = `direction-item flex items-start gap-3 ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
                stepDiv.dataset.stepIndex = index;
                
                stepDiv.innerHTML = `
                    <div class="step-number ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                        ${index + 1}
                    </div>
                    <div class="step-content">
                        <div class="step-instruction">${instruction}</div>
                        <div class="step-details">${distance < 1000 ? Math.round(distance) + ' m' : (distance/1000).toFixed(1) + ' km'}  ${formatTime(duration)}</div>
                    </div>
                `;
                
                container.appendChild(stepDiv);
            });
        }
        
        function checkNavigationProgress(position) {
            if (!isNavigating || !currentNavRoute || !currentNavRoute.steps) return;
            
            const currentPos = [position.coords.latitude, position.coords.longitude];
            if (!currentPos) return;
            
            const currentStep = currentNavRoute.steps[currentStepIndex];
            if (!currentStep) return;
            
            // Simulate progress based on time (manual step advancement removed)
            const timeSinceStart = (new Date() - routeStartTime) / 1000;
            const progressPercent = Math.min(95, (timeSinceStart / (currentStep.duration || 30)) * 100);
            
            document.getElementById('step-progress').style.width = `${progressPercent}%`;
            
            // Update navigation HUD
            updateNavigationHUD();
        }
        
        function advanceToNextStep() {
            if (!currentNavRoute || !currentNavRoute.steps) return;
            
            if (currentStepIndex < currentNavRoute.steps.length - 1) {
                currentStepIndex++;
                updateNavigationDisplay();
                updateDirectionsListUI();
                updateNavigationHUD();
            } else {
                completeNavigation();
            }
        }
        
        function updateNavigationDisplay() {
            if (!currentNavRoute) return;
            
            const steps = currentNavRoute.steps || [];
            
            if (steps.length > 0 && currentStepIndex < steps.length) {
                const currentStep = steps[currentStepIndex];
                const nextStep = steps[currentStepIndex + 1];
                
                // Update display
                document.getElementById('nav-instruction').innerHTML = currentStep.maneuver.instruction;
                document.getElementById('nav-dist-next').innerText = 
                    currentStep.distance < 1000 ? `In ${Math.round(currentStep.distance)}m` : `In ${(currentStep.distance/1000).toFixed(1)}km`;
                
                // Reset progress bar
                document.getElementById('step-progress').style.width = '0%';
                
                // Update next turn
                if (nextStep) {
                    document.getElementById('nav-next-turn').innerText = 
                        nextStep.maneuver.instruction.split('.').slice(0, 2).join('.') + '.';
                } else {
                    document.getElementById('nav-next-turn').innerText = "Final destination ahead";
                }
                
                // Update ETA
                let remainingTime = 0;
                for (let i = currentStepIndex; i < steps.length; i++) {
                    remainingTime += steps[i].duration || 0;
                }
                
                const eta = getArrival(remainingTime);
                document.getElementById('nav-eta').innerText = eta;
                
                // Update remaining distance
                let remainingDistance = 0;
                for (let i = currentStepIndex; i < steps.length; i++) {
                    remainingDistance += steps[i].distance || 0;
                }
                
                document.getElementById('nav-remaining').innerText = 
                    remainingDistance < 1000 ? `${Math.round(remainingDistance)}m` : `${(remainingDistance/1000).toFixed(1)} km`;
                
                // Update icon
                updateNavIcon(currentStep);
            }
        }
        
        function updateNavigationHUD() {
            if (!currentNavRoute || !isNavigating) return;
            
            const steps = currentNavRoute.steps || [];
            
            // Calculate total remaining time and distance
            let remainingTime = 0;
            let remainingDistance = 0;
            
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingTime += steps[i].duration || 0;
                remainingDistance += steps[i].distance || 0;
            }
            
            // Update bottom left HUD
            const eta = getArrival(remainingTime);
            document.getElementById('hud-eta').innerText = eta;
            document.getElementById('hud-remaining').innerText = 
                remainingDistance < 1000 ? `${Math.round(remainingDistance)}m` : `${(remainingDistance/1000).toFixed(1)} km`;
        }
        
        function updateDirectionsListUI() {
            const directionItems = document.querySelectorAll('.direction-item');
            const stepNumbers = document.querySelectorAll('.step-number');
            
            directionItems.forEach((item, index) => {
                item.classList.remove('active', 'completed');
                stepNumbers[index].classList.remove('active', 'completed');
                
                if (index === currentStepIndex) {
                    item.classList.add('active');
                    stepNumbers[index].classList.add('active');
                } else if (index < currentStepIndex) {
                    item.classList.add('completed');
                    stepNumbers[index].classList.add('completed');
                }
            });
        }
        
        function completeNavigation() {
            document.getElementById('nav-instruction').innerText = "You have arrived at your destination";
            document.getElementById('nav-dist-next').innerText = "Arrived";
            document.getElementById('nav-next-turn').innerText = "Destination reached";
            document.getElementById('step-progress').style.width = '100%';
            document.getElementById('nav-eta').innerText = "Now";
            document.getElementById('nav-remaining').innerText = "0 m";
            
            // Update HUD for arrival
            document.getElementById('hud-eta').innerText = "Arrived";
            document.getElementById('hud-remaining').innerText = "0 m";
            
            if (gpsWatchInterval) {
                clearInterval(gpsWatchInterval);
                gpsWatchInterval = null;
            }
        }
        
        function updateNavIcon(step) {
            const icon = document.getElementById('nav-step-icon');
            const maneuver = step.maneuver.type || '';
            
            if (maneuver.includes('arrive')) {
                icon.setAttribute('icon', 'lucide:flag');
            } else if (maneuver.includes('depart')) {
                icon.setAttribute('icon', 'lucide:map-pin');
            } else if (maneuver.includes('left')) {
                icon.setAttribute('icon', 'lucide:corner-up-left');
            } else if (maneuver.includes('right')) {
                icon.setAttribute('icon', 'lucide:corner-up-right');
            } else if (maneuver.includes('roundabout')) {
                icon.setAttribute('icon', 'lucide:repeat');
            } else if (maneuver.includes('fork')) {
                icon.setAttribute('icon', 'lucide:git-fork');
            } else {
                icon.setAttribute('icon', 'lucide:navigation');
            }
        }
        
        function getRouteBounds(geometry) {
            const coords = geometry.coordinates;
            const bounds = [];
            
            for (const coord of coords) {
                bounds.push([coord[1], coord[0]]);
            }
            
            return bounds;
        }
        
        // --- ENHANCED SEARCH WITH FILTERS ---
        async function performSearch(query) {
            if (!query || query.trim().length < 2) {
                showRecentSearches();
                return;
            }
            
            saveToRecentSearches(query);
            
            document.getElementById('search-spinner').classList.remove('hidden');
            document.getElementById('filters').classList.remove('hidden');
            
            try {
                // INCREASED SEARCH RESULTS FROM 15 TO 25
                const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=25`);
                const data = await response.json();
                
                searchResults = data.features || [];
                applyFilter(activeFilter);
            } catch (error) {
                console.error("Search failed:", error);
                searchResults = [];
                displaySearchResults([]);
            } finally {
                document.getElementById('search-spinner').classList.add('hidden');
            }
        }
        
        function saveToRecentSearches(query) {
            const recent = {
                query: query,
                timestamp: new Date().toISOString(),
                timeText: 'Just now'
            };
            
            recentSearches = recentSearches.filter(item => item.query !== query);
            recentSearches.unshift(recent);
            recentSearches = recentSearches.slice(0, 10);
            updateRecentTimes();
            localStorage.setItem('strikeRecentSearches', JSON.stringify(recentSearches));
        }
        
        function updateRecentTimes() {
            const now = new Date();
            recentSearches.forEach(item => {
                const itemTime = new Date(item.timestamp);
                const diffMinutes = Math.floor((now - itemTime) / (1000 * 60));
                
                if (diffMinutes < 1) item.timeText = 'Just now';
                else if (diffMinutes < 60) item.timeText = `${diffMinutes}m ago`;
                else if (diffMinutes < 1440) item.timeText = `${Math.floor(diffMinutes/60)}h ago`;
                else item.timeText = `${Math.floor(diffMinutes/1440)}d ago`;
            });
        }
        
        function showRecentSearches() {
            updateRecentTimes();
            const container = document.getElementById('results');
            const filters = document.getElementById('filters');
            
            if (recentSearches.length === 0) {
                container.classList.add('hidden');
                filters.classList.add('hidden');
                return;
            }
            
            filters.classList.remove('hidden');
            
            let html = `
                <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-2">Recent Searches</div>
            `;
            
            recentSearches.forEach((recent) => {
                html += `
                    <div class="recent-item" data-query="${recent.query}">
                        <div class="flex justify-between items-center">
                            <div class="text-[11px] font-semibold text-white">${recent.query}</div>
                            <div class="recent-time">${recent.timeText}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.classList.remove('hidden');
            
            document.querySelectorAll('.recent-item').forEach(item => {
                item.addEventListener('click', () => {
                    const query = item.dataset.query;
                    document.getElementById('search-input').value = query;
                    performSearch(query);
                });
            });
        }
        
        function applyFilter(filter) {
            activeFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            
            let filteredResults = searchResults;
            
            if (filter !== 'all' && filter !== 'nearby') {
                filteredResults = searchResults.filter(result => {
                    const props = result.properties;
                    const name = props.name?.toLowerCase() || '';
                    
                    switch(filter) {
                        case 'hotels':
                            return name.includes('hotel') || name.includes('inn') || name.includes('motel');
                        case 'parks':
                            return name.includes('park') || name.includes('garden');
                        case 'restaurants':
                            return name.includes('restaurant') || name.includes('cafe') || name.includes('diner');
                        case 'gas':
                            return name.includes('gas') || name.includes('fuel') || name.includes('station');
                        default:
                            return true;
                    }
                });
            }
            
            displaySearchResults(filteredResults);
        }

function generateRealNavigationInstruction(step, index, allSteps) {
    if (!step.maneuver) return "Continue on current road";
    
    const distance = step.distance;
    const streetName = step.name || ""; // Use ACTUAL street name from OSRM
    
    // Format distance like Google Maps
    let distanceText = formatDistanceForInstructions(distance);
    
    // Get CLEAN instruction from OSRM
    let instruction = step.maneuver.instruction || "";
    
    // Clean up OSRM's HTML tags and format
    instruction = instruction
        .replace(/<[^>]*>/g, '') // Remove all HTML tags
        .replace(/  +/g, ' ')    // Remove extra spaces
        .trim();
    
    // If OSRM gave us a decent instruction, use it
    if (instruction && instruction.length > 10) {
        return instruction;
    }
    
    // Otherwise generate from maneuver type with REAL data
    switch(step.maneuver.type) {
        case 'depart':
            return `Head ${streetName ? 'on ' + streetName : 'toward destination'}`;
        case 'turn':
            if (step.maneuver.modifier) {
                return `${capitalizeFirst(step.maneuver.modifier)} ${distanceText}${streetName ? ' onto ' + streetName : ''}`;
            }
            return `Turn ${distanceText}${streetName ? ' onto ' + streetName : ''}`;
        case 'continue':
            return streetName ? 
                `Continue on ${streetName} ${distanceText}` : 
                `Continue straight ${distanceText}`;
        case 'arrive':
            return index === 0 ? "You have arrived" : `Arrive at destination`;
        case 'roundabout':
            return `Enter roundabout${streetName ? ' at ' + streetName : ''}`;
        case 'merge':
            return `Merge ${distanceText}${streetName ? ' onto ' + streetName : ''}`;
        case 'fork':
            return `Keep ${step.maneuver.modifier || 'left'} ${distanceText}`;
        case 'off ramp':
            return `Take the exit ${distanceText}`;
        case 'notification':
            return streetName ? `Continue on ${streetName}` : "Continue";
        default:
            return streetName ? 
                `Follow ${streetName} ${distanceText}` : 
                `Continue ${distanceText}`;
    }
}
        
        function displaySearchResults(results) {
            const container = document.getElementById('results');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No results found</div>';
                container.classList.remove('hidden');
                return;
            }
            
            results.forEach((result) => {
                const div = document.createElement('div');
                div.className = 'search-result';
                
                const props = result.properties;
                const name = props.name || props.street || props.city || "Unnamed Location";
                const details = [props.housenumber, props.street, props.city, props.country]
                    .filter(Boolean)
                    .join(', ');
                
                div.innerHTML = `
                    <div class="text-[11px] font-bold text-white mb-1">${name}</div>
                    <div class="text-[9px] text-neutral-400">${details || 'Coordinates'}</div>
                `;
                
                div.onclick = () => {
                    const [lng, lat] = result.geometry.coordinates;
                    map.flyTo([lat, lng], 15, { animate: true, duration: 1 });
                    triggerAnalysis(lat, lng);
                    hideSearchResults();
                    document.getElementById('search-input').value = name;
                };
                
                container.appendChild(div);
            });
            
            container.classList.remove('hidden');
        }
        
        function hideSearchResults() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('filters').classList.add('hidden');
        }
        
        // --- UTILITIES ---
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m`;
            } else {
                return '<1m';
            }
        }
        
        function getArrival(seconds) {
            const now = new Date();
            const arrival = new Date(now.getTime() + seconds * 1000);
            return arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function closeSidebar() { 
            document.getElementById('info-sidebar').classList.remove('active'); 
            routeLayer.clearLayers(); 
            currentRoute = null;
            currentNavRoute = null;
            isNavigating = false;
            
            // Remove navigating class from body
            document.body.classList.remove('navigating');
            
            if (gpsWatchInterval) {
                clearInterval(gpsWatchInterval);
                gpsWatchInterval = null;
            }
            
            // Reset sidebar to default
            document.getElementById('sidebar-content').innerHTML = `
                <div class="space-y-6">
                    <div id="logistics-module">
                        <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block mb-4">Routes via Engine</span>
                        <div id="route-options" class="flex flex-col gap-2"></div>
                    </div>
                    <div class="space-y-2">
                        <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block">Address</span>
                        <p id="side-address" class="text-xs text-neutral-400 leading-relaxed">Select a location to view details</p>
                    </div>
                </div>
            `;
        }
        
        function recenterMap() {
            if (userPos) {
                map.flyTo(userPos, 14, { animate: true, duration: 1 });
                userMarker.setLatLng(userPos);
            }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Search input
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            
            searchInput.addEventListener('focus', () => {
                showRecentSearches();
            });
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                if (!e.target.value.trim()) {
                    showRecentSearches();
                    return;
                }
                searchTimeout = setTimeout(() => {
                    performSearch(e.target.value);
                }, 300);
            });
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    applyFilter(filter);
                    if (searchInput.value.trim()) {
                        performSearch(searchInput.value);
                    }
                });
            });
            
            // Locate button
            document.getElementById('locate-btn').addEventListener('click', recenterMap);
            
            // Satellite toggle
            document.getElementById('sat-toggle').addEventListener('click', () => {
                if (map.hasLayer(satLayer)) {
                    map.removeLayer(satLayer);
                } else {
                    satLayer.addTo(map);
                }
            });
            
            // Zoom buttons
            document.getElementById('zoom-in').addEventListener('click', () => {
                map.zoomIn();
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                map.zoomOut();
            });
            
            // Exit navigation button
            document.getElementById('exit-nav-btn').addEventListener('click', () => {
                isNavigating = false;
                document.getElementById('standard-ui').style.display = 'flex';
                document.getElementById('active-nav-hud').style.display = 'none';
                closeSidebar();
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                const searchContainer = document.querySelector('.strike-glass.p-2');
                const results = document.getElementById('results');
                
                if (searchContainer && results && !searchContainer.contains(e.target) && 
                    e.target !== searchInput) {
                    hideSearchResults();
                }
            });
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            if (gpsWatchInterval) {
                clearInterval(gpsWatchInterval);
            }
        });
    </script>
</body>
</html>
