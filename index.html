<!-- Compiled in Cursor | Last build update: 2/7/2026  5:38:56 PM | Version No. 5 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strike Maps</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="https://strike-bot.pages.dev/strike.jpg">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg: #000000;
            --glass-surface: rgba(10, 10, 10, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --font-main: 'Manrope', sans-serif;
            --ease-pro: cubic-bezier(0.2, 0, 0, 1);
        }

        body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: var(--font-main); height: 100vh; width: 100vw; overflow: hidden; }

        #map { height: 100%; width: 100%; z-index: 1; background: #050505; transition: opacity 1s ease; }
        .dark-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        
        .strike-glass { background: var(--glass-surface); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); box-shadow: 0 24px 60px rgba(0,0,0,0.9); border-radius: 16px; }
        .strike-input { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); color: white; transition: all 0.3s var(--ease-pro); }

        #info-sidebar { position: absolute; right: 24px; top: 24px; bottom: 24px; width: 380px; z-index: 2000; transform: translateX(calc(100% + 50px)); transition: transform 0.8s var(--ease-pro); display: flex; flex-direction: column; }
        #info-sidebar.active { transform: translateX(0); }

        .route-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; transition: all 0.2s; cursor: pointer; }
        .route-card.active { border-color: #ffffff; background: rgba(255, 255, 255, 0.05); }

        #active-nav-hud { display: none; }
        
        #loader { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loading-bar { width: 120px; height: 2px; background: #111; margin-top: 15px; position: relative; overflow: hidden; }
        .loading-fill { position: absolute; left: 0; top: 0; height: 100%; background: #fff; width: 0%; animation: load 2s forwards; }
        @keyframes load { to { width: 100%; } }

        .ui-animate { opacity: 0; transform: translateY(15px); transition: all 0.8s var(--ease-pro); }
        .ui-ready .ui-animate { opacity: 1; transform: translateY(0); }
        
        .gps-ring { 
            border: 2px solid #fff; 
            border-radius: 50%; 
            height: 18px; 
            width: 18px; 
            box-shadow: 0 0 15px rgba(255,255,255,0.6); 
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        #results { max-height: 250px; overflow-y: auto; }
        #results::-webkit-scrollbar { width: 4px; }
        #results::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
        #results::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        #sidebar-content::-webkit-scrollbar { width: 4px; }
        #sidebar-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
        #sidebar-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        #directions-list { max-height: 500px; overflow-y: auto; }
        #directions-list::-webkit-scrollbar { width: 4px; }
        #directions-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
        #directions-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .search-result { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; }
        .search-result:hover { background: rgba(255,255,255,0.05); }
        .search-result:last-child { border-bottom: none; }
        
        .filter-btn { padding: 6px 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.7); transition: all 0.2s; }
        .filter-btn.active { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); }
        
        .nav-instruction-text { font-size: 13px; line-height: 1.4; }
        
        #exit-nav-btn { background: rgba(239, 68, 68, 0.25); border: 1px solid rgba(239, 68, 68, 0.5); color: #ff6b6b; }
        #exit-nav-btn:hover { background: #ef4444; color: white; border-color: #ef4444; }
        
        .aviation-path { stroke-dasharray: 10, 10; }
        
        .type-badge { 
            font-size: 8px; 
            font-weight: 700; 
            padding: 2px 5px; 
            border-radius: 4px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .type-city { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .type-street { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; }
        .type-building { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .type-landmark { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .type-default { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.7); }
        
        .direction-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: all 0.3s; }
        .direction-item.active { background: rgba(59, 130, 246, 0.15); border-left: 3px solid #3b82f6; }
        .direction-item.completed { opacity: 0.5; }
        
        .traffic-indicator { 
            display: inline-block; 
            width: 6px; 
            height: 6px; 
            border-radius: 50%; 
            margin-right: 4px;
        }
        .traffic-high { background: #ef4444; }
        .traffic-medium { background: #f59e0b; }
        .traffic-low { background: #10b981; }
        
        .recent-item { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .recent-item:hover { background: rgba(255,255,255,0.05); }
        .recent-time { font-size: 9px; color: #6b7280; }
        
        .progress-bar { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); transition: width 0.3s; }

        .step-number { 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
            font-weight: 700;
        }
        .step-number.active { background: #3b82f6; color: white; }
        .step-number.completed { background: #10b981; color: white; }
        .step-content { flex: 1; }
        .step-instruction { font-size: 12px; font-weight: 600; color: white; }
        .step-details { font-size: 10px; color: #9ca3af; margin-top: 2px; }
        
        .nav-hud-pos { display: block; }
        .nav-hud-eta { display: none; }
        .nav-hud-acc { display: block; }
        .nav-hud-distance { display: none; }
        
        body.navigating .nav-hud-pos { display: none; }
        body.navigating .nav-hud-eta { display: block; }
        body.navigating .nav-hud-acc { display: none; }
        body.navigating .nav-hud-distance { display: block; }

#directions-list::-webkit-scrollbar { width: 4px; }
#directions-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 2px; }
#directions-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

.nav-hud-pos { display: block; }
.nav-hud-eta { display: none; }
.nav-hud-acc { display: block; }
.nav-hud-distance { display: none; }

body.navigating .nav-hud-pos { display: none; }
body.navigating .nav-hud-eta { display: block; }
body.navigating .nav-hud-acc { display: none; }
body.navigating .nav-hud-distance { display: block; }

.nav-hud-pos::before { content: "Pos:  "; }
.nav-hud-eta::before { content: "ETA:  "; } 
.nav-hud-acc::before { content: "Acc:  "; }
.nav-hud-distance::before { content: "Left:  "; } 

#custom-start-panel {
    position: absolute;
    top: 80px;
    left: 24px;
    z-index: 1001;
    width: 340px;
}

#custom-start-toggle {
    width: 100%;
    padding: 8px 12px;
    font-size: 11px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

#custom-start-toggle:hover {
    background: rgba(255,255,255,0.05);
    color: white;
}

#custom-start-expanded {
    display: none;
    margin-top: 8px;
    padding: 16px;
}

.start-mode-btn {
    width: 100%;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: white;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.start-mode-btn:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.2);
}

.start-mode-btn.active {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
    color: #93c5fd;
}

#custom-start-input-container {
    display: none;
    margin-top: 12px;
}

#custom-start-search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
}

.current-start-display {
    font-size: 10px;
    color: #9ca3af;
    margin-top: 4px;
    padding: 8px;
    background: rgba(255,255,255,0.02);
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.05);
}

#custom-start-panel {
    position: absolute;
    top: 180px;
    left: 24px;
    z-index: 1001;
    width: 340px;
}

#custom-start-toggle {
    width: 100%;
    padding: 8px 12px;
    font-size: 11px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

#custom-start-toggle:hover {
    background: rgba(255,255,255,0.05);
    color: white;
}

#custom-start-expanded {
    display: none;
    margin-top: 8px;
    padding: 16px;
}

.start-mode-btn {
    width: 100%;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: white;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.start-mode-btn:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.2);
}

.start-mode-btn.active {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
    color: #93c5fd;
}

#custom-start-input-container {
    display: none;
    margin-top: 12px;
}

#custom-start-search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
}

.current-start-display {
    font-size: 10px;
    color: #9ca3af;
    margin-top: 4px;
    padding: 8px;
    background: rgba(255,255,255,0.02);
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.05);
}

#custom-start-panel {
    position: absolute;
    top: 180px;
    left: 24px;
    z-index: 999;
    width: 340px;
    pointer-events: auto;
}

#custom-start-toggle {
    width: 100%;
    padding: 8px 12px;
    font-size: 11px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

#custom-start-toggle:hover {
    background: rgba(255,255,255,0.05);
    color: white;
}

#custom-start-expanded {
    display: none;
    margin-top: 8px;
    padding: 16px;
    background: var(--glass-surface);
    backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.9);
    overflow-y: auto;
}

#custom-start-expanded.dynamic-height {
    position: fixed;
    max-height: none;
}

#custom-start-expanded::-webkit-scrollbar {
    width: 6px !important;
}

#custom-start-expanded::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05) !important;
    border-radius: 3px !important;
    margin: 4px 0 !important;
}

#custom-start-expanded::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.5) !important;
    border-radius: 3px !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
}

#custom-start-expanded::-webkit-scrollbar-thumb:hover {
    background: rgba(59, 130, 246, 0.7) !important;
}

#custom-start-search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
}

#custom-start-search-results::-webkit-scrollbar {
    width: 4px !important;
}

#custom-start-search-results::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.03) !important;
}

#custom-start-search-results::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.5) !important;
}

#custom-start-panel {
    position: absolute;
    top: 180px;
    left: 24px;
    z-index: 1001;
    width: 340px;
    pointer-events: auto;
}

#custom-start-expanded {
    display: none;
    position: fixed;
    margin-top: 8px;
    padding: 16px;
    background: var(--glass-surface);
    backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.9);
    overflow-y: auto;
    max-height: calc(100vh - 200px);
    width: 340px;
    z-index: 1002;
}

    .leaflet-popup-content {
        font-family: 'Manrope', sans-serif !important;
        margin: 12px !important;
        min-width: fit-content !important;
    }
    
    .leaflet-popup-content-wrapper {
        background: var(--glass-surface) !important;
        backdrop-filter: blur(30px) !important;
        border: 1px solid var(--glass-border) !important;
        border-radius: 12px !important;
        box-shadow: 0 8px 32px rgba(0,0,0,0.9) !important;
    }
    
    .leaflet-popup-tip {
        background: var(--glass-surface) !important;
        border: 1px solid var(--glass-border) !important;
        box-shadow: 0 4px 16px rgba(0,0,0,0.9) !important;
    }
    
    .leaflet-popup-close-button {
        color: #9ca3af !important;
        font-size: 18px !important;
        padding: 4px 8px !important;
        transition: all 0.2s !important;
    }

.leaflet-container a.leaflet-popup-close-button {
    right: 5px !important;
}
    
    .leaflet-popup-close-button:hover {
        color: white !important;
        background: transparent !important;
    }

.leaflet-popup {
    min-width: 180px;
}
    </style>



<style>
    .starting-panel-container {
        position: relative;
        width: 100%;
    }

    #custom-start-panel {
        position: absolute;
        top: 160px;
        left: 24px;
        z-index: 999;
        width: 340px;
        pointer-events: auto;
        margin-top: 8px;
    }

    body.navigating #custom-start-panel {
        display: none !important;
    }

    .destination-marker {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #ef4444;
        border: 3px solid white;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
        position: relative;
    }
    
    .destination-marker::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
    }

    #custom-start-expanded {
        display: none;
        position: absolute;
        margin-top: 8px;
        padding: 16px;
        background: var(--glass-surface);
        backdrop-filter: blur(30px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        box-shadow: 0 24px 60px rgba(0,0,0,0.9);
        overflow-y: auto;
        width: 100%;
        box-sizing: border-box;
        z-index: 1002;
max-height: 270px !important;
    }

    #custom-start-expanded {
        max-height: 400px;
    }

    #custom-start-expanded::-webkit-scrollbar {
        width: 6px !important;
    }

    #custom-start-expanded::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05) !important;
        border-radius: 3px !important;
        margin: 4px 0 !important;
    }

    #custom-start-expanded::-webkit-scrollbar-thumb {
        background: rgba(59, 130, 246, 0.5) !important;
        border-radius: 3px !important;
        border: 1px solid rgba(255,255,255,0.1) !important;
    }

    #custom-start-expanded::-webkit-scrollbar-thumb:hover {
        background: rgba(59, 130, 246, 0.7) !important;
    }

    #custom-start-search-results {
        max-height: 150px;
        overflow-y: auto;
        margin-top: 8px;
        display: none;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        background: rgba(0,0,0,0.3);
    }

    #custom-start-search-results::-webkit-scrollbar {
        width: 4px !important;
    }

    #custom-start-search-results::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.03) !important;
    }

    #custom-start-search-results::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.5) !important;
    }

@media (max-width: 775px) {
#info-sidebar {
width: 92% !important;
}
        body.navigating #info-sidebar {
            display: none !important;
        }
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.2); opacity: 0.1; }
    100% { transform: scale(1); opacity: 0.3; }
}

.real-time-marker {
    z-index: 3000 !important;
}

.click-highlight {
    animation: highlightPulse 1.5s ease-out;
}

@keyframes highlightPulse {
    0% {
        transform: scale(0.5);
        opacity: 0.8;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.4;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

.map-click-mode-active {
    cursor: crosshair !important;
}

.map-click-mode-active .leaflet-interactive {
    cursor: crosshair !important;
}

.nav-arrow {
    opacity: 0.7;
    transition: opacity 0.3s;
}

.nav-arrow:hover {
    opacity: 1;
}

.nav-start-marker {
    animation: pulseStart 2s infinite;
}

.nav-end-marker {
    animation: pulseEnd 2s infinite;
}

@keyframes pulseStart {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes pulseEnd {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

.leaflet-fade-anim .leaflet-tile,
.leaflet-zoom-anim .leaflet-zoom-animated {
    will-change: transform, opacity;
}

.start-mode-btn.map-active {
    background: rgba(59, 130, 246, 0.3) !important;
    border-color: #3b82f6 !important;
    color: #93c5fd !important;
    animation: pulseMapMode 2s infinite;
}

@keyframes pulseMapMode {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
    70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
    100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

.map-click-mode-active {
    cursor: crosshair !important;
}

.map-click-mode-active .leaflet-interactive {
    cursor: crosshair !important;
}

.click-highlight {
    pointer-events: none;
    z-index: 1000;
}

.nav-user-marker {
    animation: navUserPulse 2s infinite;
}

@keyframes navUserPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.nav-arrow-icon {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    opacity: 0.9;
    transition: opacity 0.3s;
}

.nav-arrow-icon:hover {
    opacity: 1;
    transform: scale(1.1);
}
</style>
</head>
<body class="bg-black">

    <div id="loader">
        <svg viewBox="0 0 76 65" fill="white" class="w-12 h-12 mb-4 animate-pulse"><path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path></svg>
        <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-[0.5em]">Requesting Locaton...</div>
        <div class="loading-bar"><div class="loading-fill"></div></div>
    </div>

    <div id="map"></div>

    <div id="standard-ui" class="absolute top-6 left-6 z-[1000] w-[340px] flex flex-col gap-3">
        <div class="strike-glass p-2 ui-animate">
            <div class="relative group">
                <iconify-icon icon="lucide:search" class="absolute left-3 top-2.5 text-neutral-500"></iconify-icon>
                <input type="text" id="search-input" placeholder="Search destination..." class="w-full h-10 pl-10 pr-4 rounded-xl text-xs font-bold strike-input">
                <div id="search-spinner" class="hidden absolute right-3 top-3"><iconify-icon icon="lucide:loader-2" class="animate-spin text-white"></iconify-icon></div>
            </div>
            <div id="filters" class="hidden mt-2 flex gap-1 flex-wrap">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="nearby">Near Me</button>
                <button class="filter-btn" data-filter="hotels">Hotels</button>
                <button class="filter-btn" data-filter="parks">Parks</button>
                <button class="filter-btn" data-filter="restaurants">Restaurants</button>
                <button class="filter-btn" data-filter="gas">Gas Stations</button>
            </div>
            <div id="results" class="hidden mt-2 flex flex-col"></div>
        </div>
        <div class="strike-glass px-4 py-3 flex items-center justify-between ui-animate">
            <div class="flex flex-col">
                <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-tight">Your Location</span>
                <span id="status-text" class="text-[11px] font-bold text-white">Standby</span>
            </div>
            <button id="locate-btn" class="h-8 px-4 bg-white text-black rounded-lg text-[11px] font-extrabold flex items-center gap-2 hover:bg-neutral-100 transition-all">
                <iconify-icon icon="lucide:crosshair"></iconify-icon> Re-Center
            </button>
        </div>

    </div>

<div id="custom-start-panel" class="strike-glass ui-animate">
    <div class="starting-panel-container">
        <button id="custom-start-toggle" class="w-full">
            <div class="flex justify-between items-center w-full">
                <span>Starting Point: <span id="current-start-mode">Current Location</span></span>
                <iconify-icon icon="lucide:chevron-down"></iconify-icon>
            </div>
        </button>
        <div id="custom-start-expanded">
            <div class="space-y-2">
                <button class="start-mode-btn active" data-mode="current">
                    <iconify-icon icon="lucide:crosshair"></iconify-icon>
                    Use Current Location
                </button>
                <button class="start-mode-btn" data-mode="map">
                    <iconify-icon icon="lucide:map-pin"></iconify-icon>
                    Click on Map
                </button>
                <button class="start-mode-btn" data-mode="search">
                    <iconify-icon icon="lucide:search"></iconify-icon>
                    Search for Location
                </button>
            </div>
            
            <div id="custom-start-input-container">
                <div class="relative mt-3">
                    <iconify-icon icon="lucide:search" class="absolute left-3 top-2.5 text-neutral-500"></iconify-icon>
                    <input type="text" id="custom-start-input" placeholder="Enter starting address or city..." class="w-full h-10 pl-10 pr-4 rounded-xl text-xs font-bold strike-input">
                </div>
                <div id="custom-start-search-results" class="flex flex-col"></div>
            </div>
            
            <div id="current-start-display" class="current-start-display mt-3">
                <div class="font-semibold text-white">Current start point:</div>
                <div class="text-[9px] mt-1" id="start-point-coords">Your current location</div>
            </div>
        </div>
    </div>
</div>

    <div id="active-nav-hud" class="absolute top-6 left-6 z-[2000] w-[340px] flex flex-col gap-3">
        <div class="strike-glass p-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center">
                    <iconify-icon id="nav-step-icon" icon="lucide:navigation" class="text-2xl text-emerald-400"></iconify-icon>
                </div>
                <div class="flex-1">
                    <span id="nav-dist-next" class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1">In 200m</span>
                    <h3 id="nav-instruction" class="nav-instruction-text font-bold text-white leading-tight">Continue straight for 1.2 kilometers on Main Street</h3>
                    <div class="progress-bar">
                        <div id="step-progress" class="progress-fill" style="width: 30%"></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white/5">
                <div class="flex justify-between text-[11px]">
                    <div>
                        <div class="text-neutral-500 mb-1">Next Turn</div>
                        <div id="nav-next-turn" class="text-white font-semibold">Right onto Broadway</div>
                    </div>
                    <div>
                        <div class="text-neutral-500 mb-1">ETA</div>
                        <div id="nav-eta" class="text-emerald-400 font-bold">14:30</div>
                    </div>
                    <div>
                        <div class="text-neutral-500 mb-1">Remaining</div>
                        <div id="nav-remaining" class="text-white font-bold">4.2 km</div>
                    </div>
                </div>
            </div>
        </div>
        <button id="exit-nav-btn" class="w-full h-10 bg-red-500/25 border border-red-500/50 text-white rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-red-500 transition-all duration-200">
            <iconify-icon icon="lucide:x-circle"></iconify-icon> Exit Navigation
        </button>
    </div>

    <div id="info-sidebar" class="strike-glass">
        <div class="p-6 border-b border-white/5 flex items-center justify-between">
            <h2 id="side-title" class="text-xl font-bold text-white truncate pr-4">Location</h2>
            <button onclick="closeSidebar()" class="text-neutral-500 hover:text-white"><iconify-icon icon="lucide:x" class="text-xl"></iconify-icon></button>
        </div>
        <div id="sidebar-content" class="p-6 flex-1 overflow-y-auto">
        </div>
        <div class="p-6 bg-white/[0.02] border-t border-white/5 flex gap-2">
            <button id="start-nav-btn" class="hidden flex-1 h-12 bg-white text-black rounded-xl text-xs font-black flex items-center justify-center gap-3">
                <iconify-icon icon="lucide:navigation-2" class="text-lg"></iconify-icon> START NAVIGATION
            </button>
        </div>
    </div>

    <div class="absolute bottom-6 right-6 z-[1000] flex flex-col gap-3 ui-animate">
        <div class="strike-glass p-1 flex flex-col gap-1">
            <button id="sat-toggle" class="w-10 h-10 flex items-center justify-center rounded-xl text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:layers" class="text-lg"></iconify-icon></button>
        </div>
        <div class="strike-glass p-1 flex flex-col gap-1">
            <button id="zoom-in" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:plus"></iconify-icon></button>
            <button id="zoom-out" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-neutral-400 hover:text-white transition-all"><iconify-icon icon="lucide:minus"></iconify-icon></button>
        </div>
    </div>

    <div class="absolute bottom-6 left-6 z-[1000] pointer-events-none flex flex-col gap-4 ui-animate">
<div class="strike-glass px-4 py-3 flex gap-6 items-center pointer-events-auto"style="max-width: fit-content;">
    <div class="flex flex-col">
        <span id="hud-coords" class="nav-hud-pos text-[10px] font-mono text-white mt-1">0.0, 0.0</span>
        <span id="hud-eta" class="nav-hud-eta text-[10px] font-mono text-emerald-400 mt-1">--:--</span>
    </div>
    <div class="flex flex-col">
        <span id="hud-precision" class="nav-hud-acc text-[10px] font-mono text-white mt-1">-- m</span>
        <span id="hud-remaining" class="nav-hud-distance text-[10px] font-mono text-white mt-1">-- km</span>
    </div>
</div>
<div class="opacity-40 text-[10px] font-black uppercase tracking-widest text-white flex items-center gap-2">
    <svg width="12" height="12" viewBox="0 0 76 65" fill="white">
        <path d="M37.5274 0L75.0548 65H0L37.5274 0Z"></path>
    </svg>

    <span>Strike Maps [V5]</span>

    <span class="opacity-60">•</span>

    <a
        href="https://www.openstreetmap.org/copyright"
        target="_blank"
        rel="noopener noreferrer"
        class="hover:opacity-80 underline"
        style="z-index: 999999;"
    >
        © OpenStreetMap contributors
    </a>
</div>

    </div>

<script>
    let map = null;
    let darkBase = null;
    let satLayer = null;
    const userIcon = L.divIcon({ 
        className: 'user-location-marker', 
        html: '<div class="gps-ring"></div>', 
        iconSize: [24, 24], 
        iconAnchor: [12, 12] 
    });
    let userMarker = L.marker([0,0], {icon: userIcon});
    let routeLayer = L.layerGroup();
    let userPos = null;
    let selectedTarget = null;
    let currentRoute = null;
    let currentNavRoute = null;
    let currentStepIndex = 0;
    let searchResults = [];
    let activeFilter = 'all';
    let isNavigating = false;
    let recentSearches = [];

    try {
        const storedSearches = localStorage.getItem('strikeRecentSearches');
        if (storedSearches) {
            recentSearches = JSON.parse(storedSearches);
            if (!Array.isArray(recentSearches)) {
                recentSearches = [];
                localStorage.removeItem('strikeRecentSearches');
            }
        }
    } catch (error) {
        recentSearches = [];
        localStorage.removeItem('strikeRecentSearches');
    }
    
    let watchId = null;
    let totalRouteDistance = 0;
    let remainingDistance = 0;
    let gpsWatchInterval = null;
    let isLocationRequested = false;
    let routeStartTime = null;
    
    let customStartMode = 'current';
    let customStartPos = null;
    let customStartMarker = null;
    let destinationMarker = null;
    let previousRouteCoordinates = null;

    let allRouteLayers = [];
    let allNavigationLayers = [];
    let allMarkers = [];
    
    function createStraightPath(start, end) {
        return {
            type: "LineString",
            coordinates: [
                [start[1], start[0]],
                [end[1], end[0]]
            ]
        };
    }

    async function getRealWeatherAtLocation(lat, lng) {
        try {
            const response = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,wind_speed_10m,precipitation,weather_code&timezone=auto`
            );
            const data = await response.json();
            
            if (data.current) {
                const weatherCode = data.current.weather_code;
                let conditions = "Clear";
                if (weatherCode > 0 && weatherCode < 50) conditions = "Cloudy";
                if (weatherCode >= 50 && weatherCode < 70) conditions = "Rainy";
                if (weatherCode >= 70) conditions = "Snowy";
                
                return {
                    temperature: data.current.temperature_2m,
                    windSpeed: data.current.wind_speed_10m,
                    precipitation: data.current.precipitation,
                    conditions: conditions,
                    weatherCode: weatherCode
                };
            }
        } catch (error) {}
        return null;
    }

async function getRealTimeTraffic(start, end) {
    try {
        const response = await fetch(
            `https://api.openrouteservice.org/v2/directions/driving-car?api_key=YOUR_API_KEY&start=${start[1]},${start[0]}&end=${end[1]},${end[0]}`
        );
        const data = await response.json();
        
        if (data.features && data.features[0].properties.segments) {
            const segments = data.features[0].properties.segments;
            let totalCongestion = 0;
            
            segments.forEach(segment => {
                if (segment.steps) {
                    segment.steps.forEach(step => {
                        if (step.way_points && step.way_points.length > 0) {
                            totalCongestion += step.duration || 0;
                        }
                    });
                }
            });
            
            const avgSpeed = (route.distance / route.duration) * 3.6;
            if (avgSpeed < 20) return 'high';
            if (avgSpeed < 40) return 'medium';
            return 'low';
        }
    } catch (error) {
        console.log("Real-time traffic unavailable, using simulated");
    }
    
    const now = new Date();
    const hour = now.getHours();
    const isRushHour = (hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 18);
    const isWeekend = now.getDay() === 0 || now.getDay() === 6;
    
    if (isRushHour && !isWeekend) {
        return Math.random() > 0.3 ? 'high' : 'medium';
    }
    
    const rand = Math.random();
    if (rand > 0.8) return 'high';
    if (rand > 0.5) return 'medium';
    return 'low';
}

    async function getRealTrafficEstimate(start, end) {
    try {
        const response = await fetch(
            `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=false&alternatives=false&steps=true`
        );
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
            const route = data.routes[0];
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            
            // More realistic traffic factors based on Google Maps patterns
            let trafficFactor = 1.0;
            
            // Rush hour adjustments
            const isWeekday = day >= 1 && day <= 5;
            const isWeekend = day === 0 || day === 6;
            
            if (isWeekday) {
                // Weekday rush hours
                if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                    trafficFactor = 1.4; // 40% longer during rush hour
                } else if ((hour >= 12 && hour <= 14)) {
                    trafficFactor = 1.2; // 20% longer during lunch
                }
            } else if (isWeekend) {
                // Weekend traffic (usually lighter but can be heavy in tourist areas)
                if ((hour >= 10 && hour <= 16)) {
                    trafficFactor = 1.2; // 20% longer on weekend afternoons
                }
            }
            
            // Weather impact
            const weather = await getRealWeatherAtLocation(start[0], start[1]);
            if (weather?.conditions === "Rainy") trafficFactor *= 1.3;
            if (weather?.conditions === "Snowy") trafficFactor *= 1.6;
            if (weather?.conditions === "Foggy") trafficFactor *= 1.2;
            
            // Road type adjustments
            const steps = route.legs?.[0]?.steps || [];
            let highwayPercent = 0;
            let cityStreetPercent = 0;
            
            steps.forEach(step => {
                if (step.name?.toLowerCase().includes('highway') || 
                    step.name?.toLowerCase().includes('freeway') ||
                    step.name?.toLowerCase().includes('interstate')) {
                    highwayPercent += step.distance / route.distance;
                } else {
                    cityStreetPercent += step.distance / route.distance;
                }
            });
            
            // City streets are slower
            if (cityStreetPercent > 0.7) {
                trafficFactor *= 1.2;
            }
            
            // Intersection count
            const intersections = steps.filter(step => 
                step.maneuver?.type.includes('turn') || 
                step.maneuver?.type.includes('roundabout') ||
                step.maneuver?.type === 'new name'
            ).length;
            
            if (intersections > route.distance / 1000) { // More than 1 intersection per km
                trafficFactor *= 1.1;
            }
            
            return {
                duration: route.duration * trafficFactor,
                trafficLevel: trafficFactor > 1.35 ? 'high' : trafficFactor > 1.15 ? 'medium' : 'low',
                intersections: intersections,
                weatherImpact: weather?.conditions || "Clear",
                highwayPercent: highwayPercent,
                estimatedSpeed: (route.distance / (route.duration * trafficFactor)) * 3.6
            };
        }
    } catch (error) {
        console.error("Traffic estimate failed:", error);
    }
    
    // Fallback calculation
    const distance = map.distance(start, end);
    const baseTime = (distance / 50000) * 3600; // Base speed 50 km/h (~31 mph)
    
    const now = new Date();
    const hour = now.getHours();
    let trafficFactor = 1.0;
    
    if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
        trafficFactor = 1.4;
    } else if (hour >= 12 && hour <= 14) {
        trafficFactor = 1.2;
    }
    
    return {
        duration: baseTime * trafficFactor,
        trafficLevel: trafficFactor > 1.35 ? 'high' : trafficFactor > 1.15 ? 'medium' : 'low',
        intersections: 0,
        weatherImpact: "Unknown",
        estimatedSpeed: 50 / trafficFactor
    };
}

    async function getAllAirports() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat');
            const data = await response.text();
            
            const airports = [];
            const lines = data.split('\n');
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                const fields = line.split(',');
                if (fields.length >= 14) {
                    const name = fields[1].replace(/"/g, '');
                    const city = fields[2].replace(/"/g, '');
                    const country = fields[3].replace(/"/g, '');
                    const iata = fields[4].replace(/"/g, '');
                    const icao = fields[5].replace(/"/g, '');
                    const lat = parseFloat(fields[6]);
                    const lng = parseFloat(fields[7]);
                    
                    if (iata && iata.length === 3 && 
                        !isNaN(lat) && !isNaN(lng) &&
                        !name.toLowerCase().includes('seaplane') &&
                        !name.toLowerCase().includes('heliport') &&
                        !name.toLowerCase().includes('airfield') &&
                        !name.toLowerCase().includes('municipal') &&
                        !name.toLowerCase().includes('regional') &&
                        !name.toLowerCase().includes('executive') &&
                        (name.toLowerCase().includes('international') || 
                         icao.length === 4)) {
                        
                        airports.push({
                            code: iata,
                            name: name,
                            city: city,
                            country: country,
                            coordinates: [lat, lng],
                            type: name.includes('International') ? 'large' : 'medium'
                        });
                    }
                }
            }
            
            return airports;
            
        } catch (error) {
            return getCommercialAirports();
        }
    }

    async function getFerryRoutes(start, end) {
        try {
            const [startLng, startLat] = [start[1], start[0]];
            const [endLng, endLat] = [end[1], end[0]];
            
            const bbox = [
                Math.min(startLat, endLat) - 0.5,
                Math.min(startLng, endLng) - 0.5,
                Math.max(startLat, endLat) + 0.5,
                Math.max(startLng, endLng) + 0.5
            ].join(',');
            
            const query = `
                [out:json][timeout:10];
                (
                    way["route"="ferry"](${bbox});
                    relation["route"="ferry"](${bbox});
                    node["amenity"="ferry_terminal"](${bbox});
                );
                out body;
            `;
            
            const response = await fetch(
                `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`
            );
            const data = await response.json();
            
            if (data.elements && data.elements.length > 0) {
                const ferryTerminals = data.elements.filter(el => 
                    el.type === 'node' && el.tags?.amenity === 'ferry_terminal'
                );
                
                const startTerminal = findNearestTerminal(start, ferryTerminals);
                const endTerminal = findNearestTerminal(end, ferryTerminals);
                
                if (startTerminal && endTerminal) {
                    const distance = map.distance(start, end);
                    const ferryTime = (distance / 11100) * 3600;
                    
                    return {
                        hasFerry: true,
                        duration: ferryTime + 1800,
                        distance: distance,
                        terminals: {
                            start: startTerminal.name,
                            end: endTerminal.name
                        },
                        details: `Ferry from ${startTerminal.name} to ${endTerminal.name}`
                    };
                }
            }
        } catch (error) {}
        
        return { hasFerry: false };
    }

async function getLocationImages(lat, lng, name, addressDetails = {}) {
    const isGenericStreet = isGenericLocationName(name, addressDetails);
    
    if (isGenericStreet && !isFamousStreet(name, addressDetails.city)) {
        return {
            image: null,
            description: '',
            source: null,
            relevance: 'low'
        };
    }
    
    try {
        const wikiResponse = await fetch(
            `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages|extracts|coordinates&titles=${encodeURIComponent(name)}&exintro=1&explaintext=1&pithumbsize=400&colimit=1&origin=*`
        );
        const wikiData = await wikiResponse.json();
        
        const pages = wikiData.query?.pages;
        if (pages) {
            const page = Object.values(pages)[0];
            
            if (isNotableWikipediaPage(page)) {
                if (page.thumbnail?.source) {
                    return {
                        image: page.thumbnail.source,
                        description: page.extract || '',
                        wikipediaUrl: `https://en.wikipedia.org/wiki/${encodeURIComponent(page.title)}`,
                        source: 'Wikipedia',
                        relevance: 'high'
                    };
                }
            }
        }
    } catch (error) {
        console.error("Wikipedia error:", error);
    }
    
    try {
        const searchTerms = generateLocationSearchTerms(name, addressDetails);
        
        for (const term of searchTerms) {
            const commonsResponse = await fetch(
                `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(term)}&gsrnamespace=6&gsrlimit=3&prop=imageinfo&iiprop=url|extmetadata&iiurlwidth=400&format=json&origin=*`
            );
            const commonsData = await commonsResponse.json();
            
            const pages = commonsData.query?.pages;
            if (pages) {
                const relevantImage = findMostRelevantImage(pages, name, addressDetails);
                if (relevantImage) {
                    return {
                        image: relevantImage.url,
                        description: relevantImage.description || `Image related to ${name}`,
                        source: 'Wikimedia Commons',
                        relevance: 'medium'
                    };
                }
            }
        }
    } catch (error) {
        console.error("Wikimedia Commons error:", error);
    }
    
    try {
        const notableFeature = await getNotableFeatureFromOSM(lat, lng);
        if (notableFeature && notableFeature.wikipedia_image) {
            return {
                image: notableFeature.wikipedia_image,
                description: notableFeature.description || '',
                source: 'OpenStreetMap + Wikipedia',
                relevance: 'high'
            };
        }
    } catch (error) {
        console.error("OSM feature error:", error);
    }
    
    return {
        image: null,
        description: '',
        source: null,
        relevance: 'none'
    };
}

function isGenericLocationName(name, addressDetails) {
    const genericTerms = [
        'street', 'avenue', 'boulevard', 'blvd', 
        'drive','court', 'ct', 'place', 'pl', 'way',
        'highway', 'hwy', 'freeway', 'fwy', 'expressway', 'expy', 'parkway', 'pkwy',
        'route', 'rt', 'circle', 'cir', 'terrace', 'ter', 'trail', 'trl'
    ];
    
    const nameLower = name.toLowerCase();
    
    for (const term of genericTerms) {
        if (nameLower.includes(` ${term}`) || nameLower.endsWith(` ${term}`)) {
            return true;
        }
    }
    
    if (/^\d+(st|nd|rd|th)\s/.test(nameLower) || /^\d+$/.test(name)) {
        return true;
    }
    
    if (/^(I-|US-|SR-|CR-|Route\s\d+)/i.test(name)) {
        return true;
    }
    
    return false;
}

function isFamousStreet(name, city) {
    const famousStreets = [
        'wall street', 'broadway', 'fifth avenue', 'rodeo drive', 'sunset boulevard',
        'lombard street', 'bourbon street', 'abbey road', 'champs-élysées',
        'las vegas strip', 'times square', 'piccadilly circus', 'trafalgar square'
    ];
    
    const nameLower = name.toLowerCase();
    if (famousStreets.includes(nameLower)) {
        return true;
    }
    
    const cityFamousStreets = {
        'new york': ['wall street', 'broadway', 'fifth avenue', 'madison avenue', 'park avenue'],
        'los angeles': ['rodeo drive', 'sunset boulevard', 'hollywood boulevard'],
        'san francisco': ['lombard street', 'market street'],
        'london': ['abbey road', 'oxford street', 'regent street', 'baker street'],
        'paris': ['champs-élysées', 'rue de rivoli'],
        'chicago': ['magnificent mile', 'state street'],
        'miami': ['ocean drive', 'lincoln road']
    };
    
    if (city && cityFamousStreets[city.toLowerCase()]) {
        return cityFamousStreets[city.toLowerCase()].includes(nameLower);
    }
    
    return false;
}

function isNotableWikipediaPage(page) {
    if (!page.extract || page.extract.length < 50) {
        return false;
    }
    
    if (page.redirect) {
        return false;
    }
    
    if (page.title && (page.title.includes('(disambiguation)') || 
                       page.extract.includes('may refer to'))) {
        return false;
    }
    
    if (page.length && page.length < 500) {
        return false;
    }
    
    return true;
}

function generateLocationSearchTerms(name, addressDetails) {
    const terms = [];
    
    const city = addressDetails.city || '';
    const state = addressDetails.state || '';
    const country = addressDetails.country || '';
    const county = addressDetails.county || '';
    const type = addressDetails.type || '';
    const osm_key = addressDetails.osm_key || '';
    
    const fullLocation = [city, county, state, country].filter(Boolean).join(' ');
    
    if (fullLocation) {
        terms.push(`${name} ${fullLocation}`);
        terms.push(`${fullLocation} ${name}`);
    }
    
    if (city && state) {
        terms.push(`${name} ${city} ${state}`);
        terms.push(`${city} ${state} ${name}`);
    }
    
    if (city && country) {
        terms.push(`${name} ${city} ${country}`);
        terms.push(`${city} ${country} ${name}`);
    }
    
    if (state && country) {
        terms.push(`${name} ${state} ${country}`);
    }
    
    if (county && state) {
        terms.push(`${name} ${county} ${state}`);
        terms.push(`${county} ${state} ${name}`);
    }
    
    if (type === 'city' || type === 'town') {
        terms.push(`${name} ${state} ${country} city`);
        terms.push(`${name} tourism ${state}`);
        terms.push(`${name} downtown ${city}`);
    } else if (type === 'airport' || name.includes('Airport') || name.includes('International')) {
        terms.push(`${name} airport ${city} ${state}`);
        terms.push(`${city} ${state} airport terminal`);
        terms.push(`${name} aerial view ${city}`);
    } else if (type === 'street' || type === 'road' || osm_key === 'highway') {
        terms.push(`${name} ${city} ${state} road`);
        terms.push(`${city} ${state} ${name} street`);
        terms.push(`${name} scenic drive ${state}`);
        terms.push(`${name} ${county} ${state} highway`);
    } else if (type === 'building') {
        terms.push(`${name} ${city} building architecture`);
        terms.push(`${city} ${state} ${name} landmark`);
    } else {
        terms.push(`${name} ${city} ${state} landmark`);
        terms.push(`${name} ${county} ${state} tourism`);
    }
    
    if (state) {
        terms.push(`${name} ${state}`);
    }
    
    if (country) {
        terms.push(`${name} ${country}`);
    }
    
    terms.push(`${name} landmark`);
    terms.push(`${name} tourism`);
    terms.push(`${name} ${type || 'location'}`);
    
    return terms;
}

function findMostRelevantImage(pages, name, addressDetails) {
    const images = [];
    
    for (const pageId in pages) {
        const page = pages[pageId];
        if (page.imageinfo && page.imageinfo[0]) {
            const imageInfo = page.imageinfo[0];
            
            let score = 0;
            
            const filename = page.title.toLowerCase();
            const nameLower = name.toLowerCase();
            
            if (filename.includes(nameLower.replace(/\s+/g, '_'))) {
                score += 3;
            }
            
            if (filename.includes('panorama') || filename.includes('aerial')) {
                score += 2;
            }
            
            if (filename.includes('night') || filename.includes('dusk') || filename.includes('dawn')) {
                score += 1;
            }
            
            if (imageInfo.extmetadata) {
                const metadata = imageInfo.extmetadata;
                
                if (metadata.ImageDescription && metadata.ImageDescription.value) {
                    const desc = metadata.ImageDescription.value.toLowerCase();
                    if (desc.includes(nameLower)) score += 2;
                    if (desc.includes('landmark')) score += 3;
                    if (desc.includes('building')) score += 2;
                    if (desc.includes('architecture')) score += 2;
                }
                
                if (metadata.DateTimeOriginal) {
                    const year = new Date(metadata.DateTimeOriginal.value).getFullYear();
                    if (year > 2010) score += 1;
                }
            }
            
            images.push({
                url: imageInfo.thumburl,
                description: imageInfo.extmetadata?.ImageDescription?.value || '',
                score: score
            });
        }
    }
    
    images.sort((a, b) => b.score - a.score);
    return images[0];
}

async function getNotableFeatureFromOSM(lat, lng) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&namedetails=1`
        );
        const data = await response.json();
        
        if (data.namedetails) {
            const names = data.namedetails;
            
            if (data.extratags) {
                const extras = data.extratags;
                
                const wikipedia = extras.wikipedia || extras['wikipedia:en'] || extras['wikipedia'];
                const wikidata = extras.wikidata;
                const image = extras.image || extras['image:0'] || extras['image:1'];
                
                if (wikipedia) {
                    const pageTitle = wikipedia.split(':').slice(1).join(':');
                    
                    const wikiImageResponse = await fetch(
                        `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(pageTitle)}&prop=pageimages&format=json&pithumbsize=400&origin=*`
                    );
                    const wikiImageData = await wikiImageResponse.json();
                    
                    const pages = wikiImageData.query?.pages;
                    if (pages) {
                        const page = Object.values(pages)[0];
                        if (page.thumbnail?.source) {
                            return {
                                name: names.name || names['name:en'] || Object.values(names)[0],
                                description: `Notable feature: ${names.name || ''}`,
                                wikipedia_image: page.thumbnail.source,
                                wikipedia_url: `https://en.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}`
                            };
                        }
                    }
                }
            }
            
            const notableTypes = [
                'historic', 'tourism', 'amenity', 'building', 'leisure',
                'man_made', 'natural', 'place_of_worship', 'shop'
            ];
            
            if (data.category && notableTypes.includes(data.category)) {
                return {
                    name: names.name || names['name:en'] || Object.values(names)[0],
                    description: `${data.category}: ${names.name || ''}`,
                    type: data.category
                };
            }
        }
    } catch (error) {
        console.error("OSM notable feature error:", error);
    }
    
    return null;
}

    function findNearestTerminal(point, terminals) {
        const [lat, lng] = point;
        let nearest = null;
        let minDistance = Infinity;
        
        for (const terminal of terminals) {
            if (terminal.lat && terminal.lon) {
                const distance = map.distance([lat, lng], [terminal.lat, terminal.lon]);
                if (distance < 50000 && distance < minDistance) {
                    minDistance = distance;
                    nearest = {
                        name: terminal.tags?.name || "Ferry Terminal",
                        lat: terminal.lat,
                        lng: terminal.lon,
                        distance: distance
                    };
                }
            }
        }
        
        return nearest;
    }

    async function getElevationAdjustedTime(start, end, mode) {
        try {
            const response = await fetch(
                `https://api.open-elevation.com/api/v1/lookup?locations=${start[0]},${start[1]}|${end[0]},${end[1]}`
            );
            const data = await response.json();
            
            if (data.results && data.results.length === 2) {
                const startElev = data.results[0].elevation;
                const endElev = data.results[1].elevation;
                const elevationGain = Math.max(0, endElev - startElev);
                
                let baseSpeed = mode === 'cycling' ? 15000 : 5000;
                
                if (elevationGain > 100) {
                    baseSpeed *= 0.7;
                } else if (elevationGain < -100) {
                    baseSpeed *= 1.3;
                }
                
                const distance = map.distance(start, end);
                return (distance / baseSpeed) * 3600;
            }
        } catch (error) {}
        
        const distance = map.distance(start, end);
        const baseSpeed = mode === 'cycling' ? 15000 : 5000;
        return (distance / baseSpeed) * 3600;
    }

    function getFallbackAirports() {
        return getCommercialAirports();
    }

    function cityPopulationLookup(city, country) {
        const majorCities = {
            "New York": 8419000,
            "Los Angeles": 3980000,
            "Chicago": 2716000,
            "Houston": 2328000,
            "Phoenix": 1689000,
            "Philadelphia": 1584000,
            "San Antonio": 1547000,
            "San Diego": 1426000,
            "Dallas": 1344000,
            "San Jose": 1035000,
            "London": 8900000,
            "Paris": 2148000,
            "Berlin": 3769000,
            "Madrid": 3223000,
            "Rome": 2873000,
            "Tokyo": 13960000,
            "Beijing": 21540000,
            "Shanghai": 26320000,
            "Delhi": 32941000,
            "Mumbai": 21357000
        };
        
        return majorCities[city] || 100000;
    }

    function isMajorCity(city, country) {
        const majorCities = [
            "New York", "Los Angeles", "Chicago", "Houston", "Phoenix",
            "Philadelphia", "San Antonio", "San Diego", "Dallas", "San Jose",
            "London", "Paris", "Berlin", "Madrid", "Rome", "Barcelona",
            "Tokyo", "Beijing", "Shanghai", "Delhi", "Mumbai", "Sydney",
            "Melbourne", "Toronto", "Vancouver", "Montreal", "Mexico City",
            "São Paulo", "Rio de Janeiro", "Buenos Aires", "Cairo", "Johannesburg"
        ];
        
        return majorCities.includes(city);
    }

    async function getFlightStatus(departureAirport, arrivalAirport) {
        const flightDistance = map.distance(departureAirport.coordinates, arrivalAirport.coordinates);
        const flightTime = (flightDistance / 750000) * 3600;
        
        return {
            available: true,
            duration: flightTime,
            airline: "Estimated",
            status: "Estimated"
        };
    }

    async function calculateSmartFlightRoute(start, end, distance) {
        try {
            const airports = await getAllAirports();
            
            const startAirports = airports
                .map(airport => ({
                    ...airport,
                    distance: map.distance(start, airport.coordinates),
                    score: calculateAirportScore(airport, start)
                }))
                .filter(a => a.distance < 150000)
                .sort((a, b) => b.score - a.score);
                
            const endAirports = airports
                .map(a => ({
                    ...a,
                    distance: map.distance(end, a.coordinates)
                }))
                .filter(a => a.distance < 150000)
                .sort((a, b) => a.distance - b.distance);
            
            if (startAirports.length === 0 || endAirports.length === 0) return null;
            
            const startAirport = startAirports[0];
            const endAirport = endAirports[0];
            
            if (startAirport.code === endAirport.code) return null;
            
            const airportDistance = map.distance(startAirport.coordinates, endAirport.coordinates);
            if (airportDistance < 500000) return null;
            
            const flightData = await getFlightStatus(startAirport, endAirport);
            
            const groundSpeed = 50000;
            const toAirportTime = (startAirport.distance / groundSpeed) * 3600;
            const fromAirportTime = (endAirport.distance / groundSpeed) * 3600;
            
            const flightTime = flightData.duration || (airportDistance / 750000) * 3600;
            const airportTime = 7200;
            
            const totalTime = toAirportTime + flightTime + fromAirportTime + airportTime;
            
            const drivingEstimate = (distance / 80000) * 3600;
            if (totalTime > drivingEstimate * 0.8) return null;
            
            return {
                id: 'flight',
                icon: 'lucide:plane',
                label: 'Flight',
                duration: totalTime,
                distance: airportDistance,
                geometry: createFlightPath(startAirport.coordinates, endAirport.coordinates),
                steps: [
                    {
                        distance: startAirport.distance,
                        duration: toAirportTime,
                        maneuver: { instruction: `Travel to ${startAirport.name}`, type: 'ground' }
                    },
                    {
                        distance: airportDistance,
                        duration: flightTime,
                        maneuver: { instruction: `Fly to ${endAirport.name}`, type: 'flight' }
                    },
                    {
                        distance: endAirport.distance,
                        duration: fromAirportTime,
                        maneuver: { instruction: `Travel to destination`, type: 'ground' }
                    }
                ],
                airports: { departure: startAirport, arrival: endAirport },
                flightData: flightData,
                realData: true,
                details: `${startAirport.code} → ${endAirport.code}`
            };
            
        } catch (error) {
            return null;
        }
    }

async function calculateRoutes(start, end) {
    const container = document.getElementById('route-options');
    container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">Calculating routes...</div>';
    
    const routes = [];
    
    const [trafficData, weatherData] = await Promise.all([
        getRealTrafficEstimate(start, end),
        getRealWeatherAtLocation(start[0], start[1])
    ]);
    
    const directDistance = map.distance(start, end);
    
    if (shouldShowFlightRoute(start, end, directDistance)) {
        const flightRoute = await calculateFlightRoute(start, end, directDistance);
        if (flightRoute) {
            routes.push(flightRoute);
        }
    }
    
    try {
        const drivingResponse = await fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true`)
            .then(res => {
                if (!res.ok) {
                    return null;
                }
                return res.json();
            });
        
        if (drivingResponse?.routes?.[0] && !drivingResponse.message && drivingResponse.code !== "NoRoute") {
            const route = drivingResponse.routes[0];
            const distance = route.distance;
            let duration = route.duration;
            
            if (trafficData.duration) {
                duration = trafficData.duration;
            } else {
                const trafficLevel = trafficData.trafficLevel;
                if (trafficLevel === 'high') duration = duration * 1.4;
                else if (trafficLevel === 'medium') duration = duration * 1.2;
            }
            
            const googleDrivingFactor = 0.66;
            const googleDuration = duration * googleDrivingFactor;
            
            routes.push({
                id: 'driving',
                icon: 'lucide:car',
                label: 'Driving',
                duration: googleDuration,
                distance: distance,
                geometry: route.geometry,
                steps: processOSRMSteps(route.legs?.[0]?.steps || []),
                traffic: trafficData.trafficLevel,
                weather: weatherData?.conditions,
                realData: true
            });
            
            const routeDistance = distance;
            const routeGeometry = route.geometry;
            const drivingSteps = route.legs?.[0]?.steps || [];
            
            const walkingTime = (routeDistance / 4360) * 3600;
            const cyclingTime = (routeDistance / 16400) * 3600;
            
            const walkingSteps = generateWalkingSteps(drivingSteps, routeDistance, walkingTime);
            const cyclingSteps = generateCyclingSteps(drivingSteps, routeDistance, cyclingTime);
            
            routes.push({
                id: 'walking',
                icon: 'lucide:footprints',
                label: 'Walking',
                duration: walkingTime,
                distance: routeDistance,
                geometry: routeGeometry,
                steps: walkingSteps,
                realData: true
            });
            
            routes.push({
                id: 'cycling',
                icon: 'lucide:bike',
                label: 'Cycling',
                duration: cyclingTime,
                distance: routeDistance,
                geometry: routeGeometry,
                steps: cyclingSteps,
                realData: true
            });
        }
    } catch(e) {
        console.error('Driving route failed:', e);
    }
    
    const ferryData = await getFerryRoutes(start, end);
    if (ferryData.hasFerry && directDistance > 10000 && directDistance < 500000) {
        const ferrySpeed = 40000;
        const ferryTime = (ferryData.distance / ferrySpeed) * 3600;
        
        routes.push({
            id: 'ferry',
            icon: 'lucide:ship',
            label: 'Ferry',
            duration: ferryTime,
            distance: ferryData.distance,
            geometry: createStraightPath(start, end),
            steps: [{
                distance: ferryData.distance,
                duration: ferryTime,
                maneuver: {
                    instruction: `Take ferry from ${ferryData.terminals.start} to ${ferryData.terminals.end}`,
                    type: 'ferry'
                }
            }],
            realData: true
        });
    }
    
    container.innerHTML = '';
    if (routes.length === 0) {
        container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No routes available</div>';
        return;
    }
    
    routes.forEach(route => {
        addRouteCard(route);
    });
}

function generateWalkingSteps(drivingSteps, totalDistance, totalTime) {
    if (!drivingSteps || drivingSteps.length === 0) {
        return [{
            distance: totalDistance,
            duration: totalTime,
            maneuver: {
                instruction: "Walk to destination",
                type: "arrive"
            }
        }];
    }
    
    const walkingSteps = [];
    let accumulatedDistance = 0;
    let accumulatedTime = 0;
    
    drivingSteps.forEach((step, index) => {
        const stepDistance = step.distance || 0;
        const stepProportion = stepDistance / totalDistance;
        const stepTime = totalTime * stepProportion;
        
        const walkingInstruction = convertToWalkingInstruction(step);
        
        walkingSteps.push({
            distance: stepDistance,
            duration: stepTime,
            geometry: step.geometry,
            maneuver: {
                instruction: walkingInstruction,
                type: step.maneuver?.type || "continue",
                modifier: step.maneuver?.modifier || ""
            },
            name: step.name,
            way_points: step.way_points
        });
        
        accumulatedDistance += stepDistance;
        accumulatedTime += stepTime;
    });
    
    if (Math.abs(accumulatedDistance - totalDistance) > 100) {
        const lastStep = walkingSteps[walkingSteps.length - 1];
        lastStep.distance = lastStep.distance + (totalDistance - accumulatedDistance);
        lastStep.duration = lastStep.duration + (totalTime - accumulatedTime);
    }
    
    walkingSteps.push({
        distance: 0,
        duration: 0,
        maneuver: {
            instruction: "Arrive at destination",
            type: "arrive"
        }
    });
    
    return walkingSteps;
}

function generateCyclingSteps(drivingSteps, totalDistance, totalTime) {
    if (!drivingSteps || drivingSteps.length === 0) {
        return [{
            distance: totalDistance,
            duration: totalTime,
            maneuver: {
                instruction: "Cycle to destination",
                type: "arrive"
            }
        }];
    }
    
    const cyclingSteps = [];
    let accumulatedDistance = 0;
    let accumulatedTime = 0;
    
    drivingSteps.forEach((step, index) => {
        const stepDistance = step.distance || 0;
        const stepProportion = stepDistance / totalDistance;
        const stepTime = totalTime * stepProportion;
        
        const cyclingInstruction = convertToCyclingInstruction(step);
        
        cyclingSteps.push({
            distance: stepDistance,
            duration: stepTime,
            geometry: step.geometry,
            maneuver: {
                instruction: cyclingInstruction,
                type: step.maneuver?.type || "continue",
                modifier: step.maneuver?.modifier || ""
            },
            name: step.name,
            way_points: step.way_points
        });
        
        accumulatedDistance += stepDistance;
        accumulatedTime += stepTime;
    });
    
    if (Math.abs(accumulatedDistance - totalDistance) > 100) {
        const lastStep = cyclingSteps[cyclingSteps.length - 1];
        lastStep.distance = lastStep.distance + (totalDistance - accumulatedDistance);
        lastStep.duration = lastStep.duration + (totalTime - accumulatedTime);
    }
    
    cyclingSteps.push({
        distance: 0,
        duration: 0,
        maneuver: {
            instruction: "Arrive at destination",
            type: "arrive"
        }
    });
    
    return cyclingSteps;
}

function convertToWalkingInstruction(step) {
    const maneuver = step.maneuver;
    if (!maneuver) return "Continue walking";
    
    const streetName = step.name || "";
    const baseInstruction = maneuver.instruction || "";
    
    switch(maneuver.type) {
        case 'depart':
            return streetName ? `Start walking toward ${streetName}` : "Start walking";
        case 'turn':
            if (maneuver.modifier === 'left') {
                return streetName ? `Turn left onto ${streetName}` : "Turn left";
            } else if (maneuver.modifier === 'right') {
                return streetName ? `Turn right onto ${streetName}` : "Turn right";
            } else if (maneuver.modifier === 'sharp left') {
                return streetName ? `Take sharp left onto ${streetName}` : "Take sharp left";
            } else if (maneuver.modifier === 'sharp right') {
                return streetName ? `Take sharp right onto ${streetName}` : "Take sharp right";
            } else if (maneuver.modifier === 'slight left') {
                return streetName ? `Bear left onto ${streetName}` : "Bear left";
            } else if (maneuver.modifier === 'slight right') {
                return streetName ? `Bear right onto ${streetName}` : "Bear right";
            } else if (maneuver.modifier === 'uturn') {
                return "Make a U-turn";
            }
            return streetName ? `Turn onto ${streetName}` : "Turn";
        case 'continue':
            return streetName ? `Continue on ${streetName}` : "Continue straight";
        case 'roundabout':
            const exitNumber = maneuver.exit || 1;
            const ordinal = getOrdinal(exitNumber);
            return streetName ? `Take ${ordinal} exit onto ${streetName}` : `Take ${ordinal} exit`;
        case 'merge':
            return streetName ? `Merge onto ${streetName}` : "Merge";
        case 'fork':
            if (maneuver.modifier === 'left') {
                return streetName ? `Keep left onto ${streetName}` : "Keep left at fork";
            } else if (maneuver.modifier === 'right') {
                return streetName ? `Keep right onto ${streetName}` : "Keep right at fork";
            }
            return streetName ? `At fork, continue onto ${streetName}` : "Continue at fork";
        case 'off ramp':
            return streetName ? `Take exit for ${streetName}` : "Take exit";
        case 'on ramp':
            return streetName ? `Take ramp onto ${streetName}` : "Take ramp";
        case 'end of road':
            if (maneuver.modifier === 'left') {
                return streetName ? `At end of road, turn left onto ${streetName}` : "Turn left at end of road";
            } else if (maneuver.modifier === 'right') {
                return streetName ? `At end of road, turn right onto ${streetName}` : "Turn right at end of road";
            }
            return streetName ? `At end of road, continue onto ${streetName}` : "Continue at end of road";
        default:
            return baseInstruction.replace(/Drive|Car/g, "Walk").replace(/driving/gi, "walking");
    }
}

function convertToCyclingInstruction(step) {
    const maneuver = step.maneuver;
    if (!maneuver) return "Continue cycling";
    
    const streetName = step.name || "";
    const baseInstruction = maneuver.instruction || "";
    
    switch(maneuver.type) {
        case 'depart':
            return streetName ? `Start cycling toward ${streetName}` : "Start cycling";
        case 'turn':
            if (maneuver.modifier === 'left') {
                return streetName ? `Turn left onto ${streetName}` : "Turn left";
            } else if (maneuver.modifier === 'right') {
                return streetName ? `Turn right onto ${streetName}` : "Turn right";
            } else if (maneuver.modifier === 'sharp left') {
                return streetName ? `Take sharp left onto ${streetName}` : "Take sharp left";
            } else if (maneuver.modifier === 'sharp right') {
                return streetName ? `Take sharp right onto ${streetName}` : "Take sharp right";
            } else if (maneuver.modifier === 'slight left') {
                return streetName ? `Bear left onto ${streetName}` : "Bear left";
            } else if (maneuver.modifier === 'slight right') {
                return streetName ? `Bear right onto ${streetName}` : "Bear right";
            } else if (maneuver.modifier === 'uturn') {
                return "Make a U-turn";
            }
            return streetName ? `Turn onto ${streetName}` : "Turn";
        case 'continue':
            return streetName ? `Continue on ${streetName}` : "Continue straight";
        case 'roundabout':
            const exitNumber = maneuver.exit || 1;
            const ordinal = getOrdinal(exitNumber);
            return streetName ? `Take ${ordinal} exit onto ${streetName}` : `Take ${ordinal} exit`;
        case 'merge':
            return streetName ? `Merge onto ${streetName}` : "Merge";
        case 'fork':
            if (maneuver.modifier === 'left') {
                return streetName ? `Keep left onto ${streetName}` : "Keep left at fork";
            } else if (maneuver.modifier === 'right') {
                return streetName ? `Keep right onto ${streetName}` : "Keep right at fork";
            }
            return streetName ? `At fork, continue onto ${streetName}` : "Continue at fork";
        case 'off ramp':
            return streetName ? `Take exit for ${streetName}` : "Take exit";
        case 'on ramp':
            return streetName ? `Take ramp onto ${streetName}` : "Take ramp";
        case 'end of road':
            if (maneuver.modifier === 'left') {
                return streetName ? `At end of road, turn left onto ${streetName}` : "Turn left at end of road";
            } else if (maneuver.modifier === 'right') {
                return streetName ? `At end of road, turn right onto ${streetName}` : "Turn right at end of road";
            }
            return streetName ? `At end of road, continue onto ${streetName}` : "Continue at end of road";
        case 'arrive':
            return "Arrive at destination";
        default:
            return baseInstruction.replace(/Drive|Car/g, "Cycle").replace(/driving/gi, "cycling");
    }
}
 
    function initMap() {
        map = L.map('map', { 
            zoomControl: false, 
            attributionControl: false, 
            maxBounds: [[-85, -10000], [85, 10000]], 
            maxBoundsViscosity: 1.0, 
            worldCopyJump: true, 
            minZoom: 3 
        }).setView([40.7128, -74.0060], 2);
        
        darkBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            maxZoom: 19, 
            className: 'dark-layer',
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
            maxZoom: 19 
        });
        
        routeLayer.addTo(map);
        
        userMarker.addTo(map);
        
        customStartMarker = L.marker([0,0], {
            icon: L.divIcon({
                className: 'custom-start-marker',
                html: '<div style="background: #f59e0b; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(245,158,11,0.5);"></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            })
        });

        destinationMarker = L.marker([0,0], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div style="background: #ef4444; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(239,68,68,0.5); position: relative;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: white; border-radius: 50%;"></div></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            }),
            zIndexOffset: 1000
        });
    }
    
    function setupMapEvents() {
        if (!map) return;

        map.off('click');
        
        map.on('click', (e) => {
            if (isNavigating) return;
            
            if (isMapClickModeActive) {
                return;
            } else {
                triggerAnalysis(e.latlng.lat, e.latlng.lng);
                hideSearchResults();
            }
        });
        
        map.on('mousemove', (e) => {
            document.getElementById('hud-coords').innerText = 
                `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
        });
        
        map.on('move', () => {
            hideSearchResults();
        });
    }
    
    function toggleStartPanel(e) {
        e.stopPropagation();
        const expanded = document.getElementById('custom-start-expanded');
        const searchResults = document.getElementById('results');
        const customSearchResults = document.getElementById('custom-start-search-results');
        
        if (searchResults && !searchResults.classList.contains('hidden')) {
            hideSearchResults();
        }
        
        if (customSearchResults && customSearchResults.style.display === 'block') {
            customSearchResults.style.display = 'none';
        }
        
        if (expanded.style.display === 'block') {
            expanded.style.display = 'none';
        } else {
            expanded.style.display = 'block';
            
            expanded.style.maxHeight = '400px';
            
            const panelRect = expanded.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            if (panelRect.bottom > viewportHeight - 10) {
                const availableHeight = viewportHeight - panelRect.top - 20;
                expanded.style.maxHeight = Math.max(150, availableHeight) + 'px';
            }
        }
    }

    window.addEventListener('resize', () => {
        const expanded = document.getElementById('custom-start-expanded');
        if (expanded.style.display === 'block') {
            const panelRect = expanded.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            if (panelRect.bottom > viewportHeight - 10) {
                const availableHeight = viewportHeight - panelRect.top - 20;
                expanded.style.maxHeight = Math.max(150, availableHeight) + 'px';
            } else {
                expanded.style.maxHeight = '400px';
            }
        }
    });

    document.addEventListener('click', (e) => {
        const startPanel = document.getElementById('custom-start-panel');
        const startToggle = document.getElementById('custom-start-toggle');
        const startExpanded = document.getElementById('custom-start-expanded');
        const customStartInput = document.getElementById('custom-start-input');
        const customSearchResults = document.getElementById('custom-start-search-results');
        
        const isInSearchResults = customSearchResults && customSearchResults.contains(e.target);
        
        if (startExpanded.style.display === 'block' && 
            !startPanel.contains(e.target) && 
            e.target !== startToggle &&
            e.target !== customStartInput &&
            !isInSearchResults) {
            startExpanded.style.display = 'none';
        }
    });

    function calculateDynamicHeight() {
        const expanded = document.getElementById('custom-start-expanded');
        if (!expanded || expanded.style.display !== 'block') return;
        
        const viewportHeight = window.innerHeight;
        
        const panelRect = expanded.getBoundingClientRect();
        const toggleRect = document.getElementById('custom-start-toggle').getBoundingClientRect();
        
        const spaceFromTop = toggleRect.top + toggleRect.height + 8;
        const spaceToBottom = viewportHeight - spaceFromTop - 10;
        
        const maxHeight = Math.max(150, Math.min(400, spaceToBottom));
        
        expanded.style.maxHeight = `${maxHeight}px`;
        expanded.style.position = 'absolute';
        expanded.style.top = 'calc(100% + 8px)';
        expanded.style.left = '0';
        expanded.style.right = '0';
    }

    window.addEventListener('resize', calculateDynamicHeight);

    document.querySelectorAll('.start-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            setTimeout(() => calculateDynamicHeight(), 100);
        });
    });

    const customStartInput = document.getElementById('custom-start-input');
    customStartInput.addEventListener('input', () => {
        setTimeout(() => calculateDynamicHeight(), 200);
    });
    
    let isMapClickModeActive = false;
    let mapClickListener = null;

    function setStartMode(mode) {
        const previousMode = customStartMode;
        customStartMode = mode;
        
        if (mapClickListener) {
            map.off('click', mapClickListener);
            mapClickListener = null;
        }
        
        isMapClickModeActive = (mode === 'map');
        
        document.querySelectorAll('.start-mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });
        
        document.getElementById('current-start-mode').textContent = 
            mode === 'current' ? 'Current Location' :
            mode === 'map' ? 'Click on Map' :
            'Search for Location';
        
        if (mode === 'map') {
            if (!customStartPos || previousMode !== 'map') {
                enableMapClickMode();
            } else {
                updateMapModeUI(true);
            }
            
            map.getContainer().style.cursor = isMapClickModeActive ? 'crosshair' : '';
            
        } else {
            disableMapClickMode();
        }
        
        const searchContainer = document.getElementById('custom-start-input-container');
        const searchResults = document.getElementById('custom-start-search-results');
        
        if (mode === 'search') {
            searchContainer.style.display = 'block';
            searchResults.style.display = 'none';
        } else {
            searchContainer.style.display = 'none';
            searchResults.style.display = 'none';
            document.getElementById('custom-start-input').value = '';
        }
        
        updateCustomStartMarker();
        
        updateStartPointDisplay();
        
        if (selectedTarget) {
            calculateRoutes(getCurrentStartPoint(), selectedTarget);
        }
    }

    function enableMapClickMode() {
        isMapClickModeActive = true;
        
        map.getContainer().style.cursor = 'crosshair';
        map.getContainer().classList.add('map-click-mode-active');
        
        updateMapModeUI(true);
        
        mapClickListener = (e) => {
            setCustomStartFromMap(e.latlng);
            
            disableMapClickMode();
        };
        
        map.on('click', mapClickListener);
    }

    function disableMapClickMode() {
        isMapClickModeActive = false;
        map.getContainer().style.cursor = '';
        map.getContainer().classList.remove('map-click-mode-active');
        
        updateMapModeUI(false);
        
        if (mapClickListener) {
            map.off('click', mapClickListener);
            mapClickListener = null;
        }
    }

    function updateMapModeUI(isActive) {
        const mapModeBtn = document.querySelector('.start-mode-btn[data-mode="map"]');
        if (!mapModeBtn) return;
        
        if (isActive) {
            mapModeBtn.style.background = 'rgba(59, 130, 246, 0.3)';
            mapModeBtn.style.borderColor = '#3b82f6';
            mapModeBtn.style.color = '#93c5fd';
            mapModeBtn.innerHTML = `
                <iconify-icon icon="lucide:map-pin"></iconify-icon>
                Click on Map <span style="font-size: 9px; opacity: 0.8;">(click map)</span>
            `;
        } else {
            mapModeBtn.style.background = '';
            mapModeBtn.style.borderColor = '';
            mapModeBtn.style.color = '';
            mapModeBtn.innerHTML = `
                <iconify-icon icon="lucide:map-pin"></iconify-icon>
                Click on Map
            `;
        }
    }

    function showClickHighlight(latlng) {
        removeClickHighlight();
        
        window.clickHighlight = L.circleMarker(latlng, {
            radius: 15,
            color: '#3b82f6',
            weight: 3,
            opacity: 0.8,
            fillColor: '#3b82f6',
            fillOpacity: 0.2,
            className: 'click-highlight'
        }).addTo(map);
        
        setTimeout(() => {
            removeClickHighlight();
        }, 1500);
    }

    function removeClickHighlight() {
        if (window.clickHighlight) {
            map.removeLayer(window.clickHighlight);
            window.clickHighlight = null;
        }
    }
    
    function setCustomStartFromMap(latlng) {
        customStartPos = [latlng.lat, latlng.lng];
        
        customStartMode = 'map';
        
        updateCustomStartMarker();
        
        showClickHighlight(latlng);
        
        fetch(`https://photon.komoot.io/reverse?lon=${latlng.lng}&lat=${latlng.lat}&limit=1`)
            .then(res => res.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    const p = data.features[0].properties || {};
                    const address = [p.street, p.city, p.country].filter(Boolean).join(', ') || 
                                   `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                    document.getElementById('start-point-coords').textContent = address;
                } else {
                    document.getElementById('start-point-coords').textContent = 
                        `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                }
            })
            .catch(() => {
                document.getElementById('start-point-coords').textContent = 
                    `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
            });
        
        if (selectedTarget) {
            calculateRoutes(customStartPos, selectedTarget);
        }
        
        map.flyTo(latlng, 15, {
            animate: true,
            duration: 0.5
        });
    }
    
    function searchCustomStartLocation(query) {
        if (!query || query.trim().length < 2) {
            const container = document.getElementById('custom-start-search-results');
            container.style.display = 'none';
            return;
        }
        
        fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=10`)
            .then(res => res.json())
            .then(data => {
                const results = data.features || [];
                const container = document.getElementById('custom-start-search-results');
                
                if (results.length === 0) {
                    container.innerHTML = '<div class="text-xs text-neutral-500 p-2 text-center">No results found</div>';
                    container.style.display = 'block';
                    return;
                }
                
                let html = '';
                results.forEach(result => {
                    const props = result.properties;
                    const name = props.name || props.street || props.city || "Unnamed Location";
                    const details = [props.housenumber, props.street, props.city, props.country]
                        .filter(Boolean)
                        .join(', ') || 'Coordinates';
                    
                    html += `
                        <div class="search-result" data-lat="${result.geometry.coordinates[1]}" data-lng="${result.geometry.coordinates[0]}" data-name="${name}">
                            <div class="text-[11px] font-bold text-white mb-1">${name}</div>
                            <div class="text-[9px] text-neutral-400">${details}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                container.style.display = 'block';
                
                const expanded = document.getElementById('custom-start-expanded');
                const expandedRect = expanded.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                
                const resultsHeight = Math.min(150, viewportHeight - expandedRect.top - 180);
                container.style.maxHeight = resultsHeight + 'px';
                
                document.querySelectorAll('#custom-start-search-results .search-result').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lng = parseFloat(item.dataset.lng);
                        const name = item.dataset.name;
                        
                        customStartPos = [lat, lng];
                        customStartMode = 'search';
                        updateCustomStartMarker();
                        
                        document.getElementById('start-point-coords').textContent = name;
                        
                        container.style.display = 'none';
                        document.getElementById('custom-start-input').value = name;
                        
                        if (selectedTarget) {
                            calculateRoutes(customStartPos, selectedTarget);
                        }
                        
                        map.flyTo([lat, lng], 14, { animate: true, duration: 1 });
                    });
                });
            })
            .catch(error => {});
    }
    
    function updateCustomStartMarker() {
        if (map.hasLayer(customStartMarker)) {
            map.removeLayer(customStartMarker);
        }
        
        if (customStartMode !== 'current' && customStartPos) {
            customStartMarker.setLatLng(customStartPos);
            customStartMarker.addTo(map);
        }
    }
    
    function updateStartPointDisplay() {
        let displayText = '';
        
        if (customStartMode === 'current') {
            displayText = 'Your current location';
        } else if (customStartMode === 'map' && customStartPos) {
            displayText = `${customStartPos[0].toFixed(4)}, ${customStartPos[1].toFixed(4)}`;
        } else if (customStartMode === 'search' && customStartPos) {
            displayText = document.getElementById('start-point-coords').textContent;
        } else {
            displayText = 'Your current location';
        }
        
        document.getElementById('start-point-coords').textContent = displayText;
    }
    
    function getCurrentStartPoint() {
        if (customStartMode === 'current') {
            return userPos || [40.7128, -74.0060];
        } else if (customStartPos) {
            return customStartPos;
        } else {
            return userPos || [40.7128, -74.0060];
        }
    }
    
    window.onload = () => {
        initMap();
        
        document.getElementById('custom-start-toggle').addEventListener('click', toggleStartPanel);
        
        document.querySelectorAll('.start-mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                
                if (mode === 'map') {
                    if (customStartMode === 'map' && !isMapClickModeActive) {
                        enableMapClickMode();
                        return;
                    }
                    
                    if (customStartMode === 'map' && isMapClickModeActive) {
                        setStartMode('current');
                        disableMapClickMode();
                        return;
                    }
                    
                    setStartMode('map');
                    
                } else {
                    setStartMode(mode);
                    disableMapClickMode();
                }
            });
        });
        
        const customStartInput = document.getElementById('custom-start-input');
        let customSearchTimeout;
        customStartInput.addEventListener('input', (e) => {
            clearTimeout(customSearchTimeout);
            customSearchTimeout = setTimeout(() => {
                searchCustomStartLocation(e.target.value);
            }, 500);
        });
        
        customStartInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchCustomStartLocation(e.target.value);
            }
        });
        
        setTimeout(() => {
            if (navigator.geolocation && !isLocationRequested) {
                isLocationRequested = true;
                document.getElementById('status-text').innerText = "Acquiring Signal";
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userPos = [pos.coords.latitude, pos.coords.longitude];
                        userMarker.setLatLng(userPos);
                        map.setView(userPos, 14);
                        
                        document.getElementById('hud-precision').innerText = `${pos.coords.accuracy.toFixed(0)}m`;
                        document.getElementById('status-text').innerText = "Located";
                        document.getElementById('hud-coords').innerText = `${userPos[0].toFixed(4)}, ${userPos[1].toFixed(4)}`;
                        
                        updateStartPointDisplay();
                        
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => { 
                            document.getElementById('loader').style.display = 'none'; 
                            document.body.classList.add('ui-ready'); 
                            setupMapEvents();
                            
                            setTimeout(() => {
                                startContinuousGPS();
                            }, 1000);
                        }, 500);
                    },
                    (error) => { 
                        userPos = [40.7128, -74.0060];
                        userMarker.setLatLng(userPos);
                        map.setView(userPos, 2);
                        document.getElementById('status-text').innerText = "GPS Unavailable";
                        
                        updateStartPointDisplay();
                        
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => { 
                            document.getElementById('loader').style.display = 'none'; 
                            document.body.classList.add('ui-ready'); 
                            setupMapEvents();
                        }, 500);
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 60000,
                        maximumAge: 0
                    }
                );
            } else {
                userPos = [40.7128, -74.0060];
                userMarker.setLatLng(userPos);
                map.setView(userPos, 2);
                
                updateStartPointDisplay();
                
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => { 
                    document.getElementById('loader').style.display = 'none'; 
                    document.body.classList.add('ui-ready'); 
                    setupMapEvents();
                }, 500);
            }
        }, 2000);
    };
    
    function startContinuousGPS() {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        
        watchId = navigator.geolocation.watchPosition(
            (pos) => {
                userPos = [pos.coords.latitude, pos.coords.longitude];
                
                userMarker.setLatLng(userPos);
                
                if (customStartMode === 'current') {
                    updateStartPointDisplay();
                }
                
                if (!isNavigating) {
                    document.getElementById('hud-precision').innerText = `${pos.coords.accuracy.toFixed(0)}m`;
                    document.getElementById('hud-coords').innerText = 
                        `${userPos[0].toFixed(4)}, ${userPos[1].toFixed(4)}`;
                }
                
                if (isNavigating && currentNavRoute) {
                    checkNavigationProgress(pos);
                }
            },
            (error) => {},
            { 
                enableHighAccuracy: true,
                maximumAge: 5000,
                timeout: 15000
            }
        );
    }

function stripAllHTML(input = '') {
    if (typeof input !== 'string') return '';
    const div = document.createElement('div');
    div.innerHTML = input;
    return (div.textContent || '')
        .replace(/\u00A0/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

    async function triggerAnalysis(lat, lng) {
if (destinationMarker && map.hasLayer(destinationMarker)) {
            map.removeLayer(destinationMarker);
        }

    selectedTarget = [lat, lng];
    const sidebar = document.getElementById('info-sidebar');
    sidebar.classList.add('active');
    routeLayer.clearLayers();
    document.getElementById('start-nav-btn').classList.add('hidden');
    updateDestinationMarker(lat, lng);
    
    document.getElementById('side-title').innerText = "Processing...";
    
    try {
        const res = await fetch(`https://photon.komoot.io/reverse?lon=${lng}&lat=${lat}&limit=1`);
        const data = await res.json();
        
        if (data.features && data.features.length > 0) {
            const p = data.features[0].properties || {};
            const locationName = p.name || p.street || "Selected Location";

    const addressDetails = {
        city: p.city,
        country: p.country,
        street: p.street,
        housenumber: p.housenumber,
        postcode: p.postcode
    };
    
    const imageData = await getLocationImages(lat, lng, locationName, addressDetails);
    
    const shouldShowImage = imageData.relevance === 'high' || imageData.relevance === 'medium';

const cleanDescription = stripAllHTML(imageData.description);
const truncatedDescription = cleanDescription.substring(0, 200) + (cleanDescription.length > 200 ? '...' : '');

const safeWikiUrl = imageData.wikipediaUrl ? encodeURI(imageData.wikipediaUrl) : null;
                        
            document.getElementById('side-title').innerText = locationName;
            
            const addressParts = [p.street, p.city, p.country, p.postcode].filter(Boolean);
            const addressString = addressParts.length > 0 ? 
                addressParts.join(', ') : 
                `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            let sidebarHTML = `
                <div class="space-y-6">
                    ${imageData.image ? `
                    <div class="relative h-48 rounded-xl overflow-hidden">
                        <img src="${imageData.image}" 
                             class="w-full h-full object-cover"
                             alt="${locationName}"
                             onerror="this.style.display='none'; this.parentElement.style.display='none';">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-4">
                            ${imageData.source ? `
                            <div class="flex items-center gap-2 mb-2">
                                <iconify-icon icon="lucide:camera" class="text-white/70 text-sm"></iconify-icon>
                                <span class="text-xs text-white/70">${imageData.source}</span>
                            </div>
                            ` : ''}
                            <h3 class="text-lg font-bold text-white">${locationName}</h3>
                        </div>
                    </div>
                    ` : `
                    <div class="h-32 rounded-xl bg-gradient-to-br from-gray-900 to-black border border-white/10 flex items-center justify-center">
                        <div class="text-center">
                            <iconify-icon icon="lucide:map-pin" class="text-3xl text-white/30 mb-2"></iconify-icon>
                            <div class="text-sm text-white/50">${locationName}</div>
                        </div>
                    </div>
                    `}
                    
                    ${imageData.description ? `
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <iconify-icon icon="lucide:info" class="text-neutral-500"></iconify-icon>
                            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">About</span>
                        </div>
                        <p class="text-xs text-neutral-300 leading-relaxed line-clamp-3">${truncatedDescription}</p>
                        ${safeWikiUrl ? `
                        <a href="${safeWikiUrl}" target="_blank" class="inline-flex items-center gap-1 text-xs text-sky-400 hover:text-sky-300 mt-1">
                            <iconify-icon icon="lucide:external-link" class="text-[10px]"></iconify-icon>
                            Read more on Wikipedia
                        </a>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <iconify-icon icon="lucide:map-pin" class="text-neutral-500"></iconify-icon>
                            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Address</span>
                        </div>
                        <p class="text-xs text-neutral-300 leading-relaxed">${addressString}</p>
                        <button onclick="copyToClipboard('${addressString.replace(/'/g, "\\'")}', event)" 
                                class="inline-flex items-center gap-1 text-xs text-emerald-400 hover:text-emerald-300 mt-1">
                            <iconify-icon icon="lucide:copy" class="text-[10px]"></iconify-icon>
                            Copy Address
                        </button>
                    </div>
                    
                    <div id="logistics-module">
                        <div class="flex items-center gap-2 mb-4">
                            <iconify-icon icon="lucide:route" class="text-neutral-500"></iconify-icon>
                            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Routes</span>
                        </div>
                        <div id="route-options" class="flex flex-col gap-2"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('sidebar-content').innerHTML = sidebarHTML;
            
            updateDestinationMarker(lat, lng, locationName);
            
        } else {
            const imageData = await getLocationImages(lat, lng, "Location");
            
            document.getElementById('side-title').innerText = "Location";
            document.getElementById('sidebar-content').innerHTML = `
                <div class="space-y-6">
                    ${imageData.image ? `
                    <div class="relative h-48 rounded-xl overflow-hidden">
                        <img src="${imageData.image}" 
                             class="w-full h-full object-cover"
                             alt="Location"
                             onerror="this.style.display='none'; this.parentElement.style.display='none';">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-4">
                            <h3 class="text-lg font-bold text-white">Selected Location</h3>
                        </div>
                    </div>
                    ` : `
                    <div class="h-32 rounded-xl bg-gradient-to-br from-gray-900 to-black border border-white/10 flex items-center justify-center">
                        <div class="text-center">
                            <iconify-icon icon="lucide:map-pin" class="text-3xl text-white/30 mb-2"></iconify-icon>
                            <div class="text-sm text-white/50">Selected Location</div>
                        </div>
                    </div>
                    `}
                    
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <iconify-icon icon="lucide:map-pin" class="text-neutral-500"></iconify-icon>
                            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Coordinates</span>
                        </div>
                        <p class="text-xs text-neutral-300 leading-relaxed">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        <button onclick="copyToClipboard('${lat.toFixed(6)}, ${lng.toFixed(6)}')" 
                                class="inline-flex items-center gap-1 text-xs text-emerald-400 hover:text-emerald-300 mt-1">
                            <iconify-icon icon="lucide:copy" class="text-[10px]"></iconify-icon>
                            Copy Coordinates
                        </button>
                    </div>
                    
                    <div id="logistics-module">
                        <div class="flex items-center gap-2 mb-4">
                            <iconify-icon icon="lucide:route" class="text-neutral-500"></iconify-icon>
                            <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Routes via Engine</span>
                        </div>
                        <div id="route-options" class="flex flex-col gap-2"></div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error("Analysis failed:", error);
        document.getElementById('side-title').innerText = "Target Location";
        document.getElementById('sidebar-content').innerHTML = `
            <div class="space-y-6">
                <div class="h-32 rounded-xl bg-gradient-to-br from-gray-900 to-black border border-white/10 flex items-center justify-center">
                    <div class="text-center">
                        <iconify-icon icon="lucide:map-pin" class="text-3xl text-white/30 mb-2"></iconify-icon>
                        <div class="text-sm text-white/50">Selected Location</div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <iconify-icon icon="lucide:map-pin" class="text-neutral-500"></iconify-icon>
                        <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Coordinates</span>
                    </div>
                    <p class="text-xs text-neutral-300 leading-relaxed">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                </div>
                
                <div id="logistics-module">
                    <div class="flex items-center gap-2 mb-4">
                        <iconify-icon icon="lucide:route" class="text-neutral-500"></iconify-icon>
                        <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest">Routes via Engine</span>
                    </div>
                    <div id="route-options" class="flex flex-col gap-2"></div>
                </div>
            </div>
        `;
    }
    
    calculateRoutes(getCurrentStartPoint(), [lat, lng]);
}

function copyToClipboard(text, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    let button;
    if (event && event.currentTarget) {
        button = event.currentTarget;
    } else if (event && event.target) {
        button = event.target.closest('button');
    }
    
    if (!button && event) {
        let element = event.target;
        while (element && element !== document.body) {
            if (element.tagName === 'BUTTON') {
                button = element;
                break;
            }
            element = element.parentElement;
        }
    }
    
    if (!button) {
        const buttons = document.querySelectorAll('button');
        for (let i = buttons.length - 1; i >= 0; i--) {
            if (buttons[i].textContent.includes('Copy')) {
                button = buttons[i];
                break;
            }
        }
    }
    
    let originalHTML = null;
    let originalClasses = null;
    
    if (button) {
        originalHTML = button.innerHTML;
        originalClasses = Array.from(button.classList);
        
        button.innerHTML = `
            <iconify-icon icon="lucide:check" class="text-[10px]"></iconify-icon>
            Copied!
        `;
        button.classList.remove('text-emerald-400', 'hover:text-emerald-300');
        button.classList.add('text-green-400');

        button.disabled = true;
    }
    
    navigator.clipboard.writeText(text).then(() => {
        console.log('Copied to clipboard:', text);
        
        if (button) {
            setTimeout(() => {
                if (originalHTML) {
                    button.innerHTML = originalHTML;
                }
                if (originalClasses) {
                    button.classList.remove('text-green-400');
                    originalClasses.forEach(cls => button.classList.add(cls));
                }
                button.disabled = false;
            }, 2000);
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        
        if (button) {
            if (originalHTML) {
                button.innerHTML = originalHTML;
            }
            if (originalClasses) {
                button.classList.remove('text-green-400');
                originalClasses.forEach(cls => button.classList.add(cls));
            }
            button.disabled = false;
            
            button.classList.add('text-red-400');
            setTimeout(() => {
                button.classList.remove('text-red-400');
            }, 1000);
        }
    });
}
 
    async function fetchGraphHopperRoute(start, end, mode) {
        try {
            const vehicle = mode === 'driving' ? 'car' : 
                           mode === 'cycling' ? 'bike' : 'foot';
            
            const response = await fetch(
                `https://graphhopper.com/api/1/route?point=${start[0]},${start[1]}&point=${end[0]},${end[1]}&vehicle=${vehicle}&locale=en&instructions=true&points_encoded=false&key=demo`
            );
            
            const data = await response.json();
            
            if (data.paths && data.paths.length > 0) {
                return {
                    distance: data.paths[0].distance,
                    duration: data.paths[0].time / 1000,
                    geometry: {
                        type: "LineString",
                        coordinates: data.paths[0].points.coordinates
                    },
                    legs: []
                };
            }
            
            throw new Error('GraphHopper no route');
            
        } catch (error) {
            throw error;
        }
    }

    async function getICOAirports() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat');
            const data = await response.text();
            
            const airports = [];
            const lines = data.split('\n');
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                const fields = line.split(',');
                if (fields.length >= 14) {
                    const name = fields[1].replace(/"/g, '');
                    const city = fields[2].replace(/"/g, '');
                    const country = fields[3].replace(/"/g, '');
                    const iata = fields[4].replace(/"/g, '');
                    const icao = fields[5].replace(/"/g, '');
                    const lat = parseFloat(fields[6]);
                    const lng = parseFloat(fields[7]);
                    
                    if (iata && iata.length === 3 && 
                        !isNaN(lat) && !isNaN(lng) &&
                        (icao || name.includes('International') || name.includes('Airport'))) {
                        
                        airports.push({
                            code: iata,
                            icao: icao,
                            name: name,
                            city: city,
                            country: country,
                            coordinates: [lat, lng],
                            size: estimateAirportSize(name, city, country)
                        });
                    }
                }
            }
            
            const filteredAirports = airports.filter(airport => {
                const name = airport.name.toLowerCase();
                const isMajor = (
                    name.includes('international') ||
                    (airport.size === 'large' || airport.size === 'medium') ||
                    isMajorCity(airport.city, airport.country)
                );
                
                const isMilitary = (
                    name.includes('air force') ||
                    name.includes('space force') ||
                    name.includes('naval') ||
                    name.includes('army') ||
                    name.includes('military') ||
                    name.includes('afb') ||
                    name.includes('airbase') ||
                    airport.code.includes('X') ||
                    name.includes('air station')
                );
                
                return isMajor && !isMilitary;
            });
            
            return filteredAirports;
            
        } catch (error) {
            return getVerifiedCommercialAirports();
        }
    }

    function estimateAirportSize(name, city, country) {
        const nameLower = name.toLowerCase();
        
        if (nameLower.includes('international') || 
            ['JFK', 'LAX', 'LHR', 'CDG', 'DXB', 'SIN', 'HND', 'PEK', 'PVG'].some(code => 
                name.includes(code))) {
            return 'large';
        }
        
        if (nameLower.includes('regional') || 
            nameLower.includes('municipal') ||
            cityPopulationLookup(city, country) > 500000) {
            return 'medium';
        }
        
        return 'small';
    }

    async function findBestAirportForRoute(startCoords, endCoords) {
        const airports = await getCommercialAirports();
        
        const startAirports = airports
            .map(airport => ({
                ...airport,
                distance: map.distance(startCoords, airport.coordinates),
                score: calculateAirportScore(airport, startCoords)
            }))
            .filter(a => a.distance < 150000)
            .sort((a, b) => b.score - a.score);
        
        const endAirports = airports
            .map(airport => ({
                ...airport,
                distance: map.distance(endCoords, airport.coordinates),
                score: calculateAirportScore(airport, endCoords)
            }))
            .filter(a => a.distance < 150000)
            .sort((a, b) => b.score - a.score);
        
        if (startAirports.length === 0 || endAirports.length === 0) {
            return null;
        }
        
        const startAirport = startAirports[0];
        const endAirport = endAirports[0];
        
        const airportDistance = map.distance(startAirport.coordinates, endAirport.coordinates);
        if (airportDistance < 300000) {
            return null;
        }
        
        return { start: startAirport, end: endAirport };
    }

    function calculateAirportScore(airport, userCoords) {
        const distance = map.distance(userCoords, airport.coordinates);
        
        let score = 0;
        
        if (isMajorInternationalAirport(airport)) {
            score += 500;
        }
        
        if (airport.size === 'large') score += 200;
        else if (airport.size === 'medium') score += 100;
        else if (airport.size === 'small') score += 50;
        
        if (airport.name.toLowerCase().includes('international')) {
            score += 150;
        }
        
        const majorAirportCodes = ['SEA', 'JFK', 'LAX', 'ORD', 'DFW', 'LHR', 'CDG', 'FRA', 'AMS', 'HND', 'PEK', 'PVG'];
        if (majorAirportCodes.includes(airport.code)) {
            score += 300;
        }
        
        const distancePenalty = distance / 1000;
        score -= distancePenalty;
        
        return score;
    }

    function isMajorInternationalAirport(airport) {
        const majorInternationalAirports = [
            'ATL','LAX','ORD','DFW','DEN','JFK','SFO','SEA','LAS','MCO','MIA','CLT','EWR','PHX',
            'IAH','BOS','MSP','DTW','PHL','SAN','TPA','PDX','BWI','IAD','DCA','SJC','OAK',
            'AUS','SAT','DAL','HOU','CLE','CMH','CVG','IND','STL','MCI','SMF','SNA','ONT',
            'BUR','LGB','PSP','RNO','BOI','SLC','ABQ','ELP','TUS','OKC','TUL','OMA','DSM',
            'MSY','BTR','GPT','MOB','BHM','HSV','CHA','TYS','AVL','GSP','CAE','CHS','SAV',
            'JAX','RSW','PBI','FLL','EYW','ORF','RIC','ROA','LYH','GSO','RDU','ILM', 'YYZ','YVR','YUL','YYC','YEG','YOW','YWG','YHZ','YQB','YYT','YXE','YLW', 'MEX','CUN','GDL','MTY','TIJ','SJD','PVR','MZT','HMO','LAP','LHR','LGW','STN','LTN','MAN','EDI','GLA','BHX','BRS','DUB','SNN','ORK','CDG','ORY','NCE','LYS','MRS','TLS','BOD','AMS','BRU','CRL','MAD','BCN','PMI','AGP','ALC','SVQ','BIO','FCO','MXP','LIN','BGY','VCE','NAP','CTA','PMO','BLQ','FCO','MXP','LIN','BGY','VCE','NAP','CTA','PMO','BLQ','ZRH','GVA','BSL','VIE','SZG','INN','ARN','OSL','CPH','HEL','GOT','TRD','SVG','TMP','ATH','SKG','HER','CFU','BEG','ZAG','LJU','SJJ','TIA','SOF','IST','SAW','AYT','ADB','HND','NRT','KIX','ITM','NGO','FUK','CTS','OKA','PEK','PKX','PVG','SHA','CAN','SZX','CTU','XIY','HGH','NKG',
            'WUH','CSX','KMG','URC','TSN','CGO','ICN','GMP','PUS','CJU','SIN','HKG','BKK','DMK','HKT','CNX','DEL','BOM','BLR','MAA','HYD','CCU','COK','TRV','AMD','PNQ','KUL','PEN','CGK','DPS','SUB','MNL','CEB','DVO','TPE','KHH','SGN','HAN','DAD','DXB','DWC','AUH','SHJ','DOH','RUH','JED','DMM','KWI',
            'BAH','MCT','AMM','TLV','BEY','CAI','JNB','CPT','DUR','PLZ','LOS','ABV','ACC','ADD','NBO',
            'DAR','KGL','EBB','CMN','RAK','TUN','ALG','TIP','CAI','GRU','CGH','GIG','BSB','CNF','SSA','REC','FOR',
            'EZE','AEP','COR','MDZ','SCL','LIM','BOG','MDE',
            'UIO','GYE','CCS','PTY','MVD','ASU','LPB','VVI','SYD','MEL','BNE','PER','ADL','CBR','OOL','CNS',
            'AKL','WLG','CHC','ZQN','NAN','PPT'
        ];
        
        return majorInternationalAirports.includes(airport.code) || 
               airport.name.toLowerCase().includes('international') ||
               airport.size === 'large';
    }

function getCommercialAirports() {
    return [
        { code: "ATL", name: "Hartsfield-Jackson Atlanta International", city: "Atlanta", country: "USA", coordinates: [33.6407, -84.4277], size: "large" },
        { code: "LAX", name: "Los Angeles International", city: "Los Angeles", country: "USA", coordinates: [33.9416, -118.4085], size: "large" },
        { code: "ORD", name: "O'Hare International", city: "Chicago", country: "USA", coordinates: [41.9742, -87.9073], size: "large" },
        { code: "DFW", name: "Dallas/Fort Worth International", city: "Dallas", country: "USA", coordinates: [32.8998, -97.0403], size: "large" },
        { code: "DEN", name: "Denver International", city: "Denver", country: "USA", coordinates: [39.8561, -104.6737], size: "large" },
        { code: "JFK", name: "John F. Kennedy International", city: "New York", country: "USA", coordinates: [40.6413, -73.7781], size: "large" },
        { code: "SFO", name: "San Francisco International", city: "San Francisco", country: "USA", coordinates: [37.6213, -122.3790], size: "large" },
        { code: "SEA", name: "Seattle-Tacoma International", city: "Seattle", country: "USA", coordinates: [47.4502, -122.3088], size: "large" },
        { code: "LAS", name: "Harry Reid International", city: "Las Vegas", country: "USA", coordinates: [36.0840, -115.1537], size: "large" },
        { code: "MCO", name: "Orlando International", city: "Orlando", country: "USA", coordinates: [28.4294, -81.3090], size: "large" },
        { code: "MIA", name: "Miami International", city: "Miami", country: "USA", coordinates: [25.7959, -80.2870], size: "large" },
        { code: "CLT", name: "Charlotte Douglas International", city: "Charlotte", country: "USA", coordinates: [35.2140, -80.9431], size: "large" },
        { code: "EWR", name: "Newark Liberty International", city: "Newark", country: "USA", coordinates: [40.6895, -74.1745], size: "large" },
        { code: "PHX", name: "Phoenix Sky Harbor International", city: "Phoenix", country: "USA", coordinates: [33.4343, -112.0081], size: "large" },
        { code: "IAH", name: "George Bush Intercontinental", city: "Houston", country: "USA", coordinates: [29.9844, -95.3414], size: "large" },
        { code: "BOS", name: "Logan International", city: "Boston", country: "USA", coordinates: [42.3643, -71.0052], size: "large" },
        { code: "MSP", name: "Minneapolis-Saint Paul International", city: "Minneapolis", country: "USA", coordinates: [44.8820, -93.2218], size: "large" },
        { code: "DTW", name: "Detroit Metropolitan", city: "Detroit", country: "USA", coordinates: [42.2124, -83.3534], size: "large" },
        { code: "PHL", name: "Philadelphia International", city: "Philadelphia", country: "USA", coordinates: [39.8719, -75.2411], size: "large" },
        { code: "SAN", name: "San Diego International", city: "San Diego", country: "USA", coordinates: [32.7338, -117.1933], size: "large" },
        { code: "TPA", name: "Tampa International", city: "Tampa", country: "USA", coordinates: [27.9759, -82.5338], size: "large" },
        { code: "PDX", name: "Portland International", city: "Portland", country: "USA", coordinates: [45.5887, -122.5975], size: "large" },
        { code: "BWI", name: "Baltimore/Washington International", city: "Baltimore", country: "USA", coordinates: [39.1754, -76.6683], size: "large" },
        { code: "IAD", name: "Washington Dulles International", city: "Washington", country: "USA", coordinates: [38.9445, -77.4558], size: "large" },
        { code: "DCA", name: "Ronald Reagan Washington National", city: "Washington", country: "USA", coordinates: [38.8521, -77.0377], size: "medium" },
        { code: "SJC", name: "San Jose International", city: "San Jose", country: "USA", coordinates: [37.3626, -121.9290], size: "medium" },
        { code: "OAK", name: "Oakland International", city: "Oakland", country: "USA", coordinates: [37.7213, -122.2207], size: "medium" },
        { code: "AUS", name: "Austin-Bergstrom International", city: "Austin", country: "USA", coordinates: [30.1975, -97.6664], size: "medium" },
        { code: "SAT", name: "San Antonio International", city: "San Antonio", country: "USA", coordinates: [29.5337, -98.4698], size: "medium" },
        { code: "DAL", name: "Dallas Love Field", city: "Dallas", country: "USA", coordinates: [32.8471, -96.8518], size: "medium" },
        { code: "HOU", name: "William P. Hobby", city: "Houston", country: "USA", coordinates: [29.6454, -95.2789], size: "medium" },
        { code: "CLE", name: "Cleveland Hopkins International", city: "Cleveland", country: "USA", coordinates: [41.4117, -81.8498], size: "medium" },
        { code: "CMH", name: "John Glenn Columbus International", city: "Columbus", country: "USA", coordinates: [39.9980, -82.8919], size: "medium" },
        { code: "CVG", name: "Cincinnati/Northern Kentucky International", city: "Cincinnati", country: "USA", coordinates: [39.0488, -84.6678], size: "medium" },
        { code: "IND", name: "Indianapolis International", city: "Indianapolis", country: "USA", coordinates: [39.7173, -86.2946], size: "medium" },
        { code: "STL", name: "St. Louis Lambert International", city: "St. Louis", country: "USA", coordinates: [38.7487, -90.3700], size: "medium" },
        { code: "MCI", name: "Kansas City International", city: "Kansas City", country: "USA", coordinates: [39.2976, -94.7139], size: "medium" },
        { code: "SMF", name: "Sacramento International", city: "Sacramento", country: "USA", coordinates: [38.6954, -121.5908], size: "medium" },
        { code: "SNA", name: "John Wayne Airport", city: "Santa Ana", country: "USA", coordinates: [33.6757, -117.8682], size: "medium" },
        { code: "ONT", name: "Ontario International", city: "Ontario", country: "USA", coordinates: [34.0560, -117.6012], size: "medium" },
        { code: "BUR", name: "Bob Hope Airport", city: "Burbank", country: "USA", coordinates: [34.2006, -118.3585], size: "small" },
        { code: "LGB", name: "Long Beach Airport", city: "Long Beach", country: "USA", coordinates: [33.8177, -118.1515], size: "small" },
        { code: "PSP", name: "Palm Springs International", city: "Palm Springs", country: "USA", coordinates: [33.8297, -116.5066], size: "small" },
        { code: "RNO", name: "Reno-Tahoe International", city: "Reno", country: "USA", coordinates: [39.4991, -119.7681], size: "medium" },
        { code: "BOI", name: "Boise Airport", city: "Boise", country: "USA", coordinates: [43.5644, -116.2229], size: "medium" },
        { code: "SLC", name: "Salt Lake City International", city: "Salt Lake City", country: "USA", coordinates: [40.7884, -111.9778], size: "large" },
        { code: "ABQ", name: "Albuquerque International Sunport", city: "Albuquerque", country: "USA", coordinates: [35.0402, -106.6091], size: "medium" },
        { code: "ELP", name: "El Paso International", city: "El Paso", country: "USA", coordinates: [31.8072, -106.3776], size: "medium" },
        { code: "TUS", name: "Tucson International", city: "Tucson", country: "USA", coordinates: [32.1161, -110.9410], size: "medium" },
        { code: "OKC", name: "Will Rogers World Airport", city: "Oklahoma City", country: "USA", coordinates: [35.3931, -97.6007], size: "medium" },
        { code: "TUL", name: "Tulsa International", city: "Tulsa", country: "USA", coordinates: [36.1984, -95.8881], size: "medium" },
        { code: "OMA", name: "Eppley Airfield", city: "Omaha", country: "USA", coordinates: [41.3025, -95.8942], size: "medium" },
        { code: "DSM", name: "Des Moines International", city: "Des Moines", country: "USA", coordinates: [41.5340, -93.6631], size: "medium" },
        { code: "MSY", name: "Louis Armstrong New Orleans International", city: "New Orleans", country: "USA", coordinates: [29.9934, -90.2580], size: "medium" },
        { code: "BTR", name: "Baton Rouge Metropolitan", city: "Baton Rouge", country: "USA", coordinates: [30.5332, -91.1496], size: "small" },
        { code: "GPT", name: "Gulfport-Biloxi International", city: "Gulfport", country: "USA", coordinates: [30.4073, -89.0701], size: "small" },
        { code: "MOB", name: "Mobile Regional Airport", city: "Mobile", country: "USA", coordinates: [30.6914, -88.2428], size: "small" },
        { code: "BHM", name: "Birmingham-Shuttlesworth International", city: "Birmingham", country: "USA", coordinates: [33.5629, -86.7535], size: "medium" },
        { code: "HSV", name: "Huntsville International", city: "Huntsville", country: "USA", coordinates: [34.6372, -86.7751], size: "medium" },
        { code: "CHA", name: "Chattanooga Metropolitan", city: "Chattanooga", country: "USA", coordinates: [35.0353, -85.2038], size: "small" },
        { code: "TYS", name: "McGhee Tyson Airport", city: "Knoxville", country: "USA", coordinates: [35.8110, -83.9940], size: "medium" },
        { code: "AVL", name: "Asheville Regional", city: "Asheville", country: "USA", coordinates: [35.4362, -82.5418], size: "medium" },
        { code: "GSP", name: "Greenville-Spartanburg International", city: "Greenville", country: "USA", coordinates: [34.8957, -82.2189], size: "medium" },
        { code: "CAE", name: "Columbia Metropolitan", city: "Columbia", country: "USA", coordinates: [33.9388, -81.1195], size: "medium" },
        { code: "CHS", name: "Charleston International", city: "Charleston", country: "USA", coordinates: [32.8986, -80.0405], size: "medium" },
        { code: "SAV", name: "Savannah/Hilton Head International", city: "Savannah", country: "USA", coordinates: [32.1276, -81.2021], size: "medium" },
        { code: "JAX", name: "Jacksonville International", city: "Jacksonville", country: "USA", coordinates: [30.4941, -81.6879], size: "medium" },
        { code: "RSW", name: "Southwest Florida International", city: "Fort Myers", country: "USA", coordinates: [26.5362, -81.7552], size: "medium" },
        { code: "PBI", name: "Palm Beach International", city: "West Palm Beach", country: "USA", coordinates: [26.6832, -80.0956], size: "medium" },
        { code: "FLL", name: "Fort Lauderdale-Hollywood International", city: "Fort Lauderdale", country: "USA", coordinates: [26.0742, -80.1506], size: "large" },
        { code: "EYW", name: "Key West International", city: "Key West", country: "USA", coordinates: [24.5561, -81.7596], size: "small" },
        { code: "ORF", name: "Norfolk International", city: "Norfolk", country: "USA", coordinates: [36.8946, -76.2012], size: "medium" },
        { code: "RIC", name: "Richmond International", city: "Richmond", country: "USA", coordinates: [37.5052, -77.3197], size: "medium" },
        { code: "ROA", name: "Roanoke-Blacksburg Regional", city: "Roanoke", country: "USA", coordinates: [37.3255, -79.9754], size: "small" },
        { code: "LYH", name: "Lynchburg Regional", city: "Lynchburg", country: "USA", coordinates: [37.3267, -79.2004], size: "small" },
        { code: "GSO", name: "Piedmont Triad International", city: "Greensboro", country: "USA", coordinates: [36.0978, -79.9373], size: "medium" },
        { code: "RDU", name: "Raleigh-Durham International", city: "Raleigh", country: "USA", coordinates: [35.8776, -78.7875], size: "large" },
        { code: "ILM", name: "Wilmington International", city: "Wilmington", country: "USA", coordinates: [34.2706, -77.9026], size: "small" },
        
        { code: "YYZ", name: "Toronto Pearson International", city: "Toronto", country: "Canada", coordinates: [43.6777, -79.6248], size: "large" },
        { code: "YVR", name: "Vancouver International", city: "Vancouver", country: "Canada", coordinates: [49.1947, -123.1792], size: "large" },
        { code: "YUL", name: "Montréal-Trudeau International", city: "Montreal", country: "Canada", coordinates: [45.4706, -73.7408], size: "large" },
        { code: "YYC", name: "Calgary International", city: "Calgary", country: "Canada", coordinates: [51.1215, -114.0076], size: "large" },
        { code: "YEG", name: "Edmonton International", city: "Edmonton", country: "Canada", coordinates: [53.3097, -113.5794], size: "large" },
        { code: "YOW", name: "Ottawa Macdonald-Cartier International", city: "Ottawa", country: "Canada", coordinates: [45.3225, -75.6692], size: "medium" },
        { code: "YWG", name: "Winnipeg James Armstrong Richardson International", city: "Winnipeg", country: "Canada", coordinates: [49.9100, -97.2399], size: "medium" },
        { code: "YHZ", name: "Halifax Stanfield International", city: "Halifax", country: "Canada", coordinates: [44.8808, -63.5086], size: "medium" },
        { code: "YQB", name: "Québec City Jean Lesage International", city: "Quebec City", country: "Canada", coordinates: [46.7911, -71.3933], size: "medium" },
        { code: "YYT", name: "St. John's International", city: "St. John's", country: "Canada", coordinates: [47.6186, -52.7519], size: "medium" },
        { code: "YXE", name: "Saskatoon John G. Diefenbaker International", city: "Saskatoon", country: "Canada", coordinates: [52.1708, -106.6997], size: "medium" },
        { code: "YLW", name: "Kelowna International", city: "Kelowna", country: "Canada", coordinates: [49.9561, -119.3778], size: "medium" },
        
        { code: "MEX", name: "Mexico City International", city: "Mexico City", country: "Mexico", coordinates: [19.4363, -99.0721], size: "large" },
        { code: "CUN", name: "Cancún International", city: "Cancún", country: "Mexico", coordinates: [21.0365, -86.8771], size: "large" },
        { code: "GDL", name: "Guadalajara International", city: "Guadalajara", country: "Mexico", coordinates: [20.5218, -103.3112], size: "large" },
        { code: "MTY", name: "Monterrey International", city: "Monterrey", country: "Mexico", coordinates: [25.7785, -100.1069], size: "large" },
        { code: "TIJ", name: "Tijuana International", city: "Tijuana", country: "Mexico", coordinates: [32.5411, -116.9702], size: "large" },
        { code: "SJD", name: "Los Cabos International", city: "San José del Cabo", country: "Mexico", coordinates: [23.1518, -109.7210], size: "large" },
        { code: "PVR", name: "Puerto Vallarta International", city: "Puerto Vallarta", country: "Mexico", coordinates: [20.6801, -105.2542], size: "medium" },
        { code: "MZT", name: "Mazatlán International", city: "Mazatlán", country: "Mexico", coordinates: [23.1614, -106.2661], size: "medium" },
        { code: "HMO", name: "Hermosillo International", city: "Hermosillo", country: "Mexico", coordinates: [29.0959, -111.0478], size: "medium" },
        { code: "LAP", name: "La Paz International", city: "La Paz", country: "Mexico", coordinates: [24.0727, -110.3625], size: "medium" },

        { code: "LHR", name: "London Heathrow", city: "London", country: "UK", coordinates: [51.4700, -0.4543], size: "large" },
        { code: "LGW", name: "London Gatwick", city: "London", country: "UK", coordinates: [51.1481, -0.1903], size: "large" },
        { code: "STN", name: "London Stansted", city: "London", country: "UK", coordinates: [51.8850, 0.2350], size: "large" },
        { code: "LTN", name: "London Luton", city: "London", country: "UK", coordinates: [51.8747, -0.3683], size: "medium" },
        { code: "MAN", name: "Manchester Airport", city: "Manchester", country: "UK", coordinates: [53.3497, -2.2803], size: "large" },
        { code: "EDI", name: "Edinburgh Airport", city: "Edinburgh", country: "UK", coordinates: [55.9500, -3.3725], size: "large" },
        { code: "GLA", name: "Glasgow International", city: "Glasgow", country: "UK", coordinates: [55.8722, -4.4331], size: "large" },
        { code: "BHX", name: "Birmingham Airport", city: "Birmingham", country: "UK", coordinates: [52.4539, -1.7480], size: "large" },
        { code: "BRS", name: "Bristol Airport", city: "Bristol", country: "UK", coordinates: [51.3827, -2.7191], size: "medium" },
        
        { code: "DUB", name: "Dublin Airport", city: "Dublin", country: "Ireland", coordinates: [53.4213, -6.2701], size: "large" },
        { code: "SNN", name: "Shannon Airport", city: "Shannon", country: "Ireland", coordinates: [52.7020, -8.9248], size: "medium" },
        { code: "ORK", name: "Cork Airport", city: "Cork", country: "Ireland", coordinates: [51.8413, -8.4911], size: "medium" },

        { code: "CDG", name: "Paris Charles de Gaulle", city: "Paris", country: "France", coordinates: [49.0097, 2.5479], size: "large" },
        { code: "ORY", name: "Paris Orly", city: "Paris", country: "France", coordinates: [48.7253, 2.3594], size: "large" },
        { code: "NCE", name: "Nice Côte d'Azur", city: "Nice", country: "France", coordinates: [43.6584, 7.2159], size: "large" },
        { code: "LYS", name: "Lyon-Saint Exupéry", city: "Lyon", country: "France", coordinates: [45.7256, 5.0811], size: "large" },
        { code: "MRS", name: "Marseille Provence", city: "Marseille", country: "France", coordinates: [43.4367, 5.2150], size: "large" },
        { code: "TLS", name: "Toulouse-Blagnac", city: "Toulouse", country: "France", coordinates: [43.6291, 1.3638], size: "large" },
        { code: "BOD", name: "Bordeaux-Mérignac", city: "Bordeaux", country: "France", coordinates: [44.8283, -0.7156], size: "large" },
        
        { code: "AMS", name: "Amsterdam Schiphol", city: "Amsterdam", country: "Netherlands", coordinates: [52.3086, 4.7639], size: "large" },
        
        { code: "BRU", name: "Brussels Airport", city: "Brussels", country: "Belgium", coordinates: [50.9014, 4.4844], size: "large" },
        { code: "CRL", name: "Brussels South Charleroi", city: "Charleroi", country: "Belgium", coordinates: [50.4592, 4.4538], size: "medium" },
        
        { code: "MAD", name: "Adolfo Suárez Madrid–Barajas", city: "Madrid", country: "Spain", coordinates: [40.4983, -3.5676], size: "large" },
        { code: "BCN", name: "Josep Tarradellas Barcelona–El Prat", city: "Barcelona", country: "Spain", coordinates: [41.2974, 2.0833], size: "large" },
        { code: "PMI", name: "Palma de Mallorca", city: "Palma", country: "Spain", coordinates: [39.5517, 2.7388], size: "large" },
        { code: "AGP", name: "Málaga-Costa del Sol", city: "Málaga", country: "Spain", coordinates: [36.6749, -4.4991], size: "large" },
        { code: "ALC", name: "Alicante–Elche", city: "Alicante", country: "Spain", coordinates: [38.2822, -0.5582], size: "large" },
        { code: "SVQ", name: "Seville", city: "Seville", country: "Spain", coordinates: [37.4180, -5.8931], size: "medium" },
        { code: "BIO", name: "Bilbao", city: "Bilbao", country: "Spain", coordinates: [43.3011, -2.9106], size: "medium" },
        
        { code: "FCO", name: "Rome–Fiumicino", city: "Rome", country: "Italy", coordinates: [41.8045, 12.2508], size: "large" },
        { code: "MXP", name: "Milan–Malpensa", city: "Milan", country: "Italy", coordinates: [45.6306, 8.7281], size: "large" },
        { code: "LIN", name: "Milan–Linate", city: "Milan", country: "Italy", coordinates: [45.4451, 9.2767], size: "medium" },
        { code: "BGY", name: "Milan–Bergamo", city: "Bergamo", country: "Italy", coordinates: [45.6739, 9.7042], size: "medium" },
        { code: "VCE", name: "Venice Marco Polo", city: "Venice", country: "Italy", coordinates: [45.5053, 12.3519], size: "large" },
        { code: "NAP", name: "Naples International", city: "Naples", country: "Italy", coordinates: [40.8860, 14.2908], size: "large" },
        { code: "CTA", name: "Catania–Fontanarossa", city: "Catania", country: "Italy", coordinates: [37.4668, 15.0664], size: "large" },
        { code: "PMO", name: "Palermo Falcone Borsellino", city: "Palermo", country: "Italy", coordinates: [38.1810, 13.0993], size: "large" },
        { code: "BLQ", name: "Bologna Guglielmo Marconi", city: "Bologna", country: "Italy", coordinates: [44.5354, 11.2887], size: "medium" },
        
        { code: "ZRH", name: "Zurich Airport", city: "Zurich", country: "Switzerland", coordinates: [47.4647, 8.5492], size: "large" },
        { code: "GVA", name: "Geneva Airport", city: "Geneva", country: "Switzerland", coordinates: [46.2381, 6.1089], size: "large" },
        { code: "BSL", name: "EuroAirport Basel-Mulhouse-Freiburg", city: "Basel", country: "Switzerland", coordinates: [47.5896, 7.5299], size: "medium" },
        
        { code: "VIE", name: "Vienna International", city: "Vienna", country: "Austria", coordinates: [48.1103, 16.5697], size: "large" },
        { code: "SZG", name: "Salzburg Airport", city: "Salzburg", country: "Austria", coordinates: [47.7933, 13.0043], size: "medium" },
        { code: "INN", name: "Innsbruck Airport", city: "Innsbruck", country: "Austria", coordinates: [47.2602, 11.3440], size: "medium" },
        
        { code: "ARN", name: "Stockholm Arlanda", city: "Stockholm", country: "Sweden", coordinates: [59.6519, 17.9186], size: "large" },
        { code: "OSL", name: "Oslo Gardermoen", city: "Oslo", country: "Norway", coordinates: [60.1939, 11.1004], size: "large" },
        { code: "CPH", name: "Copenhagen Airport", city: "Copenhagen", country: "Denmark", coordinates: [55.6180, 12.6561], size: "large" },
        { code: "HEL", name: "Helsinki Airport", city: "Helsinki", country: "Finland", coordinates: [60.3172, 24.9633], size: "large" },
        { code: "GOT", name: "Göteborg Landvetter", city: "Gothenburg", country: "Sweden", coordinates: [57.6628, 12.2798], size: "medium" },
        { code: "TRD", name: "Trondheim Airport", city: "Trondheim", country: "Norway", coordinates: [63.4576, 10.9243], size: "medium" },
        { code: "SVG", name: "Stavanger Airport", city: "Stavanger", country: "Norway", coordinates: [58.8768, 5.6379], size: "medium" },
        { code: "TMP", name: "Tampere-Pirkkala", city: "Tampere", country: "Finland", coordinates: [61.4141, 23.6044], size: "medium" },
        
        { code: "ATH", name: "Athens International", city: "Athens", country: "Greece", coordinates: [37.9364, 23.9445], size: "large" },
        { code: "SKG", name: "Thessaloniki Airport", city: "Thessaloniki", country: "Greece", coordinates: [40.5197, 22.9709], size: "large" },
        { code: "HER", name: "Heraklion International", city: "Heraklion", country: "Greece", coordinates: [35.3397, 25.1803], size: "large" },
        { code: "CFU", name: "Corfu International", city: "Corfu", country: "Greece", coordinates: [39.6019, 19.9117], size: "medium" },
        
        { code: "BEG", name: "Belgrade Nikola Tesla", city: "Belgrade", country: "Serbia", coordinates: [44.8194, 20.3069], size: "large" },
        { code: "ZAG", name: "Zagreb Airport", city: "Zagreb", country: "Croatia", coordinates: [45.7429, 16.0688], size: "medium" },
        { code: "LJU", name: "Ljubljana Jože Pučnik", city: "Ljubljana", country: "Slovenia", coordinates: [46.2237, 14.4576], size: "medium" },
        { code: "SJJ", name: "Sarajevo International", city: "Sarajevo", country: "Bosnia", coordinates: [43.8246, 18.3315], size: "medium" },
        { code: "TIA", name: "Tirana International", city: "Tirana", country: "Albania", coordinates: [41.4147, 19.7206], size: "medium" },
        { code: "SOF", name: "Sofia Airport", city: "Sofia", country: "Bulgaria", coordinates: [42.6952, 23.4062], size: "large" },
        
        { code: "IST", name: "Istanbul Airport", city: "Istanbul", country: "Turkey", coordinates: [41.2622, 28.7425], size: "large" },
        { code: "SAW", name: "Istanbul Sabiha Gökçen", city: "Istanbul", country: "Turkey", coordinates: [40.8986, 29.3092], size: "large" },
        { code: "AYT", name: "Antalya Airport", city: "Antalya", country: "Turkey", coordinates: [36.8987, 30.8005], size: "large" },
        { code: "ADB", name: "İzmir Adnan Menderes", city: "Izmir", country: "Turkey", coordinates: [38.2924, 27.1569], size: "large" },
        
        { code: "HND", name: "Tokyo Haneda", city: "Tokyo", country: "Japan", coordinates: [35.5494, 139.7798], size: "large" },
        { code: "NRT", name: "Tokyo Narita", city: "Tokyo", country: "Japan", coordinates: [35.7647, 140.3864], size: "large" },
        { code: "KIX", name: "Kansai International", city: "Osaka", country: "Japan", coordinates: [34.4273, 135.2441], size: "large" },
        { code: "ITM", name: "Osaka International", city: "Osaka", country: "Japan", coordinates: [34.7855, 135.4382], size: "large" },
        { code: "NGO", name: "Chubu Centrair International", city: "Nagoya", country: "Japan", coordinates: [34.8584, 136.8054], size: "large" },
        { code: "FUK", name: "Fukuoka Airport", city: "Fukuoka", country: "Japan", coordinates: [33.5859, 130.4507], size: "large" },
        { code: "CTS", name: "New Chitose Airport", city: "Sapporo", country: "Japan", coordinates: [42.7752, 141.6923], size: "large" },
        { code: "OKA", name: "Naha Airport", city: "Naha", country: "Japan", coordinates: [26.1958, 127.6459], size: "large" },
        
        { code: "PEK", name: "Beijing Capital International", city: "Beijing", country: "China", coordinates: [40.0799, 116.6031], size: "large" },
        { code: "PKX", name: "Beijing Daxing International", city: "Beijing", country: "China", coordinates: [39.5098, 116.4105], size: "large" },
        { code: "PVG", name: "Shanghai Pudong International", city: "Shanghai", country: "China", coordinates: [31.1434, 121.8052], size: "large" },
        { code: "SHA", name: "Shanghai Hongqiao International", city: "Shanghai", country: "China", coordinates: [31.1979, 121.3363], size: "large" },
        { code: "CAN", name: "Guangzhou Baiyun International", city: "Guangzhou", country: "China", coordinates: [23.3924, 113.2988], size: "large" },
        { code: "SZX", name: "Shenzhen Bao'an International", city: "Shenzhen", country: "China", coordinates: [22.6393, 113.8106], size: "large" },
        { code: "CTU", name: "Chengdu Shuangliu International", city: "Chengdu", country: "China", coordinates: [30.5785, 103.9471], size: "large" },
        { code: "XIY", name: "Xi'an Xianyang International", city: "Xi'an", country: "China", coordinates: [34.4471, 108.7516], size: "large" },
        { code: "HGH", name: "Hangzhou Xiaoshan International", city: "Hangzhou", country: "China", coordinates: [30.2295, 120.4345], size: "large" },
        { code: "NKG", name: "Nanjing Lukou International", city: "Nanjing", country: "China", coordinates: [31.7420, 118.8620], size: "large" },
        { code: "WUH", name: "Wuhan Tianhe International", city: "Wuhan", country: "China", coordinates: [30.7838, 114.2081], size: "large" },
        { code: "CSX", name: "Changsha Huanghua International", city: "Changsha", country: "China", coordinates: [28.1892, 113.2196], size: "large" },
        { code: "KMG", name: "Kunming Changshui International", city: "Kunming", country: "China", coordinates: [25.1019, 102.9292], size: "large" },
        { code: "URC", name: "Ürümqi Diwopu International", city: "Ürümqi", country: "China", coordinates: [43.9071, 87.4742], size: "large" },
        { code: "TSN", name: "Tianjin Binhai International", city: "Tianjin", country: "China", coordinates: [39.1244, 117.3464], size: "large" },
        { code: "CGO", name: "Zhengzhou Xinzheng International", city: "Zhengzhou", country: "China", coordinates: [34.5197, 113.8409], size: "large" },
        
        { code: "ICN", name: "Incheon International", city: "Seoul", country: "South Korea", coordinates: [37.4602, 126.4407], size: "large" },
        { code: "GMP", name: "Gimpo International", city: "Seoul", country: "South Korea", coordinates: [37.5583, 126.7906], size: "large" },
        { code: "PUS", name: "Gimhae International", city: "Busan", country: "South Korea", coordinates: [35.1795, 128.9382], size: "large" },
        { code: "CJU", name: "Jeju International", city: "Jeju", country: "South Korea", coordinates: [33.5113, 126.4930], size: "large" },
        
        { code: "SIN", name: "Singapore Changi", city: "Singapore", country: "Singapore", coordinates: [1.3644, 103.9915], size: "large" },
        
        { code: "HKG", name: "Hong Kong International", city: "Hong Kong", country: "China", coordinates: [22.3080, 113.9185], size: "large" },
        
        { code: "BKK", name: "Suvarnabhumi Airport", city: "Bangkok", country: "Thailand", coordinates: [13.6811, 100.7475], size: "large" },
        { code: "DMK", name: "Don Mueang International", city: "Bangkok", country: "Thailand", coordinates: [13.9126, 100.6068], size: "large" },
        { code: "HKT", name: "Phuket International", city: "Phuket", country: "Thailand", coordinates: [8.1132, 98.3169], size: "large" },
        { code: "CNX", name: "Chiang Mai International", city: "Chiang Mai", country: "Thailand", coordinates: [18.7668, 98.9626], size: "large" },
        
        { code: "DEL", name: "Indira Gandhi International", city: "Delhi", country: "India", coordinates: [28.5562, 77.1000], size: "large" },
        { code: "BOM", name: "Chhatrapati Shivaji Maharaj International", city: "Mumbai", country: "India", coordinates: [19.0887, 72.8679], size: "large" },
        { code: "BLR", name: "Kempegowda International", city: "Bangalore", country: "India", coordinates: [13.1986, 77.7066], size: "large" },
        { code: "MAA", name: "Chennai International", city: "Chennai", country: "India", coordinates: [12.9941, 80.1709], size: "large" },
        { code: "HYD", name: "Rajiv Gandhi International", city: "Hyderabad", country: "India", coordinates: [17.2403, 78.4294], size: "large" },
        { code: "CCU", name: "Netaji Subhas Chandra Bose International", city: "Kolkata", country: "India", coordinates: [22.6547, 88.4467], size: "large" },
        { code: "COK", name: "Cochin International", city: "Kochi", country: "India", coordinates: [10.1520, 76.4019], size: "large" },
        { code: "TRV", name: "Trivandrum International", city: "Thiruvananthapuram", country: "India", coordinates: [8.4821, 76.9201], size: "medium" },
        { code: "AMD", name: "Sardar Vallabhbhai Patel International", city: "Ahmedabad", country: "India", coordinates: [23.0772, 72.6346], size: "large" },
        { code: "PNQ", name: "Pune Airport", city: "Pune", country: "India", coordinates: [18.5821, 73.9197], size: "medium" },
        
        { code: "KUL", name: "Kuala Lumpur International", city: "Kuala Lumpur", country: "Malaysia", coordinates: [2.7456, 101.7099], size: "large" },
        { code: "PEN", name: "Penang International", city: "Penang", country: "Malaysia", coordinates: [5.2971, 100.2769], size: "large" },
        
        { code: "CGK", name: "Soekarno–Hatta International", city: "Jakarta", country: "Indonesia", coordinates: [-6.1256, 106.6558], size: "large" },
        { code: "DPS", name: "Ngurah Rai International", city: "Denpasar", country: "Indonesia", coordinates: [-8.7482, 115.1672], size: "large" },
        { code: "SUB", name: "Juanda International", city: "Surabaya", country: "Indonesia", coordinates: [-7.3798, 112.7869], size: "large" },
        
        { code: "MNL", name: "Ninoy Aquino International", city: "Manila", country: "Philippines", coordinates: [14.5086, 121.0196], size: "large" },
        { code: "CEB", name: "Mactan–Cebu International", city: "Cebu", country: "Philippines", coordinates: [10.3070, 123.9790], size: "large" },
        { code: "DVO", name: "Francisco Bangoy International", city: "Davao", country: "Philippines", coordinates: [7.1255, 125.6458], size: "large" },

        { code: "TPE", name: "Taiwan Taoyuan International", city: "Taipei", country: "Taiwan", coordinates: [25.0777, 121.2328], size: "large" },
        { code: "KHH", name: "Kaohsiung International", city: "Kaohsiung", country: "Taiwan", coordinates: [22.5771, 120.3500], size: "large" },
        
        { code: "SGN", name: "Tan Son Nhat International", city: "Ho Chi Minh City", country: "Vietnam", coordinates: [10.8188, 106.6520], size: "large" },
        { code: "HAN", name: "Noi Bai International", city: "Hanoi", country: "Vietnam", coordinates: [21.2212, 105.8072], size: "large" },
        { code: "DAD", name: "Da Nang International", city: "Da Nang", country: "Vietnam", coordinates: [16.0439, 108.1994], size: "large" },
        
        { code: "DXB", name: "Dubai International", city: "Dubai", country: "UAE", coordinates: [25.2532, 55.3657], size: "large" },
        { code: "DWC", name: "Al Maktoum International", city: "Dubai", country: "UAE", coordinates: [24.8861, 55.1722], size: "large" },
        { code: "AUH", name: "Abu Dhabi International", city: "Abu Dhabi", country: "UAE", coordinates: [24.4330, 54.6511], size: "large" },
        { code: "SHJ", name: "Sharjah International", city: "Sharjah", country: "UAE", coordinates: [25.3286, 55.5172], size: "medium" },
        { code: "DOH", name: "Hamad International", city: "Doha", country: "Qatar", coordinates: [25.2609, 51.6138], size: "large" },
        { code: "RUH", name: "King Khalid International", city: "Riyadh", country: "Saudi Arabia", coordinates: [24.9584, 46.6989], size: "large" },
        { code: "JED", name: "King Abdulaziz International", city: "Jeddah", country: "Saudi Arabia", coordinates: [21.6796, 39.1565], size: "large" },
        { code: "DMM", name: "King Fahd International", city: "Dammam", country: "Saudi Arabia", coordinates: [26.4712, 49.7979], size: "large" },
        { code: "KWI", name: "Kuwait International", city: "Kuwait City", country: "Kuwait", coordinates: [29.2266, 47.9689], size: "large" },
        { code: "BAH", name: "Bahrain International", city: "Manama", country: "Bahrain", coordinates: [26.2708, 50.6336], size: "large" },
        { code: "MCT", name: "Muscat International", city: "Muscat", country: "Oman", coordinates: [23.5933, 58.2844], size: "large" },
        { code: "AMM", name: "Queen Alia International", city: "Amman", country: "Jordan", coordinates: [31.7225, 35.9932], size: "large" },
        { code: "TLV", name: "Ben Gurion Airport", city: "Tel Aviv", country: "Israel", coordinates: [32.0114, 34.8867], size: "large" },
        { code: "BEY", name: "Beirut–Rafic Hariri International", city: "Beirut", country: "Lebanon", coordinates: [33.8209, 35.4884], size: "large" },
        { code: "CAI", name: "Cairo International", city: "Cairo", country: "Egypt", coordinates: [30.1219, 31.4056], size: "large" },
        
        { code: "JNB", name: "O.R. Tambo International", city: "Johannesburg", country: "South Africa", coordinates: [-26.1392, 28.2460], size: "large" },
        { code: "CPT", name: "Cape Town International", city: "Cape Town", country: "South Africa", coordinates: [-33.9648, 18.6017], size: "large" },
        { code: "DUR", name: "King Shaka International", city: "Durban", country: "South Africa", coordinates: [-29.6144, 31.1190], size: "large" },
        { code: "PLZ", name: "Port Elizabeth International", city: "Port Elizabeth", country: "South Africa", coordinates: [-33.9849, 25.6173], size: "medium" },
        { code: "LOS", name: "Murtala Muhammed International", city: "Lagos", country: "Nigeria", coordinates: [6.5774, 3.3212], size: "large" },
        { code: "ABV", name: "Nnamdi Azikiwe International", city: "Abuja", country: "Nigeria", coordinates: [9.0068, 7.2632], size: "large" },
        { code: "ACC", name: "Kotoka International", city: "Accra", country: "Ghana", coordinates: [5.6052, -0.1668], size: "large" },
        { code: "ADD", name: "Bole International", city: "Addis Ababa", country: "Ethiopia", coordinates: [8.9779, 38.7993], size: "large" },
        { code: "NBO", name: "Jomo Kenyatta International", city: "Nairobi", country: "Kenya", coordinates: [-1.3192, 36.9278], size: "large" },
        { code: "DAR", name: "Julius Nyerere International", city: "Dar es Salaam", country: "Tanzania", coordinates: [-6.8781, 39.2026], size: "large" },
        { code: "KGL", name: "Kigali International", city: "Kigali", country: "Rwanda", coordinates: [-1.9686, 30.1395], size: "medium" },
        { code: "EBB", name: "Entebbe International", city: "Entebbe", country: "Uganda", coordinates: [0.0424, 32.4435], size: "large" },
        { code: "CMN", name: "Mohammed V International", city: "Casablanca", country: "Morocco", coordinates: [33.3675, -7.5900], size: "large" },
        { code: "RAK", name: "Marrakesh Menara", city: "Marrakesh", country: "Morocco", coordinates: [31.6069, -8.0363], size: "large" },
        { code: "TUN", name: "Tunis–Carthage International", city: "Tunis", country: "Tunisia", coordinates: [36.8510, 10.2272], size: "large" },
        { code: "ALG", name: "Houari Boumediene Airport", city: "Algiers", country: "Algeria", coordinates: [36.6910, 3.2154], size: "large" },
        { code: "TIP", name: "Tripoli International", city: "Tripoli", country: "Libya", coordinates: [32.6635, 13.1590], size: "large" },
        
        { code: "GRU", name: "São Paulo–Guarulhos International", city: "São Paulo", country: "Brazil", coordinates: [-23.4356, -46.4731], size: "large" },
        { code: "CGH", name: "São Paulo–Congonhas", city: "São Paulo", country: "Brazil", coordinates: [-23.6261, -46.6564], size: "large" },
        { code: "GIG", name: "Rio de Janeiro–Galeão International", city: "Rio de Janeiro", country: "Brazil", coordinates: [-22.8089, -43.2436], size: "large" },
        { code: "BSB", name: "Brasília International", city: "Brasília", country: "Brazil", coordinates: [-15.8711, -47.9186], size: "large" },
        { code: "CNF", name: "Belo Horizonte–Confins", city: "Belo Horizonte", country: "Brazil", coordinates: [-19.6337, -43.9689], size: "large" },
        { code: "SSA", name: "Salvador–Deputado Luís Eduardo Magalhães International", city: "Salvador", country: "Brazil", coordinates: [-12.9107, -38.3310], size: "large" },
        { code: "REC", name: "Recife/Guararapes–Gilberto Freyre International", city: "Recife", country: "Brazil", coordinates: [-8.1268, -34.9240], size: "large" },
        { code: "FOR", name: "Fortaleza–Pinto Martins International", city: "Fortaleza", country: "Brazil", coordinates: [-3.7763, -38.5326], size: "large" },
        { code: "EZE", name: "Ministro Pistarini International", city: "Buenos Aires", country: "Argentina", coordinates: [-34.8222, -58.5358], size: "large" },
        { code: "AEP", name: "Jorge Newbery Airfield", city: "Buenos Aires", country: "Argentina", coordinates: [-34.5592, -58.4156], size: "medium" },
        { code: "COR", name: "Ingeniero Aeronáutico Ambrosio L.V. Taravella International", city: "Córdoba", country: "Argentina", coordinates: [-31.3236, -64.2080], size: "large" },
        { code: "MDZ", name: "Governor Francisco Gabrielli International", city: "Mendoza", country: "Argentina", coordinates: [-32.8317, -68.7928], size: "large" },
        { code: "SCL", name: "Arturo Merino Benítez International", city: "Santiago", country: "Chile", coordinates: [-33.3930, -70.7858], size: "large" },
        { code: "LIM", name: "Jorge Chávez International", city: "Lima", country: "Peru", coordinates: [-12.0219, -77.1143], size: "large" },
        { code: "BOG", name: "El Dorado International", city: "Bogotá", country: "Colombia", coordinates: [4.7016, -74.1469], size: "large" },
        { code: "MDE", name: "José María Córdova International", city: "Medellín", country: "Colombia", coordinates: [6.1644, -75.4231], size: "large" },
        { code: "UIO", name: "Mariscal Sucre International", city: "Quito", country: "Ecuador", coordinates: [-0.1411, -78.4882], size: "large" },
        { code: "GYE", name: "José Joaquín de Olmedo International", city: "Guayaquil", country: "Ecuador", coordinates: [-2.1574, -79.8836], size: "large" },
        { code: "CCS", name: "Simón Bolívar International", city: "Caracas", country: "Venezuela", coordinates: [10.6031, -66.9906], size: "large" },
        { code: "PTY", name: "Tocumen International", city: "Panama City", country: "Panama", coordinates: [9.0714, -79.3835], size: "large" },
        { code: "MVD", name: "Carrasco International", city: "Montevideo", country: "Uruguay", coordinates: [-34.8384, -56.0308], size: "large" },
        { code: "ASU", name: "Silvio Pettirossi International", city: "Asunción", country: "Paraguay", coordinates: [-25.2398, -57.5191], size: "large" },
        { code: "LPB", name: "El Alto International", city: "La Paz", country: "Bolivia", coordinates: [-16.5133, -68.1923], size: "large" },
        { code: "VVI", name: "Viru Viru International", city: "Santa Cruz de la Sierra", country: "Bolivia", coordinates: [-17.6448, -63.1354], size: "large" },
        
        { code: "SYD", name: "Sydney Kingsford Smith", city: "Sydney", country: "Australia", coordinates: [-33.9399, 151.1753], size: "large" },
        { code: "MEL", name: "Melbourne Airport", city: "Melbourne", country: "Australia", coordinates: [-37.6733, 144.8433], size: "large" },
        { code: "BNE", name: "Brisbane Airport", city: "Brisbane", country: "Australia", coordinates: [-27.3842, 153.1175], size: "large" },
        { code: "PER", name: "Perth Airport", city: "Perth", country: "Australia", coordinates: [-31.9404, 115.9670], size: "large" },
        { code: "ADL", name: "Adelaide Airport", city: "Adelaide", country: "Australia", coordinates: [-34.9450, 138.5306], size: "large" },
        { code: "CBR", name: "Canberra Airport", city: "Canberra", country: "Australia", coordinates: [-35.3069, 149.1950], size: "medium" },
        { code: "OOL", name: "Gold Coast Airport", city: "Gold Coast", country: "Australia", coordinates: [-28.1644, 153.5047], size: "medium" },
        { code: "CNS", name: "Cairns Airport", city: "Cairns", country: "Australia", coordinates: [-16.8858, 145.7555], size: "medium" },
        { code: "AKL", name: "Auckland Airport", city: "Auckland", country: "New Zealand", coordinates: [-37.0081, 174.7925], size: "large" },
        { code: "WLG", name: "Wellington International", city: "Wellington", country: "New Zealand", coordinates: [-41.3272, 174.8053], size: "large" },
        { code: "CHC", name: "Christchurch International", city: "Christchurch", country: "New Zealand", coordinates: [-43.4894, 172.5322], size: "large" },
        { code: "ZQN", name: "Queenstown Airport", city: "Queenstown", country: "New Zealand", coordinates: [-45.0211, 168.7392], size: "medium" },
        { code: "NAN", name: "Nadi International", city: "Nadi", country: "Fiji", coordinates: [-17.7554, 177.4434], size: "medium" },
        { code: "PPT", name: "Faa'a International", city: "Papeete", country: "French Polynesia", coordinates: [-17.5567, -149.6114], size: "medium" },
        
        { code: "ANC", name: "Ted Stevens Anchorage International", city: "Anchorage", country: "USA", coordinates: [61.1744, -149.9960], size: "large" }
    ];
}
    
    function getMajorAirportsList() {
        return [
            { code: "JFK", name: "John F. Kennedy International", coords: [40.6413, -73.7781], city: "New York" },
            { code: "LAX", name: "Los Angeles International", coords: [33.9416, -118.4085], city: "Los Angeles" },
            { code: "ORD", name: "O'Hare International", coords: [41.9742, -87.9073], city: "Chicago" },
            { code: "DFW", name: "Dallas/Fort Worth International", coords: [32.8998, -97.0403], city: "Dallas" },
            { code: "DEN", name: "Denver International", coords: [39.8561, -104.6737], city: "Denver" },
            { code: "SFO", name: "San Francisco International", coords: [37.6213, -122.3790], city: "San Francisco" },
            { code: "SEA", name: "Seattle-Tacoma International", coords: [47.4502, -122.3088], city: "Seattle" },
            { code: "MIA", name: "Miami International", coords: [25.7959, -80.2870], city: "Miami" },
            { code: "ATL", name: "Hartsfield-Jackson Atlanta", coords: [33.6407, -84.4277], city: "Atlanta" },
            { code: "YYZ", name: "Toronto Pearson", coords: [43.6777, -79.6248], city: "Toronto" },
            { code: "YVR", name: "Vancouver International", coords: [49.1947, -123.1792], city: "Vancouver" },
            { code: "MEX", name: "Mexico City International", coords: [19.4363, -99.0721], city: "Mexico City" },
            
            { code: "LHR", name: "London Heathrow", coords: [51.4700, -0.4543], city: "London" },
            { code: "CDG", name: "Paris Charles de Gaulle", coords: [49.0097, 2.5479], city: "Paris" },
            { code: "FRA", name: "Frankfurt Airport", coords: [50.0333, 8.5706], city: "Frankfurt" },
            { code: "AMS", name: "Amsterdam Schiphol", coords: [52.3086, 4.7639], city: "Amsterdam" },
            { code: "MAD", name: "Madrid Barajas", coords: [40.4983, -3.5676], city: "Madrid" },
            { code: "FCO", name: "Rome Fiumicino", coords: [41.8045, 12.2508], city: "Rome" },
            { code: "BCN", name: "Barcelona El Prat", coords: [41.2974, 2.0833], city: "Barcelona" },
            { code: "ZRH", name: "Zurich Airport", coords: [47.4647, 8.5492], city: "Zurich" },
            { code: "IST", name: "Istanbul Airport", coords: [41.2622, 28.7425], city: "Istanbul" },
            { code: "DUB", name: "Dublin Airport", coords: [53.4213, -6.2701], city: "Dublin" },
            
            { code: "HND", name: "Tokyo Haneda", coords: [35.5494, 139.7798], city: "Tokyo" },
            { code: "NRT", name: "Tokyo Narita", coords: [35.7647, 140.3864], city: "Tokyo" },
            { code: "PEK", name: "Beijing Capital", coords: [40.0799, 116.6031], city: "Beijing" },
            { code: "PVG", name: "Shanghai Pudong", coords: [31.1434, 121.8052], city: "Shanghai" },
            { code: "HKG", name: "Hong Kong International", coords: [22.3080, 113.9185], city: "Hong Kong" },
            { code: "SIN", name: "Singapore Changi", coords: [1.3644, 103.9915], city: "Singapore" },
            { code: "BKK", name: "Bangkok Suvarnabhumi", coords: [13.6811, 100.7475], city: "Bangkok" },
            { code: "DEL", name: "Delhi Indira Gandhi", coords: [28.5562, 77.1000], city: "Delhi" },
            { code: "ICN", name: "Seoul Incheon", coords: [37.4602, 126.4407], city: "Seoul" },
            { code: "DOH", name: "Doha Hamad International", coords: [25.2609, 51.6138], city: "Doha" },
            
            { code: "SYD", name: "Sydney Kingsford Smith", coords: [-33.9399, 151.1753], city: "Sydney" },
            { code: "MEL", name: "Melbourne Airport", coords: [-37.6733, 144.8433], city: "Melbourne" },
            { code: "AKL", name: "Auckland Airport", coords: [-37.0081, 174.7925], city: "Auckland" },
            
            { code: "GRU", name: "São Paulo Guarulhos", coords: [-23.4356, -46.4731], city: "São Paulo" },
            { code: "EZE", name: "Buenos Aires Ezeiza", coords: [-34.8222, -58.5358], city: "Buenos Aires" },
            { code: "SCL", name: "Santiago Arturo Merino Benítez", coords: [-33.3930, -70.7858], city: "Santiago" },
            { code: "LIM", name: "Lima Jorge Chávez", coords: [-12.0219, -77.1143], city: "Lima" },
            
            { code: "JNB", name: "Johannesburg O.R. Tambo", coords: [-26.1392, 28.2460], city: "Johannesburg" },
            { code: "CAI", name: "Cairo International", coords: [30.1219, 31.4056], city: "Cairo" },
            { code: "ADD", name: "Addis Ababa Bole", coords: [8.9779, 38.7993], city: "Addis Ababa" },
            { code: "MBA", name: "Mombasa Moi International", coords: [-4.0348, 39.5942], city: "Mombasa" },
            
            { code: "DXB", name: "Dubai International", coords: [25.2532, 55.3657], city: "Dubai" },
            { code: "AUH", name: "Abu Dhabi International", coords: [24.4330, 54.6511], city: "Abu Dhabi" },
            { code: "RUH", name: "Riyadh King Khalid", coords: [24.9584, 46.6989], city: "Riyadh" },
            { code: "TLV", name: "Tel Aviv Ben Gurion", coords: [32.0114, 34.8867], city: "Tel Aviv" }
        ];
    }
    
    async function findNearestMajorAirport(coords) {
        const majorAirports = getMajorAirportsList();
        
        const airportsWithDistance = majorAirports.map(airport => {
            const distance = map.distance(coords, airport.coords);
            return { ...airport, distance };
        });
        
        airportsWithDistance.sort((a, b) => a.distance - b.distance);
        
        const nearbyAirports = airportsWithDistance.filter(a => a.distance <= 500000);
        
        if (nearbyAirports.length === 0) {
            return null;
        }
        
        return {
            name: nearbyAirports[0].name,
            code: nearbyAirports[0].code,
            city: nearbyAirports[0].city,
            coordinates: nearbyAirports[0].coords,
            distance: nearbyAirports[0].distance
        };
    }

    let airportCache = null;
    const CACHE_DURATION = 24 * 60 * 60 * 1000;

    async function getAirportDatabase() {
        if (airportCache && (Date.now() - airportCache.timestamp) < CACHE_DURATION) {
            return airportCache.data;
        }
        
        try {
            const airports = await getAllAirports();
            
            airportCache = {
                timestamp: Date.now(),
                data: airports
            };
            
            try {
                localStorage.setItem('airportData', JSON.stringify({
                    timestamp: Date.now(),
                    data: airports.slice(0, 5000)
                }));
            } catch (e) {}
            
            return airports;
            
        } catch (error) {
            try {
                const cached = JSON.parse(localStorage.getItem('airportData'));
                if (cached && cached.data) {
                    return cached.data;
                }
            } catch (e) {}
            
            return getEssentialAirports();
        }
    }

    async function findNearestAirport(coords, maxDistance = 200000) {
        const airports = await getAirportDatabase();
        const [lat, lng] = coords;
        
        let nearest = null;
        let minDistance = Infinity;
        
        for (const airport of airports) {
            const distance = map.distance([lat, lng], airport.coordinates);
            
            if (distance < minDistance && distance < maxDistance) {
                minDistance = distance;
                nearest = {
                    ...airport,
                    distance: distance
                };
            }
        }
        
        return nearest;
    }

    function getEssentialAirports() {
        return [
            { code: "ATL", name: "Hartsfield-Jackson Atlanta International", city: "Atlanta", country: "USA", coordinates: [33.6407, -84.4277] },
            { code: "LAX", name: "Los Angeles International", city: "Los Angeles", country: "USA", coordinates: [33.9416, -118.4085] },
            { code: "ORD", name: "O'Hare International", city: "Chicago", country: "USA", coordinates: [41.9742, -87.9073] },
            { code: "DFW", name: "Dallas/Fort Worth International", city: "Dallas", country: "USA", coordinates: [32.8998, -97.0403] },
            { code: "DEN", name: "Denver International", city: "Denver", country: "USA", coordinates: [39.8561, -104.6737] },
            { code: "JFK", name: "John F. Kennedy International", city: "New York", country: "USA", coordinates: [40.6413, -73.7781] },
            { code: "SFO", name: "San Francisco International", city: "San Francisco", country: "USA", coordinates: [37.6213, -122.3790] },
            { code: "SEA", name: "Seattle-Tacoma International", city: "Seattle", country: "USA", coordinates: [47.4502, -122.3088] },
            { code: "YYZ", name: "Toronto Pearson International", city: "Toronto", country: "Canada", coordinates: [43.6777, -79.6248] },
            { code: "MEX", name: "Mexico City International", city: "Mexico City", country: "Mexico", coordinates: [19.4363, -99.0721] },
            
            { code: "LHR", name: "London Heathrow", city: "London", country: "UK", coordinates: [51.4700, -0.4543] },
            { code: "CDG", name: "Paris Charles de Gaulle", city: "Paris", country: "France", coordinates: [49.0097, 2.5479] },
            { code: "AMS", name: "Amsterdam Schiphol", city: "Amsterdam", country: "Netherlands", coordinates: [52.3086, 4.7639] },
            { code: "FRA", name: "Frankfurt Airport", city: "Frankfurt", country: "Germany", coordinates: [50.0333, 8.5706] },
            { code: "IST", name: "Istanbul Airport", city: "Istanbul", country: "Turkey", coordinates: [41.2622, 28.7425] },
            { code: "MAD", name: "Madrid Barajas", city: "Madrid", country: "Spain", coordinates: [40.4983, -3.5676] },
            { code: "FCO", name: "Rome Fiumicino", city: "Rome", country: "Italy", coordinates: [41.8045, 12.2508] },
            
            { code: "PEK", name: "Beijing Capital International", city: "Beijing", country: "China", coordinates: [40.0799, 116.6031] },
            { code: "HND", name: "Tokyo Haneda", city: "Tokyo", country: "Japan", coordinates: [35.5494, 139.7798] },
            { code: "PVG", name: "Shanghai Pudong International", city: "Shanghai", country: "China", coordinates: [31.1434, 121.8052] },
            { code: "DXB", name: "Dubai International", city: "Dubai", country: "UAE", coordinates: [25.2532, 55.3657] },
            { code: "SIN", name: "Singapore Changi", city: "Singapore", country: "Singapore", coordinates: [1.3644, 103.9915] },
            { code: "BKK", name: "Bangkok Suvarnabhumi", city: "Bangkok", country: "Thailand", coordinates: [13.6811, 100.7475] },
            { code: "ICN", name: "Seoul Incheon International", city: "Seoul", country: "South Korea", coordinates: [37.4602, 126.4407] },
            { code: "DEL", name: "Delhi Indira Gandhi International", city: "Delhi", country: "India", coordinates: [28.5562, 77.1000] },
            
            { code: "SYD", name: "Sydney Kingsford Smith", city: "Sydney", country: "Australia", coordinates: [-33.9399, 151.1753] },
            { code: "MEL", name: "Melbourne Airport", city: "Melbourne", country: "Australia", coordinates: [-37.6733, 144.8433] },
            { code: "AKL", name: "Auckland Airport", city: "Auckland", country: "New Zealand", coordinates: [-37.0081, 174.7925] },
            
            { code: "GRU", name: "São Paulo Guarulhos", city: "São Paulo", country: "Brazil", coordinates: [-23.4356, -46.4731] },
            { code: "EZE", name: "Buenos Aires Ezeiza", city: "Buenos Aires", country: "Argentina", coordinates: [-34.8222, -58.5358] },
            
            { code: "JNB", name: "Johannesburg O.R. Tambo", city: "Johannesburg", country: "South Africa", coordinates: [-26.1392, 28.2460] },
            { code: "CAI", name: "Cairo International", city: "Cairo", country: "Egypt", coordinates: [30.1219, 31.4056] }
        ];
    }

    function shouldShowFlightRoute(start, end, distance) {
        if (distance < 100000) return false;
        
        if (distance < 300000) {
            const startAirport = findNearestMajorAirport(start);
            const endAirport = findNearestMajorAirport(end);
            
            if (startAirport && endAirport && startAirport.code === endAirport.code) {
                return false;
            }
        }
        
        if (distance > 300000) return true;
        
        return false;
    }

    async function calculateFlightRoute(start, end, distance) {
        if (distance < 300000) return null;
        
        const airports = await findBestAirportForRoute(start, end);
        if (!airports) return null;
        
        const { start: startAirport, end: endAirport } = airports;
        
        const toAirportDistance = startAirport.distance;
        const airportToAirportDistance = map.distance(startAirport.coordinates, endAirport.coordinates);
        const fromAirportDistance = endAirport.distance;
        
        const groundSpeed = 30000;
        const flightSpeed = 800000;
        const airportTime = 7200;
        
        const toAirportTime = (toAirportDistance / groundSpeed) * 3600;
        const flightTime = (airportToAirportDistance / flightSpeed) * 3600;
        const fromAirportTime = (fromAirportDistance / groundSpeed) * 3600;
        
        const totalTime = toAirportTime + flightTime + fromAirportTime + airportTime;
        
        const directDistance = map.distance(start, end);
        const drivingTime = (directDistance / 80000) * 3600;
        if (totalTime > drivingTime * 0.8) {
            return null;
        }
        
        return {
            id: 'flight',
            icon: 'lucide:plane',
            label: 'Flight',
            duration: totalTime,
            distance: airportToAirportDistance,
            geometry: createFlightPath(startAirport.coordinates, endAirport.coordinates),
            steps: [
                {
                    distance: toAirportDistance,
                    duration: toAirportTime,
                    maneuver: {
                        instruction: `Travel to ${startAirport.code} Airport`,
                        type: 'ground'
                    }
                },
                {
                    distance: airportToAirportDistance,
                    duration: flightTime,
                    maneuver: {
                        instruction: `Fly from ${startAirport.code} to ${endAirport.code}`,
                        type: 'flight'
                    }
                },
                {
                    distance: fromAirportDistance,
                    duration: fromAirportTime,
                    maneuver: {
                        instruction: `Travel from ${endAirport.code} Airport to destination`,
                        type: 'ground'
                    }
                }
            ],
            airports: {
                departure: startAirport,
                arrival: endAirport
            },
            groundTransport: {
                toAirport: formatTime(toAirportTime),
                fromAirport: formatTime(fromAirportTime)
            },
            details: `${startAirport.name} → ${endAirport.name}`
        };
    }
                        
    function processOSRMSteps(osrmSteps) {
        return osrmSteps.map((step, index) => {
            const exitInfo = getExitInfo(step);
            const instruction = generateRealNavigationInstruction(step, index, osrmSteps);
            
            return {
                distance: step.distance,
                duration: step.duration,
                geometry: step.geometry,
                maneuver: {
                    instruction: instruction,
                    type: step.maneuver?.type || 'continue',
                    modifier: step.maneuver?.modifier || '',
                    location: step.maneuver?.location,
                    exit: step.maneuver?.exit,
                    notification_type: step.maneuver?.notification_type
                },
                name: step.name || getStreetName(step),
                ref: step.ref || '',
                destinations: step.destinations || '',
                intersections: step.intersections || [],
                exit: exitInfo,
                way_points: step.way_points
            };
        });
    }

    function generateFlightBookingLinks(departure, arrival) {
        const links = [];
        
        if (departure.code && arrival.code) {
            links.push({
                name: "Kayak",
                url: `https://www.kayak.com/flights/${departure.code}-${arrival.code}`,
                icon: "lucide:search"
            });
            
            links.push({
                name: "Expedia",
                url: `https://www.expedia.com/Flights-Search?flight-type=on&mode=search&trip=oneway&leg1=from:${departure.code},to:${arrival.code}`,
                icon: "lucide:plane"
            });
            
            links.push({
                name: "Google Flights",
                url: `https://www.google.com/travel/flights?q=Flights%20to%20${arrival.code}%20from%20${departure.code}`,
                icon: "lucide:globe"
            });
        } else {
            const startName = departure.city || departure.name || "origin";
            const endName = arrival.city || arrival.name || "destination";
            
            links.push({
                name: "Search Flights",
                url: `https://www.google.com/search?q=flights+from+${encodeURIComponent(startName)}+to+${encodeURIComponent(endName)}`,
                icon: "lucide:search"
            });
        }
        
        links.push({
            name: "Car Rental",
            url: `https://www.rentalcars.com/`,
            icon: "lucide:car"
        });
        
        links.push({
            name: "Hotels",
            url: `https://www.booking.com/`,
            icon: "lucide:building"
        });
        
        return links;
    }
    
    function createFlightPath(start, end) {
        const midLat = (start[0] + end[0]) / 2;
        const midLng = (start[1] + end[1]) / 2;
        
        const curveFactor = 0.5;
        const curveLat = midLat + curveFactor;
        const curveLng = midLng + curveFactor;
        
        return {
            type: "LineString",
            coordinates: [
                [start[1], start[0]],
                [curveLng, curveLat],
                [end[1], end[0]]
            ]
        };
    }
    
    function formatDistanceForInstructions(distance) {
        if (distance < 50) return "Soon";
        if (distance < 100) return "In 100 m";
        if (distance < 200) return "In 200 m";
        if (distance < 500) return "In 500 m";
        if (distance < 1000) return "In " + Math.round(distance/100)*100 + " m";
        return "in " + (distance/1000).toFixed(1) + " km";
    }
    
    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    function getStreetName(step) {
        if (!step) return '';
        
        const name = step.name || 
                    step.road_name || 
                    step.way_name || 
                    step.ref || 
                    step.destination || 
                    '';
        
        if (name) {
            return name
                .replace(/^US-/, 'US Route ')
                .replace(/^I-/, 'I-')
                .replace(/^SR-/, 'State Route ')
                .replace(/^CR-/, 'County Route ')
                .replace(/_/g, ' ')
                .trim();
        }
        
        return '';
    }

    function getExitInfo(step) {
        if (!step.intersections || !step.intersections[0]) return null;
        
        const intersection = step.intersections[0];
        if (intersection.classes && intersection.classes.includes('motorway_junction')) {
            return {
                number: intersection.ref || '',
                name: intersection.name || '',
                destinations: intersection.destinations || ''
            };
        }
        return null;
    }
        
    function getOrdinal(n) {
        if (n === undefined || n === null || isNaN(n)) return '';
        n = parseInt(n);
        
        if (n % 100 >= 11 && n % 100 <= 13) {
            return n + "th";
        }
        
        switch (n % 10) {
            case 1: return n + "st";
            case 2: return n + "nd";
            case 3: return n + "rd";
            default: return n + "th";
        }
    }
        
    function calculateTrafficLevel(start, end) {
        const now = new Date();
        const hour = now.getHours();
        const distance = map.distance(start, end);
        
        if (distance < 50000 && ((hour >= 8 && hour <= 10) || (hour >= 16 && hour <= 19))) {
            return Math.random() > 0.5 ? 'high' : 'medium';
        }
        
        const rand = Math.random();
        if (rand > 0.7) return 'high';
        if (rand > 0.4) return 'medium';
        return 'low';
    }
    
    function addRouteCard(route) {
        const container = document.getElementById('route-options');
        const div = document.createElement('div');
        div.className = "route-card";
        div.dataset.routeId = route.id;
        
        const timeStr = formatTime(route.duration);
        const arrival = getArrival(route.duration);
        const distanceStr = (route.distance / 1000).toFixed(1) + ' km';
        
        let trafficIndicator = '';
        if (route.id === 'driving' && route.traffic) {
            const trafficClass = `traffic-${route.traffic}`;
            trafficIndicator = `<span class="traffic-indicator ${trafficClass}"></span>`;
        }

        if (route.id === 'flight') {
            const bookingLinks = generateFlightBookingLinks(
                route.airports?.departure || {code: "???", city: "origin"}, 
                route.airports?.arrival || {code: "???", city: "destination"}
            );
            
            const bookingLinksHTML = bookingLinks.map(link => 
                `<a href="${link.url}" target="_blank" class="inline-flex items-center gap-1 text-[8px] text-sky-400 hover:text-sky-300 mr-3 border border-sky-400/30 rounded px-2 py-1 hover:bg-sky-400/10 transition-colors">
                    <iconify-icon icon="${link.icon}" class="text-[10px]"></iconify-icon>
                    ${link.name}
                </a>`
            ).join('');
            
            const totalTime = formatTime(route.duration);
            const flightTime = formatTime(route.flightTime || (route.duration * 0.6));
            
            div.innerHTML = `
                <div class="flex items-center gap-4">
                    <iconify-icon icon="${route.icon}" class="text-2xl text-sky-500"></iconify-icon>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <div class="text-[10px] font-bold text-white">Flight Route</div>
                            <div class="text-[9px] font-bold text-sky-400">${(route.distance/1000).toFixed(0)} km</div>
                        </div>
                        <div class="text-[9px] text-sky-300 mb-1">${route.details || "Direct flight"}</div>
                        <div class="text-[9px] text-neutral-400 uppercase">${flightTime} flight • ${totalTime} total</div>
                        <div class="mt-2 pt-2 border-t border-white/10">
                            <div class="text-[8px] text-neutral-500 uppercase mb-1">Book Travel:</div>
                            <div class="flex flex-wrap gap-1">
                                ${bookingLinksHTML}
                            </div>
                        </div>
                    </div>
                </div>`;
        } else {
            div.innerHTML = `
                <div class="flex items-center gap-4">
                    <iconify-icon icon="${route.icon}" class="text-xl text-neutral-500"></iconify-icon>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <div class="text-[10px] font-bold text-white">${trafficIndicator}${route.label}</div>
                            <div class="text-[9px] font-bold text-emerald-400">${distanceStr}</div>
                        </div>
                        <div class="text-[9px] text-neutral-400 uppercase">${timeStr} • Arr: ${arrival}</div>
                    </div>
                </div>`;
        }
        
        div.onclick = (e) => {
            e.stopPropagation();
            
            document.querySelectorAll('.route-card').forEach(c => c.classList.remove('active'));
            div.classList.add('active');
            
            currentRoute = route;
            
            renderPath(route);
        };
        
        container.appendChild(div);
    }
    
    
function cleanupRouteRendering() {
    if (routeLayer) {
        routeLayer.clearLayers();
    }
    
    window.currentRouteLayer = null;
}

function renderPath(route) {
    routeLayer.clearLayers();
    
    if (!route || !route.geometry) return;
    
    const coords = route.geometry.coordinates || [];
    if (coords.length < 2) return;
    
    const routeColor = getRouteColor(route);
    let weight = 5;
    let dashArray = null;
    
    if (route.id === 'driving') {
        weight = 5;
    } else if (route.id === 'cycling') {
        weight = 4;
    } else if (route.id === 'walking') {
        weight = 3;
        dashArray = '5, 10';
    } else if (route.id === 'flight') {
        weight = 3;
        dashArray = '10, 5';
    }
    
    const geoJsonLayer = L.geoJSON(route.geometry, {
        style: { 
            color: routeColor, 
            weight: weight, 
            opacity: 0.8,
            dashArray: dashArray
        }
    });
    
    geoJsonLayer.addTo(routeLayer);
    
    window.currentRouteGeoJson = geoJsonLayer;
    
    currentRoute = route;
    
    const startBtn = document.getElementById('start-nav-btn');
    startBtn.classList.remove('hidden');
    startBtn.style.display = '';
    startBtn.onclick = () => startActiveNav(route);
}

    function getRouteColor(route) {
    if (route.id === 'cycling') return '#38bdf8';
    if (route.id === 'walking') return '#38bdf8';
    if (route.id === 'flight') return '#38bdf8';
    
    if (route.id === 'driving') {
        if (route.traffic === 'high') return '#ef4444';
        if (route.traffic === 'medium') return '#f59e0b';
        return '#3b82f6';
    }
    
    return '#3b82f6';
}

function drawNavigationRoute(latLngs, route) {
    if (window.navigationGeoJson && map.hasLayer(window.navigationGeoJson)) {
        map.removeLayer(window.navigationGeoJson);
    }
    
    const routeColor = getRouteColor(route);
    const weight = 5;

    const coordinates = latLngs.map(point => {
        return [point[1], point[0]];
    });
    
    const geoJsonGeometry = {
        type: "LineString",
        coordinates: coordinates
    };
    
    window.navigationGeoJson = L.geoJSON(geoJsonGeometry, {
        style: { 
            color: routeColor, 
            weight: weight, 
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round'
        }
    }).addTo(map);
}
        
function startActiveNav(route) {
    isNavigating = true;
    currentNavRoute = route;
    currentStepIndex = 0;
    totalRouteDistance = route.distance;
    routeStartTime = new Date();
    
    document.body.classList.add('navigating');
    const startBtn1 = document.getElementById('start-nav-btn');
    startBtn1.classList.add('hidden');
    startBtn1.style.display = 'none';
    document.getElementById('standard-ui').style.display = 'none';
    document.getElementById('active-nav-hud').style.display = 'flex';
    
    transformSidebarToDirections(route);
    updateNavigationDisplay();
    updateNavigationHUD();
    
    routeLayer.clearLayers();
    
    const coords = route.geometry.coordinates || [];
    if (coords.length >= 2) {
        const latLngs = coords.map(coord => [coord[1], coord[0]]);
        
        if (latLngs.length >= 2) {
            drawNavigationRoute(latLngs, route);
            
            const bounds = L.latLngBounds(latLngs);
            map.fitBounds(bounds, {
                padding: [50, 50],
                animate: true,
                duration: 1
            });
        }
    }
    
    startNavigationUpdates();
}

    function startNavigationUpdates() {
        if (window.navUpdateInterval) {
            clearInterval(window.navUpdateInterval);
        }
        
        let isUserMovingMap = false;
        let mapMoveTimeout;
        
        map.on('movestart', () => {
            isUserMovingMap = true;
            clearTimeout(mapMoveTimeout);
        });
        
        map.on('moveend', () => {
            mapMoveTimeout = setTimeout(() => {
                isUserMovingMap = false;
            }, 3000);
        });
        
        window.navUpdateInterval = setInterval(() => {
            if (!isNavigating || !window.navigationCamera || isUserMovingMap) {
                return;
            }
            
            const camera = window.navigationCamera;
            const userPos = getCurrentUserPosition();
            
            if (!userPos) return;
            
            const userLatLng = L.latLng(userPos[0], userPos[1]);
            
            let closestIndex = 0;
            let minDistance = Infinity;
            
            const searchStart = Math.max(0, camera.currentIndex - 20);
            const searchEnd = Math.min(camera.currentIndex + 50, camera.routePoints.length);
            
            for (let i = searchStart; i < searchEnd; i++) {
                const distance = userLatLng.distanceTo(camera.routePoints[i]);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = i;
                }
            }
            
            if (minDistance > 100 && Math.abs(closestIndex - camera.currentIndex) > 5) {
                camera.currentIndex = closestIndex;
                
                updateTraveledPath(closestIndex);
                
                const lookAhead = Math.min(closestIndex + 10, camera.routePoints.length - 1);
                
                if (lookAhead > closestIndex) {
                    const targetPoint = camera.routePoints[closestIndex];
                    const currentCenter = map.getCenter();
                    const distanceToCenter = targetPoint.distanceTo(currentCenter);
                    
                    if (distanceToCenter > 300) {
                        map.panTo(targetPoint, {
                            animate: true,
                            duration: 0.5,
                            easeLinearity: 0.25
                        });
                    }
                    
                    camera.bearing = calculateBearing(
                        camera.routePoints[closestIndex],
                        camera.routePoints[lookAhead]
                    );
                    
                    updateRealTimeMarkerRotation(camera.bearing);
                }
            }
            
            updateRouteProgress(camera.currentIndex, camera.routePoints.length);
            
        }, 3000);
    }
    
    function transformSidebarToDirections(route) {
        const sidebar = document.getElementById('info-sidebar');
        sidebar.classList.add('active');
        
        const title = document.getElementById('side-title');
        title.innerText = "Turn-by-Turn Directions";
        
        const content = document.getElementById('sidebar-content');
        content.innerHTML = `
            <div class="space-y-1">
                <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-4">STEP-BY-STEP DIRECTIONS</div>
                <div id="directions-list" class="space-y-4"></div>
            </div>
        `;
        
        generateGoogleStyleDirectionsList(route);
    }

    function generateGoogleStyleDirectionsList(route) {
        const container = document.getElementById('directions-list');
        container.innerHTML = '';
        
        if (!route.steps || route.steps.length === 0) {
            container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No directions available</div>';
            return;
        }
        
        const groupedSteps = groupStepsLikeGoogle(route.steps);
        
        groupedSteps.forEach((group, groupIndex) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'direction-group';
            
            const primaryInstruction = group.primaryStep.maneuver.instruction || 
                                     generateRealNavigationInstruction(group.primaryStep, 0, route.steps);
            
            const distanceText = group.totalDistance < 1000 ? 
                `${Math.round(group.totalDistance)} m` : 
                `${(group.totalDistance/1000).toFixed(1)} km`;
            const timeText = formatTime(group.totalTime);
            
            groupDiv.innerHTML = `
                <div class="flex items-start gap-3 mb-2">
                    <div class="step-number">${groupIndex + 1}</div>
                    <div class="flex-1">
                        <div class="text-[11px] font-bold text-white leading-tight mb-1">${primaryInstruction}</div>
                        <div class="text-[9px] text-emerald-400">${timeText} • ${distanceText}</div>
                    </div>
                </div>
            `;
            
            if (group.substeps.length > 1) {
                const substepsDiv = document.createElement('div');
                substepsDiv.className = 'ml-9 pl-3 border-l border-white/10 space-y-2';
                
                group.substeps.forEach((substep, substepIndex) => {
                    if (substepIndex === 0) return;
                    
                    const instruction = substep.maneuver.instruction || 
                                      generateRealNavigationInstruction(substep, 0, route.steps);
                    const substepDiv = document.createElement('div');
                    substepDiv.className = 'text-[10px] text-neutral-400';
                    substepDiv.innerHTML = `
                        <iconify-icon icon="lucide:chevron-right" class="text-[8px] mr-1 opacity-50"></iconify-icon>
                        ${instruction}
                    `;
                    substepsDiv.appendChild(substepDiv);
                });
                
                groupDiv.appendChild(substepsDiv);
            }
            
            container.appendChild(groupDiv);
        });
    }
        
    function generateDirectionsListUI(route) {
        const container = document.getElementById('directions-list');
        container.innerHTML = '';
        
        if (!route.steps || route.steps.length === 0) {
            container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No directions available</div>';
            return;
        }
        
        let cumulativeDistance = 0;
        
        route.steps.forEach((step, index) => {
            const instruction = step.maneuver.instruction;
            const distance = step.distance;
            const duration = step.duration || 0;
            const isActive = index === currentStepIndex;
            const isCompleted = index < currentStepIndex;
            
            cumulativeDistance += distance;
            
            const stepDiv = document.createElement('div');
            stepDiv.className = `direction-item flex items-start gap-3 ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
            stepDiv.dataset.stepIndex = index;
            
            stepDiv.innerHTML = `
                <div class="step-number ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                    ${index + 1}
                </div>
                <div class="step-content">
                    <div class="step-instruction">${instruction}</div>
                    <div class="step-details">${distance < 1000 ? Math.round(distance) + ' m' : (distance/1000).toFixed(1) + ' km'} • ${formatTime(duration)}</div>
                </div>
            `;
            
            container.appendChild(stepDiv);
        });
    }
        
    async function checkFerryRouteFree(start, end) {
        const distance = map.distance(start, end);
        
        if (distance < 10000 || distance > 500000) return { hasFerry: false };
        
        try {
            const [startWater, endWater] = await Promise.all([
                isPointOverWater(start),
                isPointOverWater(end)
            ]);
            
            if (startWater && endWater) {
                const ferryTime = (distance / 40000) * 3600;
                
                return {
                    hasFerry: true,
                    duration: ferryTime + 1800,
                    distance: distance,
                    description: "Possible ferry route",
                    details: "Check local ferry schedules"
                };
            }
            
        } catch (error) {}
        
        return { hasFerry: false };
    }

    async function isPointOverWater(coords) {
        try {
            const [lat, lng] = coords;
            const query = `
                [out:json][timeout:5];
                (
                    way["natural"="water"](around:1000, ${lat}, ${lng});
                    relation["natural"="water"](around:1000, ${lat}, ${lng});
                );
                out body;
            `;
            
            const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            return data.elements && data.elements.length > 0;
            
        } catch (error) {
            return false;
        }
    }

    function checkNavigationProgress(position) {
        if (!isNavigating || !currentNavRoute || !currentNavRoute.steps) return;
        
        const currentPos = [position.coords.latitude, position.coords.longitude];
        if (!currentPos) return;
        
        const currentStep = currentNavRoute.steps[currentStepIndex];
        if (!currentStep) return;
        
        const timeSinceStart = (new Date() - routeStartTime) / 1000;
        const progressPercent = Math.min(95, (timeSinceStart / (currentStep.duration || 30)) * 100);
        
        document.getElementById('step-progress').style.width = `${progressPercent}%`;
        
        updateNavigationHUD();
    }
    
    function advanceToNextStep() {
        if (!currentNavRoute || !currentNavRoute.steps) return;
        
        if (currentStepIndex < currentNavRoute.steps.length - 1) {
            currentStepIndex++;
            updateNavigationDisplay();
            updateDirectionsListUI();
            updateNavigationHUD();
        } else {
            completeNavigation();
        }
    }
    
    function updateNavigationDisplay() {
        if (!currentNavRoute) return;
        
        const steps = currentNavRoute.steps || [];
        
        if (steps.length > 0 && currentStepIndex < steps.length) {
            const currentStep = steps[currentStepIndex];
            const nextStep = steps[currentStepIndex + 1];
            
            document.getElementById('nav-instruction').innerHTML = currentStep.maneuver.instruction;
            document.getElementById('nav-dist-next').innerText = 
                currentStep.distance < 1000 ? `In ${Math.round(currentStep.distance)}m` : `In ${(currentStep.distance/1000).toFixed(1)}km`;
            
            document.getElementById('step-progress').style.width = '0%';
            
            if (nextStep) {
                document.getElementById('nav-next-turn').innerText = 
                    nextStep.maneuver.instruction.split('.').slice(0, 2).join('.') + '.';
            } else {
                document.getElementById('nav-next-turn').innerText = "Final destination ahead";
            }
            
            let remainingTime = 0;
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingTime += steps[i].duration || 0;
            }
            
            const eta = getArrival(remainingTime);
            document.getElementById('nav-eta').innerText = eta;
            
            let remainingDistance = 0;
            for (let i = currentStepIndex; i < steps.length; i++) {
                remainingDistance += steps[i].distance || 0;
            }
            
            document.getElementById('nav-remaining').innerText = 
                remainingDistance < 1000 ? `${Math.round(remainingDistance)}m` : `${(remainingDistance/1000).toFixed(1)} km`;
            
            updateNavIcon(currentStep);
        }
    }
    
    function updateNavigationHUD() {
        if (!currentNavRoute || !isNavigating) return;
        
        const steps = currentNavRoute.steps || [];
        
        let remainingTime = 0;
        let remainingDistance = 0;
        
        for (let i = currentStepIndex; i < steps.length; i++) {
            remainingTime += steps[i].duration || 0;
            remainingDistance += steps[i].distance || 0;
        }
        
        const eta = getArrival(remainingTime);
        document.getElementById('hud-eta').innerText = eta;
        document.getElementById('hud-remaining').innerText = 
            remainingDistance < 1000 ? `${Math.round(remainingDistance)}m` : `${(remainingDistance/1000).toFixed(1)} km`;
    }
    
    function updateDirectionsListUI() {
        const directionItems = document.querySelectorAll('.direction-item');
        const stepNumbers = document.querySelectorAll('.step-number');
        
        directionItems.forEach((item, index) => {
            item.classList.remove('active', 'completed');
            stepNumbers[index].classList.remove('active', 'completed');
            
            if (index === currentStepIndex) {
                item.classList.add('active');
                stepNumbers[index].classList.add('active');
            } else if (index < currentStepIndex) {
                item.classList.add('completed');
                stepNumbers[index].classList.add('completed');
            }
        });
    }
    
    function completeNavigation() {
        document.getElementById('nav-instruction').innerText = "You have arrived at your destination";
        document.getElementById('nav-dist-next').innerText = "Arrived";
        document.getElementById('nav-next-turn').innerText = "Destination reached";
        document.getElementById('step-progress').style.width = '100%';
        document.getElementById('nav-eta').innerText = "Now";
        document.getElementById('nav-remaining').innerText = "0 m";
        
        document.getElementById('hud-eta').innerText = "Arrived";
        document.getElementById('hud-remaining').innerText = "0 m";
        
        if (gpsWatchInterval) {
            clearInterval(gpsWatchInterval);
            gpsWatchInterval = null;
        }
    }
    
    function updateNavIcon(step) {
        const icon = document.getElementById('nav-step-icon');
        const maneuver = step.maneuver.type || '';
        
        if (maneuver.includes('arrive')) {
            icon.setAttribute('icon', 'lucide:flag');
        } else if (maneuver.includes('depart')) {
            icon.setAttribute('icon', 'lucide:map-pin');
        } else if (maneuver.includes('left')) {
            icon.setAttribute('icon', 'lucide:corner-up-left');
        } else if (maneuver.includes('right')) {
            icon.setAttribute('icon', 'lucide:corner-up-right');
        } else if (maneuver.includes('roundabout')) {
            icon.setAttribute('icon', 'lucide:repeat');
        } else if (maneuver.includes('fork')) {
            icon.setAttribute('icon', 'lucide:git-fork');
        } else {
            icon.setAttribute('icon', 'lucide:navigation');
        }
    }
    
    function getRouteBounds(geometry) {
        const coords = geometry.coordinates;
        const bounds = [];
        
        for (const coord of coords) {
            bounds.push([coord[1], coord[0]]);
        }
        
        return bounds;
    }
    
    async function performSearch(query) {
        if (!query || query.trim().length < 2) {
            showRecentSearches();
            return;
        }
        
        saveToRecentSearches(query);
        
        document.getElementById('search-spinner').classList.remove('hidden');
        document.getElementById('filters').classList.remove('hidden');
        
        try {
            const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=25`);
            const data = await response.json();
            
            searchResults = data.features || [];
            applyFilter(activeFilter);
        } catch (error) {
            searchResults = [];
            displaySearchResults([]);
        } finally {
            document.getElementById('search-spinner').classList.add('hidden');
        }
    }
    
    function saveToRecentSearches(query) {
        const recent = {
            query: query,
            timestamp: new Date().toISOString(),
            timeText: 'Just now'
        };
        
        recentSearches = recentSearches.filter(item => item.query !== query);
        recentSearches.unshift(recent);
        recentSearches = recentSearches.slice(0, 10);
        updateRecentTimes();
        localStorage.setItem('strikeRecentSearches', JSON.stringify(recentSearches));
    }
    
    function updateRecentTimes() {
        const now = new Date();
        recentSearches.forEach(item => {
            const itemTime = new Date(item.timestamp);
            const diffMinutes = Math.floor((now - itemTime) / (1000 * 60));
            
            if (diffMinutes < 1) item.timeText = 'Just now';
            else if (diffMinutes < 60) item.timeText = `${diffMinutes}m ago`;
            else if (diffMinutes < 1440) item.timeText = `${Math.floor(diffMinutes/60)}h ago`;
            else item.timeText = `${Math.floor(diffMinutes/1440)}d ago`;
        });
    }
    
    function showRecentSearches() {
        updateRecentTimes();
        const container = document.getElementById('results');
        const filters = document.getElementById('filters');
        
        if (recentSearches.length === 0) {
            filters.classList.add('show');
            filters.classList.remove('hidden');
            
            container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No recent searches</div>';
            container.classList.add('show');
            container.classList.remove('hidden');
            return;
        }
        
        filters.classList.remove('hidden');
        
        let html = `
            <div class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest mb-2">Recent Searches</div>
        `;
        
        recentSearches.forEach((recent) => {
            html += `
                <div class="recent-item" data-query="${recent.query}">
                    <div class="flex justify-between items-center">
                        <div class="text-[11px] font-semibold text-white">${recent.query}</div>
                        <div class="recent-time">${recent.timeText}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        container.classList.remove('hidden');
        
        document.querySelectorAll('.recent-item').forEach(item => {
            item.addEventListener('click', () => {
                const query = item.dataset.query;
                document.getElementById('search-input').value = query;
                performSearch(query);
            });
        });
    }
    
    function applyFilter(filter) {
        activeFilter = filter;
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filter) {
                btn.classList.add('active');
            }
        });
        
        let filteredResults = searchResults;
        
        if (filter !== 'all' && filter !== 'nearby') {
            filteredResults = searchResults.filter(result => {
                const props = result.properties;
                const name = props.name?.toLowerCase() || '';
                
                switch(filter) {
                    case 'hotels':
                        return name.includes('hotel') || name.includes('inn') || name.includes('motel');
                    case 'parks':
                        return name.includes('park') || name.includes('garden');
                    case 'restaurants':
                        return name.includes('restaurant') || name.includes('cafe') || name.includes('diner');
                    case 'gas':
                        return name.includes('gas') || name.includes('fuel') || name.includes('station');
                    default:
                        return true;
                }
            });
        }
        
        displaySearchResults(filteredResults);
    }

    function generateRealNavigationInstruction(step, index, allSteps) {
        if (!step.maneuver) return "Continue";
        
        const distance = step.distance;
        const streetName = step.name || getStreetName(step) || '';
        const nextStreetName = allSteps[index + 1]?.name || getStreetName(allSteps[index + 1]) || '';
        const maneuverType = step.maneuver.type;
        const modifier = step.maneuver.modifier || '';
        const exitNumber = step.maneuver.exit;
        const laneCount = step.intersections?.[0]?.lanes?.length || 0;
        
        let distanceText = formatDistanceGoogleStyle(distance);
        let actionText = '';
        let laneText = '';
        let exitText = '';
        
        const formattedStreet = formatStreetNameForDisplay(streetName);
        const formattedNextStreet = formatStreetNameForDisplay(nextStreetName);
        
        if (exitNumber) {
            exitText = `exit ${exitNumber}`;
        }
        
        if (laneCount >= 3) {
            if (modifier === 'left') {
                laneText = `Use the left ${Math.min(2, laneCount)} lanes to `;
            } else if (modifier === 'right') {
                laneText = `Use the right ${Math.min(2, laneCount)} lanes to `;
            }
        }
        
        switch(maneuverType) {
            case 'depart':
                if (formattedStreet) {
                    actionText = `Head toward ${formattedStreet}`;
                } else if (formattedNextStreet) {
                    actionText = `Head toward ${formattedNextStreet}`;
                } else {
                    actionText = `Head toward destination`;
                }
                break;
                
            case 'turn':
                let turnType = '';
                switch(modifier) {
                    case 'left': turnType = 'Turn left'; break;
                    case 'right': turnType = 'Turn right'; break;
                    case 'sharp left': turnType = 'Turn sharp left'; break;
                    case 'sharp right': turnType = 'Turn sharp right'; break;
                    case 'slight left': turnType = 'Turn slight left'; break;
                    case 'slight right': turnType = 'Turn slight right'; break;
                    case 'uturn': turnType = 'Make a U-turn'; break;
                    default: turnType = 'Turn';
                }
                
                if (formattedStreet) {
                    actionText = `${turnType} onto ${formattedStreet}`;
                } else {
                    actionText = turnType;
                }
                break;
                
            case 'continue':
                if (formattedStreet && formattedNextStreet && formattedStreet !== formattedNextStreet) {
                    actionText = `Continue onto ${formattedNextStreet}`;
                } else if (formattedStreet) {
                    actionText = `Continue on ${formattedStreet}`;
                } else {
                    actionText = 'Continue straight';
                }
                break;
                
            case 'arrive':
                if (index === allSteps.length - 1) {
                    return "You have arrived at your destination";
                }
                actionText = "Arrive at waypoint";
                break;
                
            case 'roundabout':
                const ordinalExit = getOrdinal(exitNumber || 1);
                if (formattedStreet) {
                    actionText = `Take the ${ordinalExit} exit onto ${formattedStreet}`;
                } else {
                    actionText = `Take the ${ordinalExit} exit`;
                }
                break;
                
            case 'merge':
                if (formattedStreet) {
                    actionText = `Merge onto ${formattedStreet}`;
                } else {
                    actionText = 'Merge';
                }
                break;
                
            case 'fork':
                if (modifier === 'left') {
                    actionText = `Keep left at the fork${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                } else if (modifier === 'right') {
                    actionText = `Keep right at the fork${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                } else {
                    actionText = `At the fork, continue${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                }
                break;
                
            case 'off ramp':
                const exitName = step.ref || step.destinations || '';
                if (exitName) {
                    actionText = `Take exit ${exitName}${formattedStreet ? ' for ' + formattedStreet : ''}`;
                } else if (formattedStreet) {
                    actionText = `Take the exit onto ${formattedStreet}`;
                } else {
                    actionText = 'Take the exit';
                }
                break;
                
            case 'on ramp':
                if (formattedStreet) {
                    actionText = `Take the ramp onto ${formattedStreet}`;
                } else {
                    actionText = 'Take the ramp';
                }
                break;
                
            case 'end of road':
                if (modifier === 'left') {
                    actionText = `At the end of the road, turn left${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                } else if (modifier === 'right') {
                    actionText = `At the end of the road, turn right${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                } else {
                    actionText = `At end of road, continue${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                }
                break;
                
            case 'new name':
                if (formattedNextStreet) {
                    actionText = `Continue onto ${formattedNextStreet}`;
                } else {
                    actionText = 'Continue';
                }
                break;
                
            case 'exit roundabout':
                actionText = `Exit the roundabout${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                break;
                
            case 'rotary':
                actionText = `Enter the rotary${formattedStreet ? ' onto ' + formattedStreet : ''}`;
                break;
                
            default:
                if (formattedStreet) {
                    actionText = `Follow ${formattedStreet}`;
                } else {
                    actionText = 'Continue';
                }
        }
        
        if (laneText) {
            actionText = laneText + actionText.toLowerCase();
        }
        
        if (distanceText) {
            return `${distanceText}, ${actionText}`;
        }
        return actionText;
    }

    function formatDistanceGoogleStyle(distance) {
        if (distance < 20) return "";
        if (distance < 50) return "Soon";
        
        if (distance < 1000) {
            const feet = Math.round(distance * 3.28084);
            if (feet < 100) return "in 100 ft";
            if (feet < 200) return "in 200 ft";
            if (feet < 500) return "in 500 ft";
            
            const rounded = Math.round(feet / 50) * 50;
            return `in ${rounded} ft`;
        }
        
        const miles = distance / 1609.34;
        
        if (miles < 0.1) return "in 500 ft";
        if (miles < 0.2) return "in 0.1 mi";
        if (miles < 0.3) return "in 0.2 mi";
        if (miles < 0.5) return "in 0.3 mi";
        if (miles < 0.6) return "in 0.4 mi";
        if (miles < 0.7) return "in 0.5 mi";
        if (miles < 0.8) return "in 0.6 mi";
        if (miles < 0.9) return "in 0.7 mi";
        if (miles < 1.0) return "in 0.8 mi";
        if (miles < 1.1) return "in 0.9 mi";
        if (miles < 1.2) return "in 1.0 mi";
        
        if (miles < 10) {
            const rounded = Math.round(miles * 10) / 10;
            return `in ${rounded.toFixed(1)} mi`;
        }
        
        return `in ${Math.round(miles)} mi`;
    }

    function formatStreetNameForDisplay(name) {
        if (!name) return '';
        
        const abbreviations = {
            'N': 'North', 'S': 'South', 'E': 'East', 'W': 'West',
            'NE': 'Northeast', 'NW': 'Northwest', 'SE': 'Southeast', 'SW': 'Southwest',
            'St': 'Street', 'Ave': 'Avenue', 'Blvd': 'Boulevard', 'Rd': 'Road',
            'Dr': 'Drive', 'Ln': 'Lane', 'Ct': 'Court', 'Pl': 'Place',
            'Hwy': 'Highway', 'Fwy': 'Freeway', 'Expy': 'Expressway', 'Pkwy': 'Parkway',
            'I-': 'I-', 'US-': 'US ', 'SR-': 'State Route ', 'CR-': 'County Road '
        };
        
        const parts = name.split(' ');
        return parts.map(part => {
            const trimmed = part.trim();
            
            if (/^(I-|US-|SR-|CR-)\d+/.test(trimmed)) {
                return trimmed;
            }
            
            if (/^\d+(st|nd|rd|th)$/i.test(trimmed)) {
                return trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
            }
            
            const expanded = abbreviations[trimmed] || 
                            abbreviations[trimmed.replace('.', '')] || 
                            trimmed;
            
            return expanded.charAt(0).toUpperCase() + expanded.slice(1);
        }).join(' ');
    }

    function getOrdinal(n) {
        if (n === undefined || n === null) return '';
        const s = ["th", "st", "nd", "rd"];
        const v = n % 100;
        return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function capitalizeStreetName(streetName) {
        if (!streetName) return '';
        
        const directions = {
            'n': 'North', 'n.': 'North',
            's': 'South', 's.': 'South', 
            'e': 'East', 'e.': 'East',
            'w': 'West', 'w.': 'West',
            'ne': 'Northeast', 'ne.': 'Northeast',
            'nw': 'Northwest', 'nw.': 'Northwest',
            'se': 'Southeast', 'se.': 'Southeast',
            'sw': 'Southwest', 'sw.': 'Southwest'
        };
        
        const streetTypes = {
            'st': 'Street', 'st.': 'Street',
            'ave': 'Avenue', 'ave.': 'Avenue',
            'av': 'Avenue', 'av.': 'Avenue',
            'blvd': 'Boulevard', 'blvd.': 'Boulevard',
            'rd': 'Road', 'rd.': 'Road',
            'dr': 'Drive', 'dr.': 'Drive',
            'ln': 'Lane', 'ln.': 'Lane',
            'ct': 'Court', 'ct.': 'Court',
            'pl': 'Place', 'pl.': 'Place',
            'ter': 'Terrace', 'ter.': 'Terrace',
            'cir': 'Circle', 'cir.': 'Circle',
            'pkwy': 'Parkway', 'pkwy.': 'Parkway',
            'hwy': 'Highway', 'hwy.': 'Highway',
            'fwy': 'Freeway', 'fwy.': 'Freeway',
            'expy': 'Expressway', 'expy.': 'Expressway'
        };
        
        const parts = streetName.split(' ');
        
        return parts.map((part, index) => {
            const lowerPart = part.toLowerCase().replace(/\.$/, '');
            
            if (index === 0) {
                if (directions[lowerPart]) {
                    return directions[lowerPart];
                }
                if (/^[Ii]-\d+$/.test(part)) {
                    return part.toUpperCase();
                }
                if (/^US-\d+$/.test(part)) {
                    return part.replace('US-', 'US Route ');
                }
                if (/^SR-\d+$/.test(part) || /^State Route \d+$/.test(part)) {
                    return part.replace('SR-', 'State Route ');
                }
                return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
            }
            
            if (index === parts.length - 1) {
                if (streetTypes[lowerPart]) {
                    return streetTypes[lowerPart];
                }
            }
            
            if (directions[lowerPart]) {
                return directions[lowerPart];
            }
            
            if (/^\d+(st|nd|rd|th)$/i.test(part)) {
                return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
            }
            
            if (/^\d+$/.test(part)) {
                return part + (streetTypes[parts[parts.length - 1]?.toLowerCase()] ? 'th' : '');
            }
            
            return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
        }).join(' ');
    }

    function groupStepsLikeGoogle(steps) {
        const grouped = [];
        let currentGroup = null;
        
        for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            
            const isMajorManeuver = step.maneuver.type === 'turn' || 
                                   step.maneuver.type === 'merge' ||
                                   step.maneuver.type === 'fork' ||
                                   step.maneuver.type === 'off ramp' ||
                                   step.maneuver.type === 'on ramp' ||
                                   step.maneuver.type === 'roundabout' ||
                                   i === 0;
            
            if (isMajorManeuver || !currentGroup) {
                if (currentGroup) {
                    grouped.push(currentGroup);
                }
                
                currentGroup = {
                    primaryStep: step,
                    substeps: [step],
                    totalDistance: step.distance,
                    totalTime: step.duration || 0
                };
            } else {
                currentGroup.substeps.push(step);
                currentGroup.totalDistance += step.distance;
                currentGroup.totalTime += (step.duration || 0);
            }
        }
        
        if (currentGroup) {
            grouped.push(currentGroup);
        }
        
        return grouped;
    }

    function displaySearchResults(results) {
    const container = document.getElementById('results');
    container.innerHTML = '';
    
    if (results.length === 0) {
        container.innerHTML = '<div class="text-xs text-neutral-500 p-4 text-center">No results found</div>';
        container.classList.remove('hidden');
        return;
    }
    
    results.forEach((result) => {
        const div = document.createElement('div');
        div.className = 'search-result';
        
        const props = result.properties;
        const name = props.name || props.street || props.city || "Location";
        
        const addressParts = [];
        
        if (props.housenumber && props.street) {
            addressParts.push(`${props.housenumber} ${props.street}`);
        } else if (props.street) {
            addressParts.push(props.street);
        }
        
        if (props.city) addressParts.push(props.city);
        if (props.county) addressParts.push(props.county);
        if (props.state) addressParts.push(props.state);
        if (props.country) addressParts.push(props.country);
        if (props.postcode) addressParts.push(props.postcode);
        
        const address = addressParts.length > 0 ? addressParts.join(', ') : 'Coordinates';
        
        let typeBadge = '';
        if (props.type) {
            const typeClass = {
                'city': 'type-city',
                'street': 'type-street',
                'building': 'type-building',
                'landmark': 'type-landmark'
            }[props.type] || 'type-default';
            
            const typeLabel = {
                'city': 'City',
                'street': 'Street',
                'building': 'Building',
                'landmark': 'Landmark',
                'county': 'County',
                'state': 'State',
                'country': 'Country'
            }[props.type] || props.type || 'Location';
            
            typeBadge = `<span class="type-badge ${typeClass}">${typeLabel}</span>`;
        }
        
        const osmType = props.osm_type;
        if (osmType && !props.type) {
            const osmTypeClass = {
                'N': 'type-landmark',
                'W': 'type-street',
                'R': 'type-city'
            }[osmType] || 'type-default';
            
            const osmTypeLabel = {
                'N': 'Node',
                'W': 'Way',
                'R': 'Relation'
            }[osmType] || 'OSM';
            
            typeBadge = `<span class="type-badge ${osmTypeClass}">${osmTypeLabel}</span>`;
        }
        
        div.innerHTML = `
            <div class="flex items-start gap-2 mb-1">
                ${typeBadge}
                <div class="text-[11px] font-bold text-white truncate flex-1">${name}</div>
            </div>
            <div class="text-[9px] text-neutral-400 leading-tight">${address}</div>
        `;
        
        div.onclick = () => {
            const [lng, lat] = result.geometry.coordinates;
            map.flyTo([lat, lng], 15, { animate: true, duration: 1 });
            triggerAnalysis(lat, lng);
            hideSearchResults();
            document.getElementById('search-input').value = name;
        };
        
        container.appendChild(div);
    });
    
    container.classList.remove('hidden');
}
    
    function hideSearchResults() {
        document.getElementById('results').classList.add('hidden');
        document.getElementById('filters').classList.add('hidden');
    }

    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
            return `${minutes}m`;
        } else {
            return '<1m';
        }
    }
    
    function getArrival(seconds) {
        const now = new Date();
        const arrival = new Date(now.getTime() + seconds * 1000);
        return arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function closeSidebar() { 
        document.getElementById('info-sidebar').classList.remove('active'); 
        routeLayer.clearLayers(); 
        currentRoute = null;
        currentNavRoute = null;
        
        if (isNavigating) {
            exitNavigation();
            isNavigating = false;
            
            if (gpsWatchInterval) {
                clearInterval(gpsWatchInterval);
                gpsWatchInterval = null;
            }
        }
        
        if (gpsWatchInterval) {
            clearInterval(gpsWatchInterval);
            gpsWatchInterval = null;
        }

        if (destinationMarker && map.hasLayer(destinationMarker)) {
            map.removeLayer(destinationMarker);
        }
        
        document.getElementById('sidebar-content').innerHTML = `
            <div class="space-y-6">
                <div id="logistics-module">
                    <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block mb-4">Routes via Engine</span>
                    <div id="route-options" class="flex flex-col gap-2"></div>
                </div>
                <div class="space-y-2">
                    <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-widest block">Address</span>
                    <p id="side-address" class="text-xs text-neutral-400 leading-relaxed">Select a location to view details</p>
                </div>
            </div>
        `;
    }
    
    function recenterMap() {
        if (userPos) {
            map.flyTo(userPos, 14, { animate: true, duration: 1 });
            userMarker.setLatLng(userPos);
        }
    }

    function updateDestinationMarker(lat, lng, name = "Destination") {
        if (destinationMarker && map.hasLayer(destinationMarker)) {
            map.removeLayer(destinationMarker);
        }
        
        destinationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div style="background: #ef4444; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(239,68,68,0.5); position: relative;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: white; border-radius: 50%;"></div></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            }),
            zIndexOffset: 1000,
            title: name
        });
        
        destinationMarker.addTo(map);
        
        if (name && name !== "Destination") {
            destinationMarker.bindPopup(`
                <div class="text-xs font-bold text-white" style="margin-right: 15px;">${name}</div>
                <div class="text-[10px] text-neutral-600">Destination</div>
            `);
        }
    }

    async function checkRealFerryRoute(start, end) {
        try {
            const [startLng, startLat] = [start[1], start[0]];
            const [endLng, endLat] = [end[1], end[0]];
            
            const bbox = [
                Math.min(startLat, endLat) - 1,
                Math.min(startLng, endLng) - 1,
                Math.max(startLat, endLat) + 1,
                Math.max(startLng, endLng) + 1
            ].join(',');
            
            const overpassQuery = `
                [out:json][timeout:25];
                (
                    relation["route"="ferry"](${bbox});
                    way["route"="ferry"](${bbox});
                    node["amenity"="ferry_terminal"](${bbox});
                );
                out body;
                >;
                out skel qt;
            `;
            
            const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`);
            const data = await response.json();
            
            if (data.elements && data.elements.length > 0) {
                const ferryRoutes = data.elements.filter(el => 
                    el.type === 'relation' && el.tags && el.tags.route === 'ferry'
                );
                
                const ferryTerminals = data.elements.filter(el => 
                    el.type === 'node' && el.tags && el.tags.amenity === 'ferry_terminal'
                );
                
                if (ferryRoutes.length > 0 || ferryTerminals.length > 0) {
                    const startNearTerminal = isNearFerryTerminal(start, ferryTerminals);
                    const endNearTerminal = isNearFerryTerminal(end, ferryTerminals);
                    
                    if (startNearTerminal && endNearTerminal) {
                        const distance = map.distance(start, end);
                        const ferryTime = (distance / 55000) * 3600;
                        
                        return {
                            hasFerry: true,
                            duration: ferryTime + 1800,
                            distance: distance,
                            description: "Ferry route available",
                            terminals: {
                                start: startNearTerminal.name || "Ferry terminal",
                                end: endNearTerminal.name || "Ferry terminal"
                            }
                        };
                    }
                }
            }
            
            return { hasFerry: false };
        } catch (error) {
            return { hasFerry: false };
        }
    }

    function isNearFerryTerminal(point, terminals) {
        const [lat, lng] = point;
        
        for (const terminal of terminals) {
            const terminalLat = terminal.lat;
            const terminalLng = terminal.lon;
            const distance = map.distance([lat, lng], [terminalLat, terminalLng]);
            
            if (distance < 5000) {
                return {
                    name: terminal.tags.name || "Ferry Terminal",
                    lat: terminalLat,
                    lng: terminalLng
                };
            }
        }
        return null;
    }
    
function exitNavigation() {
    isNavigating = false;
    document.body.classList.remove('navigating');
    
    if (window.navigationGeoJson && map.hasLayer(window.navigationGeoJson)) {
        map.removeLayer(window.navigationGeoJson);
        window.navigationGeoJson = null;
    }
    
    if (window.currentRouteGeoJson && routeLayer.hasLayer(window.currentRouteGeoJson)) {
        routeLayer.removeLayer(window.currentRouteGeoJson);
        window.currentRouteGeoJson = null;
    }
    
    routeLayer.clearLayers();

    closeSidebar();
    
    document.getElementById('standard-ui').style.display = 'flex';
    document.getElementById('active-nav-hud').style.display = 'none';
    document.getElementById('start-nav-btn').classList.add('hidden');
    
    currentNavRoute = null;
    currentStepIndex = 0;
}

    function updateRealTimeMarkerRotation(bearing) {
        if (!window.realTimeMarker || !bearing) return;
        
        const markerElement = window.realTimeMarker.getElement();
        if (!markerElement) return;
        
        const arrowDiv = markerElement.querySelector('div > div:nth-child(1)');
        if (arrowDiv) {
            arrowDiv.style.transform = `rotate(${bearing}deg)`;
        }
    }

    function updateRouteProgress(currentIndex, totalPoints) {
        if (!navigationLine || !window.navigationCamera) return;
        
        const progress = currentIndex / totalPoints;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search-input');
        let searchTimeout;
        
        searchInput.addEventListener('focus', () => {
            showRecentSearches();
        });
        
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            if (!e.target.value.trim()) {
                showRecentSearches();
                return;
            }
            searchTimeout = setTimeout(() => {
                performSearch(e.target.value);
            }, 300);
        });
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filter = e.target.dataset.filter;
                applyFilter(filter);
                if (searchInput.value.trim()) {
                    performSearch(searchInput.value);
                }
            });
        });
        
        document.getElementById('locate-btn').addEventListener('click', recenterMap);
        
        document.getElementById('sat-toggle').addEventListener('click', () => {
            if (map.hasLayer(satLayer)) {
                map.removeLayer(satLayer);
            } else {
                satLayer.addTo(map);
            }
        });
        
        document.getElementById('zoom-in').addEventListener('click', () => {
            map.zoomIn();
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            map.zoomOut();
        });
        
        document.getElementById('exit-nav-btn').addEventListener('click', exitNavigation);
        
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.strike-glass.p-2');
            const results = document.getElementById('results');
            
            if (searchContainer && results && !searchContainer.contains(e.target) && 
                e.target !== searchInput) {
                hideSearchResults();
            }
        });
    });
    
    window.addEventListener('beforeunload', () => {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
        if (gpsWatchInterval) {
            clearInterval(gpsWatchInterval);
        }
    });
</script>

</body>
</html>
